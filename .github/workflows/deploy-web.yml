name: Deploy cuty_web (React/Vite) build to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - "cuty_web/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # ë¹Œë“œ ê´€ë ¨ ê°’ë§Œ envë¡œ ìœ ì§€ (secretsëŠ” withì—ì„œ ì§ì ‘ ì‚¬ìš©)
    env:
      TARGET_DIR: cuty_web/build     # EC2 ê¸°ì¤€: ~/cuty_web/build
      BUILD_DIR: dist                # Vite ë¹Œë“œ ì‚°ì¶œë¬¼ í´ë”

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install & Build (Vite)
        working-directory: cuty_web
        run: |
          npm ci
          npm run build

      - name: Compress build folder
        run: |
          tar -czf build.tar.gz -C cuty_web/${{ env.BUILD_DIR }} .

      # (ì„ íƒ) SSH ì—°ê²°ë§Œ ì‚¬ì „ ì ê²€
      - name: Test SSH connection
        uses: appleboy/ssh-action@v1.1.0
        with:
          host:     ${{ secrets.CUTY_HOST }}
          username: ${{ secrets.CUTY_USER }}      # ì˜ˆ: ubuntu
          key:      ${{ secrets.CUTY_SSH_KEY }}   # ë©€í‹°ë¼ì¸ í”„ë¼ì´ë¹—í‚¤ ì „ì²´
          port:     ${{ secrets.CUTY_PORT }}
          script: |
            whoami && hostname -I && echo "SSH OK"

      - name: Upload build to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.CUTY_HOST }}
          username: ${{ secrets.CUTY_USER }}
          key:      ${{ secrets.CUTY_SSH_KEY }}
          port:     ${{ secrets.CUTY_PORT }}
          source:   "build.tar.gz"
          target:   "~/"

      - name: Deploy on EC2 (replace build folder)
      uses: appleboy/ssh-action@v1.1.0
      with:
        host:     ${{ secrets.CUTY_HOST }}
        username: ${{ secrets.CUTY_USER }}
        port:     ${{ secrets.CUTY_PORT }}
        key_path: id_gh_actions
        script: |
          set -e
          echo "ğŸš€ Start deploying new build..."
          cd ~/cuty_web

          echo "ğŸ§¹ Removing old build folder..."
          sudo rm -rf build

          echo "ğŸ“ Creating build folder..."
          sudo mkdir -p build

          echo "ğŸ“¦ Extracting new build..."
          sudo mv ~/build.tar.gz .
          sudo tar -xzf build.tar.gz -C build
          sudo rm -f build.tar.gz

          echo "ğŸ”§ Fix permissions..."
          sudo chown -R www-data:www-data build
          sudo chmod -R 755 build

          echo "âœ… Deployed to ~/cuty_web/build"

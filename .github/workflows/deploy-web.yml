name: Deploy cuty_web (React/Vite) build to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - "cuty_web/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      SSH_HOST: ${{ secrets.CUTY_HOST }}
      SSH_USER: ${{ secrets.CUTY }}
      SSH_KEY:  ${{ secrets.CUTY_SSH }}
      SSH_PORT: ${{ secrets.CUTY_PORT }}
      TARGET_DIR: cuty_web/build         # EC2 ê¸°ì¤€: ~/cuty_web/build
      BUILD_DIR: dist                    # ë¡œì»¬ ë¹Œë“œ ì‚°ì¶œë¬¼ (Vite)

    steps:
      # 1ï¸âƒ£ ë¦¬í¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Node ì„¤ì¹˜ ë° ë¹Œë“œ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install & Build (Vite)
        working-directory: cuty_web
        run: |
          npm ci
          npm run build

      # 3ï¸âƒ£ ë¹Œë“œ ê²°ê³¼ ì••ì¶•
      - name: Compress build folder
        run: |
          tar -czf build.tar.gz -C cuty_web/${{ env.BUILD_DIR }} .

      # 4ï¸âƒ£ EC2ì— build.tar.gz ì „ì†¡
      - name: Upload build to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          source: "build.tar.gz"
          target: "~/"                     # í™ˆ ë””ë ‰í† ë¦¬(~/)ì— ì„ì‹œë¡œ ì—…ë¡œë“œ

      # 5ï¸âƒ£ EC2ì—ì„œ ê¸°ì¡´ build ì‚­ì œ â†’ ìƒˆ ë¹Œë“œ í’€ê¸°
      - name: Deploy on EC2 (replace build folder)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key: ${{ env.SSH_KEY }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e
            echo "ğŸš€ Start deploying new build..."

            # 1. ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™
            cd ~/cuty_web

            # 2. ê¸°ì¡´ build í´ë” ì‚­ì œ
            echo "ğŸ§¹ Removing old build folder..."
            sudo rm -rf build

            # 3. ìƒˆ build í´ë” ìƒì„±
            mkdir -p build

            # 4. ì „ë‹¬ëœ ì••ì¶•íŒŒì¼ì„ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
            mv ~/build.tar.gz .

            # 5. ìƒˆ ë¹Œë“œ ì••ì¶• í•´ì œ
            echo "ğŸ“¦ Extracting new build..."
            tar -xzf build.tar.gz -C build

            # 6. ì••ì¶•íŒŒì¼ ì‚­ì œ
            rm -f build.tar.gz

            # 7. ê¶Œí•œ ì¬ì„¤ì • (nginxê°€ www-dataë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ)
            echo "ğŸ”§ Setting permissions..."
            sudo chown -R www-data:www-data build
            sudo chmod -R 755 build

            echo "âœ… New build deployed successfully at ~/cuty_web/build"

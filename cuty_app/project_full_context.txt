=== pubspec.yaml ===
name: cuty_app
description: "A new Flutter project."
# The following line prevents the package from being accidentally published to
# pub.dev using `flutter pub publish`. This is preferred for private packages.
publish_to: 'none' # Remove this line if you wish to publish to pub.dev

# The following defines the version and build number for your application.
# A version number is three numbers separated by dots, like 1.2.43
# followed by an optional build number separated by a +.
# Both the version and the builder number may be overridden in flutter
# build by specifying --build-name and --build-number, respectively.
# In Android, build-name is used as versionName while build-number used as versionCode.
# Read more about Android versioning at https://developer.android.com/studio/publish/versioning
# In iOS, build-name is used as CFBundleShortVersionString while build-number is used as CFBundleVersion.
# Read more about iOS versioning at
# https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CoreFoundationKeys.html
# In Windows, build-name is used as the major, minor, and patch parts
# of the product and file versions while build-number is used as the build suffix.
version: 1.0.0+1

environment:
  sdk: ^3.10.7

# Dependencies specify other packages that your package needs in order to work.
# To automatically upgrade your package dependencies to the latest versions
# consider running `flutter pub upgrade --major-versions`. Alternatively,
# dependencies can be manually updated by changing the version numbers below to
# the latest version available on pub.dev. To see which dependencies have newer
# versions available, run `flutter pub outdated`.
dependencies:
  flutter:
    sdk: flutter

  # The following adds the Cupertino Icons font to your application.
  # Use with the CupertinoIcons class for iOS style icons.
  cupertino_icons: ^1.0.8
  flutter_riverpod: ^2.4.9
  dio: ^5.4.0
  google_fonts: ^6.1.0
  intl: ^0.19.0
  json_annotation: ^4.9.0
  webview_flutter: ^4.13.1
  webview_windows: ^0.4.0
  window_manager: ^0.5.1
  fl_chart: ^0.70.2
  shared_preferences: ^2.2.2
  provider: ^6.1.1
  share_plus: ^7.2.1
  http: ^1.6.0
  flutter_secure_storage: ^10.0.0

dev_dependencies:
  flutter_test:
    sdk: flutter

  # The "flutter_lints" package below contains a set of recommended lints to
  # encourage good coding practices. The lint set provided by the package is
  # activated in the `analysis_options.yaml` file located at the root of your
  # package. See that file for information about deactivating specific lint
  # rules and activating additional ones.
  flutter_lints: ^6.0.0
  json_serializable: ^6.11.4
  build_runner: ^2.10.5
  flutter_launcher_icons: ^0.14.4

# For information on the generic Dart part of this file, see the
# following page: https://dart.dev/tools/pub/pubspec

# The following section is specific to Flutter packages.
flutter:

  # The following line ensures that the Material Icons font is
  # included with your application, so that you can use the icons in
  # the material Icons class.
  uses-material-design: true

  # To add assets to your application, add an assets section, like this:
  assets:
    - assets/images/
  #   - images/a_dot_burr.jpeg

  # An image asset can refer to one or more resolution-specific "variants", see
  # https://flutter.dev/to/resolution-aware-images

  # For details regarding adding assets from package dependencies, see
  # https://flutter.dev/to/asset-from-package

  # To add custom fonts to your application, add a fonts section here,
  # in this "flutter" section. Each entry in this list should have a
  # "family" key with the font family name, and a "fonts" key with a
  # list giving the asset and other descriptors for the font. For
  # example:
  # fonts:
  #   - family: Schyler
  #     fonts:
  #       - asset: fonts/Schyler-Regular.ttf
  #       - asset: fonts/Schyler-Italic.ttf
  #         style: italic
  #   - family: Trajan Pro
  #     fonts:
  #       - asset: fonts/TrajanPro.ttf
  #       - asset: fonts/TrajanPro_Bold.ttf
  #         weight: 700
  #
  # For details regarding fonts from package dependencies,
  # see https://flutter.dev/to/font-from-package

flutter_launcher_icons:
  android: true
  ios: true
  image_path: "assets/images/cuty_app_icon.png"
  adaptive_icon_background: "#FFFFFF"
  adaptive_icon_foreground: "assets/images/cuty_app_icon.png"

=== lib\main.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:provider/provider.dart' as p;
import 'providers/f27_visa_provider.dart';


import 'dart:io';
import 'package:window_manager/window_manager.dart';
import 'config/theme.dart';
import 'screens/main_screen.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  if (Platform.isWindows || Platform.isMacOS) {
    await windowManager.ensureInitialized();
    WindowOptions windowOptions = const WindowOptions(
      size: Size(393, 852), // iPhone 15 Pro dimensions
      minimumSize: Size(393, 852), // Prevent resizing smaller
      center: true,
      backgroundColor: Colors.transparent,
      skipTaskbar: false,
      titleBarStyle: TitleBarStyle.normal,
      title: "CUTY Dev (iPhone 15 View)",
    );
    windowManager.waitUntilReadyToShow(windowOptions, () async {
      await windowManager.show();
      await windowManager.focus();
    });
  }

  runApp(
    ProviderScope(
      child: p.MultiProvider(
        providers: [
          p.ChangeNotifierProvider(create: (_) => VisaScoreProvider()),
        ],
        child: const CutyApp(),
      ),
    ),
  );
}

class CutyApp extends StatelessWidget {
  const CutyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'CUTY',
      debugShowCheckedModeBanner: false,
      theme: AppTheme.lightTheme,
      home: const MainScreen(),
    );
  }
}

=== lib\config\app_assets.dart ===
class AppAssets {
  static const String basePath = 'assets/images';

  // Character Images
  static const String capyFortuneHold = '$basePath/capy_fortune_hold.png';
  static const String capyMeditate = '$basePath/capy_meditate.png';
  static const String capyReadSleep = '$basePath/capy_read_sleep.png';
  static const String capySit = '$basePath/capy_sit.png';
  static const String capyBow = '$basePath/capy_bow.png';
  static const String capyBusiness = '$basePath/capy_business_cut.png';

  // Helper list for random selection (excluding fortune hold)
  static const List<String> randomPoses = [
    capyMeditate,
    capyReadSleep,
    capySit,
  ];
}

=== lib\config\theme.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class AppTheme {
  static final ThemeData lightTheme = ThemeData(
    colorScheme: ColorScheme.fromSeed(seedColor: const Color(0xFF1E2B4D)),
    useMaterial3: true,
    // Apply global text style: Dark Navy color and heavier weights
    textTheme: GoogleFonts.notoSansKrTextTheme().apply(
      bodyColor: const Color(0xFF1A1A2E), 
      displayColor: const Color(0xFF1A1A2E),
    ).copyWith(
      bodyLarge: GoogleFonts.notoSansKr(fontWeight: FontWeight.w700),
      bodyMedium: GoogleFonts.notoSansKr(fontWeight: FontWeight.w700),
      bodySmall: GoogleFonts.notoSansKr(fontWeight: FontWeight.w700),
      titleLarge: GoogleFonts.notoSansKr(fontWeight: FontWeight.w700),
      titleMedium: GoogleFonts.notoSansKr(fontWeight: FontWeight.w700),
      titleSmall: GoogleFonts.notoSansKr(fontWeight: FontWeight.w700),
    ),
  );

  // Custom Colors
  static const Color softMint = Color(0xFFE0F7FA);
  static const Color darkGreen = Color(0xFF006064);
  static const Color salaryCardBg = Color(0xFFF1F8E9); // Light Green for Salary Card
  static const Color primaryBlue = Color(0xFF1E88E5);
}

=== lib\data\models\post_dto.dart ===
import 'package:json_annotation/json_annotation.dart';

part 'post_dto.g.dart';

@JsonSerializable(fieldRename: FieldRename.snake)
class PostResponse {
  final bool success;
  final PostData data;

  PostResponse({required this.success, required this.data});

  factory PostResponse.fromJson(Map<String, dynamic> json) => _$PostResponseFromJson(json);
  Map<String, dynamic> toJson() => _$PostResponseToJson(this);
}

@JsonSerializable(fieldRename: FieldRename.snake)
class PostData {
  final List<PostDto> items;

  PostData({required this.items});

  factory PostData.fromJson(Map<String, dynamic> json) => _$PostDataFromJson(json);
  Map<String, dynamic> toJson() => _$PostDataToJson(this);
}

@JsonSerializable(fieldRename: FieldRename.snake)
class PostDto {
  final int id;
  final String title;
  final String? content;
  final int? likesCount; // Matching API typical snake_case
  final int? viewCount;
  // Add other fields as necessary based on API response, allowing nulls for safety

  PostDto({
    required this.id,
    required this.title,
    this.content,
    this.likesCount,
    this.viewCount,
  });

  factory PostDto.fromJson(Map<String, dynamic> json) => _$PostDtoFromJson(json);
  Map<String, dynamic> toJson() => _$PostDtoToJson(this);
}

=== lib\data\repositories\real_home_repository.dart ===
import 'package:dio/dio.dart';
import 'package:flutter/material.dart'; // Import Material for Icons and Colors
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../services/home_repository.dart';
import '../../models/schedule_item.dart';
import '../../models/community_post.dart';
import '../../models/job_post.dart';
import '../../models/banner_item.dart';
import '../../config/app_assets.dart'; // Ensure AppAssets is accessible for the Capybara image

// Provider for RealHomeRepository
final realHomeRepositoryProvider = Provider<HomeRepository>((ref) {
  final dio = Dio(BaseOptions(
    baseUrl: 'https://api.university.ac.kr', // Replace with actual base URL if known, or keep placeholder
    connectTimeout: const Duration(seconds: 5),
    receiveTimeout: const Duration(seconds: 3),
  ));
  return RealHomeRepository(dio);
});

class RealHomeRepository implements HomeRepository {
  final Dio _dio;

  RealHomeRepository(this._dio);

  @override
  Future<List<ScheduleItem>> fetchDailySchedule() {
    // API Endpoint doesn't exist yet, return empty list for safety
    return Future.value([]);
  }

  @override
  Future<List<CommunityPost>> fetchPopularPosts() async {
    try {
      // API Endpoint doesn't exist yet, return empty list for safety to prevent connection errors
      /* 
      final response = await _dio.get('/api/v1/posts/popular', queryParameters: {
        'limit': 5,
        // Add category if needed, e.g., 'category': 'FREE'
      });

      if (response.statusCode == 200) {
        final postResponse = PostResponse.fromJson(response.data);
        
        // Map DTO to Domain Model
        return postResponse.data.items.map((dto) {
          return CommunityPost(
            userName: 'Anonymous', // API doesn't seem to return user info in simple list often, check if present
            title: dto.title,
            content: dto.content ?? '',
            likes: dto.likesCount ?? 0,
            comments: 0, // Comment count might not be in the list response
            timeAgo: '諛⑷툑 ??, // Date parsing logic needed if created_at is provided
          );
        }).toList();
      }
      */
      return [];
    } catch (e) {
      // In case of error, return empty list or rethrow depending on requirement.
      // User asked to return empty or throw exception. Return empty for UI stability now or log.
      debugPrint('Error fetching posts: $e');
      return [];
    }
  }

  @override
  Future<List<JobPost>> fetchJobPosts() async {
    // Forced Dummy Data for Demo Mode
    return Future.value([
      JobPost(
        id: 'job_1',
        title: '遺???쒕㈃ 移댄럹 ?쒕튃',
        companyName: '移댄럹 荑좏떚',
        location: '遺?곗쭊援?以묒븰?濡?,
        hourlyWage: 10000,
        tags: ['鍮꾩옄媛??, '?숆탳 踰꾩뒪 10遺?],
        imageUrl: 'https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=1000&auto=format&fit=crop',
        isVerified: true,
        workingHours: '二쇰쭚 09:00 - 14:00',
        deadline: 'D-33',
        description: '諛앹? 誘몄냼濡??먮떂??留욎씠??二쇱꽭??',
        requirements: '珥덈낫 媛?? ?쒓뎅??3湲??댁긽',
      ),
    ]);
  }
  @override
  Future<List<BannerItem>> fetchBanners(int categoryIndex) async {
    // 0: Part-Time (Alba), 1: Career (Job)
    if (categoryIndex == 0) {
      // Original Capybara Banner
      return [
        const BannerItem(
          title: '?쒓컙??痍⑥뾽 ?덇?',
          subtitle: '荑좏떚? ?④퍡 ?쎄퀬 ?뺥솗?섍쾶!',
          gradientColors: [Color(0xFF80E0D4), Color(0xFFB39DDB)], // Mint to Purple
          imagePath: AppAssets.capyBusiness,
        ),
        const BannerItem(
          title: '泥??뚮컮, 臾댁뾿遺??',
          subtitle: '?뚮컮珥덈낫瑜??꾪븳 湲곗큹 媛?대뱶',
          gradientColors: [Color(0xFFFFCC80), Color(0xFFFFAB91)], // Light Orange
          icon: Icons.help_outline_rounded,
        ),
        const BannerItem(
          title: '?덉쟾??洹쇰줈怨꾩빟??,
          subtitle: '瑗??뺤씤?댁빞 ???꾩닔 泥댄겕由ъ뒪??,
          gradientColors: [Color(0xFF80CBC4), Color(0xFF4DB6AC)], // Mint
          icon: Icons.assignment_turned_in_rounded,
        ),
      ];
    } else {
      // Career Banners (Dummy)
      return [
        const BannerItem(
          title: 'Spec Diagnosis', // Title used as ID for custom UI
          subtitle: '',
          gradientColors: [Color(0xFF283593), Color(0xFF3F51B5)], // Lighter Navy to Blue
          imagePath: 'assets/images/capy_corp_semicut.png',
        ),
        const BannerItem(
          title: 'IT/?ㅽ??몄뾽 ?명꽩??,
          subtitle: '?쒓뎅 ?ㅽ??몄뾽?먯꽌 而ㅻ━?대? ?쒖옉?섏꽭??',
          gradientColors: [Color(0xFF0288D1), Color(0xFF4FC3F7)], // Light Blue
          icon: Icons.rocket_launch_outlined,
        ),
        const BannerItem(
          title: '?대젰???먯냼??泥⑥궘',
          subtitle: '?꾩쭅?먭? ?뚮젮二쇰뒗 ?⑷꺽?섎뒗 ?묒꽦踰?,
          gradientColors: [Color(0xFFE65100), Color(0xFFFF9800)], // Orange
          icon: Icons.edit_note_rounded,
        ),
      ];
    }
  }
}

=== lib\models\attendance_response.dart ===
class AttendanceResponse {
  final int gainedPoint;
  final String message;
  final int totalPoints;

  AttendanceResponse({
    required this.gainedPoint,
    required this.message,
    required this.totalPoints,
  });

  factory AttendanceResponse.fromJson(Map<String, dynamic> json) {
    return AttendanceResponse(
      gainedPoint: json['gained_point'] ?? 0,
      message: json['message'] ?? '',
      totalPoints: json['total_points'] ?? 0,
    );
  }
}

=== lib\models\auth_response.dart ===
class AuthResponse {
  final String accessToken;
  final String tokenType;
  final String? userType;

  AuthResponse({
    required this.accessToken,
    required this.tokenType,
    this.userType,
  });

  factory AuthResponse.fromJson(Map<String, dynamic> json) {
    return AuthResponse(
      accessToken: json['access_token'] ?? '',
      tokenType: json['token_type'] ?? 'Bearer',
      userType: json['user_type'],
    );
  }
}

=== lib\models\banner_item.dart ===
import 'package:flutter/material.dart';

class BannerItem {
  final String title;
  final String subtitle;
  final List<Color> gradientColors;
  final String? imagePath; // For local assets like Capybara
  final IconData? icon;    // For simple icons

  const BannerItem({
    required this.title,
    required this.subtitle,
    required this.gradientColors,
    this.imagePath,
    this.icon,
  });
}

=== lib\models\community_post.dart ===
class CommunityPost {
  final String userName;
  final String title;
  final String content;
  final int likes;
  final int comments;
  final String timeAgo;

  CommunityPost({
    required this.userName,
    required this.title,
    required this.content,
    required this.likes,
    required this.comments,
    required this.timeAgo,
  });
}

=== lib\models\diagnosis_model.dart ===
enum VisaStatus { GREEN, YELLOW, RED }

class CareerExperience {
  final String category; // '?명꽩??, '?쒓컙??痍⑥뾽(?뚮컮)', '怨쇨굅 E-7 洹쇰Т'
  final String detailType; // '?щТ/?됱젙', '?앸떦/?쒕튃', '湲고?' etc.
  final String? customInput; // User typed input or E-7 code

  CareerExperience({
    required this.category, 
    required this.detailType, 
    this.customInput
  });
}

class SurveyAnswer {
  // 1. ?щ쭩 吏곷Т (Multi-select)
  final List<String> targetJobs;
  // 2. ?좏샇 吏??(Multi-select)
  final List<String> preferredLocations;
  // 3. ?쒓뎅???ㅻ젰 (Description)
  final String koreanLevel;
  // 4. 寃쎈젰 ?ы빆 (Detailed List)
  final List<CareerExperience> experiences;

  SurveyAnswer({
    this.targetJobs = const [],
    this.preferredLocations = const [],
    this.koreanLevel = '',
    this.experiences = const [],
  });

  SurveyAnswer copyWith({
    List<String>? targetJobs,
    List<String>? preferredLocations,
    String? koreanLevel,
    List<CareerExperience>? experiences,
  }) {
    return SurveyAnswer(
      targetJobs: targetJobs ?? this.targetJobs,
      preferredLocations: preferredLocations ?? this.preferredLocations,
      koreanLevel: koreanLevel ?? this.koreanLevel,
      experiences: experiences ?? this.experiences,
    );
  }
}

class JobAnalysisData {
  final String jobCode; // "2351"
  final String jobName; // "General Engineer"
  final VisaStatus visaStatus;
  
  // 5-Axis Scores
  final Map<String, int> myScores; // { "?몄뼱": 80, "吏곷Т": 60 ... }
  final Map<String, int> avgScores; // Benchmarking { "?몄뼱": 90 ... }
  
  final String avgSalary; // "3,200留뚯썝"

  JobAnalysisData({
    required this.jobCode,
    required this.jobName,
    required this.visaStatus,
    required this.myScores,
    required this.avgScores,
    required this.avgSalary,
  });
}

class DiagnosisResult {
  // Key: Job Code (e.g., "2351") -> Data
  final Map<String, JobAnalysisData> analysisResults;
  final List<String> solutionDocs; 
  
  // Total Competency Score
  final int totalScore;
  final String totalTier; // "Diamond", "Gold", etc.
  final String tierDescription;

  DiagnosisResult({
    required this.analysisResults,
    required this.solutionDocs,
    required this.totalScore,
    required this.totalTier,
    required this.tierDescription,
  });

  // Factory for empty/initial state
  factory DiagnosisResult.empty() {
    return DiagnosisResult(
      analysisResults: {},
      solutionDocs: [],
      totalScore: 0,
      totalTier: "Unranked",
      tierDescription: "吏꾨떒???쒖옉?댁＜?몄슂.",
    );
  }

  // Get Primary Result (First one or empty) - Helper for UI
  JobAnalysisData? get primary => analysisResults.isNotEmpty ? analysisResults.values.first : null;
}

=== lib\models\document_model.dart ===
class Document {
  final int id;
  final String name;
  final String type;
  final DateTime createdAt;
  final String imageUrl;

  Document({
    required this.id,
    required this.name,
    required this.type,
    required this.createdAt,
    required this.imageUrl,
  });

  factory Document.fromJson(Map<String, dynamic> json) {
    // Parser for image object structure: "image": { "url": "..." }
    String parsedImageUrl = '';
    if (json['image'] != null && json['image'] is Map) {
      parsedImageUrl = json['image']['url'] ?? '';
    } else if (json['image_url'] != null) {
      // Fallback if API changes to flat structure
      parsedImageUrl = json['image_url'] ?? '';
    }

    return Document(
      id: json['id'] ?? 0,
      name: json['name'] ?? '',
      type: json['type'] ?? '',
      createdAt: json['created_at'] != null
          ? DateTime.tryParse(json['created_at']) ?? DateTime.now()
          : DateTime.now(),
      imageUrl: parsedImageUrl,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
      'type': type,
      'created_at': createdAt.toIso8601String(),
      'image': {'url': imageUrl},
    };
  }

  // Compatibility getters for old UI code
  String get title => name;
  
  String get expiryDate {
    final expiry = createdAt.add(const Duration(days: 365));
    return "${expiry.year}-${expiry.month.toString().padLeft(2, '0')}-${expiry.day.toString().padLeft(2, '0')}";
  }

  bool get isVerified => true; // Assume verified if it exists in the list
}

=== lib\models\job_post.dart ===
class JobPost {
  final String? id;
  final String title;
  final String? companyName;
  final String? location;
  final int? hourlyWage;
  final String? salary;
  final List<String> tags;
  final String imageUrl;
  final bool isVerified;
  final bool isBookmarked;
  final String? description;
  final DateTime? postedDate;
  final String? workingHours;
  final String? requirements;
  final String? deadline;

  JobPost({
    this.id,
    required this.title,
    this.companyName,
    this.location,
    this.hourlyWage,
    this.salary,
    required this.tags,
    required this.imageUrl,
    this.isVerified = false,
    this.isBookmarked = false,
    this.description,
    this.postedDate,
    this.workingHours,
    this.requirements,
    this.deadline,
  });
}

=== lib\models\post_model.dart ===
class PostModel {
  final int id;
  final String title;
  final String content;
  final int likeCount;
  final int viewCount;

  PostModel({
    required this.id,
    required this.title,
    required this.content,
    required this.likeCount,
    required this.viewCount,
  });

  factory PostModel.fromJson(Map<String, dynamic> json) {
    return PostModel(
      id: json['id'] ?? 0,
      title: json['title'] ?? '',
      content: json['content'] ?? '',
      likeCount: json['like_count'] ?? 0,
      viewCount: json['view_count'] ?? 0,
    );
  }
}

=== lib\models\schedule_item.dart ===
class ScheduleItem {
  final String title;
  final String subtitle;
  final String time;

  ScheduleItem({
    required this.title,
    required this.subtitle,
    required this.time,
  });

  factory ScheduleItem.fromJson(Map<String, dynamic> json) {
    return ScheduleItem(
      title: json['title'] ?? '',
      subtitle: json['subtitle'] ?? '',
      time: json['time'] ?? '',
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'title': title,
      'subtitle': subtitle,
      'time': time,
    };
  }
}

=== lib\models\schedule_model.dart ===
class Schedule {
  final int? id;
  final String title;
  final String classroom;
  final String day;
  final int startTime;
  final int duration;

  Schedule({
    this.id,
    required this.title,
    required this.classroom,
    required this.day,
    required this.startTime,
    required this.duration,
  });

  factory Schedule.fromJson(Map<String, dynamic> json) {
    return Schedule(
      id: json['id'], // nullable
      title: json['title'] ?? '',
      classroom: json['classroom'] ?? '',
      day: json['day'] ?? '',
      startTime: json['start_time'] ?? 9, // Default to 1st period (9:00) if missing
      duration: json['duration'] ?? 1, // Default duration 1 hour
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'title': title,
      'classroom': classroom,
      'day': day,
      'start_time': startTime,
      'duration': duration,
    };
  }
}

=== lib\models\shop_model.dart ===
class Shop {
  final int id;
  final String name;
  final int price;
  final String category;
  final String? imageUrl;
  final String? description;

  Shop({
    required this.id,
    required this.name,
    required this.price,
    required this.category,
    this.imageUrl,
    this.description,
  });

  factory Shop.fromJson(Map<String, dynamic> json) {
    return Shop(
      id: json['id'] ?? 0,
      name: json['name'] ?? '',
      price: json['price'] ?? 0,
      category: json['category'] ?? 'General',
      imageUrl: json['image_url'], // Nullable
      description: json['description'], // Nullable
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
      'price': price,
      'category': category,
      'image_url': imageUrl,
      'description': description,
    };
  }
}

=== lib\models\user.dart ===
import 'package:json_annotation/json_annotation.dart';

part 'user.g.dart';

@JsonSerializable(explicitToJson: true)
class User {
  final int id;
  final String name;
  final String email;
  final School school;
  final College college;
  final Department department;
  final Country country;

  User({
    required this.id,
    required this.name,
    required this.email,
    required this.school,
    required this.college,
    required this.department,
    required this.country,
  });

  factory User.fromJson(Map<String, dynamic> json) => _$UserFromJson(json);
  Map<String, dynamic> toJson() => _$UserToJson(this);

  // --- Compatibility Layer for Legacy UI (MyPageScreen) ---
  factory User.dummy() {
    return User(
      id: 0,
      name: 'User Name',
      email: 'test@university.ac.kr',
      school: School(id: 0, name: 'University Name'),
      college: College.empty(),
      department: Department.empty(),
      country: Country.empty(),
    );
  }

  // Getters to match old UserModel fields
  String get university => school.name;
  String get major => department.name; // Added compatibility
  String get visaType => '鍮꾩옄 ?뺣낫 ?놁쓬'; // Placeholder: API doesn't provide this yet
  int get points => 0; // Placeholder: Points might come from separate API
  String get visaExpiry => '-';
  String get workPermitDate => '- ~ -';
  bool get isWorkPermitApproved => false;
}

@JsonSerializable()
class School {
  final int id;
  final String name;

  School({required this.id, required this.name});

  factory School.fromJson(Map<String, dynamic> json) => _$SchoolFromJson(json);
  Map<String, dynamic> toJson() => _$SchoolToJson(this);

  factory School.empty() {
    return School(id: 0, name: '');
  }
}

@JsonSerializable()
class College {
  final int id;
  final String name;

  College({required this.id, required this.name});

  factory College.fromJson(Map<String, dynamic> json) => _$CollegeFromJson(json);
  Map<String, dynamic> toJson() => _$CollegeToJson(this);

  factory College.empty() {
    return College(id: 0, name: '');
  }
}

@JsonSerializable()
class Department {
  final int id;
  final String name;

  Department({required this.id, required this.name});

  factory Department.fromJson(Map<String, dynamic> json) => _$DepartmentFromJson(json);
  Map<String, dynamic> toJson() => _$DepartmentToJson(this);

  factory Department.empty() {
    return Department(id: 0, name: '');
  }
}

@JsonSerializable()
class Country {
  final int id;
  final String name;

  Country({required this.id, required this.name});

  factory Country.fromJson(Map<String, dynamic> json) => _$CountryFromJson(json);
  Map<String, dynamic> toJson() => _$CountryToJson(this);

  factory Country.empty() {
    return Country(id: 0, name: '');
  }
}

=== lib\providers\alba_permit_provider.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

class AlbaPermitState {
  final int currentStep; 
  // Step 0: Selection
  // Step 1: Visa Link
  // Step 2: Guide (Checks)
  // Step 3: Camera (3 stages)
  // Step 4: Info Confirm
  // Step 5: Signature
  // Step 6: Submit Complete (Pending School)
  // Step 7: School Approved (Show Stamp)
  // Step 8: Final Folder / HiKorea Guide
  // Step 9: Final Permit (Success)

  // Step 1 Data
  final bool isVisaLinked;

  // Step 2 Data
  final bool consentChecked;
  final bool purposeChecked;

  // Step 3 Data (Camera)
  final int cameraStep; // 0, 1, 2
  final String? bizLicenseImage;
  final String? contractImage;
  final String? idCardImage;

  // Step 4 & 5 Data (Detailed Form)
  // Student Info (Mock for now)
  final String studentName;
  final String studentRegNo;
  final String studentMajor;
  final String studentSemester;
  final String studentPhone;
  final String studentEmail;

  // Employer Info
  final String companyName;
  final String bizNo;
  final String ownerName;
  final String sectors; // ?낆쥌
  final String address;
  final String employerPhone;
  final String employmentPeriod;
  final String hourlyWage;
  final String weekdayWork; // ?됱씪 洹쇰Т
  final String weekendWork; // 二쇰쭚 洹쇰Т (?대Т)

  // Step 4 Data
  final bool infoCorrectChecked;

  // Step 5 Data (Signature)
  final List<Offset?> signaturePoints;
  final bool isSignatureSaved;

  // Step 8 Data
  final bool isPdfDownloaded;

  AlbaPermitState({
    this.currentStep = 0,
    this.isVisaLinked = false,
    this.consentChecked = false,
    this.purposeChecked = false,
    this.cameraStep = 0,
    this.bizLicenseImage,
    this.contractImage,
    this.idCardImage,
    
    // Student Defaults
    this.studentName = '源荑좏떚',
    this.studentRegNo = '990101-1234567',
    this.studentMajor = '而댄벂?곌났?숆낵',
    this.studentSemester = '2?숆린',
    this.studentPhone = '010-1234-5678',
    this.studentEmail = 'cuty@university.ac.kr',

    // Employer Defaults
    this.companyName = '(二?荑좏떚移댄럹?뚮━??,
    this.bizNo = '123-45-67890',
    this.ownerName = '源荑좏떚',
    this.sectors = '?뚯떇?먯뾽',
    this.address = '遺?곌킅??떆 ?댁슫?援??곕룞 123',
    this.employerPhone = '051-123-4567',
    this.employmentPeriod = '2024.03.01 ~ 2024.08.31 (6媛쒖썡)',
    this.hourlyWage = '10,030??,
    this.weekdayWork = '18:00 ~ 22:00 (4?쒓컙)',
    this.weekendWork = '?대Т',

    this.infoCorrectChecked = false,
    this.signaturePoints = const [],
    this.isSignatureSaved = false,
    this.isPdfDownloaded = false,
  });

  AlbaPermitState copyWith({
    int? currentStep,
    bool? isVisaLinked,
    bool? consentChecked,
    bool? purposeChecked,
    int? cameraStep,
    String? bizLicenseImage,
    String? contractImage,
    String? idCardImage,
    String? studentName,
    String? studentRegNo,
    String? studentMajor,
    String? studentSemester,
    String? studentPhone,
    String? studentEmail,
    String? companyName,
    String? bizNo,
    String? ownerName,
    String? sectors,
    String? address,
    String? employerPhone,
    String? employmentPeriod,
    String? hourlyWage,
    String? weekdayWork,
    String? weekendWork,
    bool? infoCorrectChecked,
    List<Offset?>? signaturePoints,
    bool? isSignatureSaved,
    bool? isPdfDownloaded,
  }) {
    return AlbaPermitState(
      currentStep: currentStep ?? this.currentStep,
      isVisaLinked: isVisaLinked ?? this.isVisaLinked,
      consentChecked: consentChecked ?? this.consentChecked,
      purposeChecked: purposeChecked ?? this.purposeChecked,
      cameraStep: cameraStep ?? this.cameraStep,
      bizLicenseImage: bizLicenseImage ?? this.bizLicenseImage,
      contractImage: contractImage ?? this.contractImage,
      idCardImage: idCardImage ?? this.idCardImage,
      studentName: studentName ?? this.studentName,
      studentRegNo: studentRegNo ?? this.studentRegNo,
      studentMajor: studentMajor ?? this.studentMajor,
      studentSemester: studentSemester ?? this.studentSemester,
      studentPhone: studentPhone ?? this.studentPhone,
      studentEmail: studentEmail ?? this.studentEmail,
      companyName: companyName ?? this.companyName,
      bizNo: bizNo ?? this.bizNo,
      ownerName: ownerName ?? this.ownerName,
      sectors: sectors ?? this.sectors,
      address: address ?? this.address,
      employerPhone: employerPhone ?? this.employerPhone,
      employmentPeriod: employmentPeriod ?? this.employmentPeriod,
      hourlyWage: hourlyWage ?? this.hourlyWage,
      weekdayWork: weekdayWork ?? this.weekdayWork,
      weekendWork: weekendWork ?? this.weekendWork,
      infoCorrectChecked: infoCorrectChecked ?? this.infoCorrectChecked,
      signaturePoints: signaturePoints ?? this.signaturePoints,
      isSignatureSaved: isSignatureSaved ?? this.isSignatureSaved,
      isPdfDownloaded: isPdfDownloaded ?? this.isPdfDownloaded,
    );
  }
}

class AlbaPermitNotifier extends StateNotifier<AlbaPermitState> {
  AlbaPermitNotifier() : super(AlbaPermitState());

  void setStep(int step) {
    state = state.copyWith(currentStep: step);
  }

  void nextStep() {
    state = state.copyWith(currentStep: state.currentStep + 1);
  }

  void prevStep() {
    if (state.currentStep > 0) {
      // Step 4 is now Camera (was 3)
      if (state.currentStep == 4 && state.cameraStep > 0) {
        state = state.copyWith(cameraStep: state.cameraStep - 1);
      } else {
        state = state.copyWith(currentStep: state.currentStep - 1);
      }
    }
  }

  // Step 1: Visa Link
  void linkVisa() {
     state = state.copyWith(isVisaLinked: true);
  }

  // Step 2: Checks
  void toggleConsent() => state = state.copyWith(consentChecked: !state.consentChecked);
  void togglePurpose() => state = state.copyWith(purposeChecked: !state.purposeChecked);

  // Step 3: Camera
  void advanceCameraStep() {
    if (state.cameraStep < 2) {
      state = state.copyWith(cameraStep: state.cameraStep + 1);
    } else {
      nextStep(); 
    }
  }

  // Step 4: Form Updates
  void updateCompanyName(String v) => state = state.copyWith(companyName: v);
  void updateBizNo(String v) => state = state.copyWith(bizNo: v);
  void updateOwnerName(String v) => state = state.copyWith(ownerName: v);
  void updateAddress(String v) => state = state.copyWith(address: v);
  void updateHourlyWage(String v) => state = state.copyWith(hourlyWage: v);
  void updateWorkingHours(String v) {
    // In the simple form, we map this to weekdayWork for now, or split it if needed.
    // simpler to just update weekdayWork as the primary display
    state = state.copyWith(weekdayWork: v);
  }
  
  void toggleInfoCorrect() => state = state.copyWith(infoCorrectChecked: !state.infoCorrectChecked);

  // Step 5: Signature
  void addSignaturePoint(Offset? point) {
    if (state.isSignatureSaved) return;
    final newPoints = List<Offset?>.from(state.signaturePoints)..add(point);
    state = state.copyWith(signaturePoints: newPoints);
  }

  void clearSignature() {
    state = state.copyWith(signaturePoints: [], isSignatureSaved: false);
  }

  void saveSignature() {
    state = state.copyWith(isSignatureSaved: true);
  }

  // Step 8: PDF Download
  void downloadPdf() {
    state = state.copyWith(isPdfDownloaded: true);
  }
}

final albaPermitProvider = StateNotifierProvider.autoDispose<AlbaPermitNotifier, AlbaPermitState>((ref) {
  return AlbaPermitNotifier();
});

=== lib\providers\auth_provider.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../models/user.dart';
import '../services/api_service.dart';

class UserNotifier extends StateNotifier<User?> {
  UserNotifier() : super(null); // Init with null (logged out)
  
  // Login: Use ApiService
  Future<bool> login(String email, String password) async {
    print("Attempting login for $email...");
    final success = await ApiService.instance.login(email, password);
    
    if (success) {
      print("Login successful. Fetching user info...");
      final user = await ApiService.instance.fetchMyInfo();
      if (user != null) {
        state = user;
        print("User info loaded: ${user.name}");
        return true;
      } else {
        print("Failed to fetch user info after login.");
      }
    } else {
      print("Login failed.");
    }
    return false;
  }

  // Logout: Clear state
  void logout() {
    state = null;
    // ApiService.instance.logout(); // Implement storage clear if needed
  }
}

final userProvider = StateNotifierProvider<UserNotifier, User?>((ref) {
  return UserNotifier();
});

=== lib\providers\diagnosis_provider.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../models/diagnosis_model.dart';
import '../models/document_model.dart';
import 'document_provider.dart';

class DiagnosisState {
  final SurveyAnswer answer;
  final DiagnosisResult? result;
  final bool isAnalyzing;

  DiagnosisState({
    required this.answer,
    this.result,
    this.isAnalyzing = false,
  });

  DiagnosisState copyWith({
    SurveyAnswer? answer,
    DiagnosisResult? result,
    bool? isAnalyzing,
  }) {
    return DiagnosisState(
      answer: answer ?? this.answer,
      result: result ?? this.result,
      isAnalyzing: isAnalyzing ?? this.isAnalyzing,
    );
  }
  
  bool get isAnalysisDone => result != null;
}

class DiagnosisNotifier extends StateNotifier<DiagnosisState> {
  final Ref ref;

  DiagnosisNotifier(this.ref)
      : super(DiagnosisState(answer: SurveyAnswer()));

  // 1. Update Survey Input
  void updateAnswer(SurveyAnswer newAnswer) {
    state = state.copyWith(answer: newAnswer);
  }

  // 2. Perform Analysis
  Future<void> analyze({required bool useDocuments}) async {
    state = state.copyWith(isAnalyzing: true);
    
    // Simulate thinking time for UX
    // If using documents, it takes longer (Wallet opening)
    await Future.delayed(Duration(seconds: useDocuments ? 3 : 2));

    // Get Objective Data (Documents)
    final myDocs = useDocuments ? ref.read(documentProvider) : <Document>[];
    
    // Logic Execution
    final result = _calculateResult(state.answer, myDocs);

    state = state.copyWith(
      result: result,
      isAnalyzing: false,
    );
  }

  // Core Business Logic
  DiagnosisResult _calculateResult(SurveyAnswer answer, List<Document> docs) {
    // -------------------------------------------------------------
    // 1. Scoring Logic (5 Axis)
    // -------------------------------------------------------------
    
    // A. Language (TOPIK + Survey)
    int langScore = 0;
    switch (answer.koreanLevel) {
      case '湲곗큹 (?몄궗留??뺣룄)': langScore = 20; break;
      case '?쇱긽?뚰솕 (?앸떦/留덊듃 ?댁슜)': langScore = 40; break;
      case '鍮꾩쫰?덉뒪 (?좊줎 媛??': langScore = 70; break;
      case '?먯뼱誘??섏?': langScore = 100; break;
      default: langScore = 10;
    }
    bool hasTopik = docs.any((d) => d.name.toUpperCase().contains('TOPIK'));
    if (hasTopik) langScore = (langScore + 30).clamp(0, 100);

    // B. Experience (Intern, Alba, E7)
    int expScore = 0;
    for (var exp in answer.experiences) {
      if (exp.category == '?명꽩??) {
        expScore += 30;
      } else if (exp.category == '?쒓컙??痍⑥뾽(?뚮컮)') expScore += 20;
      else if (exp.category == '怨쇨굅 E-7 洹쇰Т') expScore += 50;
    }
    expScore = expScore.clamp(0, 100);

    // C. Expertise (Job Match + Degree)
    int expertiseScore = 40; // Base
    bool hasDegree = docs.any((d) => d.name.contains('議몄뾽') || d.name.contains('?숈쐞'));
    if (hasDegree) expertiseScore += 40;
    // Boost if experience details match target job
    // Simple check: if any target job matches experience detail
    bool expMatch = false;
    for (var job in answer.targetJobs) {
       // Check detailType and customInput
       if (answer.experiences.any((e) {
          final detail = e.detailType;
          final custom = e.customInput ?? '';
          return (detail.contains(job) || custom.contains(job)) || (detail.contains('?명뀛') && job.contains('愿愿?));
       })) {
          expMatch = true;
       }
    }
    if (expMatch) expertiseScore += 20;
    expertiseScore = expertiseScore.clamp(0, 100);

    // D. Korea Understanding (Duration + Culture) - Simulated
    int koreaScore = 60; // Default
    if (langScore > 70) koreaScore += 20;
    if (docs.any((d) => d.name.contains('GKS') || d.name.contains('?ы쉶?듯빀'))) koreaScore += 20;
    koreaScore = koreaScore.clamp(0, 100);

    // E. Sincerity/Reputation (GPA + Attendance) - Simulated
    int sincerityScore = 70; // Default
    if (expScore > 50) sincerityScore += 10;
    if (hasDegree) sincerityScore += 10;
    sincerityScore = sincerityScore.clamp(0, 100);

    // -------------------------------------------------------------
    // 2. Benchmarking & Result Generation
    // -------------------------------------------------------------
    Map<String, JobAnalysisData> results = {};
    List<String> solutions = [];

    // Common Solutions
    if (!hasTopik) solutions.add("TOPIK 蹂댁셿 (3湲??댁긽 沅뚯옣)");
    if (!hasDegree) solutions.add("?꾧났 ?숈쐞 利앸챸??);
    if (answer.experiences.isEmpty) solutions.add("愿???명꽩??寃쏀뿕");

    // Helper to Create Data
    void addResult(String code, String name, int avgSalaryInt, {int bonus = 0}) {
      VisaStatus status = VisaStatus.RED;
      // Simple Pass Logic
      if (expertiseScore + bonus >= 70 && langScore >= 40) {
        status = VisaStatus.GREEN;
      } else if (expertiseScore + bonus >= 50) status = VisaStatus.YELLOW;

      results[code] = JobAnalysisData(
        jobCode: code,
        jobName: name,
        visaStatus: status,
        myScores: {
          "?몄뼱": langScore,
          "?꾨Ц??: (expertiseScore + bonus).clamp(0, 100),
          "寃쎈젰": expScore,
          "?쒓뎅?댄빐": koreaScore,
          "?깆떎??: sincerityScore,
        },
        avgScores: {
          "?몄뼱": 85,
          "?꾨Ц??: 80,
          "寃쎈젰": 70,
          "?쒓뎅?댄빐": 75,
          "?깆떎??: 90,
        },
        avgSalary: "$avgSalaryInt留뚯썝",
      );
    }

    // Generate Results based on Multi-select Targets
    for (var job in answer.targetJobs) {
      if (job.contains('IT') || job.contains('湲곗닠')) {
          addResult('1332', '?묒슜 S/W 媛쒕컻??, 3800);
          addResult('2351', '?곗씠???꾨Ц媛', 4200, bonus: -10);
      } else if (job.contains('留덉???) || job.contains('臾댁뿭')) {
          addResult('2733', '?댁쇅 ?곸뾽??, 3400);
          addResult('2742', '?곹뭹 湲고쉷 ?꾨Ц媛', 3200, bonus: -5);
      } else if (job.contains('愿愿?) || job.contains('?쒕퉬??) || job.contains('?명뀛')) {
          addResult('3991', '愿愿??듭뿭 ?덈궡??, 2800);
          addResult('3910', '?명뀛 ?묒닔 ?щТ??, 2900, bonus: 10);
      } else if (job.contains('援먯쑁')) {
          addResult('2591', '?멸뎅??媛뺤궗', 3000);
      } else if (job.contains('?섎즺')) {
          addResult('S392', '?섎즺 肄붾뵒?ㅼ씠??, 3100);
      } else {
         // Default fallback
         addResult('3922', '?ы뻾 ?곹뭹 媛쒕컻??, 3000);
      }
    }
    
    // Fallback if no jobs generated
    if (results.isEmpty) {
       addResult('3991', '愿愿??듭뿭 ?덈궡??, 2800);
    }

    // -------------------------------------------------------------
    // 3. Total Score & Tier Calculation
    // -------------------------------------------------------------
    int totalScore = 50; // Base Score

    // Lang (+10 ~ +30)
    if (answer.koreanLevel.contains('湲곗큹')) {
      totalScore += 10;
    } else if (answer.koreanLevel.contains('?쇱긽')) totalScore += 20;
    else if (answer.koreanLevel.contains('鍮꾩쫰?덉뒪') || answer.koreanLevel.contains('?먯뼱誘?)) totalScore += 30;

    // Edu (+10 ~ +20)
    // Simple heuristic: if any degree doc exists, give +20 for now as we don't distinguish degree types yet
    if (hasDegree) totalScore += 20;

    // Experience (+5 per item, max 10)
    int expBonus = (answer.experiences.length * 5).clamp(0, 10);
    totalScore += expBonus;

    totalScore = totalScore.clamp(0, 100);

    // Tier
    String totalTier = "Silver";
    String tierDescription = "媛?μ꽦???⑥븮! ?댁젣遺???섎굹??以鍮꾪빐蹂댁븘??";
    
    if (totalScore >= 90) {
      totalTier = "Diamond";
      tierDescription = "以鍮꾨맂 ?몄옱! ?대? 異⑸텇??寃쎌웳?μ쓣 媛뽰텛?④뎔??";
    } else if (totalScore >= 80) {
      totalTier = "Platinum";
      tierDescription = "?곗닔 ?몄옱! 議곌툑留????ㅻ벉?쇰㈃ ?꾨꼍?⑸땲??";
    } else if (totalScore >= 70) {
      totalTier = "Gold";
      tierDescription = "?깆옣?섎뒗 ?몄옱! 湲곕낯 ??웾????媛뽰텛怨?怨꾩떆?ㅼ슂.";
    } 

    return DiagnosisResult(
      analysisResults: results,
      solutionDocs: solutions,
      totalScore: totalScore,
      totalTier: totalTier,
      tierDescription: tierDescription,
    );
  }
}

final diagnosisProvider = StateNotifierProvider<DiagnosisNotifier, DiagnosisState>((ref) {
  return DiagnosisNotifier(ref);
});

=== lib\providers\document_provider.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:cuty_app/providers/point_provider.dart';
import '../models/document_model.dart';

class DocumentNotifier extends StateNotifier<List<Document>> {
  final Ref ref;
  DocumentNotifier(this.ref) : super([]);

  void addDocumentWithReward(Document doc) {
    state = [...state, doc];
    ref.read(pointProvider.notifier).earnPoints(300, "${doc.name} ?몄쬆 蹂댁긽");
  }

  // ?쒓컙??痍⑥뾽 ?꾩닔 ?쒕쪟 泥댄겕 濡쒖쭅
  // Checks if we have documents of specific types or names
  List<String> hasRequiredDocsForPartTime() {
    final requiredDocs = ['?멸뎅?몃벑濡앹쬆', '?ш텒', '?깆쟻利앸챸??, '?좏뵿利앸챸??, '嫄곗＜吏 利앸튃'];
    List<String> missingDocs = [];

    for (var req in requiredDocs) {
      // Check if any document name contains the required string
      bool hasDoc = state.any((doc) => doc.name.contains(req) || doc.type.contains(req));
      if (!hasDoc) missingDocs.add(req);
    }
    return missingDocs;
  }
}

final documentProvider = StateNotifierProvider<DocumentNotifier, List<Document>>((ref) {
  return DocumentNotifier(ref);
});

=== lib\providers\f27_visa_provider.dart ===
import 'package:flutter/material.dart';

class VisaScoreProvider extends ChangeNotifier {
  // --- State Variables ---
  String? selectedAge;
  String? educationLevel; // 諛뺤궗, ?앹궗, ?숈궗, ?꾨Ц?숈궗
  bool isStemOrDoubleMajor = false; // ?닿났怨?or 蹂듭닔?꾧났
  String? koreanLevel;
  String? incomeBracket;

  // --- Bonus Items ---
  String? uniBonusType; // 'top_global', 'domestic', or null
  bool kiipCompleted = false; // ?ы쉶?듯빀 5?④퀎 ?댁닔
  bool highTechIndustry = false; // 泥⑤떒遺꾩빞 醫낆궗
  bool govRecommendation = false; // 以묒븰?됱젙湲곌???異붿쿇
  bool warVeteran = false; // 李몄쟾援??곗닔?몄옱
  String? volunteerBonus; // 遊됱궗?쒕룞 (3??2??1??
  
  // Regional Score (Input)
  int regionalScore = 0; 
  
  // --- Penalty Items ---
  bool immigrationViolation = false;
  bool criminalPunishment = false;

  // --- UI State ---
  bool isSpecWalletLinked = false;

  // --- Actions ---

  void updateAge(String? value) {
    selectedAge = value;
    notifyListeners();
  }

  void updateEducation(String? level) {
    educationLevel = level;
    notifyListeners();
  }

  void updateStemStatus(bool value) {
    isStemOrDoubleMajor = value;
    notifyListeners();
  }

  void updateKoreanLevel(String? level) {
    koreanLevel = level;
    notifyListeners();
  }

  void updateIncome(String? bracket) {
    incomeBracket = bracket;
    notifyListeners();
  }

  void updateUniBonus(String? type) {
    uniBonusType = type;
    notifyListeners();
  }

  void updateKiipBonus(bool value) {
    kiipCompleted = value;
    notifyListeners();
  }

  void updateHighTechBonus(bool value) {
    highTechIndustry = value;
    notifyListeners();
  }

  void updateGovBonus(bool value) {
    govRecommendation = value;
    notifyListeners();
  }

  void updateVeteranBonus(bool value) {
    warVeteran = value;
    notifyListeners();
  }

  void updateVolunteerBonus(String? val) {
    volunteerBonus = val;
    notifyListeners();
  }

  void updateRegionalScore(int score) {
    regionalScore = score;
    notifyListeners();
  }

  void updateImmigrationPenalty(bool value) {
    immigrationViolation = value;
    notifyListeners();
  }

  void updateCriminalPenalty(bool value) {
    criminalPunishment = value;
    notifyListeners();
  }

  void toggleSpecWallet(bool value) {
    isSpecWalletLinked = value;
    if (value) {
      loadMockData(); // Auto-fill
    } else {
      reset(); // Or keep data? Request implies explicit reset usually or just unlink. Sticking to reset for clean toggle behavior as per previous code.
    }
    notifyListeners();
  }

  void reset() {
    selectedAge = null;
    educationLevel = null;
    isStemOrDoubleMajor = false;
    koreanLevel = null;
    incomeBracket = null;
    uniBonusType = null;
    kiipCompleted = false;
    highTechIndustry = false;
    govRecommendation = false;
    warVeteran = false;
    volunteerBonus = null;
    regionalScore = 0;
    immigrationViolation = false;
    criminalPunishment = false;
    isSpecWalletLinked = false;
    notifyListeners();
  }

  void loadMockData() {
    // "Golden Path" Scenario
    selectedAge = '25~29??; // 25
    educationLevel = '?앹궗'; // 17 (Normal) / 20 (STEM)
    isStemOrDoubleMajor = true; // -> 20
    koreanLevel = 'TOPIK 5~6湲?/ KIIP 5?④퀎'; // 20
    incomeBracket = '3泥쒕쭔 ~ 4泥쒕쭔 誘몃쭔'; // 30
    // Bonus
    uniBonusType = 'domestic'; // +7 (Master)
    // Calc: 25 + 20 + 20 + 30 + 7 = 102 (Wow)
    notifyListeners();
  }

  // --- Calculation Logic ---
  int calculateTotalScore() {
    int total = 0;

    // A. Age
    if (selectedAge == '25~29??) {
      total += 25;
    } else if (selectedAge == '18~24?? || selectedAge == '30~34??) {
      total += 23;
    } else if (selectedAge == '35~39??) {
      total += 20;
    } else if (selectedAge == '40~44??) {
      total += 12;
    } else if (selectedAge == '45~50??) {
      total += 8;
    } else if (selectedAge == '51???댁긽') {
      total += 3;
    }

    // B. Education
    // Levels: 諛뺤궗, ?앹궗, ?숈궗, ?꾨Ц?숈궗
    if (educationLevel == '諛뺤궗') {
      total += (isStemOrDoubleMajor ? 25 : 20);
    } else if (educationLevel == '?앹궗') {
      total += (isStemOrDoubleMajor ? 20 : 17);
    } else if (educationLevel == '?숈궗') {
      total += (isStemOrDoubleMajor ? 17 : 15);
    } else if (educationLevel == '?꾨Ц?숈궗') {
      total += (isStemOrDoubleMajor ? 15 : 10);
    }

    // C. Korean
    if (koreanLevel == 'TOPIK 5~6湲?/ KIIP 5?④퀎') {
      total += 20;
    } else if (koreanLevel == 'TOPIK 4湲?/ KIIP 4?④퀎') {
      total += 15;
    } else if (koreanLevel == 'TOPIK 3湲?/ KIIP 3?④퀎') {
      total += 10;
    } else if (koreanLevel == 'TOPIK 2湲?/ KIIP 2?④퀎') {
      total += 5;
    } else if (koreanLevel == 'TOPIK 1湲?/ KIIP 1?④퀎') {
      total += 3;
    }

    // D. Income
    if (incomeBracket == '1?????댁긽') {
      total += 60;
    } else if (incomeBracket == '9泥쒕쭔 ~ 1??誘몃쭔') {
      total += 58;
    } else if (incomeBracket == '8泥쒕쭔 ~ 9泥쒕쭔 誘몃쭔') {
      total += 56;
    } else if (incomeBracket == '7泥쒕쭔 ~ 8泥쒕쭔 誘몃쭔') {
      total += 53;
    } else if (incomeBracket == '6泥쒕쭔 ~ 7泥쒕쭔 誘몃쭔') {
      total += 50;
    } else if (incomeBracket == '5泥쒕쭔 ~ 6泥쒕쭔 誘몃쭔') {
      total += 45;
    } else if (incomeBracket == '4泥쒕쭔 ~ 5泥쒕쭔 誘몃쭔') {
      total += 40;
    } else if (incomeBracket == '3泥쒕쭔 ~ 4泥쒕쭔 誘몃쭔') {
      total += 30;
    } else if (incomeBracket == '理쒖??꾧툑 ~ 3泥쒕쭔 誘몃쭔') {
      total += 10;
    }
    // '?놁쓬 / 誘몄랬?? -> 0 (Default)

    // E. Bonus (Max 40)
    int bonus = 0;
    
    // E-1. University
    if (uniBonusType == 'top_global') {
      if (educationLevel == '諛뺤궗') {
        bonus += 30;
      } else if (educationLevel == '?앹궗') {
        bonus += 20;
      } else if (educationLevel == '?숈궗') {
        bonus += 15;
      }
    } else if (uniBonusType == 'domestic') {
       if (educationLevel == '諛뺤궗') {
         bonus += 10;
       } else if (educationLevel == '?앹궗') {
         bonus += 7;
       } else if (educationLevel == '?숈궗') {
         bonus += 5;
       }
    }

    // E-2. Policy
    if (kiipCompleted) bonus += 10;
    if (highTechIndustry) bonus += 20;
    if (govRecommendation) bonus += 20;
    if (warVeteran) bonus += 20;

    // E-3. Volunteer
    if (volunteerBonus == '3???댁긽') {
      bonus += 7;
    } else if (volunteerBonus == '2???댁긽') {
      bonus += 5;
    } else if (volunteerBonus == '1???댁긽') {
      bonus += 1;
    }

    // E-4. Regional
    bonus += regionalScore;

    // Cap
    if (bonus > 40) bonus = 40;
    total += bonus;

    // F. Deductions
    if (immigrationViolation) total -= 30;
    if (criminalPunishment) total -= 40;

    return total;
  }
}

=== lib\providers\fortune_provider.dart ===
import 'dart:math';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:shared_preferences/shared_preferences.dart';

final fortuneProvider = StateNotifierProvider<FortuneNotifier, bool>((ref) {
  return FortuneNotifier();
});

class FortuneResult {
  final String message;
  final int points;

  FortuneResult(this.message, this.points);
}

class FortuneNotifier extends StateNotifier<bool> {
  FortuneNotifier() : super(true) { // Default to true (locked) until loaded
    checkAvailability();
  }

  static const String _lastOpenedKey = 'last_fortune_date';

  final List<String> _fortunes = [
    "?삳컰???됱슫??李얠븘?듬땲?? ??",
    "?ㅻ뒛? 洹?몄쓣 留뚮궇 ?좎씠?먯슂. ?삃",
    "?몃젰??留뚰겮 醫뗭? 寃곗떎??留븐쓣 嫄곗삁?? ?뮞",
    "湲곕떎由щ뜕 ?뚯떇??怨??꾩갑?⑸땲?? ?벃",
    "?먯떊媛먯쓣 媛吏?몄슂! ?뱀떊? 理쒓퀬?낅땲?? ?몟",
    "?묒? ?됰났?ㅼ씠 紐⑥뿬 ??湲곗겏???⑸땲?? ??,
    "?ㅻ뒛? 臾댁뾿???대룄 ???섎뒗 ?? ?럦",
    "?좎떆 ?댁떇??痍⑦븯硫???硫由?媛????덉뼱?? ??,
    "?됱슫???됱긽? '蹂대씪?? ?낅땲?? ?뮏",
    "?뱀떊??誘몄냼媛 ?꾧뎔媛?먭쾶 ?섏씠 ?⑸땲?? ?쁽",
    "?덈줈??湲고쉶媛 臾몄쓣 ?먮뱶由ш퀬 ?덉뼱?? ?슞",
    "嫄깆젙?섏? 留덉꽭?? 紐⑤뱺 寃껋씠 ????嫄곗삁?? ?뙂",
  ];

  Future<void> checkAvailability() async {
    final prefs = await SharedPreferences.getInstance();
    final lastDate = prefs.getString(_lastOpenedKey);
    final today = _getTodayString();

    if (lastDate != today) {
      state = false; // Not opened yet today
    } else {
      state = true; // Already opened
    }
  }

  Future<FortuneResult> openCookie() async {
    final prefs = await SharedPreferences.getInstance();
    final today = _getTodayString();

    await prefs.setString(_lastOpenedKey, today);
    state = true; // Mark as opened

    final random = Random();
    final message = _fortunes[random.nextInt(_fortunes.length)];
    final points = 10 + random.nextInt(41); // 10 ~ 50 Random Points

    return FortuneResult(message, points);
  }

  String _getTodayString() {
    final now = DateTime.now();
    return "${now.year}-${now.month}-${now.day}";
  }

  // Method to reset for testing
  Future<void> reset() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove(_lastOpenedKey);
    state = false;
  }

  // Getter for UI readability
  bool get hasOpenedToday => state;
}

=== lib\providers\home_view_provider.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';

final homeViewProvider = StateProvider<String>((ref) => 'dashboard'); // 'dashboard' or 'job'

=== lib\providers\nav_provider.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';

final bottomNavIndexProvider = StateProvider<int>((ref) => 1); // Default to Home (index 1)

=== lib\providers\point_provider.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';

// 1. PointHistory Model (Robust & Null-Safe)
class PointHistory {
  final String title;
  final DateTime date;
  final int amount;
  final String type; // 'earn' | 'use'

  PointHistory({
    required this.title,
    required this.date,
    required this.amount,
    required this.type,
  });
}

class PointState {
  final int totalBalance;
  final List<PointHistory> history; // Changed from List<Map>
  final bool isAttendedToday;

  PointState({
    required this.totalBalance,
    required this.history,
    this.isAttendedToday = false,
  });

  PointState copyWith({
    int? totalBalance,
    List<PointHistory>? history,
    bool? isAttendedToday,
  }) {
    return PointState(
      totalBalance: totalBalance ?? this.totalBalance,
      history: history ?? this.history,
      isAttendedToday: isAttendedToday ?? this.isAttendedToday,
    );
  }
}

class PointNotifier extends StateNotifier<PointState> {
  PointNotifier()
      : super(PointState(
          totalBalance: 10000, // Initial dummy balance
          history: [
            PointHistory(
              title: "?쒗넗由ъ뼹 ?꾨즺 ?럞",
              date: DateTime.now().subtract(const Duration(hours: 1)),
              amount: 300,
              type: 'earn',
            ),
            PointHistory(
              title: "?좉퇋 媛??異뺥븯湲??럦",
              date: DateTime.now().subtract(const Duration(days: 1)),
              amount: 9650,
              type: 'earn',
            ),
            PointHistory(
              title: "泥?濡쒓렇??蹂댁긽",
              date: DateTime.now().subtract(const Duration(days: 1, hours: 2)),
              amount: 50,
              type: 'earn',
            ),
          ],
        ));

  // Earn Points (External)
  void earnPoints(int amount, String title) {
    final newHistory = List<PointHistory>.from(state.history)
      ..insert(0, PointHistory(
        title: title,
        date: DateTime.now(),
        amount: amount,
        type: 'earn',
      ));

    state = state.copyWith(
      totalBalance: state.totalBalance + amount,
      history: newHistory,
    );
  }

  // Use Points
  bool usePoints(int amount, String title) {
    if (state.totalBalance < amount) return false;

    final newHistory = List<PointHistory>.from(state.history)
      ..insert(0, PointHistory(
        title: title,
        date: DateTime.now(),
        amount: -amount,
        type: 'use',
      ));

    state = state.copyWith(
      totalBalance: state.totalBalance - amount,
      history: newHistory,
    );
    
    return true;
  }
}

final pointProvider = StateNotifierProvider<PointNotifier, PointState>((ref) {
  return PointNotifier();
});

=== lib\providers\schedule_provider.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../models/schedule_model.dart';

// [1] ?명떚?뚯씠?? ?쒓컙??濡쒖쭅 愿由?
class ScheduleNotifier extends StateNotifier<List<Schedule>> {
  ScheduleNotifier() : super([]) {
    // 珥덇린 ?붾? ?곗씠???ㅼ젙 (?뚯뒪?몄슜)
    state = [
      Schedule(id: 1, title: "寃쎌젣濡?, classroom: "寃쎌쟻 304", day: "Mon", startTime: 10, duration: 1), 
      Schedule(id: 2, title: "留덉??낆썝濡?, classroom: "寃쎌쁺愿 B103", day: "Tue", startTime: 14, duration: 1),
      Schedule(id: 3, title: "?곗씠?곕텇??, classroom: "怨듯븰愿 201", day: "Wed", startTime: 11, duration: 1),
    ];
    
    // (?뚯뒪?몄슜) ?ㅻ뒛???됱씪?대씪硫? ?ㅻ뒛 ?좎쭨???섏뾽???섎굹 媛뺤젣濡?異붽??대몺
    final todayWeekday = DateTime.now().weekday;
    final dayMap = {1: "Mon", 2: "Tue", 3: "Wed", 4: "Thu", 5: "Fri", 6: "Sat", 7: "Sun"};
    
    if (todayWeekday <= 5) {
       state = [
         ...state,
         Schedule(
           id: 999, 
           title: "?ㅻ뒛?섏닔??, 
           classroom: "?뚯뒪?몃８", 
           day: dayMap[todayWeekday] ?? "Mon", 
           startTime: DateTime.now().hour + 1, 
           duration: 1
         ),
       ];
    }
  }

  // --- [湲곕뒫 1] ???붾㈃?? ?ㅼ쓬 ?섏뾽 李얘린 ---
  Schedule? getNextClass() { // Changed return type to nullable Schedule
    final now = DateTime.now();
    final currentWeekday = now.weekday; // 1(Mon)..7(Sun)
    final dayMap = {1: "Mon", 2: "Tue", 3: "Wed", 4: "Thu", 5: "Fri", 6: "Sat", 7: "Sun"};
    final currentDayStr = dayMap[currentWeekday];
    final currentHour = now.hour;

    // 1. ?ㅻ뒛 ?붿씪???섏뾽留??꾪꽣留?
    final todayClasses = state.where((item) => item.day == currentDayStr).toList();

    // 2. ?쒓컙???뺣젹
    todayClasses.sort((a, b) => a.startTime.compareTo(b.startTime));

    // 3. ?꾩옱 ?쒓컙 ?댄썑???섏뾽 以?媛??鍮좊Ⅸ 寃?李얘린
    for (var item in todayClasses) {
      if (item.startTime > currentHour) {
        return item;
      }
    }
    
    return null; // ?섏뾽 ?놁쓬
  }

  // --- [湲곕뒫 2] 留덉씠?섏씠吏 二쇨컙 ?쒓컙?쒖슜 ---
  List<Schedule> getClassesForDay(int dayInt) { // dayInt: 1=Mon, etc.
    final dayMap = {1: "Mon", 2: "Tue", 3: "Wed", 4: "Thu", 5: "Fri", 6: "Sat", 7: "Sun"};
    final dayStr = dayMap[dayInt];
    return state.where((item) => item.day == dayStr).toList();
  }

  // --- [湲곕뒫 2] ?쒓컙??愿由ъ슜: 異붽?/??젣 ---
  bool addClass(Schedule item) {
    // 1. 以묐났 泥댄겕
    final isDuplicate = state.any((existing) => 
      existing.day == item.day && 
      existing.startTime == item.startTime 
    );

    if (isDuplicate) {
      return false; // 異붽? ?ㅽ뙣
    }

    state = [...state, item];
    return true;
  }

  void removeClass(String title) {
    state = state.where((item) => item.title != title).toList();
  }
}

// [3] ?꾨줈諛붿씠???뺤쓽
final scheduleProvider = StateNotifierProvider<ScheduleNotifier, List<Schedule>>((ref) {
  return ScheduleNotifier();
});

=== lib\providers\shop_provider.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../models/shop_model.dart';
// Note: PointNotifier import would be ideal but avoiding circular deps if point_provider imports shop_provider.
// Assuming dynamic dispatch for now as requested or purely interface based. 
// Ideally we should import point_provider.dart if point_provider doesn't import shop_provider.
// Checking file usage... MyPage imports both.
// I will keep it dynamic for flexibility or import if I knew point_provider path exactly (I do).
import 'point_provider.dart';

class ShopState {
  final List<Shop> products;
  final List<Shop> inventory;
  final bool isLoading;

  ShopState({
    required this.products,
    required this.inventory,
    this.isLoading = false,
  });
  
  ShopState copyWith({
    List<Shop>? products,
    List<Shop>? inventory,
    bool? isLoading,
  }) {
    return ShopState(
      products: products ?? this.products,
      inventory: inventory ?? this.inventory,
      isLoading: isLoading ?? this.isLoading,
    );
  }
}

class ShopNotifier extends StateNotifier<ShopState> {
  ShopNotifier() : super(ShopState(products: [], inventory: [])) {
    _loadMockData();
  }

  void _loadMockData() {
    state = state.copyWith(
      products: [
        Shop(
          id: 1,
          name: '?꾨찓由ъ뭅??,
          imageUrl: 'assets/images/capy_meal.png', 
          price: 2000,
          category: 'cafe',
          description: '?쒖썝???꾩씠???꾨찓由ъ뭅?몄엯?덈떎.',
        ),
        Shop(
          id: 2,
          name: '?몄쓽???곹뭹沅?,
          imageUrl: 'assets/images/capy_visa.png',
          price: 5000,
          category: 'voucher',
          description: '?몄쓽?먯뿉???ъ슜 媛?ν븳 5000???곹뭹沅뚯엯?덈떎.',
        ),
        Shop(
          id: 3,
          name: '移댄럹?쇰뼹',
          imageUrl: 'assets/images/item_fortune_cookie.png',
          price: 3500,
          category: 'cafe',
          description: '遺?쒕윭???곗쑀媛 ?ㅼ뼱媛?移댄럹?쇰뼹?낅땲??',
        ),
      ],
      isLoading: false,
    );
  }

  // 2. Buy Item Logic
  // Using PointNotifier
  bool buyItem(Shop product, PointNotifier pointNotifier) {
    if (pointNotifier.usePoints(product.price, "${product.name} 援щℓ")) {
      state = state.copyWith(
        inventory: [...state.inventory, product],
      );
      return true;
    }
    return false;
  }
}

final shopProvider = StateNotifierProvider<ShopNotifier, ShopState>((ref) {
  return ShopNotifier();
});

=== lib\providers\survey_provider.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';

class SurveyState {
  final String? job;
  final int? koreanLevel;
  
  SurveyState({this.job, this.koreanLevel});

  bool get isSurveyCompleted => job != null && koreanLevel != null;

  SurveyState copyWith({String? job, int? koreanLevel}) {
    return SurveyState(
      job: job ?? this.job,
      koreanLevel: koreanLevel ?? this.koreanLevel,
    );
  }
}

class SurveyNotifier extends StateNotifier<SurveyState> {
  SurveyNotifier() : super(SurveyState());

  void setJob(String job) {
    state = state.copyWith(job: job);
  }
  
  void setKoreanLevel(int level) {
    state = state.copyWith(koreanLevel: level);
  }

  void reset() {
    state = SurveyState();
  }
}

final surveyProvider = StateNotifierProvider<SurveyNotifier, SurveyState>((ref) {
  return SurveyNotifier();
});

=== lib\providers\user_provider.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../models/user.dart';
import '../services/api_service.dart';

class UserNotifier extends StateNotifier<User?> {
  UserNotifier() : super(null); // Init with null (logged out)
  
  // Login: Use ApiService
  Future<bool> login(String email, String password) async {
    print("Attempting login for $email...");
    final success = await ApiService.instance.login(email, password);
    
    if (success) {
      print("Login successful. Fetching user info...");
      final user = await ApiService.instance.fetchMyInfo();
      if (user != null) {
        state = user;
        print("User info loaded: ${user.name}");
        return true;
      } else {
        print("Failed to fetch user info after login.");
      }
    } else {
      print("Login failed.");
    }
    return false;
  }

  // Logout: Clear state
  void logout() {
    state = null;
    // ApiService.instance.logout(); // Implement storage clear if needed
  }
}

final userProvider = StateNotifierProvider<UserNotifier, User?>((ref) {
  return UserNotifier();
});

=== lib\screens\main_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../providers/nav_provider.dart';
import 'home/home_screen.dart';
import 'mypage/my_page_screen.dart';
import 'home/widgets/home_bottom_nav_bar.dart';
import 'shop/shop_screen.dart';

class MainScreen extends ConsumerWidget {
  const MainScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final currentIndex = ref.watch(bottomNavIndexProvider);

    return Scaffold(
      body: IndexedStack(
        index: currentIndex,
        children: const [
          ShopScreen(),       // Shop Tab
          HomeScreen(),       // Home Tab
          MyPageScreen(),     // My Page
        ],
      ),
      bottomNavigationBar: const HomeBottomNavBar(),
    );

  }
}

=== lib\screens\academic\academic_main_screen.dart ===
import 'package:flutter/material.dart';

class AcademicMainScreen extends StatelessWidget {
  const AcademicMainScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('?숈궗?뺣낫'),
      ),
      backgroundColor: Colors.white,
      body: const Center(
        child: Text('?곗씠???곕룞 ?湲?以?),
      ),
    );
  }
}

=== lib\screens\alba\part_time_apply_consent_screen.dart ===
import 'package:flutter/material.dart';

class PartTimeApplyConsentScreen extends StatelessWidget {
  const PartTimeApplyConsentScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("?쎄? ?숈쓽")),
      body: const Center(
        child: Text("?쎄? ?숈쓽 ?붾㈃?낅땲??"),
      ),
    );
  }
}

=== lib\screens\alba\part_time_apply_form_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:cuty_app/providers/user_provider.dart';

class PartTimeApplyFormScreen extends ConsumerWidget {
  const PartTimeApplyFormScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final user = ref.watch(userProvider);
    
    if (user == null) {
      return const Scaffold(body: Center(child: CircularProgressIndicator()));
    }

    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text("?쒓컙??痍⑥뾽 ?좎껌??, style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        elevation: 0,
        centerTitle: true,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios, color: Colors.black),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(24),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              "留덉?留??④퀎?낅땲??\n?ъ뾽二??뺣낫瑜??뺤씤?댁＜?몄슂.",
              style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, height: 1.4),
            ),
            const SizedBox(height: 32),

            // 1. ?좎? ?뺣낫 (?먮룞 ?낅젰??
            const Text("?좎껌???뺣낫", style: TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Colors.grey)),
            const SizedBox(height: 8),
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.grey[50],
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: Colors.grey[200]!),
              ),
              child: Column(
                children: [
                  _buildInfoRow("?대쫫", user.name),
                  const SizedBox(height: 8),
                  _buildInfoRow("?뚯냽", user.university),
                  const SizedBox(height: 8),
                  _buildInfoRow("鍮꾩옄", user.visaType),
                ],
              ),
            ),

            const SizedBox(height: 32),

            // 2. ?ъ뾽二?洹쇰줈怨꾩빟 ?뺣낫 (Mock)
            const Text("洹쇰줈吏 ?뺣낫", style: TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Colors.grey)),
            const SizedBox(height: 12),
            _buildTextField("?곹샇紐?(?ъ뾽???깅줉利???", "荑좏떚 ?몄쓽????궪??),
            const SizedBox(height: 16),
            _buildTextField("?ъ뾽???깅줉踰덊샇", "123-45-67890"),
            const SizedBox(height: 16),
            _buildTextField("?대떦???곕씫泥?, "010-1234-5678"),
            
            const SizedBox(height: 48),

            SizedBox(
              width: double.infinity,
              height: 56,
              child: ElevatedButton(
                onPressed: () {
                   showDialog(
                     context: context,
                     builder: (context) => AlertDialog(
                       title: const Text("?좎껌 ?꾨즺"),
                       content: const Text("?쒓컙??痍⑥뾽 ?덇? ?좎껌???꾨즺?섏뿀?듬땲??\n?ъ궗 寃곌낵????3???댁뿉 ?듬낫?⑸땲??"),
                       actions: [
                         TextButton(
                           onPressed: () {
                              Navigator.pop(context); // Close dialog
                              Navigator.pop(context); // Close Form
                              Navigator.pop(context); // Close Check
                              Navigator.pop(context); // Close Consent (Back to Home)
                           },
                           child: const Text("?뺤씤"),
                         )
                       ],
                     )
                   );
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF1E3A8A), // Blue-900
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                  elevation: 0,
                ),
                child: const Text(
                  "理쒖쥌 ?좎껌?섍린",
                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Text(label, style: const TextStyle(color: Colors.grey)),
        Text(value, style: const TextStyle(fontWeight: FontWeight.bold)),
      ],
    );
  }

  Widget _buildTextField(String label, String placeholder) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(label, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
        const SizedBox(height: 8),
        TextField(
          decoration: InputDecoration(
            hintText: placeholder,
            filled: true,
            fillColor: Colors.white,
            contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: BorderSide(color: Colors.grey[300]!),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(12),
              borderSide: BorderSide(color: Colors.grey[300]!),
            ),
          ),
        )
      ],
    );
  }
}

=== lib\screens\alba\permit_application_wizard.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:google_fonts/google_fonts.dart';
// import 'package:url_launcher/url_launcher.dart'; // simulation for now
import '../../providers/alba_permit_provider.dart';
import '../../providers/document_provider.dart';
import '../spec/spec_wallet_screen.dart';

// Main Widget
class PermitApplicationWizard extends ConsumerWidget {
  const PermitApplicationWizard({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final state = ref.watch(albaPermitProvider);
    final notifier = ref.read(albaPermitProvider.notifier);

    // Render based on current step
    switch (state.currentStep) {
      case 0: return _Step0Selection(notifier);
      case 1: return _Step1VisaLink(notifier, state);
      case 2: return _StepCheckDocs(notifier); // [NEW] Document Check
      case 3: return _Step2Guide(notifier, state);
      case 4: return _Step3Camera(notifier, state);
      case 5: return _Step4InfoConfirm(notifier, state);
      case 6: return _Step5Signature(notifier, state);
      case 7: return _Step6SubmitComplete(notifier);
      case 8: return _Step7SchoolApproval(notifier);
      case 9: return _Step8FinalFolder(notifier, state);
      case 10: return _Step9HiKoreaGuide(notifier);
      case 11: return _Step10FinalPermit();
      default: return const Scaffold(body: Center(child: Text("Unknown Step")));
    }
  }
}

// -----------------------------------------------------------------------------
// STEP 0: Selection
// -----------------------------------------------------------------------------
class _Step0Selection extends StatelessWidget {
  final AlbaPermitNotifier notifier;
  const _Step0Selection(this.notifier);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          Container(
            width: double.infinity,
            padding: EdgeInsets.fromLTRB(24, MediaQuery.of(context).padding.top + 12, 24, 64),
            decoration: const BoxDecoration(
              gradient: LinearGradient(begin: Alignment.topLeft, end: Alignment.bottomRight, colors: [Color(0xFF86EFAC), Color(0xFF93C5FD), Color(0xFFDBEAFE)]),
            ),
            child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
                Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [
                    IconButton(icon: const Icon(Icons.arrow_back, color: Color(0xFF0F172A)), onPressed: () => Navigator.pop(context), style: IconButton.styleFrom(backgroundColor: Colors.white.withOpacity(0.2), shape: const CircleBorder())),
                    Text('CUTY', style: GoogleFonts.inter(fontWeight: FontWeight.w900, fontSize: 14, color: const Color(0xFF0F172A))),
                ]),
                const SizedBox(height: 24),
                Text('?쒓컙??痍⑥뾽 ?덇?\n以鍮꾪븯湲?, style: GoogleFonts.notoSansKr(fontSize: 22, fontWeight: FontWeight.w900, height: 1.2, color: const Color(0xFF0F172A))),
                const SizedBox(height: 8),
                Text('?대뼡 諛⑹떇?쇰줈 ?뚮컮瑜?援ы븯?⑤굹??\n荑좏떚媛 ?쒕쪟 以鍮꾨? ?꾩??쒕┫寃뚯슂!', style: GoogleFonts.notoSansKr(fontSize: 12, fontWeight: FontWeight.w700, height: 1.5, color: const Color(0xFF1E293B))),
            ]),
          ),
          Expanded(child: Transform.translate(offset: const Offset(0, -24), child: Container(padding: const EdgeInsets.fromLTRB(20, 32, 20, 20), decoration: const BoxDecoration(color: Colors.white, borderRadius: BorderRadius.only(topLeft: Radius.circular(28), topRight: Radius.circular(28))), child: Column(children: [
             _SelectionCard(title: '荑좏떚?먯꽌 ?뚮컮 李얘린', subtitle: '?꾩쭅 ?뚮컮瑜?援ы븯吏 紐삵뻽?ㅻ㈃\n荑좏떚?먯꽌 援ы빐遊먯슂!', badgeText: 'CUTY', icon: Icons.shopping_bag_outlined, bgColor: const Color(0xFFBFDBFE), textColor: const Color(0xFF1E3A8A), onTap: () => Navigator.pop(context)),
             const SizedBox(height: 12),
             _SelectionCard(title: '?닿? 吏곸젒 李얠? ?뚮컮', subtitle: '?쒖?洹쇰줈怨꾩빟?????쒕쪟瑜?n吏곸젒 ?щ젮二쇱꽭??', badgeText: 'Upload', icon: Icons.upload_file, bgColor: const Color(0xFF1E3A8A), textColor: Colors.white, isDark: true, onTap: () => notifier.setStep(1)),
          ])))),
        ],
      ),
    );
  }
}
class _SelectionCard extends StatelessWidget {
  final String title, subtitle, badgeText;
  final IconData icon;
  final Color bgColor, textColor;
  final bool isDark;
  final VoidCallback onTap;
  const _SelectionCard({required this.title, required this.subtitle, required this.badgeText, required this.icon, required this.bgColor, required this.textColor, this.isDark = false, required this.onTap});
  @override
  Widget build(BuildContext context) {
    return GestureDetector(onTap: onTap, child: Container(height: 112, padding: const EdgeInsets.symmetric(horizontal: 20), decoration: BoxDecoration(color: bgColor, borderRadius: BorderRadius.circular(20), boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10, offset: const Offset(0, 4))]), child: Row(children: [Container(width: 48, height: 48, decoration: BoxDecoration(color: isDark ? Colors.white.withOpacity(0.1) : Colors.white, borderRadius: BorderRadius.circular(12)), child: Icon(icon, color: isDark ? Colors.white : const Color(0xFF3B82F6), size: 24)), const SizedBox(width: 16), Expanded(child: Column(mainAxisAlignment: MainAxisAlignment.center, crossAxisAlignment: CrossAxisAlignment.start, children: [Container(padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2), decoration: BoxDecoration(color: isDark ? Colors.white.withOpacity(0.2) : const Color(0xFF3B82F6), borderRadius: BorderRadius.circular(10)), child: Text(badgeText, style: GoogleFonts.notoSansKr(fontSize: 9, fontWeight: FontWeight.w700, color: isDark ? const Color(0xFFDBEAFE) : Colors.white))), const SizedBox(height: 4), Text(title, style: GoogleFonts.notoSansKr(fontSize: 17, fontWeight: FontWeight.w800, color: textColor)), Text(subtitle, style: GoogleFonts.notoSansKr(fontSize: 11, fontWeight: FontWeight.w500, color: textColor.withOpacity(0.8), height: 1.2))]))])));
  }
}

// -----------------------------------------------------------------------------
// STEP 1: Visa Link
// -----------------------------------------------------------------------------
class _Step1VisaLink extends StatefulWidget {
  final AlbaPermitNotifier notifier;
  final AlbaPermitState state;
  const _Step1VisaLink(this.notifier, this.state);

  @override
  State<_Step1VisaLink> createState() => _Step1VisaLinkState();
}

class _Step1VisaLinkState extends State<_Step1VisaLink> {
  bool _isAgreed = false;
  bool _isLoading = false;

  void _handleLink() async {
    setState(() => _isLoading = true);
    await Future.delayed(const Duration(seconds: 2));
    if (mounted) {
      widget.notifier.linkVisa();
      widget.notifier.nextStep(); // Auto-advance
      // setState(() => _isLoading = false); // No need as we leave screen
    }
  }

  @override
  Widget build(BuildContext context) {
    // If already linked, we usually auto-skip in logic, or just show normal view but button acts as next
    // But since user wants to skip the "success" screen, we treat isLinked as "just initialized".
    bool isLinked = widget.state.isVisaLinked;

    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.black), 
          onPressed: () => widget.notifier.setStep(0)
        ), 
        backgroundColor: Colors.white, 
        elevation: 0
      ),
      body: Stack(children: [
          Container(
            height: MediaQuery.of(context).size.height * 0.6, 
            decoration: BoxDecoration(gradient: LinearGradient(begin: Alignment.topCenter, end: Alignment.bottomCenter, colors: [Colors.blue.shade50, Colors.white]))
          ),
          Padding(
            padding: const EdgeInsets.all(24), 
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start, 
              children: [
                Text.rich(
                  TextSpan(children: [
                    const TextSpan(text: '?덉쟾???쒕쪟 以鍮꾨? ?꾪빐\n'), 
                    TextSpan(text: '鍮꾩옄 ?뺣낫', style: GoogleFonts.notoSansKr(color: const Color(0xFF2563EB))), 
                    const TextSpan(text: '瑜?n?곕룞?댁＜?몄슂.')
                  ]), 
                  style: GoogleFonts.notoSansKr(fontSize: 26, fontWeight: FontWeight.w900, color: const Color(0xFF0F172A), height: 1.3)
                ),
                
                Expanded(
                  child: Center(
                    child: Stack(alignment: Alignment.center, children: [
                      Container(width: 250, height: 2, color: Colors.blue.shade100),
                      Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [
                          _circleIcon('CUTY', Colors.blue.shade600),
                          _circleIcon('Wallet', Colors.indigo.shade600, icon: Icons.wallet),
                      ]),
                    ])
                  )
                ),

                // Consent Checkbox
                GestureDetector(
                    onTap: () => setState(() => _isAgreed = !_isAgreed),
                    child: Container(
                      margin: const EdgeInsets.only(bottom: 20),
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.grey[50],
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: _isAgreed ? Colors.blue : Colors.grey[300]!)
                      ),
                      child: Row(children: [
                        Icon(_isAgreed ? Icons.check_circle : Icons.radio_button_unchecked, color: _isAgreed ? Colors.blue : Colors.grey),
                        const SizedBox(width: 10),
                        Expanded(child: Text("MY????λ맂 鍮꾩옄吏媛??곗씠?곕?\n?덉쟾?섍쾶 遺덈윭?ㅻ뒗 寃껋뿉 ?숈쓽?⑸땲??", style: GoogleFonts.notoSansKr(fontSize: 13, fontWeight: FontWeight.bold, color: Colors.grey[800]))),
                      ]),
                    ),
                  ),

                SizedBox(
                  width: double.infinity, 
                  height: 60, 
                  child: ElevatedButton(
                    onPressed: (_isAgreed && !_isLoading) ? _handleLink : null, 
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF1E293B), 
                      disabledBackgroundColor: const Color(0xFFCBD5E1),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20))
                    ), 
                    child: _isLoading 
                      ? Row(mainAxisAlignment: MainAxisAlignment.center, children: const [SizedBox(width: 20, height: 20, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white)), SizedBox(width: 12), Text("?곕룞 以?..", style: TextStyle(color: Colors.white, fontSize: 18))])
                      : const Text("鍮꾩옄吏媛??덉쟾?섍쾶 ?곕룞?섍린", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.white))
                  )
                ),
                
                Padding(
                    padding: const EdgeInsets.only(top: 16),
                    child: Row(mainAxisAlignment: MainAxisAlignment.center, children: [
                      const Icon(Icons.security, size: 14, color: Colors.grey),
                      const SizedBox(width: 4),
                      Text("CUTY??怨좉컼?섏쓽 媛쒖씤?뺣낫瑜??덉쟾?섍쾶 蹂댄샇?⑸땲??", style: GoogleFonts.notoSansKr(fontSize: 11, color: Colors.grey)),
                    ]),
                  )
              ]
            )
          )
      ]),
    );
  }

  Widget _circleIcon(String label, Color color, {IconData? icon}) {
    return Container(width: 80, height: 80, decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20), boxShadow: [BoxShadow(color: Colors.blue.shade100, blurRadius: 20)], border: Border.all(color: Colors.blue.shade50)), child: Center(child: icon == null ? Text(label, style: GoogleFonts.inter(fontWeight: FontWeight.w900, fontSize: 16, color: color)) : Icon(icon, color: color, size: 32)));
  }
}

// -----------------------------------------------------------------------------
// STEP 2: Guide
// -----------------------------------------------------------------------------
class _Step2Guide extends StatelessWidget {
  final AlbaPermitNotifier notifier;
  final AlbaPermitState state;
  const _Step2Guide(this.notifier, this.state);
  @override
  Widget build(BuildContext context) {
    bool isAllChecked = state.consentChecked && state.purposeChecked;
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(title: const Text('?ъ뾽???쒕쪟 珥ъ쁺 ?덈궡'), centerTitle: true, elevation: 0, backgroundColor: Colors.white, foregroundColor: Colors.black, leading: IconButton(icon: const Icon(Icons.arrow_back), onPressed: () => notifier.prevStep())),
      body: Column(children: [
         Expanded(child: SingleChildScrollView(padding: const EdgeInsets.all(24), child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
             Text.rich(TextSpan(children: [const TextSpan(text: '?쇳븯寃???怨녹쓽\n'), TextSpan(text: '?ъ뾽???쒕쪟', style: GoogleFonts.notoSansKr(color: const Color(0xFF2563EB))), const TextSpan(text: '瑜?以鍮꾪빐二쇱꽭??')]), style: GoogleFonts.notoSansKr(fontSize: 24, fontWeight: FontWeight.w900, color: const Color(0xFF0F172A), height: 1.3)),
             const SizedBox(height: 12),
             Text('?ъ옣?섍퍡 ?꾨옒 3媛吏 ?쒕쪟??珥ъ쁺 ?숈쓽瑜?援ы빐二쇱꽭??', style: GoogleFonts.notoSansKr(fontSize: 14, color: const Color(0xFF64748B))),
             const SizedBox(height: 32),
             Container(padding: const EdgeInsets.all(20), decoration: BoxDecoration(color: const Color(0xFFF8FAFC), borderRadius: BorderRadius.circular(16), border: Border.all(color: const Color(0xFFF1F5F9))), child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
                 Text('珥ъ쁺???쒕쪟 由ъ뒪??, style: GoogleFonts.notoSansKr(fontSize: 12, fontWeight: FontWeight.w700, color: const Color(0xFF64748B))), const SizedBox(height: 12),
                 _listItem(1, '?ъ뾽???깅줉利?), const SizedBox(height: 8), _listItem(2, '洹쇰줈怨꾩빟??), const SizedBox(height: 8), _listItem(3, '?ъ뾽二??좊텇利??щ낯')
             ])),
             const SizedBox(height: 32),
             _checkbox(state.consentChecked, '(?꾩닔) ?ъ옣?섍퍡 ???쒕쪟?ㅼ쓽 珥ъ쁺 ?숈쓽瑜?援ы뻽?듬땲??', () => notifier.toggleConsent()), const SizedBox(height: 16),
             _checkbox(state.purposeChecked, '(?꾩닔) ?섏쭛???뺣낫??痍⑥뾽 ?덇? ?좎껌 紐⑹쟻?쇰줈留??ъ슜?⑸땲??', () => notifier.togglePurpose())
         ]))),
         Padding(padding: EdgeInsets.fromLTRB(20, 10, 20, MediaQuery.of(context).padding.bottom + 20), child: SizedBox(width: double.infinity, height: 60, child: ElevatedButton(onPressed: isAllChecked ? () => notifier.nextStep() : null, style: ElevatedButton.styleFrom(foregroundColor: Colors.white, backgroundColor: const Color(0xFF1A2B49), disabledBackgroundColor: Colors.grey[300], shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20))), child: Row(mainAxisAlignment: MainAxisAlignment.center, children: [const Icon(Icons.camera_alt, size: 20), const SizedBox(width: 8), Text('?뺤씤?덉뒿?덈떎. 珥ъ쁺?섍린', style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.w700))]))))
      ]),
    );
  }
  Widget _listItem(int i, String t) => Row(children: [CircleAvatar(radius: 10, backgroundColor: Colors.black, child: Text('$i', style: const TextStyle(fontSize: 10, color: Colors.white))), const SizedBox(width: 12), Text(t, style: GoogleFonts.notoSansKr(fontWeight: FontWeight.bold, color: Colors.grey[800]))]);
  Widget _checkbox(bool c, String t, VoidCallback tap) => GestureDetector(onTap: tap, child: Row(children: [Container(width: 24, height: 24, decoration: BoxDecoration(color: c ? Colors.blue : Colors.white, borderRadius: BorderRadius.circular(6), border: Border.all(color: c ? Colors.blue : Colors.grey[300]!)), child: c ? const Icon(Icons.check, size: 16, color: Colors.white) : null), const SizedBox(width: 12), Expanded(child: Text(t, style: GoogleFonts.notoSansKr(fontSize: 14, fontWeight:  FontWeight.w500, color: c ? Colors.black : Colors.grey[500]!)))]));
}

// -----------------------------------------------------------------------------
// STEP 3: Camera
// -----------------------------------------------------------------------------
class _Step3Camera extends StatelessWidget {
  final AlbaPermitNotifier notifier;
  final AlbaPermitState state;
  const _Step3Camera(this.notifier, this.state);
  @override
  Widget build(BuildContext context) {
    final steps = [{'title': '癒쇱?, ?ъ뾽?먮벑濡앹쬆??n李띿뼱二쇱꽭??', 'desc': '?ъ뾽??踰덊샇媛 ??蹂댁씠寃?李띿뼱二쇱꽭??'}, {'title': '?ㅼ쓬? 洹쇰줈怨꾩빟?쒖엯?덈떎.', 'desc': '湲?먭? ??蹂댁씠寃?李띿뼱二쇱꽭??'}, {'title': '留덉?留됱쑝濡??ъ뾽二??좊텇利앹쓣\n李띿뼱二쇱꽭??', 'desc': '二쇰??깅줉踰덊샇 ?룹옄由щ뒗 媛?ㅻ룄 ?⑸땲??'}];
    final current = steps[state.cameraStep];
    return Scaffold(backgroundColor: Colors.black, body: Stack(children: [
        Positioned(
          top: 0, left: 0, right: 0, 
          child: SafeArea(
            bottom: false,
            child: Column(
              children: [
                Padding(
                  padding: const EdgeInsets.fromLTRB(20, 10, 20, 0),
                  child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [
                    IconButton(icon: const Icon(Icons.arrow_back, color: Colors.white), onPressed: () => notifier.prevStep()), 
                    Container(padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4), decoration: BoxDecoration(color: Colors.white.withOpacity(0.2), borderRadius: BorderRadius.circular(20)), child: Text('珥ъ쁺 ${state.cameraStep + 1}/3', style: const TextStyle(color: Colors.white, fontSize: 12, fontWeight: FontWeight.bold)))
                  ]),
                ),
                Column(children: [
                  Text(current['title']!, textAlign: TextAlign.center, style: GoogleFonts.notoSansKr(fontSize: 22, fontWeight: FontWeight.w700, color: Colors.white)), 
                  const SizedBox(height: 8), 
                  Text(current['desc']!, style: GoogleFonts.notoSansKr(fontSize: 14, color: Colors.white70))
                ])
              ],
            ),
          )
        ),
        Positioned.fill(
          child: Padding(
            padding: const EdgeInsets.only(top: 30),
            child: Center(
              child: Container(width: MediaQuery.of(context).size.width * 0.8, height: MediaQuery.of(context).size.width * 0.8 * 1.4, decoration: BoxDecoration(border: Border.all(color: Colors.cyanAccent, width: 2), borderRadius: BorderRadius.circular(20)))
            ),
          )
        ),
        Positioned(bottom: 30, left: 0, right: 0, child: Center(child: GestureDetector(onTap: () { showDialog(context: context, barrierDismissible: false, builder: (_) => const Center(child: CircularProgressIndicator(color: Colors.cyanAccent))); Future.delayed(const Duration(seconds: 1), () { Navigator.pop(context); notifier.advanceCameraStep(); }); }, child: Container(width: 80, height: 80, decoration: BoxDecoration(shape: BoxShape.circle, border: Border.all(color: Colors.white, width: 4)), child: Container(margin: const EdgeInsets.all(4), decoration: const BoxDecoration(color: Colors.white, shape: BoxShape.circle))))))
    ]));
  }
}

// -----------------------------------------------------------------------------
// STEP 4: Info Confirm
// -----------------------------------------------------------------------------
class _Step4InfoConfirm extends StatelessWidget {
  final AlbaPermitNotifier notifier;
  final AlbaPermitState state;
  const _Step4InfoConfirm(this.notifier, this.state);
  @override
  Widget build(BuildContext context) {
    return Scaffold(backgroundColor: Colors.white, appBar: AppBar(elevation: 0, backgroundColor: Colors.white, leading: IconButton(icon: const Icon(Icons.arrow_back, color: Colors.black), onPressed: () => notifier.prevStep())), body: Column(children: [
        Padding(padding: const EdgeInsets.all(24), child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text.rich(TextSpan(children: [const TextSpan(text: '嫄곗쓽 ???먯뼱??\n'), TextSpan(text: '?뺣낫', style: GoogleFonts.notoSansKr(color: const Color(0xFF2563EB))), const TextSpan(text: '瑜??뺤씤?댁＜?몄슂.')]), style: GoogleFonts.notoSansKr(fontSize: 24, fontWeight: FontWeight.w900, color: const Color(0xFF0F172A))), const SizedBox(height: 8), Text('?ъ뾽?먮벑濡앹쬆 ?댁슜??諛뷀깢?쇰줈\n?먮룞 ?낅젰???뺣낫?낅땲??', style: GoogleFonts.notoSansKr(fontSize: 14, color: const Color(0xFF64748B)))])),
        Expanded(child: ListView(padding: const EdgeInsets.symmetric(horizontal: 24), children: [_field('?곹샇紐?, state.companyName, notifier.updateCompanyName), _field('?ъ뾽???깅줉踰덊샇', state.bizNo, notifier.updateBizNo), _field('??쒖옄紐?, state.ownerName, notifier.updateOwnerName), _field('?ъ뾽??二쇱냼', state.address, notifier.updateAddress, maxLines: 2), _field('?쒓툒', state.hourlyWage, notifier.updateHourlyWage), _field('洹쇰Т ?쒓컙', state.weekdayWork, notifier.updateWorkingHours), const SizedBox(height: 30), 
        // Changed: Checkbox instead of badge
        _checkbox(state.infoCorrectChecked, '(?꾩닔) 湲곗엯???뺣낫媛 留욎븘??, () => notifier.toggleInfoCorrect()), const SizedBox(height: 20)])),
        Padding(padding: EdgeInsets.fromLTRB(20, 10, 20, MediaQuery.of(context).padding.bottom + 20), child: SizedBox(width: double.infinity, height: 60, child: ElevatedButton(onPressed: state.infoCorrectChecked ? () => notifier.nextStep() : null, style: ElevatedButton.styleFrom(foregroundColor: Colors.white, backgroundColor: const Color(0xFF1A2B49), disabledBackgroundColor: Colors.grey[300], shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20))), child: Row(mainAxisAlignment: MainAxisAlignment.center, children: [const Icon(Icons.work, size: 20), const SizedBox(width: 8), Text('?뺣낫媛 留욎븘??(?ㅼ쓬)', style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.bold))]))))
    ]));
  }
  Widget _field(String l, String v, Function(String) c, {int maxLines = 1}) => Padding(padding: const EdgeInsets.only(bottom: 20), child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text(l, style: GoogleFonts.notoSansKr(fontSize: 12, fontWeight: FontWeight.bold, color: Colors.blueGrey)), TextFormField(initialValue: v, onChanged: c, maxLines: maxLines, style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.bold), decoration: const InputDecoration(enabledBorder: UnderlineInputBorder(borderSide: BorderSide(color: Colors.grey)), focusedBorder: UnderlineInputBorder(borderSide: BorderSide(color: Colors.blue)), suffixIcon: Icon(Icons.edit, size: 16)))]));
  
  Widget _checkbox(bool c, String t, VoidCallback tap) => GestureDetector(onTap: tap, child: Row(children: [Container(width: 24, height: 24, decoration: BoxDecoration(color: c ? Colors.blue : Colors.white, borderRadius: BorderRadius.circular(6), border: Border.all(color: c ? Colors.blue : Colors.grey[300]!)), child: c ? const Icon(Icons.check, size: 16, color: Colors.white) : null), const SizedBox(width: 12), Expanded(child: Text(t, style: GoogleFonts.notoSansKr(fontSize: 14, fontWeight:  FontWeight.w500, color: c ? Colors.black : Colors.grey[500]!)))]));
}

// -----------------------------------------------------------------------------
// STEP 5: Signature
// -----------------------------------------------------------------------------
class _Step5Signature extends StatefulWidget {
  final AlbaPermitNotifier notifier;
  final AlbaPermitState state;
  const _Step5Signature(this.notifier, this.state);
  @override State<_Step5Signature> createState() => _Step5SignatureState();
}
class _Step5SignatureState extends State<_Step5Signature> {
  bool _modal = false;
  @override Widget build(BuildContext context) {
    if (_modal) return _modalView();
    return Scaffold(backgroundColor: Colors.grey[100], appBar: AppBar(title: const Text('?꾩옄 ?쒕챸'), centerTitle: true, elevation: 0, backgroundColor: Colors.white, foregroundColor: Colors.black, leading: IconButton(icon: const Icon(Icons.arrow_back), onPressed: () => widget.notifier.prevStep())), body: Stack(children: [
        SingleChildScrollView(padding: const EdgeInsets.all(20), child: Container(padding: const EdgeInsets.all(24), color: Colors.white, child: Column(children: [
            Text("?멸뎅?몄쑀?숈깮 ?쒓컙?쒖랬???뺤씤??, style: GoogleFonts.notoSansKr(fontSize: 18, fontWeight: FontWeight.w900, decoration: TextDecoration.underline)),
            const SizedBox(height: 20),
            // Complex Table (Compact: Employer only per request)
            Table(border: TableBorder.all(color: Colors.black), columnWidths: const {0: FixedColumnWidth(80)}, children: [
              // 2. Employer Section ONLY
              TableRow(children: [
                 TableCell(verticalAlignment: TableCellVerticalAlignment.middle, child: Container(height: 280, color: Colors.grey[50], alignment: Alignment.center, child: const Text("痍⑥뾽\n?덉젙\n洹쇰Т泥?, textAlign: TextAlign.center, style: TextStyle(fontWeight: FontWeight.bold)))),
                 TableCell(verticalAlignment: TableCellVerticalAlignment.middle, child: Column(children: [
                    _tableRow("??泥?紐?, widget.state.companyName),
                    Container(height: 1, color: Colors.black),
                    _tableRow("?ъ뾽??n?깅줉踰덊샇", widget.state.bizNo, labelWidth: 60),
                    Container(height: 1, color: Colors.black),
                    _tableRow("二???, widget.state.address),
                    Container(height: 1, color: Colors.black),
                    // Signature Row
                    IntrinsicHeight(child: Row(children: [
                      Container(width: 80, padding: const EdgeInsets.all(8), alignment: Alignment.center, child: const Text("怨???二?, style: TextStyle(fontWeight: FontWeight.bold))),
                      Container(width: 1, color: Colors.black),
                      // Display signature image when saved
                      Expanded(child: Container(height: 60, padding: EdgeInsets.zero, alignment: Alignment.center, child: widget.state.isSignatureSaved 
                        ? ClipRect(
                            child: SizedBox(
                                width: 100, height: 60,
                                child: CustomPaint(painter: _SignaturePainter(widget.state.signaturePoints))
                            )
                        )
                        : const Text("(???먮뒗 ?쒕챸)", style: TextStyle(color: Colors.grey))
                      ))
                    ])),
                    Container(height: 1, color: Colors.black),
                    _tableRow("痍⑥뾽湲곌컙", widget.state.employmentPeriod),
                    Container(height: 1, color: Colors.black),
                    _tableRow("湲됱뿬(?쒓툒)", widget.state.hourlyWage),
                 ]))
              ]),
            ]),
            // Removed bottom text as requested
            const SizedBox(height: 100)
        ]))),
        Positioned(bottom: 0, left: 0, right: 0, child: Container(padding: EdgeInsets.fromLTRB(20, 20, 20, MediaQuery.of(context).padding.bottom + 20), color: Colors.white, child: ElevatedButton(onPressed: () => widget.state.isSignatureSaved ? widget.notifier.nextStep() : setState(() => _modal = true), style: ElevatedButton.styleFrom(foregroundColor: Colors.white, backgroundColor: const Color(0xFF1A2B49), padding: const EdgeInsets.symmetric(vertical: 16), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12))), child: Row(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(widget.state.isSignatureSaved ? Icons.check : Icons.edit, size: 18), const SizedBox(width: 8), Text(widget.state.isSignatureSaved ? "?쒕챸 ?꾨즺 諛??쒖텧?섍린" : "?ъ뾽二??쒕챸?섍린", style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.bold))]))))
    ]));
  }
  Widget _tableRow(String label, String value, {double labelWidth = 80}) => IntrinsicHeight(child: Row(children: [Container(width: labelWidth, padding: const EdgeInsets.all(8), alignment: Alignment.center, child: Text(label, textAlign: TextAlign.center, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12))), Container(width: 1, color: Colors.black), Expanded(child: Container(padding: const EdgeInsets.all(8), alignment: Alignment.centerLeft, child: Text(value, style: const TextStyle(fontSize: 12))))]));
  Widget _modalView() => Scaffold(backgroundColor: Colors.black54, body: Align(alignment: Alignment.bottomCenter, child: Container(height: 480, decoration: const BoxDecoration(color: Colors.white, borderRadius: BorderRadius.vertical(top: Radius.circular(24))), padding: const EdgeInsets.all(24), child: Column(children: [Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [Text("怨좎슜二??쒕챸", style: GoogleFonts.notoSansKr(fontSize: 18, fontWeight: FontWeight.bold)), IconButton(icon: const Icon(Icons.close), onPressed: () => setState(() => _modal = false))]), const SizedBox(height: 16), Expanded(child: Container(decoration: BoxDecoration(color: Colors.grey[50], border: Border.all(color: Colors.grey[300]!), borderRadius: BorderRadius.circular(12)), child: ClipRect(child: GestureDetector(onPanUpdate: (d) => widget.notifier.addSignaturePoint(d.localPosition), onPanEnd: (_) => widget.notifier.addSignaturePoint(null), child: CustomPaint(painter: _SignaturePainter(widget.state.signaturePoints), size: Size.infinite))))), const SizedBox(height: 16), Row(children: [Expanded(child: TextButton(onPressed: () => widget.notifier.clearSignature(), child: const Text("吏?곌린"))), const SizedBox(width: 12), Expanded(flex: 2, child: ElevatedButton(onPressed: () { widget.notifier.saveSignature(); setState(() => _modal = false); }, style: ElevatedButton.styleFrom(backgroundColor: Colors.blue), child: const Text("?쒕챸 ?꾨즺")))])]))));
}
class _SignaturePainter extends CustomPainter {
  final List<Offset?> p; _SignaturePainter(this.p);
  @override void paint(Canvas c, Size s) { 
    Paint paint = Paint()..color = Colors.black..strokeCap = StrokeCap.round..strokeWidth = 2.0;
    
    if (s.width < 200 && p.isNotEmpty) {
       double minX = double.infinity, minY = double.infinity, maxX = -double.infinity, maxY = -double.infinity;
       for (var o in p) { if (o != null) { if (o.dx < minX) minX = o.dx; if (o.dx > maxX) maxX = o.dx; if (o.dy < minY) minY = o.dy; if (o.dy > maxY) maxY = o.dy; } }
       if (minX != double.infinity) {
         double w = maxX - minX, h = maxY - minY;
         if (w == 0) w = 1; if (h == 0) h = 1;
         double scale = (s.width / w < s.height / h ? s.width / w : s.height / h) * 0.8;
         c.save();
         c.translate(s.width/2, s.height/2);
         c.scale(scale);
         c.translate(-(minX + w/2), -(minY + h/2));
         paint.strokeWidth = 2.0 / scale;
         for (int i = 0; i < p.length - 1; i++) {
           if (p[i] != null && p[i+1] != null) c.drawLine(p[i]!, p[i+1]!, paint);
         }
         c.restore();
         return;
       }
    }
    for (int i = 0; i < p.length - 1; i++) {
      if (p[i] != null && p[i+1] != null) c.drawLine(p[i]!, p[i+1]!, paint);
    } 
  }
  @override bool shouldRepaint(covariant CustomPainter o) => true;
}

// -----------------------------------------------------------------------------
// STEP 6: Submit Complete -> Wait for school
// -----------------------------------------------------------------------------
class _Step6SubmitComplete extends StatelessWidget {
  final AlbaPermitNotifier notifier;
  const _Step6SubmitComplete(this.notifier);
  @override
  Widget build(BuildContext context) {
    Future.delayed(const Duration(seconds: 3), () => notifier.nextStep());
    return Scaffold(backgroundColor: Colors.white, body: Center(child: Column(mainAxisAlignment: MainAxisAlignment.center, children: [
      Container(width: 80, height: 80, decoration: const BoxDecoration(color: Color(0xFFDCFCE7), shape: BoxShape.circle), child: const Icon(Icons.mail, size: 40, color: Color(0xFF16A34A))),
      const SizedBox(height: 24),
      Text.rich(TextSpan(children: [const TextSpan(text: '?쒕쪟 ?쒖텧 ?꾨즺!\n'), TextSpan(text: 'CUTY媛 ?뺤씤?섍퀬 ?덉뼱??', style: TextStyle(color: Colors.blue))], style: GoogleFonts.notoSansKr(fontSize: 24, fontWeight: FontWeight.w900, color: const Color(0xFF0F172A))), textAlign: TextAlign.center),
      const SizedBox(height: 12),
      Text('寃?좊뒗 ?곸뾽??湲곗? 1???댁뿉 ?꾨즺?⑸땲??', textAlign: TextAlign.center, style: GoogleFonts.notoSansKr(fontSize: 16, color: const Color(0xFF64748B))),
      const SizedBox(height: 48),
      const CircularProgressIndicator()
    ])));
  }
}

// -----------------------------------------------------------------------------
// STEP 7: School Approval
// -----------------------------------------------------------------------------
// -----------------------------------------------------------------------------
// STEP 7: School Approval
// -----------------------------------------------------------------------------
class _Step7SchoolApproval extends StatelessWidget {
  final AlbaPermitNotifier notifier;
  const _Step7SchoolApproval(this.notifier);
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(elevation: 0, backgroundColor: Colors.white, leading: IconButton(icon: const Icon(Icons.arrow_back, color: Colors.black), onPressed: () => notifier.prevStep())),
      body: SafeArea(
        child: Column(
          children: [
            Expanded(
              child: SingleChildScrollView(
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const SizedBox(height: 20),
                    // Header
                    Container(width: 60, height: 60, decoration: BoxDecoration(color: Colors.yellow[100], shape: BoxShape.circle), child: Icon(Icons.celebration, size: 30, color: Colors.yellow[800])),
                    const SizedBox(height: 20),
                    Text("???\n?숆탳 ?뱀씤???꾨즺?섏뿀?댁슂! ?럦", textAlign: TextAlign.center, style: GoogleFonts.notoSansKr(fontSize: 24, fontWeight: FontWeight.w900, height: 1.3, color: const Color(0xFF0F172A))),
                    const SizedBox(height: 32),
                    // Document Placeholder
                    Container(
                      width: 200, // Slightly smaller
                      height: 282, // A4 aspect ratio
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: Colors.grey[200]!),
                        boxShadow: [
                          BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 15, offset: const Offset(0, 8))
                        ]
                      ),
                      child: Column(
                        children: [
                           // Mock Document Content
                           Container(height: 40, decoration: BoxDecoration(color: Colors.grey[50], borderRadius: const BorderRadius.vertical(top: Radius.circular(8))), alignment: Alignment.center, child: Text("?숆탳 ?뱀씤 ?꾨즺", style: GoogleFonts.notoSansKr(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.grey[500]))),
                           Expanded(
                             child: Center(
                               child: Column(
                                 mainAxisAlignment: MainAxisAlignment.center,
                                 children: [
                                   Icon(Icons.check_circle, size: 40, color: Colors.green[100]),
                                   const SizedBox(height: 8),
                                   Text("?쒓컙??痍⑥뾽 ?뺤씤??, textAlign: TextAlign.center, style: GoogleFonts.notoSansKr(fontSize: 14, fontWeight: FontWeight.bold, color: Colors.grey[400])),
                                 ],
                               ),
                             ),
                           ),
                           // Mock Lines
                           Padding(padding: const EdgeInsets.all(16), child: Column(children: [
                             Container(height: 6, width: double.infinity, color: Colors.grey[100]),
                             const SizedBox(height: 4),
                             Container(height: 6, width: 120, color: Colors.grey[100]),
                           ]))
                        ],
                      ),
                    ),
                    const SizedBox(height: 20),
                  ],
                ),
              ),
            ),
            // Bottom Button
            Padding(
              padding: const EdgeInsets.fromLTRB(24, 12, 24, 24),
              child: SizedBox(
                width: double.infinity,
                height: 56,
                child: ElevatedButton(
                  onPressed: () => notifier.nextStep(),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF1E3A8A),
                    elevation: 0,
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16))
                  ),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Text("?듯빀 ?쒕쪟 ?뺤씤?섎윭 媛湲?, style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.w700, color: Colors.white)),
                      const SizedBox(width: 8),
                      const Icon(Icons.arrow_forward, size: 18, color: Colors.white),
                    ],
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// -----------------------------------------------------------------------------
// STEP 8: Final Folder (PDF Download)
// -----------------------------------------------------------------------------
class _Step8FinalFolder extends StatelessWidget {
  final AlbaPermitNotifier notifier;
  final AlbaPermitState state;
  const _Step8FinalFolder(this.notifier, this.state);
  @override
  Widget build(BuildContext context) {
    if (state.isPdfDownloaded) Future.delayed(const Duration(seconds: 1), () => notifier.nextStep());
    final docs = ["?멸뎅???좏븰???쒓컙??痍⑥뾽 ?뺤씤??, "?쒖?洹쇰줈怨꾩빟??, "?ъ뾽?먮벑濡앹쬆 ?щ낯", "?멸뎅?몃벑濡앹쬆 (????", "?ш텒 ?щ낯", "?ы븰利앸챸??, "?깆쟻利앸챸??, "TOPIK ?쒓뎅?대뒫?μ떆???깆쟻??, "?듯빀 ?좎껌??(?좉퀬??", "?꾩엫??(?좉퀬?먯슜)", "湲고? 援щ퉬 ?쒕쪟"];
    return Scaffold(backgroundColor: Colors.white, appBar: AppBar(title: const Text("理쒖쥌 ?쒕쪟 ?듯빀"), centerTitle: true, elevation: 0, backgroundColor: Colors.white, foregroundColor: Colors.black, leading: IconButton(icon: const Icon(Icons.arrow_back), onPressed: () => notifier.prevStep())), body: Column(children: [
       Expanded(child: SingleChildScrollView(padding: const EdgeInsets.all(24), child: Column(children: [
          Container(padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4), decoration: BoxDecoration(color: Colors.blue[50], borderRadius: BorderRadius.circular(20)), child: Row(mainAxisSize: MainAxisSize.min, children: const [Icon(Icons.check, size: 12, color: Colors.blue), SizedBox(width: 4), Text("11醫??쒕쪟 ?듯빀 ?꾨즺", style: TextStyle(color: Colors.blue, fontWeight: FontWeight.bold, fontSize: 12))])),
          const SizedBox(height: 16),
          Text.rich(TextSpan(children: [const TextSpan(text: "?곕줈?곕줈 以鍮꾪븷 ?꾩슂 ?놁씠\n"), TextSpan(text: "?섎굹??PDF", style: TextStyle(color: Colors.blue)), const TextSpan(text: "濡?臾띠뿀?댁슂")]), textAlign: TextAlign.center, style: GoogleFonts.notoSansKr(fontSize: 24, fontWeight: FontWeight.w900)),
          const SizedBox(height: 30),
          Container(width: 160, height: 200, decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(16), boxShadow: [BoxShadow(color: Colors.blue.withOpacity(0.2), blurRadius: 20, offset: const Offset(0, 10))], border: Border.all(color: Colors.blue.shade100)), child: Column(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(Icons.folder_open, size: 60, color: Colors.blue), const SizedBox(height: 12), const Text("FINAL DOCUMENT", style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.grey)), const Text("??CUTY\n?듯빀 ?좎껌 ?대뜑", textAlign: TextAlign.center, style: TextStyle(fontWeight: FontWeight.w900, fontSize: 14)), const SizedBox(height: 8), Container(padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2), color: Colors.grey[100], child: const Text("(PDF / 3.2MB)", style: TextStyle(fontSize: 10, color: Colors.grey)))] )),
          const SizedBox(height: 40),
          Align(alignment: Alignment.centerLeft, child: Text(" ?ы븿???쒕쪟 紐⑸줉", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.grey[800]))),
          const SizedBox(height: 12),
          Container(decoration: BoxDecoration(border: Border.all(color: Colors.grey[200]!), borderRadius: BorderRadius.circular(12)), child: Column(children: docs.asMap().entries.map((e) => Container(padding: const EdgeInsets.all(12), decoration: BoxDecoration(border: Border(bottom: BorderSide(color: Colors.grey[100]!))), child: Row(children: [Container(padding: const EdgeInsets.all(6), decoration: BoxDecoration(color: Colors.blue[50], borderRadius: BorderRadius.circular(8)), child: const Icon(Icons.description, size: 14, color: Colors.blue)), const SizedBox(width: 12), Expanded(child: Text(e.value, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13))), const Icon(Icons.check, size: 16, color: Colors.blue)]))).toList()))
       ]))),
       Padding(padding: const EdgeInsets.all(20), child: SizedBox(width: double.infinity, height: 60, child: ElevatedButton(onPressed: () => notifier.downloadPdf(), style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF1A2B49), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16))), child: state.isPdfDownloaded ? Row(mainAxisAlignment: MainAxisAlignment.center, children: const [Text("媛?대뱶 ?섏씠吏濡??대룞 以?..", style: TextStyle(color: Colors.white)), SizedBox(width: 8), Icon(Icons.chevron_right, color: Colors.white)]) : Row(mainAxisAlignment: MainAxisAlignment.center, children: const [Icon(Icons.download, color: Colors.white), SizedBox(width: 8), Text("?듯빀 PDF ?ㅼ슫濡쒕뱶 諛??묒닔 媛?대뱶", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold))])))),
    ]));
  }
}

// -----------------------------------------------------------------------------
// STEP 9: HiKorea Guide
// -----------------------------------------------------------------------------
class _Step9HiKoreaGuide extends StatelessWidget {
  final AlbaPermitNotifier notifier;
  const _Step9HiKoreaGuide(this.notifier);
  @override
  Widget build(BuildContext context) {
    return Scaffold(backgroundColor: Colors.white, appBar: AppBar(title: const Text("?좎껌 媛?대뱶"), centerTitle: true, elevation: 0, backgroundColor: Colors.white, foregroundColor: Colors.black, leading: IconButton(icon: const Icon(Icons.arrow_back), onPressed: () => notifier.prevStep())), body: Column(children: [
       Expanded(child: ListView(padding: const EdgeInsets.all(24), children: [
          Text.rich(TextSpan(children: [const TextSpan(text: "?댁젣 "), TextSpan(text: "?섏씠肄붾━??, style: TextStyle(color: Colors.blue)), const TextSpan(text: "?먯꽌\n?쒕쪟留??щ━硫??앸굹??")]), style: GoogleFonts.notoSansKr(fontSize: 24, fontWeight: FontWeight.w900)),
          const SizedBox(height: 8),
          const Text("蹂듭옟??怨쇱젙? 荑좏떚媛 ???앸깉?댁슂.\n媛?대뱶???곕씪 1遺?留뚯뿉 ?묒닔?대낫?몄슂.", style: TextStyle(color: Colors.grey, fontSize: 13)),
          const SizedBox(height: 30),
          _step(1, "?섏씠肄붾━???묒냽 諛?濡쒓렇??, icon: Icons.public, child: Container(margin: const EdgeInsets.only(top: 12), height: 160, width: double.infinity, decoration: BoxDecoration(color: Colors.grey[200], borderRadius: BorderRadius.circular(12)), alignment: Alignment.center, child: const Text("?섏씠肄붾━???덊럹?댁? 罹≪퀜 ?대?吏\n(異뷀썑 ?쎌엯 ?덉젙)", textAlign: TextAlign.center, style: TextStyle(color: Colors.grey, fontSize: 12)))) ,
          _step(2, "誘쇱썝?좏깮 > ?쒓컙?쒖랬???덇? ?대┃", icon: Icons.mouse, child: Container(margin: const EdgeInsets.only(top: 12), height: 160, width: double.infinity, decoration: BoxDecoration(color: Colors.grey[200], borderRadius: BorderRadius.circular(12)), alignment: Alignment.center, child: const Text("誘쇱썝?좏깮 ?붾㈃ 罹≪퀜 ?대?吏\n(異뷀썑 ?쎌엯 ?덉젙)", textAlign: TextAlign.center, style: TextStyle(color: Colors.grey, fontSize: 12)))),
          _step(3, "?쒕쪟 ?낅줈??(媛??以묒슂!)", highlight: true, desc: "諛⑷툑 ?ㅼ슫濡쒕뱶??'CUTY ?듯빀 ?좎껌 ?⑦궎吏.pdf' ?섎굹留??щ━硫???\n(?ы븰/?깆쟻利앸챸?? ?좊텇利? 怨꾩빟?????ы븿??", icon: Icons.folder_zip, child: Container(margin: const EdgeInsets.only(top: 12), height: 160, width: double.infinity, decoration: BoxDecoration(color: Colors.grey[200], borderRadius: BorderRadius.circular(12)), alignment: Alignment.center, child: const Text("?쒕쪟 ?낅줈???붾㈃ 罹≪퀜 ?대?吏\n(異뷀썑 ?쎌엯 ?덉젙)", textAlign: TextAlign.center, style: TextStyle(color: Colors.grey, fontSize: 12)))),
          _step(4, "?묒닔 ?꾨즺 諛??묒닔利??낅줈??, child: GestureDetector(
            onTap: () { /* Todo: Implement Upload */ },
            child: Container(
              margin: const EdgeInsets.only(top: 12),
              height: 120,
              width: double.infinity,
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: Colors.blue.shade200, style: BorderStyle.none), // Placeholder for dashed border if needed, or just solid
              ),
              child: Container(
                   width: double.infinity,
                   height: double.infinity,
                   decoration: BoxDecoration(
                     border: Border.all(color: Colors.blue.shade300, width: 1.5),
                     borderRadius: BorderRadius.circular(12),
                     color: Colors.blue.shade50
                   ),
                   child: Center(child: Column(mainAxisAlignment: MainAxisAlignment.center, children: [
                     Icon(Icons.camera_alt, color: Colors.blue.shade300, size: 32),
                     const SizedBox(height: 8),
                     Text("?묒닔利?罹≪퀜蹂??щ━湲?, style: TextStyle(color: Colors.blue.shade400, fontWeight: FontWeight.bold))
                   ]))
              )
            )
          )),
          const SizedBox(height: 20),
          Container(padding: const EdgeInsets.all(16), decoration: BoxDecoration(color: Colors.amber[50], borderRadius: BorderRadius.circular(12), border: Border.all(color: Colors.amber[100]!)), child: Row(children: [Icon(Icons.lightbulb, color: Colors.amber[700], size: 20), const SizedBox(width: 12), Expanded(child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: const [Text("?묒닔 轅??, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: Colors.brown)), Text("?됱씪 ?ㅼ쟾 9??~ ?ㅽ썑 6???ъ씠???좎껌?섎㈃ 泥섎━媛 鍮⑤씪??", style: TextStyle(fontSize: 12, color: Colors.brown))]))]))
       ])),
       Padding(padding: const EdgeInsets.all(20), child: SizedBox(width: double.infinity, height: 60, child: ElevatedButton(onPressed: () => notifier.nextStep(), style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF1A2B49), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16))), child: const Text("?좎껌 ?꾨즺?덉뼱??(?ㅼ쓬)", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)))))
    ]));
  }
  Widget _step(int i, String t, {bool highlight = false, String? desc, IconData? icon, Widget? child}) => Padding(padding: const EdgeInsets.only(bottom: 24), child: Row(crossAxisAlignment: CrossAxisAlignment.start, children: [Container(width: 40, height: 40, decoration: BoxDecoration(color: highlight ? Colors.blue : Colors.white, border: Border.all(color: highlight ? Colors.blue : Colors.grey[300]!), shape: BoxShape.circle), alignment: Alignment.center, child: Text("$i", style: TextStyle(color: highlight ? Colors.white : Colors.grey, fontWeight: FontWeight.bold))), const SizedBox(width: 16), Expanded(child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Row(children: [Text(t, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 15, color: highlight ? Colors.blue : Colors.black)), if (icon != null) Padding(padding: const EdgeInsets.only(left: 8), child: Icon(icon, size: 16, color: Colors.grey))]), if (desc != null) Container(margin: const EdgeInsets.only(top: 8), padding: const EdgeInsets.all(12), decoration: BoxDecoration(color: Colors.blue[50], borderRadius: BorderRadius.circular(8)), child: Text(desc, style: const TextStyle(fontSize: 12, color: Colors.blue))), if (child != null) child]))]));
}

// -----------------------------------------------------------------------------
// STEP 10: Final Permit
// -----------------------------------------------------------------------------
class _Step10FinalPermit extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(backgroundColor: Colors.white, body: Center(child: Padding(padding: const EdgeInsets.all(24), child: Column(mainAxisAlignment: MainAxisAlignment.center, children: [
       Container(padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4), decoration: BoxDecoration(color: Colors.yellow[100], borderRadius: BorderRadius.circular(20), border: Border.all(color: Colors.yellow[200]!)), child: Row(mainAxisSize: MainAxisSize.min, children: [Icon(Icons.verified, size: 14, color: Colors.yellow[900]), const SizedBox(width: 4), Text("理쒖쥌 ?덇? ?꾨즺", style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: Colors.yellow[900]))])),
       const SizedBox(height: 30),
       Stack(clipBehavior: Clip.none, children: [
         Container(width: 100, height: 100, decoration: BoxDecoration(color: Colors.indigo[50], shape: BoxShape.circle), child: const Icon(Icons.confirmation_number, size: 50, color: Colors.indigo)),
         const Positioned(bottom: 0, right: 0, child: CircleAvatar(backgroundColor: Colors.green, radius: 14, child: Icon(Icons.check, color: Colors.white, size: 16)))
       ]),
       const SizedBox(height: 24),
       Text.rich(TextSpan(children: [const TextSpan(text: "異뺥븯?⑸땲??\n?댁젣 諛붾줈 "), TextSpan(text: "?쇳븷 ???덉뼱??", style: TextStyle(color: Colors.indigo)), const TextSpan(text: " ?Ⅳ")]), textAlign: TextAlign.center, style: GoogleFonts.notoSansKr(fontSize: 24, fontWeight: FontWeight.w900)),
       const SizedBox(height: 12),
       const Text("?깃났?곸씤 ?꾨Ⅴ諛붿씠???앺솢??nCUTY媛 ?묒썝?⑸땲??", textAlign: TextAlign.center, style: TextStyle(color: Colors.grey)),
       const SizedBox(height: 40),
       Container(padding: const EdgeInsets.all(20), decoration: BoxDecoration(color: Colors.grey[50], borderRadius: BorderRadius.circular(16)), child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
         Row(children: const [Icon(Icons.lightbulb, color: Colors.amber, size: 20), SizedBox(width: 8), Text("?꾨Ⅴ諛붿씠???쒖옉 ??轅??", style: TextStyle(fontWeight: FontWeight.bold))]),
         const SizedBox(height: 12),
         const Text("???숆린 以?二쇰떦 25?쒓컙 ?대궡濡?洹쇰Т?댁빞 ?댁슂.", style: TextStyle(fontSize: 12, color: Colors.grey)),
         const SizedBox(height: 4),
         const Text("??二쇳쑕?섎떦? 二?15?쒓컙 ?댁긽 洹쇰Т ??諛쏆쓣 ???덉뼱??", style: TextStyle(fontSize: 12, color: Colors.grey)),
         const SizedBox(height: 4),
         const Text("??洹쇰줈怨꾩빟?쒕뒗 瑗?蹂닿??대몢?몄슂!", style: TextStyle(fontSize: 12, color: Colors.grey)),
       ])),
       const SizedBox(height: 40),
       SizedBox(width: double.infinity, height: 60, child: ElevatedButton(onPressed: () => Navigator.pop(context), style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF1A2B49), padding: const EdgeInsets.symmetric(horizontal: 40, vertical: 16), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16))), child: const Text("??鍮꾩옄 ?곹깭 ?뺤씤?섍린 (?꾨즺)", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold))))
    ]))));
  }
}

// -----------------------------------------------------------------------------
// STEP 2: Document Check (NEW)
// -----------------------------------------------------------------------------
class _StepCheckDocs extends ConsumerWidget {
  final AlbaPermitNotifier notifier;
  const _StepCheckDocs(this.notifier);

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Watch Document Provider for real-time updates
    ref.watch(documentProvider); 
    final missingDocs = ref.read(documentProvider.notifier).hasRequiredDocsForPartTime();
    final isComplete = missingDocs.isEmpty;
    final requiredDocs = ['?멸뎅?몃벑濡앹쬆', '?ш텒', '?깆쟻利앸챸??, '?좏뵿利앸챸??, '嫄곗＜吏 利앸튃'];

    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text("?꾩닔 ?쒕쪟 ?뺤씤", style: TextStyle(color: Colors.black, fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        elevation: 0,
        centerTitle: true,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.black),
          onPressed: () => notifier.prevStep(),
        ),
      ),
      body: Column(
        children: [
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(24.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                   Text(
                     "?쒓컙??痍⑥뾽 ?덇?瑜??꾪빐\n?꾩닔 ?쒕쪟瑜??뺤씤?⑸땲??",
                     style: GoogleFonts.notoSansKr(fontSize: 24, fontWeight: FontWeight.bold, height: 1.4, color: const Color(0xFF111827)),
                   ),
                   const SizedBox(height: 12),
                   Text(
                     "?ㅽ럺 吏媛묒뿉 ?깅줉???쒕쪟 ?뺣낫瑜?n?먮룞?쇰줈 遺덈윭?붿뼱??",
                     style: GoogleFonts.notoSansKr(fontSize: 16, color: const Color(0xFF6B7280), height: 1.5),
                   ),
                   const SizedBox(height: 32),
                   Container(
                     decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(16), border: Border.all(color: const Color(0xFFE5E7EB)), boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10, offset: const Offset(0, 4))]),
                     child: Column(
                       children: requiredDocs.map((doc) {
                         final isMissing = missingDocs.contains(doc);
                         final isLast = doc == requiredDocs.last;
                         return Column(
                           children: [
                             Padding(
                               padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                               child: Row(
                                 children: [
                                   Container(width: 24, height: 24, decoration: BoxDecoration(color: isMissing ? const Color(0xFFF3F4F6) : const Color(0xFFDCFCE7), shape: BoxShape.circle), child: Icon(isMissing ? Icons.remove : Icons.check, size: 16, color: isMissing ? const Color(0xFF9CA3AF) : const Color(0xFF16A34A))),
                                   const SizedBox(width: 16),
                                   Expanded(child: Text(doc, style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.w500, color: isMissing ? const Color(0xFF9CA3AF) : const Color(0xFF1F2937)))),
                                   Text(isMissing ? "誘몃벑濡? : "?몄쬆 ?꾨즺", style: GoogleFonts.notoSansKr(fontSize: 14, fontWeight: FontWeight.w700, color: isMissing ? const Color(0xFFEF4444) : const Color(0xFF16A34A))),
                                 ],
                               ),
                             ),
                             if (!isLast) const Divider(height: 1, color: Color(0xFFF3F4F6)),
                           ],
                         );
                       }).toList(),
                     ),
                   ),
                ],
              ),
            ),
          ),
          Container(
            padding: const EdgeInsets.fromLTRB(24, 16, 24, 32),
            decoration: const BoxDecoration(color: Colors.white, border: Border(top: BorderSide(color: Color(0xFFE5E7EB)))),
            child: Column(
              children: [
                if (!isComplete) ...[
                  SizedBox(width: double.infinity, height: 56, child: OutlinedButton(onPressed: () { Navigator.push(context, MaterialPageRoute(builder: (context) => const SpecWalletScreen())); }, style: OutlinedButton.styleFrom(side: const BorderSide(color: Color(0xFF3B82F6)), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16))), child: Text("遺議깊븳 ?쒕쪟 梨꾩슦??媛湲?, style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.w700, color: const Color(0xFF3B82F6))))),
                  const SizedBox(height: 12),
                ],
                SizedBox(
                  width: double.infinity,
                  height: 56,
                  child: ElevatedButton(
                    onPressed: isComplete ? () => notifier.nextStep() : null,
                    style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFF1E3A8A), disabledBackgroundColor: const Color(0xFFF3F4F6), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)), elevation: 0),
                    child: Text(isComplete ? "?ㅼ쓬 ?④퀎濡? : "?쒕쪟 以鍮꾧? ?꾩슂?댁슂", style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.w700, color: isComplete ? Colors.white : const Color(0xFF9CA3AF))),
                  ),
                ),
                if (!isComplete)
                  Padding(
                    padding: const EdgeInsets.only(top: 12),
                    child: TextButton(
                      onPressed: () => notifier.nextStep(),
                      child: Text("?섏쨷???쒕쪟 梨꾩슱寃뚯슂 (?ъ뾽二?癒쇱?)", style: GoogleFonts.notoSansKr(fontSize: 14, fontWeight: FontWeight.w500, color: Colors.grey[600], decoration: TextDecoration.underline)),
                    ),
                  )
              ],
            ),
          ),
        ],
      ),
    );
  }
}

=== lib\screens\career\career_screen.dart ===
import 'package:flutter/material.dart';

class CareerScreen extends StatelessWidget {
  const CareerScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return const Scaffold(
      body: Center(
        child: Text("而ㅻ━???붾㈃ (以鍮꾩쨷)"),
      ),
    );
  }
}

=== lib\screens\career\survey_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:google_fonts/google_fonts.dart';

class SurveyScreen extends ConsumerStatefulWidget {
  const SurveyScreen({super.key});

  @override
  ConsumerState<SurveyScreen> createState() => _SurveyScreenState();
}

class _SurveyScreenState extends ConsumerState<SurveyScreen> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('而ㅻ━??吏꾨떒 ?ㅻЦ', style: GoogleFonts.notoSansKr(fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
        elevation: 0,
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
             Icon(Icons.assignment_turned_in_outlined, size: 80, color: Colors.blueAccent.shade100),
             const SizedBox(height: 16),
             Text("?ㅻЦ 議곗궗 ?붾㈃??以鍮?以묒엯?덈떎.", style: GoogleFonts.notoSansKr(fontSize: 16, color: Colors.grey[600])),
          ],
        ),
      ),
    );
  }
}

=== lib\screens\career\widgets\diagnosis_radar_chart.dart ===
import 'package:fl_chart/fl_chart.dart';
import 'package:flutter/material.dart';

class DiagnosisRadarChart extends StatelessWidget {
  final List<int> data;
  final bool showLabels;

  const DiagnosisRadarChart({
    super.key,
    required this.data,
    this.showLabels = true,
  });

  @override
  Widget build(BuildContext context) {
    // Data validation: ensure we have 5 data points
    final safeData = data.length >= 5 ? data.take(5).toList() : List.filled(5, 0);
    
    // Normalize data (assuming 0-100 range)
    // RadarChart requires RadarEntry list
    final entries = safeData.map((e) => RadarEntry(value: e.toDouble())).toList();

    return RadarChart(
      RadarChartData(
        radarShape: RadarShape.polygon,
        radarBorderData: const BorderSide(color: Colors.transparent),
        tickBorderData: const BorderSide(color: Colors.transparent),
        gridBorderData: BorderSide(color: Colors.grey.withOpacity(0.2), width: 1),
        tickCount: 4,
        ticksTextStyle: const TextStyle(color: Colors.transparent),
        titlePositionPercentageOffset: 0.2, 
        titleTextStyle: const TextStyle(color: Colors.black87, fontSize: 12),
        getTitle: (index, angle) {
          if (!showLabels) return const RadarChartTitle(text: '');
          const titles = ['吏곷Т?곹빀??, '?꾧났?쇱튂', '湲濡쒕쾶??웾', '?ㅻТ寃쏀뿕', '?댄븰?λ젰'];
          return RadarChartTitle(text: titles[index % titles.length]);
        },
        dataSets: [
          // User Data
          RadarDataSet(
            dataEntries: entries,
            fillColor: const Color(0xFF6200EE).withOpacity(0.4),
            borderColor: const Color(0xFF6200EE),
            entryRadius: 0,
            borderWidth: 2,
          ),
          // Placeholder for "Average" or "Full Score" if needed (optional)
        ],
      ),
      swapAnimationDuration: const Duration(milliseconds: 500),
      swapAnimationCurve: Curves.linear,
    );
  }
}

=== lib\screens\community\board_list_screen.dart ===

import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class BoardListScreen extends StatelessWidget {
  final String title;

  const BoardListScreen({super.key, this.title = '?뺣낫寃뚯떆??});

  @override
  Widget build(BuildContext context) {
    // Mock Data for Info/Tips
    final List<Map<String, dynamic>> infoPosts = [
      {
        'title': '2024??1?숆린 援???ν븰湲?2李??좎껌 ?덈궡',
        'content': '?좎엯?? ?몄엯?? ?ъ엯?숈깮 ??2李??좎껌 湲곌컙 ?볦튂吏 留덉꽭?? 媛援ъ썝 ?숈쓽 ?꾩닔?낅땲??',
        'author': '?숈깮吏?먰?',
        'date': '2024.02.03',
        'likes': 120,
        'comments': 15,
      },
      {
        'title': '[轅?? ?숆탳 ??媛?깅퉬 ?앸떦 由ъ뒪???뺣━ (24??ver)',
        'content': '?좊같?ㅼ씠 異붿쿇?섎뒗 吏꾩쭨 留쏆쭛留?紐⑥븯?듬땲?? ?먯떖 ?쒓컙 ?쇳빐??媛?몄슂.',
        'author': '姨앹찟諛뺤궗',
        'date': '2024.02.01',
        'likes': 85,
        'comments': 42,
      },
      {
        'title': '援먯뼇 "?곹솕???댄빐" ?섍컯 ?꾧린',
        'content': '????녾퀬 怨쇱젣???곹솕 媛먯긽臾??섎굹???명빐?? 援먯닔?섎룄 醫뗭쑝??',
        'author': '?듬챸',
        'date': '2024.01.28',
        'likes': 64,
        'comments': 8,
      },
      {
        'title': '?먯랬?앹쓣 ?꾪븳 遺꾨━?섍굅 媛?대뱶',
        'content': '?룰컝由щ뒗 ?뚮씪?ㅽ떛, 鍮꾨땺 遺꾨━?섍굅 諛⑸쾿 ?뺤떎?섍쾶 ?뺣━?대뱶由쎈땲??',
        'author': '?먯랬留뚮젟',
        'date': '2024.01.25',
        'likes': 52,
        'comments': 12,
      },
      {
        'title': '?꾩꽌愿 ?ㅽ꽣?붾８ ?덉빟 諛⑸쾿 蹂寃??덈궡',
        'content': '?댁젣 紐⑤컮???깆쑝濡쒕룄 ?덉빟 媛?ν빀?덈떎. ?뱀씪 ?덉빟? 遺덇??ν븯??李멸퀬?섏꽭??',
        'author': '?꾩꽌愿?먯튂??,
        'date': '2024.01.20',
        'likes': 30,
        'comments': 4,
      },
    ];

    return Scaffold(
      appBar: AppBar(
        title: Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
        elevation: 0,
      ),
      backgroundColor: Colors.white,
      body: ListView.separated(
        padding: const EdgeInsets.all(16),
        itemCount: infoPosts.length,
        separatorBuilder: (context, index) => const Divider(height: 1, color: Color(0xFFEEEEEE)),
        itemBuilder: (context, index) {
          final post = infoPosts[index];
          return _InfoListItem(post: post);
        },
      ),
    );
  }
}

class _InfoListItem extends StatelessWidget {
  final Map<String, dynamic> post;

  const _InfoListItem({required this.post});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Title
          Text(
            post['title'],
            style: GoogleFonts.notoSansKr(
              fontSize: 16,
              fontWeight: FontWeight.bold,
              color: const Color(0xFF1A1A2E),
            ),
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
          ),
          const SizedBox(height: 4),
          
          // Preview Content
          Text(
            post['content'],
            style: GoogleFonts.notoSansKr(
              fontSize: 14,
              color: Colors.grey[600],
              height: 1.4,
            ),
            maxLines: 2,
            overflow: TextOverflow.ellipsis,
          ),
          const SizedBox(height: 8),

          // Meta Row
          Row(
            children: [
              Text(
                '${post['author']} 쨌 ${post['date']}',
                style: GoogleFonts.notoSansKr(
                  fontSize: 12,
                  color: Colors.grey[400],
                ),
              ),
              const Spacer(),
              _buildIconStat(Icons.favorite_border_rounded, '${post['likes']}', Colors.red[300]!),
              const SizedBox(width: 8),
              _buildIconStat(Icons.chat_bubble_outline_rounded, '${post['comments']}', Colors.blue[300]!),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildIconStat(IconData icon, String label, Color color) {
    return Row(
      children: [
        Icon(icon, size: 14, color: color),
        const SizedBox(width: 2),
        Text(
          label,
          style: GoogleFonts.notoSansKr(
            fontSize: 12,
            fontWeight: FontWeight.w500,
            color: Colors.grey[600],
          ),
        ),
      ],
    );
  }
}

=== lib\screens\community\community_board_screen.dart ===

import 'package:flutter/material.dart';

class CommunityBoardScreen extends StatelessWidget {
  final String title;

  const CommunityBoardScreen({super.key, required this.title});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
        elevation: 0,
      ),
      backgroundColor: Colors.white,
      body: ListView.builder(
        itemCount: 20,
        padding: const EdgeInsets.all(16),
        itemBuilder: (context, index) {
          return Card(
            margin: const EdgeInsets.only(bottom: 12),
            elevation: 0,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12),
              side: const BorderSide(color: Color(0xFFEEEEEE)),
            ),
            child: ListTile(
              leading: CircleAvatar(
                backgroundColor: index % 2 == 0 ? Colors.orange[50] : Colors.blue[50], // Lighter colors
                child: Text('${index + 1}'),
              ),
              title: Text('寃뚯떆湲 ?쒕ぉ #$index'),
              subtitle: const Text('寃뚯떆???댁슜 誘몃━蹂닿린...'),
              trailing: const Icon(Icons.arrow_forward_ios, size: 14, color: Colors.grey),
            ),
          );
        },
      ),
    );
  }
}

=== lib\screens\community\community_feed_screen.dart ===

import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class CommunityFeedScreen extends StatefulWidget {
  const CommunityFeedScreen({super.key});

  @override
  State<CommunityFeedScreen> createState() => _CommunityFeedScreenState();
}

class _CommunityFeedScreenState extends State<CommunityFeedScreen> {
  int _selectedFilterIndex = 0;
  final List<String> _filters = ['?꾩껜', '??吏??(遺??', '???숆탳 (寃쎌꽦?)'];

  // Mock Data with Types
  final List<Map<String, dynamic>> posts = [
    {
      'id': 1,
      'type': 'text',
      'nationality': {'emoji': '?눤?눛', 'name': '踰좏듃??},
      'region': '遺??,
      'school': '寃쎌꽦?',
      'gender': 'Female',
      'content': '?쒓뎅?먯꽌 ?뚮컮 援ы븷 ???쒓뎅???λ젰 ?쇰쭏??以묒슂?? ?좏뵿 4湲됱씤???섎뱾源?\n?ъ옣?섎뱾??蹂댄넻 萸?臾쇱뼱蹂댁떆?붿? 沅곴툑???졼뀪',
      'likes': 12,
      'comments': 5,
      'time': '10遺???,
    },
    {
      'id': 2,
      'type': 'image',
      'nationality': {'emoji': '?눊?눛', 'name': '以묎뎅'},
      'region': '?쒖슱',
      'school': '嫄닿뎅?',
      'gender': 'Secret',
      'content': '?대쾲 ?숆린 ?쒓컙??留앺뻽??.. ?섍컯?좎껌 ?ㅽ뙣?댁꽌 怨듦컯 4?쒓컙 ?앷?.\n?숆탳 洹쇱쿂 留쏆쭛 異붿쿇 醫 ?댁쨾! ?쇰갈 ?섍린 醫뗭? 怨녹쑝濡?',
      'likes': 8,
      'comments': 14,
      'time': '35遺???,
    },
    {
      'id': 3,
      'type': 'poll',
      'nationality': {'emoji': '?눣?눡', 'name': '誘멸뎅'},
      'region': '???,
      'school': 'KAIST',
      'gender': 'Male',
      'content': 'What is better for lunch today? Help me choose!',
      'poll_options': ['Korean BBQ', 'Pizza & Pasta'],
      'poll_votes': [12, 5],
      'likes': 25,
      'comments': 8,
      'time': '1?쒓컙 ??,
    },
     {
      'id': 4,
      'type': 'text',
      'nationality': {'emoji': '?눓?눝', 'name': '?쇰낯'},
      'region': '?쒖슱',
      'school': '?곗꽭?',
      'gender': 'Female',
      'content': '?좎큿 洹쇱쿂?먯꽌 ?먯랬諛?援ы븯怨??덈뒗???붿꽭 ?쒖꽭媛 蹂댄넻 ?대뼸寃??? \n蹂댁쬆湲?1000??60?대㈃ ?곷떦?쒓굔媛?',
      'likes': 5,
      'comments': 2,
      'time': '2?쒓컙 ??,
    },
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('?먯쑀寃뚯떆??, style: TextStyle(fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
        elevation: 0,
        actions: [
          IconButton(icon: const Icon(Icons.search), onPressed: () {}),
          IconButton(icon: const Icon(Icons.notifications_none_rounded), onPressed: () {}),
        ],
      ),
      backgroundColor: Colors.white,
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('湲?곌린 ?붾㈃?쇰줈 ?대룞 (Mock)')));
        },
        backgroundColor: const Color(0xFF1565C0),
        child: const Icon(Icons.edit),
      ),
      body: Column(
        children: [
          // Filter Chips
          SingleChildScrollView(
            scrollDirection: Axis.horizontal,
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            child: Row(
              children: List.generate(_filters.length, (index) {
                final isSelected = _selectedFilterIndex == index;
                return Padding(
                  padding: const EdgeInsets.only(right: 8),
                  child: FilterChip(
                    label: Text(
                      _filters[index],
                      style: TextStyle(
                        color: isSelected ? Colors.white : Colors.black87,
                        fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                      ),
                    ),
                    selected: isSelected,
                    onSelected: (bool selected) {
                      setState(() {
                        _selectedFilterIndex = index;
                      });
                    },
                    backgroundColor: Colors.grey[100],
                    selectedColor: const Color(0xFF1565C0),
                    checkmarkColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      side: BorderSide(
                        color: isSelected ? Colors.transparent : Colors.grey[300]!,
                      ),
                      borderRadius: BorderRadius.circular(20),
                    ),
                  ),
                );
              }),
            ),
          ),
          const Divider(height: 1, thickness: 1, color: Color(0xFFEEEEEE)),

          // Feed List
          Expanded(
            child: ListView.separated(
              itemCount: posts.length,
              separatorBuilder: (context, index) => const Divider(height: 1, color: Color(0xFFEEEEEE)),
              itemBuilder: (context, index) {
                final post = posts[index];
                return _FeedItem(post: post);
              },
            ),
          ),
        ],
      ),
    );
  }
}

class _FeedItem extends StatelessWidget {
  final Map<String, dynamic> post;

  const _FeedItem({required this.post});

  @override
  Widget build(BuildContext context) {
    return Container(
      color: Colors.white,
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Row(
            children: [
              Container(
                width: 36,
                height: 36,
                decoration: BoxDecoration(color: Colors.grey[200], shape: BoxShape.circle),
                child: const Icon(Icons.person, color: Colors.grey, size: 20),
              ),
              const SizedBox(width: 10),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text('?듬챸', style: GoogleFonts.notoSansKr(fontSize: 14, fontWeight: FontWeight.bold, color: const Color(0xFF1A1A2E))),
                  Text(post['time'], style: GoogleFonts.notoSansKr(fontSize: 11, color: Colors.grey[500])),
                ],
              ),
              const Spacer(),
              const Icon(Icons.more_horiz, color: Colors.grey, size: 20),
            ],
          ),
          const SizedBox(height: 12),

          // Tags
          Wrap(
            spacing: 6,
            runSpacing: 6,
            children: [
              _buildTag(text: '${post['nationality']['emoji']} ${post['nationality']['name']}', color: const Color(0xFFFFF3E0), textCol: const Color(0xFFEF6C00)),
              _buildTag(text: '${post['region']} ${post['school']}', color: const Color(0xFFF5F5F5), textCol: const Color(0xFF616161)),
              _buildGenderTag(post['gender']),
            ],
          ),
          const SizedBox(height: 12),

          // Content
          Text(post['content'], style: GoogleFonts.notoSansKr(fontSize: 14, color: const Color(0xFF1A1A2E), height: 1.5)),
          const SizedBox(height: 12),

          // Type-specific Content (Image/Poll)
          if (post['type'] == 'image') _buildImageContent(),
          if (post['type'] == 'poll') _buildPollContent(post['poll_options'], post['poll_votes']),

          const SizedBox(height: 12),

          // Footer
          Row(
            children: [
              _buildFooterItem(Icons.favorite_border_rounded, '${post['likes']}'),
              const SizedBox(width: 16),
              _buildFooterItem(Icons.chat_bubble_outline_rounded, '${post['comments']}'),
              const Spacer(),
              _buildTranslateButton(),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildImageContent() {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      height: 150,
      width: double.infinity,
      decoration: BoxDecoration(
        color: Colors.grey[200],
        borderRadius: BorderRadius.circular(12),
      ),
      child: const Center(child: Icon(Icons.image_rounded, color: Colors.grey, size: 40)),
    );
  }

  Widget _buildPollContent(List<String> options, List<int> votes) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.grey[50],
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.grey[200]!),
      ),
      child: Column(
        children: List.generate(options.length, (index) {
          return Container(
            margin: const EdgeInsets.only(bottom: 8),
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.blue[100]!),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Text(options[index], style: const TextStyle(fontWeight: FontWeight.w500)),
                Text('${votes[index]}??, style: TextStyle(color: Colors.blue[700], fontWeight: FontWeight.bold)),
              ],
            ),
          );
        }),
      ),
    );
  }

  Widget _buildTag({required String text, required Color color, required Color textCol}) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(color: color, borderRadius: BorderRadius.circular(6)),
      child: Text(text, style: GoogleFonts.notoSansKr(fontSize: 11, fontWeight: FontWeight.w600, color: textCol)),
    );
  }

  Widget _buildGenderTag(String gender) {
    // Simplified logic for brevity
    Color bg = gender == 'Male' ? const Color(0xFFE3F2FD) : (gender == 'Female' ? const Color(0xFFFCE4EC) : const Color(0xFFF5F5F5));
    Color tx = gender == 'Male' ? const Color(0xFF1976D2) : (gender == 'Female' ? const Color(0xFFC2185B) : const Color(0xFF9E9E9E));
    IconData icon = gender == 'Male' ? Icons.male_rounded : (gender == 'Female' ? Icons.female_rounded : Icons.lock_outline_rounded);
    String label = gender == 'Male' ? '?⑥꽦' : (gender == 'Female' ? '?ъ꽦' : '鍮꾧났媛?);

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(color: bg, borderRadius: BorderRadius.circular(6)),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [Icon(icon, size: 12, color: tx), const SizedBox(width: 2), Text(label, style: TextStyle(fontSize: 11, fontWeight: FontWeight.w600, color: tx))],
      ),
    );
  }

  Widget _buildFooterItem(IconData icon, String count) {
    return Row(children: [Icon(icon, size: 18, color: Colors.grey[400]), const SizedBox(width: 4), Text(count, style: const TextStyle(fontSize: 12, color: Colors.grey))]);
  }

  Widget _buildTranslateButton() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
      decoration: BoxDecoration(color: const Color(0xFFF3E5F5), borderRadius: BorderRadius.circular(20)),
      child: Row(
        children: const [
          Icon(Icons.g_translate_rounded, size: 14, color: Color(0xFF7B1FA2)),
          SizedBox(width: 4),
          Text('踰덉뿭 蹂닿린', style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold, color: Color(0xFF7B1FA2))),
        ],
      ),
    );
  }
}

=== lib\screens\community\community_main_screen.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'community_feed_screen.dart';
import 'community_board_screen.dart';
import 'popular_posts_screen.dart';


class CommunityMainScreen extends StatelessWidget {
  const CommunityMainScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('而ㅻ??덊떚', style: TextStyle(fontWeight: FontWeight.bold)),
        centerTitle: true,
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
        elevation: 0,
      ),
      backgroundColor: Colors.white,
      body: ListView(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 20),
        children: [
          // Pattern Card: Popular Posts
          _PatternMenuCard(
            title: '?뵦 ?멸린寃뚯떆湲',
            subtitle: '吏湲?媛???ロ븳 ?댁빞湲?紐⑥쓬',
            color: const Color(0xFFFFF3E0), // Orange[50]
            patternColor: Colors.orange.withValues(alpha: 0.15),
            patternIcons: const [
              Icons.local_fire_department,
              Icons.favorite,
              Icons.thumb_up,
              Icons.whatshot,
              Icons.star,
            ],
            characterAsset: 'assets/images/community_hot.png',
            imageHeight: 160,       // Increased size (approx 1.25x)
            imageRightOffset: 30,   // Standardized right margin (15.0)
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => const PopularPostsScreen()),
              );
            },
          ),
          const SizedBox(height: 16),
          // Pattern Card: Free Board
          _PatternMenuCard(
            title: '?뿣截??먯쑀寃뚯떆??,
            subtitle: '?좏븰?앸뱾???붿쭅???섎떎 怨듦컙',
            color: const Color(0xFFE3F2FD), // Blue[50]
            patternColor: Colors.blue.withValues(alpha: 0.15),
            patternIcons: const [
              Icons.chat_bubble,
              Icons.forum,
              Icons.tag_faces,
              Icons.sms,
              Icons.record_voice_over,
            ],
            characterAsset: 'assets/images/community_free.png',
            imageRightOffset: 15, // Standardized right margin (15.0)
            // Default image size/offset is fine, text constraint handled in widget
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => const CommunityFeedScreen()),
              );
            },
          ),
          const SizedBox(height: 16),
          // Simple Card: Info Board
          _PatternMenuCard(
            title: '?럳 ?뺣낫寃뚯떆??,
            subtitle: '?숆탳 ?앺솢 轅??& 媛뺤쓽 ?뺣낫',
            color: const Color(0xFFFFF9C4), // Yellow[100]
            patternColor: const Color(0xFFFBC02D).withValues(alpha: 0.1),
            patternIcons: const [
              Icons.school,
              Icons.menu_book,
              Icons.auto_stories,
              Icons.assignment,
              Icons.lightbulb_outline,
            ],
            characterAsset: 'assets/images/community_info.png',
            imageHeight: 130,       // Increased to match top cards (approx 130px)
            imageRightOffset: 45,   // Standardized right margin (15.0)
            imageBottomOffset: -5,  // Slight overflow for grounded look
            // cardHeight: 160,     // Default is 160, so we can omit this or explicitly set it if needed. Removing to use default.
            onTap: () => _navigateToBoard(context, '?뺣낫寃뚯떆??),
          ),
          const SizedBox(height: 12),
          // Simple Card: Second-hand Market
          _PatternMenuCard(
            title: '?벀 以묎퀬?ν꽣',
            subtitle: '?꾧났梨? ?먯랬?⑺뭹 ?ш퀬 ?붽린',
            color: const Color(0xFFE8F5E9), // Green[50]
            patternColor: const Color(0xFF388E3C).withValues(alpha: 0.1),
            patternIcons: const [
              Icons.shopping_bag,
              Icons.inventory_2,
              Icons.local_offer,
              Icons.card_giftcard,
              Icons.store,
            ],
            characterAsset: 'assets/images/community_used.png',
            imageHeight: 115,       // Requested approx 110-120px
            imageRightOffset: 15,   // Requested standard 40px
            imageBottomOffset: 0,
            onTap: () => _navigateToBoard(context, '以묎퀬?ν꽣'),
          ),
          const SizedBox(height: 24),
          // Create Board Button
          _SimpleMenuCard(
            title: '寃뚯떆??媛쒖꽕 ?좎껌',
            subtitle: '?먰븯??二쇱젣媛 ?녿굹?? 吏곸젒 留뚮뱾?대낫?몄슂!',
            icon: Icons.add_circle_outline_rounded,
            color: Colors.white,
            iconColor: Colors.grey[600]!,
            border: Border.all(color: Colors.grey[300]!, width: 1.5),
            onTap: () => _showCreateBoardDialog(context),
            isCompact: true,
          ),
          const SizedBox(height: 20),
        ],
      ),
    );
  }

  void _navigateToBoard(BuildContext context, String title) {
    Navigator.push(
      context,
      MaterialPageRoute(builder: (context) => CommunityBoardScreen(title: title)),
    );
  }

  void _showCreateBoardDialog(BuildContext context) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('寃뚯떆??媛쒖꽕 ?좎껌', style: TextStyle(fontWeight: FontWeight.bold)),
        content: const Text('?대뼡 寃뚯떆?먯쓣 留뚮뱾怨??띠쑝?좉???\n\n(異뷀썑 ?좎껌 ?쇱씠 援ы쁽???덉젙?낅땲??'),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('痍⑥냼', style: TextStyle(color: Colors.grey)),
          ),
          TextButton(
            onPressed: () {
              Navigator.pop(context);
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('?좎껌???묒닔?섏뿀?듬땲?? (Mock)')),
              );
            },
            child: const Text('?좎껌?섍린', style: TextStyle(fontWeight: FontWeight.bold)),
          ),
        ],
      ),
    );
  }
}

class _PatternMenuCard extends StatelessWidget {
  final String title;
  final String subtitle;
  final Color color;
  final Color patternColor;
  final List<IconData> patternIcons;
  final String characterAsset;
  final VoidCallback onTap;
  final double imageHeight;
  final double imageRightOffset;
  final double imageBottomOffset;
  final double cardHeight;

  const _PatternMenuCard({
    required this.title,
    required this.subtitle,
    required this.color,
    required this.patternColor,
    required this.patternIcons,
    required this.characterAsset,
    required this.onTap,
    this.imageHeight = 130,     // Default height
    this.imageRightOffset = 10, // Default right margin
    this.imageBottomOffset = -10,
    this.cardHeight = 160.0,    // Default card height
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        height: cardHeight,
        width: double.infinity,
        decoration: BoxDecoration(
          color: color,
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.05),
              blurRadius: 10,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        clipBehavior: Clip.antiAlias,
        child: LayoutBuilder(
          builder: (context, constraints) {
            return Stack(
              children: [
                // Layer 1: Pattern
                ...List.generate(8, (index) {
                  final icon = patternIcons[index % patternIcons.length];
                  // Fixed positions for scattered look
                  final positions = [
                    const Offset(20, 80),
                    const Offset(100, 20),
                    const Offset(180, 70),
                    const Offset(250, 30),
                    const Offset(300, 100),
                    const Offset(60, 130),
                    const Offset(200, 140),
                    const Offset(320, 10),
                  ];
                  final pos = positions[index % positions.length];
                  
                  return Positioned(
                    left: pos.dx,
                    top: pos.dy,
                    child: Transform.rotate(
                      angle: (index * 0.5),
                      child: Icon(
                        icon,
                        size: 24 + (index % 3) * 10, // Varying sizes
                        color: patternColor,
                      ),
                    ),
                  );
                }),

                // Layer 2: Character Image (Adjusted size & margins)
                Positioned(
                  right: imageRightOffset, 
                  bottom: imageBottomOffset,
                  child: Image.asset(
                    characterAsset,
                    height: imageHeight, 
                    fit: BoxFit.contain,
                  ),
                ),

                // Layer 3: Text Content (Constrained width to 60%)
                Positioned(
                  left: 24,
                  top: 24,
                  width: constraints.maxWidth * 0.6, // Enforce 60% text width safe zone
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        title,
                        style: GoogleFonts.notoSansKr(
                          fontSize: 22,
                          fontWeight: FontWeight.w800,
                          color: const Color(0xFF1E2B4D),
                          height: 1.2,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        subtitle,
                        style: GoogleFonts.notoSansKr(
                          fontSize: 14,
                          color: Colors.black54,
                          fontWeight: FontWeight.w500,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            );
          }
        ),
      ),
    );
  }
}

class _SimpleMenuCard extends StatelessWidget {
  final String title;
  final String subtitle;
  final IconData icon;
  final Color color;
  final Color iconColor;
  final VoidCallback onTap;
  final BoxBorder? border;
  final bool isCompact;

  const _SimpleMenuCard({
    required this.title,
    required this.subtitle,
    required this.icon,
    required this.color,
    required this.iconColor,
    required this.onTap,
    this.border,
    this.isCompact = false,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        height: isCompact ? 100 : 120,
        width: double.infinity,
        decoration: BoxDecoration(
          color: color,
          borderRadius: BorderRadius.circular(20),
          border: border,
           boxShadow: border == null ? [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.03),
              blurRadius: 10,
              offset: const Offset(0, 4),
            ),
          ] : null,
        ),
        padding: const EdgeInsets.symmetric(horizontal: 24),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(16), // Increased from 12 (1.3x area -> approx 1.15x padding dimension)
              decoration: BoxDecoration(
                color: Colors.white.withValues(alpha: 0.6),
                shape: BoxShape.circle,
              ),
              child: Icon(icon, size: 30, color: iconColor), // Increased from 28
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: GoogleFonts.notoSansKr(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: const Color(0xFF1A1A2E),
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    subtitle,
                    style: GoogleFonts.notoSansKr(
                      fontSize: 13,
                      color: Colors.grey[700],
                      fontWeight: FontWeight.w500,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ),
            ),
            Icon(Icons.chevron_right_rounded, color: Colors.grey[400], size: 24),
          ],
        ),
      ),
    );
  }
}

=== lib\screens\community\popular_posts_screen.dart ===

import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class PopularPostsScreen extends StatelessWidget {
  const PopularPostsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    // Mock Data with Rank and Source
    final List<Map<String, dynamic>> popularPosts = [
      {
        'rank': 1,
        'source': '?먯쑀',
        'title': '?대쾲 異뺤젣 ?쇱씤???좎텧 ?대떎 ?뗣뀑??,
        'content': '吏꾩쭨硫??諛뺤씤??.. ?먯뒪???ㅻ뒗嫄?留욎쓬? ?ъ쭊 蹂대땲源?留욌뒗嫄?媛숈???,
        'likes': 120,
        'comments': 45,
        'image': true,
      },
      {
        'rank': 2,
        'source': '鍮꾨?',
        'title': '?붿쭅??C???섎━踰좎씠???덈Т ?먮┛ 嫄??꾨땲??',
        'content': '?섏뾽 10遺??꾩뿉 ?꾩갑?대룄 吏媛곹븿. ?닿굅 ?숆탳 痢≪뿉 嫄댁쓽 ?대뼸寃??섎깘',
        'likes': 85,
        'comments': 32,
        'image': false,
      },
      {
        'rank': 3,
        'source': '?ν꽣',
        'title': '?꾩씠?⑤뱶 ?꾨줈 5?몃? 湲됱쿂?⑸땲??(媛寃??대┝)',
        'content': '?곹깭 S湲됱씠怨??좏뵆耳???⑥븯?듬땲?? 荑④굅???ㅺ퀬 媛??,
        'likes': 64,
        'comments': 12,
        'image': true,
      },
      {
        'rank': 4,
        'source': '?뺣낫',
        'title': '?대쾲 ?숆린 轅援먯뼇 異붿쿇?댁???,
        'content': '?곹솕???댄빐 援먯닔??吏꾩쭨 泥쒖궗?? 怨쇱젣??轅?닿퀬 ?숈젏 ??二쇱떊??',
        'likes': 52,
        'comments': 28,
        'image': false,
      },
      {
        'rank': 5,
        'source': '?먯쑀',
        'title': '?ㅻ뒛 ?숈떇 硫붾돱 萸먯엫?',
        'content': '?덇퉴???섏샂? ?꾨땲硫?洹몃깷 諛뽰뿉??癒밴쾶',
        'likes': 45,
        'comments': 18,
        'image': false,
      },
    ];

    return Scaffold(
      appBar: AppBar(
        title: const Text('?뵦 ?ㅼ떆媛??멸린湲', style: TextStyle(fontWeight: FontWeight.bold)),
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
        elevation: 0,
      ),
      backgroundColor: Colors.white,
      body: Column(
        children: [
          // Header Banner
          Container(
            width: double.infinity,
            padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 20),
            color: const Color(0xFFFFF3E0), // Light Orange
            child: Row(
              children: [
                const Icon(Icons.emoji_events_rounded, color: Color(0xFFFF6F00), size: 24),
                const SizedBox(width: 12),
                Text(
                  '吏湲??숆탳?먯꽌 媛???ロ븳 ?댁빞湲? ?룇',
                  style: GoogleFonts.notoSansKr(
                    fontSize: 14,
                    fontWeight: FontWeight.bold,
                    color: const Color(0xFFE65100),
                  ),
                ),
              ],
            ),
          ),
          const Divider(height: 1, thickness: 1, color: Color(0xFFEEEEEE)),

          // List
          Expanded(
            child: ListView.separated(
              itemCount: popularPosts.length,
              separatorBuilder: (context, index) => const Divider(height: 1, color: Color(0xFFEEEEEE)),
              itemBuilder: (context, index) {
                final post = popularPosts[index];
                return _PopularPostItem(post: post);
              },
            ),
          ),
        ],
      ),
    );
  }
}

class _PopularPostItem extends StatelessWidget {
  final Map<String, dynamic> post;

  const _PopularPostItem({required this.post});

  @override
  Widget build(BuildContext context) {
    return Container(
      color: Colors.white,
      padding: const EdgeInsets.all(16),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Rank Badge
          _buildRankBadge(post['rank']),
          const SizedBox(width: 16),

          // Content
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Source & Title
                Row(
                  children: [
                    Text(
                      '[${post['source']}]',
                      style: GoogleFonts.notoSansKr(
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                        color: Colors.grey[600],
                      ),
                    ),
                    const SizedBox(width: 6),
                    Expanded(
                      child: Text(
                        post['title'],
                        style: GoogleFonts.notoSansKr(
                          fontSize: 15,
                          fontWeight: FontWeight.bold,
                          color: const Color(0xFF1A1A2E),
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 6),

                // Content Preview
                Text(
                  post['content'],
                  style: GoogleFonts.notoSansKr(
                    fontSize: 13,
                    color: Colors.grey[700],
                    height: 1.4,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 10),

                // Footer (Likes, Comments)
                Row(
                  children: [
                    Icon(Icons.thumb_up_alt_outlined, size: 14, color: Colors.red[400]),
                    const SizedBox(width: 4),
                    Text(
                      '${post['likes']}',
                      style: const TextStyle(fontSize: 12, color: Colors.red, fontWeight: FontWeight.bold),
                    ),
                    const SizedBox(width: 12),
                    Icon(Icons.comment_outlined, size: 14, color: Colors.blue[400]),
                    const SizedBox(width: 4),
                    Text(
                      '${post['comments']}',
                      style: const TextStyle(fontSize: 12, color: Colors.blue, fontWeight: FontWeight.bold),
                    ),
                  ],
                ),
              ],
            ),
          ),

          // Image Thumbnail (Optional)
          if (post['image']) 
            Container(
              margin: const EdgeInsets.only(left: 12),
              width: 60,
              height: 60,
              decoration: BoxDecoration(
                color: Colors.grey[200],
                borderRadius: BorderRadius.circular(8),
              ),
              child: const Icon(Icons.image, color: Colors.grey, size: 24),
            ),
        ],
      ),
    );
  }

  Widget _buildRankBadge(int rank) {
    Color color;
    Widget content;

    if (rank == 1) {
      color = const Color(0xFFFFD700); // Gold
      content = const Icon(Icons.emoji_events, color: Colors.white, size: 18);
    } else if (rank == 2) {
      color = const Color(0xFFC0C0C0); // Silver
      content = const Icon(Icons.emoji_events, color: Colors.white, size: 18);
    } else if (rank == 3) {
      color = const Color(0xFFCD7F32); // Bronze
      content = const Icon(Icons.emoji_events, color: Colors.white, size: 18);
    } else {
      color = Colors.grey[300]!;
      content = Text(
        '$rank',
        style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.white, fontSize: 14),
      );
    }

    return Container(
      width: 32,
      height: 32,
      decoration: BoxDecoration(
        color: color,
        shape: BoxShape.circle,
      ),
      alignment: Alignment.center,
      child: content,
    );
  }
}

=== lib\screens\diagnosis\consulting_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../providers/diagnosis_provider.dart';
import '../../models/diagnosis_model.dart';
import 'result_screen.dart';

class ConsultingScreen extends ConsumerStatefulWidget {
  const ConsultingScreen({super.key});

  @override
  ConsumerState<ConsultingScreen> createState() => _ConsultingScreenState();
}

class _ConsultingScreenState extends ConsumerState<ConsultingScreen> with SingleTickerProviderStateMixin {
  int _currentStep = 0;
  final int _totalSteps = 5; 
  late AnimationController _loadingController;
  
  bool _isOtherJob = false;
  final _otherJobController = TextEditingController();

  final List<String> _jobCategories = ["?쒕퉬??, "愿愿?, "臾댁뿭", "IT/湲곗닠", "留덉???, "援먯쑁", "?섎즺/肄붾뵒?ㅼ씠??, "湲고?"];
  final List<String> _locations = ["?쒖슱", "寃쎄린/?몄쿇", "遺??, "?援?, "???, "愿묒＜", "?곴??놁쓬"];
  
  // Accordion State for "Deep Depth Experience"
  final Map<String, bool> _isExpanded = {
    "?명꽩??: false,
    "?쒓컙??痍⑥뾽(?뚮컮)": false,
    "怨쇨굅 E-7 洹쇰Т": false,
  };
  // Text Controllers for "Other" Inputs
  final _internOtherController = TextEditingController();
  final _albaOtherController = TextEditingController();
  final _e7CodeController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _loadingController = AnimationController(vsync: this, duration: const Duration(seconds: 2))..repeat();
  }

  @override
  void dispose() {
    _loadingController.dispose();
    _otherJobController.dispose();
    _internOtherController.dispose();
    _albaOtherController.dispose();
    _e7CodeController.dispose();
    super.dispose();
  }

  void _nextStep() {
    setState(() => _currentStep++);
  }

  Future<void> _submit(bool useDocuments) async {
    showDialog(context: context, barrierDismissible: false, builder: (context) => _buildLoadingDialog(useDocuments));
    await ref.read(diagnosisProvider.notifier).analyze(useDocuments: useDocuments);
    if (mounted) {
      Navigator.pop(context);
      Navigator.pushReplacement(context, MaterialPageRoute(builder: (context) => const ResultScreen()));
    }
  }

  Widget _buildLoadingDialog(bool useDocuments) {
     return Dialog(
      backgroundColor: Colors.transparent,
      elevation: 0,
      child: Center(
        child: Container(
          padding: const EdgeInsets.all(30),
          decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20)),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
               RotationTransition(turns: _loadingController, child: Icon(useDocuments ? Icons.wallet : Icons.analytics, size: 60, color: Colors.indigo)),
               const SizedBox(height: 24),
               Text(useDocuments ? "?쒕쪟吏媛묒쓣\n?댁뼱蹂닿퀬 ?덉뼱??.." : "?ㅻЦ ?댁슜??諛뷀깢?쇰줈\n遺꾩꽍 以묒엯?덈떎...", textAlign: TextAlign.center, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            ],
          ),
        ),
      ),
    );
  }

  // Helper to toggle multi-select values
  void _toggleSelection(List<String> currentList, String value, Function(List<String>) onUpdate) {
    final newList = List<String>.from(currentList);
    if (newList.contains(value)) {
      newList.remove(value);
    } else {
      newList.add(value);
    }
    onUpdate(newList);
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text("荑좏떚諛붾씪 痍⑥뾽 而⑥꽕??),
        centerTitle: true,
        elevation: 0,
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
      ),
      body: Column(
        children: [
          LinearProgressIndicator(value: (_currentStep + 1) / (_totalSteps + 1), backgroundColor: Colors.grey[200], valueColor: const AlwaysStoppedAnimation(Colors.indigo)),
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(20),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.stretch,
                children: [
                  const SizedBox(height: 20),
                  // Persona
                  Center(child: Container(
                    width: 80, height: 80, 
                    decoration: BoxDecoration(color: Colors.indigo.withOpacity(0.1), shape: BoxShape.circle),
                    child: const Icon(Icons.person_pin, size: 40, color: Colors.indigo)
                  )),
                  const SizedBox(height: 16),
                  
                  // Question Bubble
                  Container(
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: Colors.indigo.withOpacity(0.05),
                      borderRadius: const BorderRadius.only(topRight: Radius.circular(20), bottomLeft: Radius.circular(20), bottomRight: Radius.circular(20)),
                    ),
                    child: Text(_getQuestionText(_currentStep), style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, height: 1.4), textAlign: TextAlign.center),
                  ),
                  const SizedBox(height: 30),

                  // Input Area
                  _buildInputArea(_currentStep),
                ],
              ),
            ),
          ),
          
          // Bottom Navigation
          if (_currentStep < 4)
          Padding(
            padding: const EdgeInsets.all(20),
            child: ElevatedButton(
              onPressed: _canProceed() ? _nextStep : null,
              style: ElevatedButton.styleFrom(
                minimumSize: const Size(double.infinity, 56),
                backgroundColor: Colors.indigo,
                disabledBackgroundColor: Colors.grey[300],
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
              ),
              child: const Text("?좏깮 ?꾨즺", style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
            ),
          )
        ],
      ),
    );
  }
  
  bool _canProceed() {
    final state = ref.read(diagnosisProvider);
    switch (_currentStep) {
      case 0: return state.answer.targetJobs.isNotEmpty;
      case 1: return state.answer.preferredLocations.isNotEmpty;
      case 2: return state.answer.koreanLevel.isNotEmpty;
      case 3: return true; 
      default: return true;
    }
  }

  String _getQuestionText(int step) {
    switch (step) {
      case 0: return "諛섍컩?듬땲?? 痍⑥뾽 而⑥꽕?댄듃 荑좏떚諛붾씪?낅땲??\n愿???덈뒗 遺꾩빞瑜?紐⑤몢 ?좏깮?댁＜?몄슂.";
      case 1: return "?대뒓 吏??뿉??洹쇰Т?섍린瑜?n?щ쭩?섏떆?섏슂?";
      case 2: return "?꾩옱 ?쒓뎅???ㅻ젰?\n?대뒓 ?뺣룄?쇨퀬 ?앷컖?섏떆?섏슂?";
      case 3: return "愿??寃쎈젰???덈떎硫??뚮젮二쇱꽭??\n(?녿떎硫?'?좏깮 ?꾨즺'瑜??뚮윭二쇱꽭??";
      case 4: return "留덉?留됱쑝濡? ?뺥솗??遺꾩꽍???꾪빐\n?쒕쪟吏媛묒쓣 ?뺤씤?대룄 ?좉퉴??";
      default: return "";
    }
  }

  Widget _buildInputArea(int step) {
    final notifier = ref.read(diagnosisProvider.notifier);
    final state = ref.watch(diagnosisProvider);

    switch (step) {
      case 0: // Job (Multi-select)
        return Column(
          children: [
            Wrap(
              spacing: 10, runSpacing: 10,
              alignment: WrapAlignment.center,
              children: _jobCategories.map((job) {
                final isSelected = state.answer.targetJobs.contains(job);
                return FilterChip(
                  label: Text(job),
                  selected: isSelected,
                  onSelected: (val) {
                     if (job == "湲고?" && val) {
                       setState(() => _isOtherJob = true);
                     } else if (job == "湲고?" && !val) {
                       setState(() => _isOtherJob = false);
                     }
                     _toggleSelection(state.answer.targetJobs, job, (l) => notifier.updateAnswer(state.answer.copyWith(targetJobs: l)));
                  },
                  selectedColor: Colors.indigo.withOpacity(0.2),
                  checkmarkColor: Colors.indigo,
                  labelStyle: TextStyle(color: isSelected ? Colors.indigo : Colors.black87, fontWeight: isSelected ? FontWeight.bold : FontWeight.normal),
                  backgroundColor: Colors.white,
                  side: BorderSide(color: isSelected ? Colors.indigo : Colors.grey[300]!),
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                );
              }).toList(),
            ),
            const SizedBox(height: 20),
            if (_isOtherJob) 
               TextField(
                 controller: _otherJobController,
                 decoration: InputDecoration(
                    labelText: "湲고? 吏곷Т ?낅젰",
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                    suffixIcon: IconButton(icon: const Icon(Icons.check), onPressed: () {
                         _toggleSelection(state.answer.targetJobs, _otherJobController.text, (l) => notifier.updateAnswer(state.answer.copyWith(targetJobs: l)));
                         _otherJobController.clear();
                    })
                 ),
               )
          ],
        );
      
      case 1: // Location (Multi-select)
        return Wrap(
          spacing: 10, runSpacing: 10,
          alignment: WrapAlignment.center,
          children: _locations.map((loc) {
            final isSelected = state.answer.preferredLocations.contains(loc);
            return FilterChip(
              label: Text(loc),
              selected: isSelected,
              onSelected: (_) => _toggleSelection(state.answer.preferredLocations, loc, (l) => notifier.updateAnswer(state.answer.copyWith(preferredLocations: l))),
              selectedColor: Colors.indigo.withOpacity(0.2),
              checkmarkColor: Colors.indigo,
              labelStyle: TextStyle(color: isSelected ? Colors.indigo : Colors.black87, fontWeight: isSelected ? FontWeight.bold : FontWeight.normal),
              backgroundColor: Colors.white,
              side: BorderSide(color: isSelected ? Colors.indigo : Colors.grey[300]!),
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
            );
          }).toList(),
        );

      case 2: // Korean
        final lvls = ["湲곗큹 (?몄궗留?", "?쇱긽?뚰솕 (?앸떦/留덊듃)", "鍮꾩쫰?덉뒪 (?좊줎 媛??", "?먯뼱誘??섏?"];
        return Column(children: lvls.map((l) => Padding(
          padding: const EdgeInsets.only(bottom: 8),
          child: _buildSelectableTile(l, state.answer.koreanLevel == l, () => notifier.updateAnswer(state.answer.copyWith(koreanLevel: l))),
        )).toList());

      case 3: // Experience (Sub-questions) + Other
      case 3: // Experience (Accordion Deep Depth)
        return Column(
          children: [
            _buildAccordionSection(
              "?명꽩??, 
              ["?щТ/?됱젙", "臾댁뿭/?좏넻", "IT/媛쒕컻", "湲고?"],
              notifier, state,
              _internOtherController,
            ),
            const SizedBox(height: 12),
            _buildAccordionSection(
              "?쒓컙??痍⑥뾽(?뚮컮)", 
              ["?앸떦/?쒕튃", "?듬쾲??, "?됱궗 蹂댁“", "湲고?"],
              notifier, state,
              _albaOtherController,
            ),
            const SizedBox(height: 12),
            _buildE7AccordionSection(notifier, state),
          ],
        );

      case 4: // Consent
        return Column(
          children: [
            ListTile(
               leading: const Icon(Icons.verified_user, size: 32, color: Colors.amber),
               title: const Text("?쒕쪟 寃利??덈궡"),
               subtitle: const Text("蹂댁쑀?섏떊 ?숈쐞/?댄븰?깆쟻???듯빐 媛?곗젏??諛쏆쓣 ???덉뒿?덈떎."),
               contentPadding: EdgeInsets.zero,
            ),
            const SizedBox(height: 20),
            Row(
              children: [
                // Yes (Left, Filled)
                Expanded(child: ElevatedButton(onPressed: () => _submit(true), style: ElevatedButton.styleFrom(backgroundColor: Colors.indigo, padding: const EdgeInsets.symmetric(vertical: 16)), child: const Text("?? ?쒕쪟 ?곕룞?좉쾶??, style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)))),
                const SizedBox(width: 12),
                // No (Right, Outlined)
                Expanded(child: OutlinedButton(onPressed: () => _submit(false), style: OutlinedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 16), foregroundColor: Colors.grey, side: const BorderSide(color: Colors.grey)), child: const Text("?꾨땲?? 愿쒖갖?꾩슂"))),
              ],
            )
          ],
        );

      default: return const SizedBox();
    }
  }
  
  Widget _buildSelectableTile(String text, bool isSelected, VoidCallback onTap) {
    return InkWell(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 20),
        decoration: BoxDecoration(
          color: isSelected ? Colors.indigo : Colors.white,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: isSelected ? Colors.indigo : Colors.grey[300]!),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(text, style: TextStyle(color: isSelected ? Colors.white : Colors.black, fontWeight: isSelected ? FontWeight.bold : FontWeight.normal)),
            if (isSelected) const Icon(Icons.check, color: Colors.white, size: 20),
          ],
        ),
      ),
    );
  }



  Widget _buildAccordionSection(
    String category, 
    List<String> options, 
    DiagnosisNotifier notifier, 
    DiagnosisState state,
    TextEditingController otherController,
  ) {
    bool isExpanded = _isExpanded[category] ?? false;
    // Count selected items in this category
    int selectedCount = state.answer.experiences.where((e) => e.category == category).length;

    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: isExpanded || selectedCount > 0 ? Colors.indigo : Colors.grey[200]!),
        boxShadow: isExpanded ? [BoxShadow(color: Colors.indigo.withOpacity(0.1), blurRadius: 8, offset: const Offset(0, 4))] : [],
      ),
      child: Column(
        children: [
          // Header
          InkWell(
            onTap: () => setState(() => _isExpanded[category] = !isExpanded),
            borderRadius: BorderRadius.circular(12),
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Row(
                    children: [
                      Text(category, style: TextStyle(
                        fontSize: 16, 
                        fontWeight: isExpanded || selectedCount > 0 ? FontWeight.bold : FontWeight.normal,
                        color: isExpanded || selectedCount > 0 ? Colors.indigo : Colors.black87
                      )),
                      if (selectedCount > 0)
                        Container(
                          margin: const EdgeInsets.only(left: 8),
                          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                          decoration: BoxDecoration(color: Colors.indigo, borderRadius: BorderRadius.circular(10)),
                          child: Text("$selectedCount", style: const TextStyle(color: Colors.white, fontSize: 10, fontWeight: FontWeight.bold)),
                        )
                    ],
                  ),
                  Icon(isExpanded ? Icons.keyboard_arrow_up : Icons.keyboard_arrow_down, color: Colors.grey),
                ],
              ),
            ),
          ),
          // Body (Animated)
          AnimatedCrossFade(
            firstChild: const SizedBox(width: double.infinity),
            secondChild: Padding(
              padding: const EdgeInsets.fromLTRB(16, 0, 16, 16),
              child: Column(
                children: [
                  const Divider(height: 1),
                  const SizedBox(height: 8),
                  ...options.map((option) {
                    final isSelected = state.answer.experiences.any((e) => e.category == category && e.detailType == option);
                    final isOther = option == "湲고?";

                    return Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        CheckboxListTile(
                          title: Text(option),
                          value: isSelected,
                          activeColor: Colors.indigo,
                          contentPadding: EdgeInsets.zero,
                          dense: true,
                          controlAffinity: ListTileControlAffinity.leading,
                          onChanged: (val) {
                             final exps = List<CareerExperience>.from(state.answer.experiences);
                             if (val == true) {
                               exps.add(CareerExperience(category: category, detailType: option, customInput: isOther ? otherController.text : null));
                             } else {
                               exps.removeWhere((e) => e.category == category && e.detailType == option);
                             }
                             notifier.updateAnswer(state.answer.copyWith(experiences: exps));
                          },
                        ),
                        // Other Input Animation
                        if (isOther && isSelected)
                          Padding(
                            padding: const EdgeInsets.only(left: 16, bottom: 8),
                            child: TextField(
                              controller: otherController,
                              decoration: const InputDecoration(
                                isDense: true,
                                hintText: "援ъ껜?곸씤 吏곷Т ?댁슜???낅젰?댁＜?몄슂",
                                border: UnderlineInputBorder(),
                              ),
                              onChanged: (text) {
                                // Update logic to save text in real-time or on submit
                                final exps = List<CareerExperience>.from(state.answer.experiences);
                                final index = exps.indexWhere((e) => e.category == category && e.detailType == "湲고?");
                                if (index != -1) {
                                  exps[index] = CareerExperience(category: category, detailType: "湲고?", customInput: text);
                                  notifier.updateAnswer(state.answer.copyWith(experiences: exps));
                                }
                              },
                            ),
                          )
                      ],
                    );
                  }),
                ],
              ),
            ),
            crossFadeState: isExpanded ? CrossFadeState.showSecond : CrossFadeState.showFirst,
            duration: const Duration(milliseconds: 300),
          )
        ],
      ),
    );
  }

  Widget _buildE7AccordionSection(DiagnosisNotifier notifier, DiagnosisState state) {
    const category = "怨쇨굅 E-7 洹쇰Т";
    bool isExpanded = _isExpanded[category] ?? false;
    bool hasData = state.answer.experiences.any((e) => e.category == category);

    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: isExpanded || hasData ? Colors.indigo : Colors.grey[200]!),
        boxShadow: isExpanded ? [BoxShadow(color: Colors.indigo.withOpacity(0.1), blurRadius: 8, offset: const Offset(0, 4))] : [],
      ),
      child: Column(
        children: [
          InkWell(
            onTap: () => setState(() => _isExpanded[category] = !isExpanded),
            borderRadius: BorderRadius.circular(12),
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                   Row(
                    children: [
                      Text(category, style: TextStyle(fontSize: 16, fontWeight: isExpanded || hasData ? FontWeight.bold : FontWeight.normal, color: isExpanded || hasData ? Colors.indigo : Colors.black87)),
                      if (hasData) const Padding(padding: EdgeInsets.only(left:8), child: Icon(Icons.check_circle, size: 16, color: Colors.indigo))
                    ],
                   ),
                   Icon(isExpanded ? Icons.keyboard_arrow_up : Icons.keyboard_arrow_down, color: Colors.grey),
                ],
              ),
            ),
          ),
          if (isExpanded)
            Padding(
              padding: const EdgeInsets.fromLTRB(16, 0, 16, 16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Divider(height: 1),
                  const SizedBox(height: 12),
                  const Text("吏곸쥌 肄붾뱶 (4?먮━) ?먮뒗 吏곸쥌紐낆쓣 ?낅젰?댁＜?몄슂.", style: TextStyle(fontSize: 13, color: Colors.grey)),
                  const SizedBox(height: 8),
                  Row(
                    children: [
                      Expanded(
                        child: TextField(
                          controller: _e7CodeController,
                          decoration: InputDecoration(
                            hintText: "?? 2351, 湲곌퀎怨듯븰",
                            isDense: true,
                            border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                            contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
                          ),
                        ),
                      ),
                      const SizedBox(width: 8),
                      ElevatedButton(
                        onPressed: () {
                           if (_e7CodeController.text.isNotEmpty) {
                             final exps = List<CareerExperience>.from(state.answer.experiences);
                             // Remove existing E7 if any to replace
                             exps.removeWhere((e) => e.category == category);
                             exps.add(CareerExperience(category: category, detailType: "E-7", customInput: _e7CodeController.text));
                             notifier.updateAnswer(state.answer.copyWith(experiences: exps));
                             setState(() => _isExpanded[category] = false); // Auto close on save
                           }
                        },
                        style: ElevatedButton.styleFrom(backgroundColor: Colors.indigo, padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12)),
                        child: const Text("???, style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                      )
                    ],
                  ),
                  if (hasData)
                    Padding(
                      padding: const EdgeInsets.only(top: 12),
                      child: Text("?낅젰?? ${state.answer.experiences.firstWhere((e) => e.category == category).customInput}", style: const TextStyle(color: Colors.indigo, fontWeight: FontWeight.bold)),
                    )
                ],
              ),
            )
        ],
      )
    );
  }
}

=== lib\screens\diagnosis\diagnosis_screen.dart ===
import 'package:flutter/material.dart';
import 'consulting_screen.dart';

class DiagnosisScreen extends StatelessWidget {
  const DiagnosisScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Text("This screen is deprecated."),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () {
                Navigator.pushReplacement(
                  context,
                  MaterialPageRoute(builder: (context) => const ConsultingScreen()),
                );
              },
              child: const Text("Go to New Diagnosis"),
            ),
          ],
        ),
      ),
    );
  }
}

=== lib\screens\diagnosis\result_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'dart:math';
import 'package:fl_chart/fl_chart.dart';
import '../../providers/diagnosis_provider.dart';
import '../../models/diagnosis_model.dart';

class ResultScreen extends ConsumerWidget {
  const ResultScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final state = ref.watch(diagnosisProvider);
    final result = state.result ?? DiagnosisResult.empty();
    
    // Sort: Green -> Yellow -> Red
    final jobResultList = result.analysisResults.values.toList()
      ..sort((a, b) => a.visaStatus.index.compareTo(b.visaStatus.index));

    if (jobResultList.isEmpty) {
      return const Scaffold(body: Center(child: Text("遺꾩꽍 寃곌낵媛 ?놁뒿?덈떎.")));
    }

    final totalTabs = 1 + jobResultList.length;

    return DefaultTabController(
      length: totalTabs,
      child: Scaffold(
        backgroundColor: Colors.white,
        appBar: AppBar(
          title: const Text("吏꾨떒 寃곌낵 由ы룷??),
          centerTitle: true,
          backgroundColor: Colors.white,
          foregroundColor: Colors.black,
          elevation: 0,
          leading: IconButton(icon: const Icon(Icons.close), onPressed: () => Navigator.pop(context)),
          bottom: TabBar(
            isScrollable: true,
            labelColor: Colors.indigo,
            unselectedLabelColor: Colors.grey,
            indicatorColor: Colors.indigo,
            tabAlignment: TabAlignment.startOffset,
            tabs: [
              // 1. Total Score Tab
              const Tab(
                child: Row(
                  children: [
                    Icon(Icons.star, color: Colors.amber),
                    SizedBox(width: 8),
                    Text("醫낇빀 ??웾"),
                  ],
                ),
              ),
              // 2. Job Tabs
              ...jobResultList.map((job) {
                 return Tab(
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                         Icon(_getStatusIcon(job.visaStatus), size: 16, color: _getStatusColor(job.visaStatus)),
                         const SizedBox(width: 8),
                         Text("${job.jobName} (${job.jobCode})"),
                      ],
                    ),
                 );
              }),
            ],
          ),
        ),
        body: TabBarView(
          children: [
            // View A: Total Score
            // View A: Total Score
            _buildTotalResultView(context, result),
            // View B: Job Details
            ...jobResultList.map((jobData) => _buildJobDetailView(context, jobData, result.solutionDocs)),
          ],
        ),
      ),
    );
  }

  Widget _buildTotalResultView(BuildContext context, DiagnosisResult result) {
    // 1. Prepare Donut Chart Data
    final double score = result.totalScore.toDouble();
    final double remaining = 100 - score;
    
    // Calculate section values for display
    final int valLang = (score * 0.4).round();
    final int valExp = (score * 0.3).round();
    final int valMajor = (score * 0.3).round();

    // 2. Prepare Radar Data (5 Axes)
    final primary = result.primary;
    Map<String, int> my5Scores = {};
    Map<String, int> avg5Scores = {};
    
    if (primary != null) {
      my5Scores = {
        "?몄뼱": primary.myScores["?몄뼱"] ?? 0,
        "?꾧났": primary.myScores["?꾨Ц??] ?? 0,
        "寃쎈젰": primary.myScores["寃쎈젰"] ?? 0,
        "?먭꺽": primary.myScores["?깆떎??] ?? 0,
        "臾명솕": primary.myScores["?쒓뎅?댄빐"] ?? 0,
      };
      avg5Scores = {
        "?몄뼱": primary.avgScores["?몄뼱"] ?? 80,
        "?꾧났": primary.avgScores["?꾨Ц??] ?? 80,
        "寃쎈젰": primary.avgScores["寃쎈젰"] ?? 70,
        "?먭꺽": primary.avgScores["?깆떎??] ?? 70,
        "臾명솕": primary.avgScores["?쒓뎅?댄빐"] ?? 70,
      };
    }

    // 3. AI Comment Logic
    String advice = "紐⑤뱺 ??웾??洹좏삎 ?≫??덉뒿?덈떎!";
    String bestJobName = primary?.jobName ?? "IT ?꾨Ц媛";
    
    if (my5Scores.isNotEmpty) {
       var sortedEntries = my5Scores.entries.toList()..sort((a, b) => a.value.compareTo(b.value));
       var weakest = sortedEntries.first;
       
       switch(weakest.key) {
         case "?몄뼱": advice = "?섏?留?**?쒓뎅???λ젰**??議곌툑 ??蹂댁셿?섎㈃ ?⑷꺽瑜좎씠 湲됱긽?뱁븷 嫄곗삁??"; break;
         case "?꾧났": advice = "?섏?留?**?꾧났 愿???숈젏**?대굹 ?꾨줈?앺듃 寃쏀뿕?????댄븘?대낫?몄슂!"; break;
         case "寃쎈젰": advice = "?섏?留?愿??**?명꽩??寃쎈젰**????踰????볥뒗 寃껋쓣 異붿쿇?댁슂!"; break;
         case "?먭꺽": advice = "?섏?留?**吏곷Т 愿???먭꺽利?*?대굹 ?깆떎?깆쓣 利앸챸???쒕쪟瑜?梨숆꺼蹂댁꽭??"; break;
         case "臾명솕": advice = "?섏?留?**?쒓뎅 臾명솕 ?댄빐??*瑜??믪씠???쒕룞(遊됱궗 ?????꾩?????嫄곗삁??"; break;
       }
    }

    return SingleChildScrollView(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const SizedBox(height: 10),
          // -----------------------------------------------------------------
          // 1. Comprehensive Donut Chart
          // -----------------------------------------------------------------
          Center(
            child: SizedBox(
              height: 220,
              child: Stack(
                children: [
                   PieChart(
                     PieChartData(
                       sectionsSpace: 4,
                       centerSpaceRadius: 70,
                       startDegreeOffset: 270,
                       sections: [
                         PieChartSectionData(color: Colors.indigo, value: valLang.toDouble(), radius: 20, showTitle: false),
                         PieChartSectionData(color: Colors.teal, value: valExp.toDouble(), radius: 20, showTitle: false),
                         PieChartSectionData(color: Colors.orange, value: valMajor.toDouble(), radius: 20, showTitle: false),
                         if (remaining > 0)
                           PieChartSectionData(color: Colors.grey[200], value: remaining, radius: 15, showTitle: false),
                       ],
                     ),
                   ),
                   Center(
                     child: Column(
                       mainAxisSize: MainAxisSize.min,
                       children: [
                         Text(
                           "${result.totalScore}", 
                           style: const TextStyle(fontSize: 42, fontWeight: FontWeight.bold, color: Colors.indigo)
                         ),
                         const Text("??/ 100", style: TextStyle(fontSize: 14, color: Colors.grey)),
                         const SizedBox(height: 4),
                         Container(
                           padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 3),
                           decoration: BoxDecoration(color: Colors.amber, borderRadius: BorderRadius.circular(12)),
                           child: Text(result.totalTier, style: const TextStyle(color: Colors.white, fontSize: 12, fontWeight: FontWeight.bold)),
                         )
                       ],
                     ),
                   ),
                ],
              ),
            ),
          ),
          const SizedBox(height: 20),
          
          // Chart Legend
          Container(
            padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 16),
            decoration: BoxDecoration(
              color: Colors.grey[50], 
              borderRadius: BorderRadius.circular(12),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceAround,
              children: [
                _buildLegendItem(Colors.indigo, "?쒓뎅??, valLang),
                _buildLegendItem(Colors.teal, "?ㅻТ寃쎈젰", valExp),
                _buildLegendItem(Colors.orange, "?꾧났/?먭꺽", valMajor),
              ],
            ),
          ),
          const SizedBox(height: 40),

          // -----------------------------------------------------------------
          // 2. Job Suitability Ranking
          // -----------------------------------------------------------------
          const Text("?룇 吏곷Т蹂?留ㅼ묶 ?먯닔", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          const SizedBox(height: 16),
          ...result.analysisResults.values.map((job) {
             double avg = job.myScores.values.reduce((a, b) => a + b) / 5;
             double displayScore = avg.clamp(0, 100);
             
             return Padding(
               padding: const EdgeInsets.only(bottom: 12.0),
               child: Column(
                 crossAxisAlignment: CrossAxisAlignment.start,
                 children: [
                   Row(
                     mainAxisAlignment: MainAxisAlignment.spaceBetween,
                     children: [
                       Text("${job.jobName} (${job.jobCode})", style: const TextStyle(fontWeight: FontWeight.w600)),
                       Text("${displayScore.toInt()}??, style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.indigo)),
                     ],
                   ),
                   const SizedBox(height: 6),
                   ClipRRect(
                     borderRadius: BorderRadius.circular(4),
                     child: LinearProgressIndicator(
                       value: displayScore / 100,
                       backgroundColor: Colors.grey[200],
                       color: _getStatusColor(job.visaStatus),
                       minHeight: 8,
                     ),
                   ),
                 ],
               ),
             );
          }),
          const SizedBox(height: 40),

          // -----------------------------------------------------------------
          // 3. 5-Axis Radar Chart
          // -----------------------------------------------------------------
          const Text("?뱤 湲곗큹 ??웾 遺꾩꽍 (5? ?붿냼)", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          const SizedBox(height: 20),
          if (my5Scores.isNotEmpty)
             SizedBox(
               height: 300,
               width: double.infinity,
               child: CustomPaint(
                 painter: RadarChartPainter(my5Scores, avg5Scores),
               ),
             ),
          
          const SizedBox(height: 30),

          // -----------------------------------------------------------------
          // 4. AI Consultant Comment
          // -----------------------------------------------------------------
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: const Color(0xFFF3E5F5), // Lavender Light
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: Colors.purple.withOpacity(0.2)),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Icon(Icons.auto_awesome, color: Colors.purple, size: 20),
                    SizedBox(width: 8),
                    Text("AI 而⑥꽕?댄듃 ?쒕쭏??, style: TextStyle(fontWeight: FontWeight.bold, color: Colors.purple, fontSize: 16)),
                  ],
                ),
                const SizedBox(height: 12),
                Text.rich(
                  TextSpan(
                    children: [
                      const TextSpan(text: "?꾩옱 遺꾩꽍 寃곌낵, "),
                      TextSpan(
                        text: bestJobName, 
                        style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.black87)
                      ),
                      const TextSpan(text: " 吏곷Т媛 媛???곹빀??蹂댁엯?덈떎.\n"),
                      TextSpan(text: advice),
                    ],
                    style: const TextStyle(fontSize: 14, height: 1.6, color: Colors.black87),
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 40),

          // -----------------------------------------------------------------
          // 5. Action Buttons
          // -----------------------------------------------------------------
          SizedBox(
            width: double.infinity,
            height: 56,
            child: ElevatedButton.icon(
              onPressed: () => Navigator.pop(context),
              icon: const Icon(Icons.work, color: Colors.white),
              label: const Text("留욎땄 怨듦퀬 蹂대윭媛湲?, style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white)),
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.indigo,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
              ),
            ),
          ),
          const SizedBox(height: 12),
          SizedBox(
            width: double.infinity,
            height: 56,
            child: TextButton.icon(
              onPressed: () => debugPrint(">>> [?대┃] 寃곌낵 怨듭쑀?섍린"),
              icon: const Icon(Icons.share, color: Colors.grey),
              label: const Text("寃곌낵 怨듭쑀?섍린", style: TextStyle(fontSize: 16, color: Colors.grey)),
            ),
          ),
          const SizedBox(height: 20),
        ],
      ),
    );
  }

  Widget _buildLegendItem(Color color, String label, int score) {
    return Row(
      children: [
        Container(width: 12, height: 12, decoration: BoxDecoration(color: color, shape: BoxShape.circle)),
        const SizedBox(width: 6),
        Text(label, style: const TextStyle(fontSize: 12, color: Colors.black54)),
        const SizedBox(width: 4),
        Text("$score??, style: const TextStyle(fontSize: 13, fontWeight: FontWeight.bold, color: Colors.black87)),
      ],
    );
  }


  Widget _buildJobDetailView(BuildContext context, JobAnalysisData data, List<String> docs) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // 1. Header Card
          // 1. Header Card
          const Text("鍮꾩옄 諛쒓툒 ?붽굔 異⑹” ?щ?", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.black87)),
          const SizedBox(height: 8),
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              color: _getStatusColor(data.visaStatus).withOpacity(0.1),
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: _getStatusColor(data.visaStatus)),
            ),
            child: Row(
              children: [
                 Icon(_getStatusIcon(data.visaStatus), size: 40, color: _getStatusColor(data.visaStatus)),
                 const SizedBox(width: 16),
                 Expanded(
                   child: Column(
                     crossAxisAlignment: CrossAxisAlignment.start,
                     children: [
                       Text(data.jobCode, style: TextStyle(color: _getStatusColor(data.visaStatus), fontWeight: FontWeight.bold)),
                       Text(data.jobName, style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                       Text(_getStatusMessage(data.visaStatus), style: TextStyle(fontSize: 12, color: _getStatusColor(data.visaStatus))),
                     ],
                   ),
                 )
              ],
            ),
          ),
          const SizedBox(height: 30),

          // 2. Benchmarking Radar Chart
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("?⑷꺽???됯퇏 鍮꾧탳 遺꾩꽍", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.black87)),
              Row(
                children: [
                  _legendItem(Colors.blue, "???먯닔"),
                  const SizedBox(width: 12),
                  // Lavender Legend
                  _legendItem(Colors.purple, "?⑷꺽???됯퇏", isDashed: false),
                ],
              ),
            ],
          ),
          const SizedBox(height: 20),
          SizedBox(
            height: 300,
            width: double.infinity,
            child: CustomPaint(
              painter: RadarChartPainter(data.myScores, data.avgScores),
            ),
          ),
          
          const SizedBox(height: 30),

          // 3. Info & Salary
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(color: Colors.grey[50], borderRadius: BorderRadius.circular(12)),
            child: Row(
               mainAxisAlignment: MainAxisAlignment.spaceBetween,
               children: [
                  const Text("?낃퀎 ?좎엯 ?됯퇏 ?곕큺", style: TextStyle(color: Colors.grey)),
                  Text(data.avgSalary, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
               ],
            ),
          ),
          const SizedBox(height: 40),

          // 4. Action
          ElevatedButton(
            onPressed: () {},
            style: ElevatedButton.styleFrom(
              minimumSize: const Size(double.infinity, 56),
              backgroundColor: Colors.indigo,
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16))
            ),
            child: const Text("?곸꽭 由ы룷???뺤씤?섍린", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
          ),
        ],
      ),
    );
  }
  
  Widget _legendItem(Color color, String text, {bool isDashed = false}) {
    return Row(
      children: [
        Container(
          width: 12, height: 12, 
          decoration: BoxDecoration(color: isDashed ? Colors.transparent : color, border: isDashed ? Border.all(color: color) : null, shape: BoxShape.circle)
        ),
        const SizedBox(width: 4),
        Text(text, style: const TextStyle(fontSize: 12, color: Colors.grey)),
      ],
    );
  }

  Color _getStatusColor(VisaStatus status) {
    switch (status) {
      case VisaStatus.GREEN: return Colors.green;
      case VisaStatus.YELLOW: return Colors.orange;
      case VisaStatus.RED: return Colors.red;
    }
  }
  
  IconData _getStatusIcon(VisaStatus status) {
    switch (status) {
      case VisaStatus.GREEN: return Icons.check_circle;
      case VisaStatus.YELLOW: return Icons.warning;
      case VisaStatus.RED: return Icons.cancel;
    }
  }

  String _getStatusMessage(VisaStatus status) {
    switch (status) {
      case VisaStatus.GREEN: return "諛쒓툒 媛?μ꽦??留ㅼ슦 ?믪뒿?덈떎!";
      case VisaStatus.YELLOW: return "?쇰? ?붽굔 蹂댁셿???꾩슂?⑸땲??";
      case VisaStatus.RED: return "?꾩옱濡쒖꽌??諛쒓툒???대졄?듬땲??";
    }
  }
}

// ---------------------------------------------------------------------------
// 5-Axis Benchmarking Radar Chart
// ---------------------------------------------------------------------------
class RadarChartPainter extends CustomPainter {
  final Map<String, int> myScores;
  final Map<String, int> avgScores;

  RadarChartPainter(this.myScores, this.avgScores);

  @override
  void paint(Canvas canvas, Size size) {
    final centerX = size.width / 2;
    final centerY = size.height / 2;
    final radius = min(centerX, centerY) * 0.8;
    
    // Grid
    final paintGrid = Paint()..color = Colors.grey[200]!..style = PaintingStyle.stroke;
    final keys = myScores.keys.toList();
    final angleStep = (2 * pi) / keys.length;

    for (int i = 1; i <= 5; i++) {
        double r = radius * (i / 5);
        _drawPolygon(canvas, centerX, centerY, r, keys.length, angleStep, paintGrid);
    }
    
    // Axes
    for(int j=0; j<keys.length; j++) {
        double angle = j * angleStep - (pi / 2);
        canvas.drawLine(Offset(centerX, centerY), Offset(centerX + radius * cos(angle), centerY + radius * sin(angle)), paintGrid);
    }

    // Average Score (Lavender, Solid Border)
    final paintAvg = Paint()
      ..color = Colors.purpleAccent.withOpacity(0.2) // Lavender Fill
      ..style = PaintingStyle.fill;
    
    final paintAvgBorder = Paint()
      ..color = Colors.purple // Solid Purple Border
      ..style = PaintingStyle.stroke
      ..strokeWidth = 2.0;

    _drawDataPolygon(canvas, centerX, centerY, radius, angleStep, keys, avgScores, paintAvg, borderPaint: paintAvgBorder);

    // My Score (Blue Fill)
    final paintMy = Paint()..color = Colors.blue.withOpacity(0.4)..style = PaintingStyle.fill;
    final paintMyBorder = Paint()..color = Colors.blue..style = PaintingStyle.stroke..strokeWidth = 2;
    _drawDataPolygon(canvas, centerX, centerY, radius, angleStep, keys, myScores, paintMy, borderPaint: paintMyBorder);
    
    // Labels
    _drawLabels(canvas, centerX, centerY, radius, angleStep, keys);
  }

  void _drawPolygon(Canvas canvas, double cx, double cy, double r, int sides, double step, Paint paint) {
    Path path = Path();
    for (int i = 0; i < sides; i++) {
      double angle = i * step - (pi / 2);
      double x = cx + r * cos(angle);
      double y = cy + r * sin(angle);
      if (i == 0) {
        path.moveTo(x, y);
      } else {
        path.lineTo(x, y);
      }
    }
    path.close();
    canvas.drawPath(path, paint);
  }

  void _drawDataPolygon(Canvas canvas, double cx, double cy, double r, double step, List<String> keys, Map<String, int> scores, Paint paint, {Paint? borderPaint}) {
    Path path = Path();
    for (int i = 0; i < keys.length; i++) {
      double val = (scores[keys[i]] ?? 0) / 100.0;
      double angle = i * step - (pi / 2);
      double x = cx + r * val * cos(angle);
      double y = cy + r * val * sin(angle);
      if (i == 0) {
        path.moveTo(x, y);
      } else {
        path.lineTo(x, y);
      }
    }
    path.close();
    canvas.drawPath(path, paint); // Fill
    if (borderPaint != null) canvas.drawPath(path, borderPaint); // Border
  }
  
  void _drawLabels(Canvas canvas, double cx, double cy, double r, double step, List<String> keys) {
     final tp = TextPainter(textDirection: TextDirection.ltr);
     for (int i = 0; i < keys.length; i++) {
        double angle = i * step - (pi / 2);
        double x = cx + (r + 20) * cos(angle);
        double y = cy + (r + 20) * sin(angle);
        tp.text = TextSpan(text: keys[i], style: const TextStyle(color: Colors.black, fontSize: 12, fontWeight: FontWeight.bold));
        tp.layout();
        tp.paint(canvas, Offset(x - tp.width/2, y - tp.height/2));
     }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
}

=== lib\screens\diagnosis\survey_screen.dart ===
import 'package:flutter/material.dart';

class SurveyScreen extends StatelessWidget {
  const SurveyScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return const Scaffold(
      body: Center(
        child: Text("This screen is deprecated. Please use ConsultingScreen."),
      ),
    );
  }
}

=== lib\screens\home\home_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'home_view_model.dart';
import '../../providers/home_view_provider.dart';
import '../jobs/jobs_home_screen.dart';
import 'widgets/home_header_v2.dart';
import 'widgets/home_menu_grid.dart';
import 'widgets/schedule_list.dart';
import 'widgets/character_section.dart';
import 'widgets/community_section.dart';
import '../schedule/schedule_screen.dart';
import 'widgets/fortune_cookie_widget.dart';

class HomeScreen extends ConsumerStatefulWidget {
  const HomeScreen({super.key});

  @override
  ConsumerState<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends ConsumerState<HomeScreen> with SingleTickerProviderStateMixin {
  late final AnimationController _controller;
  late final Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2000), // Relaxed breathing (2s)
    )..repeat(reverse: true);

    _scaleAnimation = Tween<double>(begin: 1.0, end: 1.03).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // Note: In ConsumerState, ref is available directly as a property
    final state = ref.watch(homeViewModelProvider);

    // View Switching Logic
    if (ref.watch(homeViewProvider) == 'job') {
       return Container(
        color: Colors.white, // Job Screen Background
        width: double.infinity,
        height: double.infinity,
        child: const SafeArea(
          bottom: false,
          child: JobHomeScreen(),
        ),
      );
    }

    // Default Dashboard View
    return Container(
      width: double.infinity,
      height: double.infinity,
      decoration: const BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [
            Color(0xFFFFFEF5), // Bright Ivory
            Color(0xFFFFE4C4), // Warm Apricot/Beige
          ],
        ),
      ),
      // Modified SafeArea: bottom=false allows the white sheet to extend to the very bottom device edge
      child: SafeArea(
        bottom: false, 
        child: RefreshIndicator(
          onRefresh: () async {
            ref.read(homeViewModelProvider.notifier).refresh();
          },
          child: CustomScrollView(
            physics: const AlwaysScrollableScrollPhysics(),
            slivers: [
              SliverFillRemaining(
                hasScrollBody: false,
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.start,
                  children: [
                    const Padding(
                      padding: EdgeInsets.fromLTRB(20, 5, 12, 0),
                      child: HomeHeader(),
                    ),
                    const HomeMenuGrid(),
                    
                    // Flexible Gap 1
                    const Spacer(flex: 2),

                    // [Character Hero Section]
                    // Removed ScheduleList and Shadow from here to separate them
                    SizedBox(
                      height: 300, 
                      child: ScaleTransition(
                        scale: _scaleAnimation,
                        child: Stack(
                          alignment: Alignment.topCenter,
                          clipBehavior: Clip.none,
                          children: [
                            // Character (Centered)
                            Positioned(
                              bottom: 0,
                              left: 0,
                              right: 0,
                              child: const IgnorePointer(
                                child: CharacterSection(),
                              ),
                            ),
                            // Speech Bubble (Above Character)
                            Positioned(
                              top: 30, 
                              left: 0,
                              right: 0,
                              child: Center(
                                child: Column(
                                  children: [
                                    Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                                      decoration: BoxDecoration(
                                        color: Colors.white,
                                        borderRadius: BorderRadius.circular(20),
                                        boxShadow: [
                                          BoxShadow(
                                            color: Colors.black.withValues(alpha: 0.1),
                                            blurRadius: 4,
                                            offset: const Offset(0, 2),
                                          ),
                                        ],
                                      ),
                                      child: const Text(
                                        "?ㅻ뒛???섎궡! ??",
                                        style: TextStyle(
                                          fontSize: 14,
                                          fontWeight: FontWeight.w600,
                                          color: Colors.black87,
                                        ),
                                      ),
                                    ),
                                    // Optional Triangle Tail
                                    CustomPaint(
                                      painter: _TrianglePainter(Colors.white),
                                      size: const Size(12, 8),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                            // Fortune Cookie (Character's Right Hand -> Screen Left)
                            Positioned(
                              bottom: 110, 
                              right: 80,   
                              child: const FortuneCookieWidget(),
                            ),
                          ],
                        ),
                      ),
                    ),

                    // Flexible Gap 2
                    const Spacer(flex: 1),

                    // [Status Message Card] (ScheduleList)
                    // Moved out of Stack to be a standalone element
                    Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 20),
                      child: GestureDetector(
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(builder: (context) => const ScheduleScreen()),
                          );
                        },
                        child: const ScheduleList(),
                      ),
                    ),

                    // Flexible Gap 3
                    const Spacer(flex: 1),

                    // [Community Section] - FULL WIDTH SHEET
                    const CommunitySection(),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _TrianglePainter extends CustomPainter {
  final Color color;

  _TrianglePainter(this.color);

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = color
      ..style = PaintingStyle.fill;

    final path = Path();
    path.moveTo(0, 0);
    path.lineTo(size.width / 2, size.height);
    path.lineTo(size.width, 0);
    path.close();

    canvas.drawPath(path, paint);
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => false;
}

=== lib\screens\home\home_view_model.dart ===
import 'dart:math';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../config/app_assets.dart';
import '../../models/schedule_item.dart';
import '../../models/community_post.dart';
import '../../services/mock_home_repository.dart'; // Keep for provider access? Or change later
import '../../services/home_repository.dart'; // Import Interface

// State class
class HomeState {
  final bool isLoading;
  final List<ScheduleItem> schedule;
  final List<CommunityPost> posts;
  final String characterImage;
  final String? error;

  HomeState({
    this.isLoading = true,
    this.schedule = const [],
    this.posts = const [],
    required this.characterImage,
    this.error,
  });

  HomeState copyWith({
    bool? isLoading,
    List<ScheduleItem>? schedule,
    List<CommunityPost>? posts,
    String? characterImage,
    String? error,
  }) {
    return HomeState(
      isLoading: isLoading ?? this.isLoading,
      schedule: schedule ?? this.schedule,
      posts: posts ?? this.posts,
      characterImage: characterImage ?? this.characterImage,
      error: error ?? this.error,
    );
  }
}

// ViewModel
class HomeViewModel extends StateNotifier<HomeState> {
  final HomeRepository _repository; // Use interface, not implementation class

  HomeViewModel(this._repository)
      : super(HomeState(characterImage: AppAssets.capyFortuneHold)) {
    _loadData();
  }

  Future<void> _loadData() async {
    try {
      state = state.copyWith(isLoading: true, error: null);
      
      final schedule = await _repository.fetchDailySchedule();
      final posts = await _repository.fetchPopularPosts();

      state = state.copyWith(
        isLoading: false,
        schedule: schedule,
        posts: posts,
      );
    } catch (e) {
      state = state.copyWith(
        isLoading: false,
        error: "Failed to load data",
        characterImage: AppAssets.capyBow, // Error state image
      );
    }
  }

  void refresh() {
    _updateCharacterImage();
    _loadData();
  }

  void _updateCharacterImage() {
    final random = Random();
    final newImage = AppAssets.randomPoses[random.nextInt(AppAssets.randomPoses.length)];
    state = state.copyWith(characterImage: newImage);
  }
}

final homeViewModelProvider = StateNotifierProvider<HomeViewModel, HomeState>((ref) {
  final repository = ref.watch(homeRepositoryProvider);
  return HomeViewModel(repository);
});

=== lib\screens\home\providers\home_providers.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../services/api_service.dart';
import '../../../../services/home_repository.dart';
import '../../../../services/home_repository_impl.dart';
import '../../../../services/mock_home_repository.dart';
import '../../../../models/schedule_item.dart';
import '../../../../models/community_post.dart';

// [Configuration]
// Set to false to use real API
const bool useMock = true;

// [Repository Provider]
final homeRepositoryProvider = Provider<HomeRepository>((ref) {
  if (useMock) {
    return MockHomeRepository();
  } else {
    // In a real app, you might want to provide ApiService via a provider too
    // final apiService = ref.watch(apiServiceProvider);
    return HomeRepositoryImpl(apiService: ApiService());
  }
});

// [Data Providers]

// 1. Schedule Requests
final scheduleListProvider = FutureProvider<List<ScheduleItem>>((ref) async {
  final repository = ref.watch(homeRepositoryProvider);
  return repository.fetchDailySchedule();
});

// 2. Community Posts Requests
final communityPostsProvider = FutureProvider<List<CommunityPost>>((ref) async {
  final repository = ref.watch(homeRepositoryProvider);
  return repository.fetchPopularPosts();
});

=== lib\screens\home\widgets\character_section.dart ===
import 'package:flutter/material.dart';

class CharacterSection extends StatelessWidget {
  const CharacterSection({super.key});

  @override
  Widget build(BuildContext context) {
    return Align(
      alignment: Alignment.bottomCenter,
      child: Stack(
        alignment: Alignment.bottomCenter,
        children: [
          // Shadow
          Container(
            width: MediaQuery.of(context).size.width * 0.35,
            height: 12,
            margin: const EdgeInsets.only(bottom: 2),
            decoration: BoxDecoration(
              borderRadius: const BorderRadius.all(Radius.elliptical(100, 12)),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.15),
                  blurRadius: 10,
                  spreadRadius: 2,
                ),
              ],
            ),
          ),
          // Character Image
          Image.asset(
            'assets/images/capy_happy.png',
            width: MediaQuery.of(context).size.width * 0.45,
            fit: BoxFit.contain,
          ),
        ],
      ),
    );
  }
}

=== lib\screens\home\widgets\community_section.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import '../../community/community_main_screen.dart';
import '../../community/community_feed_screen.dart';
import '../../community/board_list_screen.dart';
import '../../community/popular_posts_screen.dart';

class CommunitySection extends StatelessWidget {
  const CommunitySection({super.key});

  @override
  Widget build(BuildContext context) {
    // [Community Section] - FULL WIDTH SHEET
    return Container(
      width: double.infinity, // Key: Full Width
      margin: EdgeInsets.zero, // Key: No Margins
      padding: const EdgeInsets.fromLTRB(0, 12, 0, 20), // Reduced bottom padding
      decoration: const BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.vertical(top: Radius.circular(30)), // Key: Top Radius Only
      ),
      child: SafeArea(
        top: false, 
        child: Column(
          children: [
            // Header
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 24),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    '而ㅻ??덊떚',
                    style: GoogleFonts.notoSansKr(
                      fontSize: 15, // Reduced from 16
                      fontWeight: FontWeight.bold,
                      color: const Color(0xFF1A1A2E),
                    ),
                  ),
                  GestureDetector(
                    onTap: () {
                      Navigator.push(
                        context,
                        MaterialPageRoute(builder: (context) => const CommunityMainScreen()),
                      );
                    },
                    child: Text(
                      '?붾낫湲?, 
                      style: GoogleFonts.notoSansKr(
                        fontSize: 11, // Reduced from 12
                        color: Colors.grey,
                        fontWeight: FontWeight.w700,
                      ),
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 6), // Tight gap (8->6)
            // Horizontal List
            SizedBox(
              height: 100, // Increased height (1.4x)
              child: ListView.separated(
                scrollDirection: Axis.horizontal,
                padding: const EdgeInsets.symmetric(horizontal: 24),
                itemCount: 3,
                separatorBuilder: (context, index) => const SizedBox(width: 8), // Gap 12->8
                itemBuilder: (context, index) {
                  // Determine Content based on Index
                  String tag;
                  String title;
                  String subtitle;
                  Color tagColor;
                  Color tagTextColor;

                  if (index == 0) {
                    tag = "?뵦 ?멸린湲";
                    title = "?섍컯?좎껌 轅??";
                    subtitle = "?깃났?섏뀲?섏슂? ???..";
                    tagColor = const Color(0xFFFFF3E0);
                    tagTextColor = Colors.orange;
                  } else if (index == 1) {
                    tag = "?뮕 ?뺣낫";
                    title = "?ㅻ뒛 ?숈떇 異붿쿇";
                    subtitle = "留쏆엳?붽굅 萸??섏샂?";
                    tagColor = const Color(0xFFFFF9C4);
                    tagTextColor = const Color(0xFFFBC02D);
                  } else {
                    tag = "?뿣截??먯쑀";
                    title = "?ъ떖???щ엺 ?쒕（?";
                    subtitle = "??꾩쨾??..";
                    tagColor = const Color(0xFFE3F2FD);
                    tagTextColor = const Color(0xFF1976D2);
                  }

                  return Container(
                    width: 190, // Slightly narrower
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: const Color(0xFFEEEEEE)),
                    ),
                    child: Material(
                      color: const Color(0xFFF9F9F9),
                      borderRadius: BorderRadius.circular(12),
                      clipBehavior: Clip.hardEdge,
                      child: InkWell(
                        onTap: () {
                          if (index == 0) {
                            // Popular -> Leading to PopularPostsScreen
                            Navigator.push(
                              context,
                              MaterialPageRoute(builder: (context) => const PopularPostsScreen()),
                            );
                          } else if (index == 1) {
                             // Info -> Leading to BoardListScreen (List)
                            Navigator.push(
                              context,
                              MaterialPageRoute(builder: (context) => const BoardListScreen(title: '轅???뺣낫寃뚯떆??)),
                            );
                          } else {
                            // Free/Other -> Leading to CommunityFeedScreen (Feed)
                            Navigator.push(
                              context,
                              MaterialPageRoute(builder: (context) => const CommunityFeedScreen()),
                            );
                          }
                        },
                        child: Container(
                          padding: const EdgeInsets.symmetric(vertical: 6, horizontal: 10), // Tight Padding
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Container(
                                padding: const EdgeInsets.symmetric(horizontal: 4, vertical: 1),
                                decoration: BoxDecoration(
                                  color: tagColor,
                                  borderRadius: BorderRadius.circular(4),
                                ),
                                child: Text(
                                  tag,
                                  style: GoogleFonts.notoSansKr(fontSize: 8, fontWeight: FontWeight.bold, color: tagTextColor),
                                ),
                              ),
                              const SizedBox(height: 3), // Gap 4->3
                              Text(
                                title,
                                maxLines: 1,
                                overflow: TextOverflow.ellipsis,
                                style: GoogleFonts.notoSansKr(
                                  fontSize: 12, // 13->12
                                  fontWeight: FontWeight.bold,
                                  color: const Color(0xFF1A1A2E),
                                ),
                              ),
                              const SizedBox(height: 1), // Gap 2->1
                              Text(
                                subtitle,
                                maxLines: 1,
                                overflow: TextOverflow.ellipsis,
                                style: GoogleFonts.notoSansKr(
                                  fontSize: 10, // 11->10
                                  color: const Color(0xFF9E9E9E),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  );
                },
              ),
            ),
            // NO Bottom Spacing - Removed SizedBox
          ],
        ),
      ),
    );
  }
}

=== lib\screens\home\widgets\fortune_cookie_dialog.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../providers/point_provider.dart';
import '../../../../providers/fortune_provider.dart';

class FortuneCookieDialog extends ConsumerStatefulWidget {
  const FortuneCookieDialog({super.key});

  @override
  ConsumerState<FortuneCookieDialog> createState() => _FortuneCookieDialogState();
}

class _FortuneCookieDialogState extends ConsumerState<FortuneCookieDialog> {
  bool _isRevealed = false;
  String? _fortuneMessage;
  int? _points;

  @override
  Widget build(BuildContext context) {
    return Dialog(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Image.asset('assets/images/item_fortune_cookie.png', width: 100, height: 100),
            const SizedBox(height: 20),
            
            if (!_isRevealed) ...[
              // Step 1: Open Prompt
              const Text(
                "?ㅻ뒛???ъ텣荑좏궎 ?쪧",
                style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 10),
              const Text(
                "?ㅻ뒛???댁꽭瑜??뺤씤?섍퀬\n?ъ씤?몃? 諛쏆븘蹂댁꽭??",
                textAlign: TextAlign.center,
                style: TextStyle(color: Colors.grey, height: 1.5),
              ),
              const SizedBox(height: 20),
              ElevatedButton(
                onPressed: () async {
                  // Trigger Open Logic
                  final result = await ref.read(fortuneProvider.notifier).openCookie();
                  
                  // Earn Points
                  ref.read(pointProvider.notifier).earnPoints(result.points, "?ъ텣荑좏궎 ?댁꽭 ?뺤씤! ?쪧");

                  setState(() {
                    _isRevealed = true;
                    _fortuneMessage = result.message;
                    _points = result.points;
                  });
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF8B5CF6),
                  padding: const EdgeInsets.symmetric(horizontal: 40, vertical: 12),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                ),
                child: const Text("?댁꽭 ?뺤씤?섍린", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
              ),
            ] else ...[
              // Step 2: Result Reveal
              Text(
                "$_points""P ?곷┰ ?꾨즺! ?뮥",
                style: const TextStyle(fontSize: 22, fontWeight: FontWeight.bold, color: Color(0xFF8B5CF6)),
              ),
              const SizedBox(height: 16),
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: const Color(0xFFF3F4F6),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Text(
                  _fortuneMessage!,
                  textAlign: TextAlign.center,
                  style: const TextStyle(fontSize: 16, color: Color(0xFF1A1A2E), fontWeight: FontWeight.w600, height: 1.4),
                ),
              ),
              const SizedBox(height: 20),
              ElevatedButton(
                onPressed: () {
                  Navigator.pop(context); // Close
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFFE5E7EB),
                  foregroundColor: Colors.black87,
                  elevation: 0,
                  padding: const EdgeInsets.symmetric(horizontal: 40, vertical: 12),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                ),
                child: const Text("?뺤씤", style: TextStyle(fontWeight: FontWeight.bold)),
              ),
            ],
          ],
        ),
      ),
    );
  }
}

=== lib\screens\home\widgets\fortune_cookie_widget.dart ===
import 'package:flutter/material.dart';
import 'fortune_cookie_dialog.dart';

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../providers/fortune_provider.dart';

class FortuneCookieWidget extends ConsumerWidget {
  const FortuneCookieWidget({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return GestureDetector(
      onTap: () {
        final hasOpened = ref.read(fortuneProvider);

        if (hasOpened) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text("?ㅻ뒛???됱슫? ?대? 諛쏆쑝?⑥뼱?? ?댁씪 ??留뚮굹???뙔"),
              duration: Duration(seconds: 2),
            ),
          );
        } else {
          // Open Intro Dialog (Logic handled inside dialog)
          showDialog(
            context: context,
            barrierDismissible: false, // Force flow
            builder: (context) => const FortuneCookieDialog(),
          );
        }
      },
      onLongPress: () {
         // Developer Reset Feature
         ref.read(fortuneProvider.notifier).reset();
         ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text("媛쒕컻??紐⑤뱶: ?댁꽭 湲고쉶媛 珥덇린?붾릺?덉뒿?덈떎! ?봽")),
         );
      },
      child: Container(
        width: 60,
        height: 60,
        decoration: const BoxDecoration(
          shape: BoxShape.circle,
        ),
        child: Image.asset(
          'assets/images/item_fortune_cookie.png',
          fit: BoxFit.contain,
        ),
      ),
    );
  }
}

=== lib\screens\home\widgets\home_bottom_nav_bar.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../providers/nav_provider.dart';
import '../../../../providers/home_view_provider.dart';

class HomeBottomNavBar extends ConsumerWidget {
  const HomeBottomNavBar({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final currentIndex = ref.watch(bottomNavIndexProvider);

    return BottomNavigationBar(
      type: BottomNavigationBarType.fixed,
      selectedItemColor: const Color(0xFF1E2B4D),
      unselectedItemColor: Colors.grey,
      selectedLabelStyle: GoogleFonts.notoSansKr(fontWeight: FontWeight.w700),
      unselectedLabelStyle: GoogleFonts.notoSansKr(fontWeight: FontWeight.w700),
      showUnselectedLabels: true,
      items: const [
        BottomNavigationBarItem(icon: Icon(Icons.store), label: 'Shop'),
        BottomNavigationBarItem(icon: Icon(Icons.home), label: 'Home'),
        BottomNavigationBarItem(icon: Icon(Icons.person), label: 'My'),
      ],
      currentIndex: currentIndex,
      onTap: (index) {
        // Logic: If tapping 'Home' (1) while already on 'Home' (1), reset view to dashboard
        if (index == 1 && currentIndex == 1) {
           ref.read(homeViewProvider.notifier).state = 'dashboard';
        }
        
        ref.read(bottomNavIndexProvider.notifier).state = index;
      },
    );
  }
}

=== lib\screens\home\widgets\home_header_v2.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../providers/point_provider.dart';
import '../../wallet/my_point_screen.dart';

class HomeHeader extends ConsumerWidget {
  const HomeHeader({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Watch precise point value from PointProvider
    final pointState = ref.watch(pointProvider);
    final points = pointState.totalBalance;

    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        // Logo
        Text(
          'CUTY',
          style: GoogleFonts.poppins(
            fontSize: 28, // Adjusted size
            fontWeight: FontWeight.w900,
            color: const Color(0xFF1A1A2E),
            letterSpacing: -0.5,
          ),
        ),

        // Point Display & Notification
        Row(
          children: [
              GestureDetector(
               onTap: () {
                 Navigator.push(
                   context,
                   MaterialPageRoute(builder: (context) => const MyPointScreen()),
                 );
               },
               child: Container(
                 padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                 decoration: BoxDecoration(
                   color: Colors.white,
                   borderRadius: BorderRadius.circular(20),
                   boxShadow: [
                     BoxShadow(
                       color: Colors.black.withOpacity(0.05),
                       blurRadius: 4,
                       offset: const Offset(0, 2),
                     )
                   ],
                   border: Border.all(color: Colors.grey.shade200),
                 ),
                 child: Row(
                   mainAxisSize: MainAxisSize.min,
                   children: [
                     const Text("?뮥"), 
                     const SizedBox(width: 4),
                     Text(
                       "$points P", 
                       style: GoogleFonts.notoSansKr(
                         fontSize: 13, 
                         fontWeight: FontWeight.bold,
                         color: const Color(0xFF1A1A2E),
                       )
                     ),
                   ],
                 ),
               ),
             ),
             const SizedBox(width: 12),
             
             // Notification Bell
             GestureDetector(
              onTap: () {
                debugPrint('?뚮┝ ?대┃??);
              },
              child: const Icon(
                Icons.notifications_none_rounded,
                size: 28,
                color: Color(0xFF1A1A2E),
              ),
            ),
          ],
        ),
      ],
    );
  }
}

=== lib\screens\home\widgets\home_menu_grid.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../providers/home_view_provider.dart';
import '../../visa/visa_screen_wrapper.dart';
import '../../spec/spec_wallet_screen.dart';
import '../../academic/academic_main_screen.dart';
import '../../schedule/schedule_screen.dart';
import '../../community/community_main_screen.dart';


class HomeMenuGrid extends StatelessWidget {
  const HomeMenuGrid({super.key});

  @override
  Widget build(BuildContext context) {
    // Define menu items
    final List<Map<String, dynamic>> menuItems = [
      {
        'label': '鍮꾩옄',
        'icon': Icons.public_outlined,
        'bg': const Color(0xFFE1F5FE), // Light Blue
        'iconColor': const Color(0xFF0277BD), // Deep Blue
      },
      {
        'label': '而ㅻ??덊떚',
        'icon': Icons.chat_bubble_outline_rounded,
        'bg': const Color(0xFFE1F5FE), // Same as Visa (Primary Blue Light)
        'iconColor': const Color(0xFF0277BD), // Same as Visa (Primary Blue Deep)
      },
      {
        'label': '?쒕쪟吏媛?,
        'icon': Icons.wallet_outlined,
        'bg': const Color(0xFFFFF9C4), // Light Yellow
        'iconColor': const Color(0xFFF57F17), // Deep Yellow/Orange
      },
      {
        'label': '?뚮컮/痍⑥뾽',
        'icon': Icons.work_outline,
        'bg': const Color(0xFFE0F2F1), // Light Mint
        'iconColor': const Color(0xFF00695C), // Deep Teal
      },
      {
        'label': '?쒓컙??,
        'icon': Icons.calendar_today_outlined,
        'bg': const Color(0xFFE3F2FD), // Light Blue
        'iconColor': const Color(0xFF1565C0), // Deep Blue
      },
      {
        'label': '?숈궗?뺣낫',
        'icon': Icons.school_outlined,
        'bg': const Color(0xFFF3E5F5), // Light Purple
        'iconColor': const Color(0xFF6A1B9A), // Deep Purple
        'isPreparing': true,
      },
      {
        'label': '留쏆쭛',
        'icon': Icons.restaurant_menu,
        'bg': const Color(0xFFFFE0B2), // Light Orange
        'iconColor': const Color(0xFFEF6C00), // Deep Orange
        'isPreparing': true,
      },
    ];

    return SingleChildScrollView(
      scrollDirection: Axis.horizontal,
      padding: const EdgeInsets.only(left: 20, right: 20, top: 20, bottom: 20), // Increased padding
      child: Row(
        children: [
          for (int i = 0; i < menuItems.length; i++) ...[
            _MenuCard(
              icon: menuItems[i]['icon'] as IconData,
              label: menuItems[i]['label'] as String,
              backgroundColor: menuItems[i]['bg'] as Color,
              iconColor: menuItems[i]['iconColor'] as Color,
              isPreparing: menuItems[i]['isPreparing'] ?? false,
            ),
            if (i < menuItems.length - 1) const SizedBox(width: 16), // Increased spacing
          ],
        ],
      ),
    );
  }
}


class _MenuCard extends ConsumerWidget {
  final IconData icon;
  final String label;
  final Color backgroundColor;
  final Color iconColor;
  final bool isPreparing;

  const _MenuCard({
    required this.icon,
    required this.label,
    required this.backgroundColor,
    required this.iconColor,
    this.isPreparing = false,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Container(
      width: 72, // Increased from 60
      height: 90, // Increased from 74
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.05),
            blurRadius: 8,
            offset: const Offset(0, 3),
          ),
        ],
      ),
      child: Material(
        color: Colors.transparent,
        borderRadius: BorderRadius.circular(20),
        clipBehavior: Clip.hardEdge,
        child: InkWell(
          onTap: isPreparing
              ? null
              : () {
                  debugPrint('$label 硫붾돱 ?대┃??);
                  switch (label) {
                    case '鍮꾩옄':
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                            builder: (context) => const VisaScreenWrapper()),
                      );
                      break;
                    case '?쒕쪟吏媛?:
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                            builder: (context) => const SpecWalletScreen()),
                      );
                      break;
                    case '?뚮컮/痍⑥뾽':
                      ref.read(homeViewProvider.notifier).state = 'job';
                      break;
                    case '?숈궗?뺣낫':
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                            builder: (context) => const AcademicMainScreen()),
                      );
                      break;
                    case '?쒓컙??:
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                            builder: (context) => const ScheduleScreen()),
                      );
                      break;
                    case '而ㅻ??덊떚':
                      Navigator.push(
                        context,
                        MaterialPageRoute(
                            builder: (context) => const CommunityMainScreen()),
                      );
                      break;
                    case '留쏆쭛':
                      // Matjib no screen request, keeping log
                      break;
                  }
                },
          child: Stack(
            alignment: Alignment.center,
            children: [
              Padding(
                padding: const EdgeInsets.symmetric(vertical: 10, horizontal: 4),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Container(
                      width: 48, // Increased from 38
                      height: 40, // Increased from 34
                      decoration: BoxDecoration(
                        color: backgroundColor,
                        borderRadius: BorderRadius.circular(14),
                      ),
                      alignment: Alignment.center,
                      child: Icon(icon, color: iconColor, size: 24), // Increased size
                    ),
                    const SizedBox(height: 6), // Increased spacing
                    Text(
                      label,
                      style: GoogleFonts.notoSansKr(
                        fontSize: 12, // Increased from 10
                        fontWeight: FontWeight.w700,
                        color: const Color(0xFF1A1A2E),
                      ),
                      textAlign: TextAlign.center,
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
              if (isPreparing)
                Positioned.fill(
                  child: Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.6),
                      borderRadius: BorderRadius.circular(20),
                    ),
                    alignment: Alignment.center,
                    child: Text(
                      "以鍮꾩쨷",
                      style: GoogleFonts.notoSansKr(
                        fontSize: 12,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }
}


=== lib\screens\home\widgets\schedule_card.dart ===
import 'package:flutter/material.dart';
import '../../../../models/schedule_item.dart';

class ScheduleCard extends StatelessWidget {
  final ScheduleItem item;

  const ScheduleCard({super.key, required this.item});

  @override
  Widget build(BuildContext context) {
    return Container(
      width: double.infinity,
      margin: const EdgeInsets.symmetric(horizontal: 20),
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.08),
            blurRadius: 16,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: const Color(0xFFF3E5F5), // Light Purple
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Icon(Icons.access_time_filled_rounded, color: Color(0xFF8B5CF6)),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  item.title,
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                    color: Color(0xFF1A1A2E),
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  item.subtitle,
                  style: TextStyle(
                    fontSize: 14,
                    color: Colors.grey.shade600,
                  ),
                ),
              ],
            ),
          ),
          Text(
            item.time,
            style: const TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.bold,
              color: Color(0xFF8B5CF6),
            ),
          ),
        ],
      ),
    );
  }
}

=== lib\screens\home\widgets\schedule_list.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../providers/schedule_provider.dart';
import '../../../../models/schedule_item.dart';
import 'schedule_card.dart';

class ScheduleList extends ConsumerWidget {
  const ScheduleList({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // 1. Get next class from ScheduleProvider
    final notifier = ref.watch(scheduleProvider.notifier);
    final nextClass = notifier.getNextClass();

    // 2. Map to UI Model (ScheduleItem)
    // If title is empty, it means 'No Class' or 'End of Day'
    // If title is empty, it means 'No Class' or 'End of Day'
    if (nextClass?.title.isEmpty ?? true) {
        return ScheduleCard(item: ScheduleItem(
          title: "?ㅻ뒛 ?섏뾽 ?? ?럦",
          time: "--:--",
          subtitle: "???ъ꽭??",
        ));
    }

    final displayItem = ScheduleItem(
      title: nextClass?.title ?? '?섏뾽 ?놁쓬',
      time: "${nextClass?.startTime ?? 9}:00", // Convert int hour to string time
      subtitle: nextClass?.classroom ?? '', // Room maps to subtitle
    );

    return ScheduleCard(item: displayItem);
  }
}

=== lib\screens\home\widgets\speech_bubble_widget.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class SpeechBubbleWidget extends StatelessWidget {
  final String message;
  final VoidCallback? onTap;

  const SpeechBubbleWidget({
    super.key, 
    required this.message,
    this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () {
        debugPrint('留먰뭾???대┃??);
        onTap?.call();
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
        margin: const EdgeInsets.only(bottom: 0), // Tail space handled by shape
        decoration: ShapeDecoration(
          color: Colors.white,
          shape: const _SpeechBubbleBorder(),
          shadows: [
            BoxShadow(
              color: Colors.black.withOpacity(0.05),
              blurRadius: 10,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Text(
          message,
          style: GoogleFonts.notoSansKr(
            fontSize: 15,
            fontWeight: FontWeight.bold,
            color: const Color(0xFF1A1A2E), // Dark Navy
          ),
        ),
      ),
    );
  }
}

class _SpeechBubbleBorder extends ShapeBorder {
  final double tailWidth = 20.0;
  final double tailHeight = 10.0;
  final double radius = 24.0;

  const _SpeechBubbleBorder();

  @override
  EdgeInsetsGeometry get dimensions => EdgeInsets.only(bottom: tailHeight);

  @override
  Path getInnerPath(Rect rect, {TextDirection? textDirection}) {
    return getOuterPath(rect, textDirection: textDirection);
  }

  @override
  Path getOuterPath(Rect rect, {TextDirection? textDirection}) {
    final r = Rect.fromLTWH(rect.left, rect.top, rect.width, rect.height - tailHeight);
    
    return Path()
      ..addRRect(RRect.fromRectAndRadius(r, Radius.circular(radius)))
      ..moveTo(r.center.dx - tailWidth / 2, r.bottom)
      ..lineTo(r.center.dx, rect.bottom)
      ..lineTo(r.center.dx + tailWidth / 2, r.bottom)
      ..close();
  }

  @override
  void paint(Canvas canvas, Rect rect, {TextDirection? textDirection}) {}

  @override
  ShapeBorder scale(double t) => this;
}

=== lib\screens\jobs\jobs_home_screen.dart ===
import 'package:flutter/material.dart';

import 'widgets/job_app_bar.dart';
import 'widgets/job_category_tab.dart';
import 'widgets/promotion_banner.dart';
import 'widgets/career_tab_content.dart';
import 'widgets/job_filter_chips.dart';
import 'widgets/job_list_view.dart';


import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'providers/job_providers.dart';

class JobHomeScreen extends ConsumerWidget {
  const JobHomeScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final jobsAsyncValue = ref.watch(jobListProvider);
    final tabIndex = ref.watch(selectedJobCategoryProvider);

    return Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          const JobAppBar(),
        Expanded(
          child: SingleChildScrollView(
            child: Column(
              children: [
                const JobCategoryTab(),
                const SizedBox(height: 20),
                Consumer(
                  builder: (context, ref, child) {
                    final tabIndex = ref.watch(selectedJobCategoryProvider);
                    return PromotionBanner(key: ValueKey(tabIndex));
                  },
                ),
                if (tabIndex == 1)
                  const CareerTabContent()
                else
                  Column(
                    children: [
                      const SizedBox(height: 16),
                      const JobFilterChips(),
                      const SizedBox(height: 16),

                      // Job List Section with State Handling
                      jobsAsyncValue.when(
                        data: (jobs) {
                          if (jobs.isEmpty) {
                            return const Padding(
                              padding: EdgeInsets.only(top: 50, bottom: 50),
                              child: Column(
                                children: [
                                  Icon(Icons.work_off, size: 48, color: Colors.grey),
                                  SizedBox(height: 16),
                                  Text(
                                    "?깅줉??怨듦퀬媛 ?놁뼱??,
                                    style: TextStyle(
                                      fontSize: 16,
                                      color: Colors.grey,
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                                ],
                              ),
                            );
                          }
                          return JobListView(jobs: jobs);
                        },
                        error: (err, stack) => Padding(
                          padding: const EdgeInsets.all(20),
                          child: Center(child: Text('?ㅻ쪟媛 諛쒖깮?덉뒿?덈떎: $err')),
                        ),
                        loading: () => const _JobListSkeleton(),
                      ),
                    ],
                  ),
              ],
            ),
          ),
        ),
      ],
      ),
    );
  }
}

class _JobListSkeleton extends StatelessWidget {
  const _JobListSkeleton();

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            width: 120,
            height: 24,
            color: Colors.grey[200],
          ),
          const SizedBox(height: 16),
          ListView.separated(
            physics: const NeverScrollableScrollPhysics(),
            shrinkWrap: true,
            itemCount: 3,
            separatorBuilder: (_, __) => const SizedBox(height: 12),
            itemBuilder: (_, __) => Container(
              height: 100,
              decoration: BoxDecoration(
                color: Colors.grey[100],
                borderRadius: BorderRadius.circular(16),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

=== lib\screens\jobs\job_detail_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../models/job_post.dart';
import 'providers/job_providers.dart';

class JobDetailScreen extends ConsumerWidget {
  final JobPost job;

  const JobDetailScreen({super.key, required this.job});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final theme = ref.watch(jobThemeProvider);

    return Scaffold(
      body: Stack(
        children: [
          CustomScrollView(
            slivers: [
              // 1. Top Image Section with SliverAppBar
              SliverAppBar(
                expandedHeight: 280.0,
                pinned: true,
                backgroundColor: Colors.transparent, // Or valid color when collapsed
                flexibleSpace: FlexibleSpaceBar(
                  background: Stack(
                    fit: StackFit.expand,
                    children: [
                      // Background Image
                      // Background Image
                      Image.network(
                        'https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=1000&auto=format&fit=crop',
                        fit: BoxFit.cover,
                        loadingBuilder: (context, child, loadingProgress) {
                          if (loadingProgress == null) return child;
                          return Container(
                            color: Colors.grey[300],
                            child: const Center(child: CircularProgressIndicator()),
                          );
                        },
                        errorBuilder: (context, error, stackTrace) {
                           return Container(
                             color: Colors.grey[300],
                             child: const Center(child: Icon(Icons.coffee, size: 64, color: Colors.grey)),
                           );
                        },
                      ),
                      // Dark Gradient Overlay
                      Container(
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            begin: Alignment.topCenter,
                            end: Alignment.bottomCenter,
                            colors: [
                              Colors.transparent,
                              Colors.black.withValues(alpha: 0.8),
                            ],
                            stops: const [0.6, 1.0],
                          ),
                        ),
                      ),
                      // Content Overlay
                      Positioned(
                        left: 20,
                        right: 20,
                        bottom: 30,
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Text(
                              job.title,
                              style: const TextStyle(
                                color: Colors.white,
                                fontSize: 28,
                                fontWeight: FontWeight.bold,
                                height: 1.2,
                              ),
                            ),
                            const SizedBox(height: 12),
                            Row(
                              children: job.tags.map((tag) {
                                final isVisa = tag.contains('鍮꾩옄');
                                return Container(
                                  margin: const EdgeInsets.only(right: 8),
                                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                                  decoration: BoxDecoration(
                                    color: isVisa ? theme.primaryColor : Colors.white.withValues(alpha: 0.3),
                                    borderRadius: BorderRadius.circular(20),
                                  ),
                                  child: Text(
                                    tag,
                                    style: const TextStyle(
                                      color: Colors.white,
                                      fontSize: 14,
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                );
                              }).toList(),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
                leading: IconButton(
                  icon: const Icon(Icons.arrow_back_ios_new_rounded, color: Colors.white),
                  onPressed: () => Navigator.pop(context),
                ),
              ),

              // 2. Body Content
              SliverToBoxAdapter(
                child: Padding(
                  padding: const EdgeInsets.all(24.0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Job Info & Map
                      // Job Info & Map
                      Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                _buildInfoRow(Icons.monetization_on_rounded, '?쒓툒 10,000??, 
                                  isHighlight: true, highlightColor: const Color(0xFF26A69A), fontSize: 20),
                                const SizedBox(height: 12),
                                _buildInfoRow(Icons.timer_rounded, '????湲?18:00 - 22:00'),
                                const SizedBox(height: 12),
                                _buildInfoRow(Icons.translate_rounded, '?쒓뎅?? TOPIK 3湲됤넁'),
                                const SizedBox(height: 12),
                                _buildInfoRow(Icons.local_fire_department_rounded, '留덇컧 D-33', color: Colors.deepOrange),
                              ],
                            ),
                          ),
                          const SizedBox(width: 16),
                          // Map Thumbnail
                          Container(
                            height: 100,
                            width: 90,
                            decoration: BoxDecoration(
                              color: Colors.grey[200],
                              borderRadius: BorderRadius.circular(12),
                              border: Border.all(color: Colors.grey[300]!),
                            ),
                            child: ClipRRect(
                              borderRadius: BorderRadius.circular(12),
                              child: Stack(
                                children: [
                                  const Center(child: Icon(Icons.map, color: Colors.grey)),
                                  // Simulated Path
                                  Positioned(
                                    top: 30, left: 35,
                                    child: Icon(Icons.location_on, color: theme.primaryColor, size: 28),
                                  ),
                                  Positioned(
                                    bottom: 0, left: 0, right: 0,
                                    child: Container(
                                      color: Colors.white.withValues(alpha: 0.8),
                                      padding: const EdgeInsets.symmetric(vertical: 4),
                                      child: const Text('2km', textAlign: TextAlign.center, style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold)),
                                    ),
                                  )
                                ],
                              ),
                            ),
                          ),
                        ],
                      ),

                      const SizedBox(height: 32),

                      // CUTY Special Section
                      Container(
                        width: double.infinity,
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: theme.primaryColor.withValues(alpha: 0.1),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: theme.primaryColor.withValues(alpha: 0.2)),
                        ),
                        child: Column(
                          children: [
                             Row(
                               mainAxisAlignment: MainAxisAlignment.center,
                               children: [
                                 const Text('??', style: TextStyle(fontSize: 18)),
                                 const SizedBox(width: 8),
                                 Text(
                                   '?쒓컙??痍⑥뾽 ?덇?, CUTY媛 ?꾩??쒕젮??',
                                   style: const TextStyle(
                                     fontSize: 15,
                                     fontWeight: FontWeight.bold,
                                     color: Color(0xFF1A1A2E), // Navy
                                   ),
                                 ),
                               ],
                             ),
                             const SizedBox(height: 20),
                             Row(
                               mainAxisAlignment: MainAxisAlignment.spaceBetween,
                               crossAxisAlignment: CrossAxisAlignment.start,
                               children: [
                                 Expanded(child: _buildStepItem(Icons.description_outlined, '???꾩옄怨꾩빟\n?먮룞?꾩꽦')),
                                 Padding(
                                   padding: const EdgeInsets.only(top: 15),
                                   child: Icon(Icons.arrow_forward_rounded, color: Colors.grey[400], size: 16),
                                 ),
                                 Expanded(child: _buildStepItem(Icons.mark_email_read_outlined, '???숆탳 ?뱀씤\n硫붿씪 諛쒖넚')),
                                 Padding(
                                   padding: const EdgeInsets.only(top: 15),
                                   child: Icon(Icons.arrow_forward_rounded, color: Colors.grey[400], size: 16),
                                 ),
                                 Expanded(child: _buildStepItem(Icons.assignment_turned_in_outlined, '???섏씠肄붾━??n?쒖텧 媛?대뱶')),
                               ],
                             ),
                             const SizedBox(height: 16),
                             Container(
                               padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                               decoration: BoxDecoration(
                                 color: Colors.white,
                                 borderRadius: BorderRadius.circular(8),
                                 border: Border.all(color: Colors.grey[200]!),
                               ),
                               child: const Text(
                                 '?⑷꺽 ?? ?깆뿉???꾩옄怨꾩빟 諛??숆탳 ?좎껌???먯뒪?깆쑝濡?吏?먰빐??',
                                 style: TextStyle(fontSize: 12, color: Colors.black87, fontWeight: FontWeight.w600),
                                 textAlign: TextAlign.center,
                               ),
                             ),
                          ],
                        ),
                      ),
                      
                      const SizedBox(height: 32),
                      const Divider(thickness: 1, color: Colors.grey),
                      const SizedBox(height: 24),
                      
                      // Detailed Description
                      Text(
                        '?곸꽭 ?붽컯',
                        style: Theme.of(context).textTheme.titleMedium?.copyWith(
                          fontWeight: FontWeight.bold,
                          fontSize: 18,
                        ),
                      ),
                      const SizedBox(height: 16),
                      const Text(
                        '???移댄럹?먯꽌 諛앷퀬 ?깆떎??二쇰쭚 ?ㅽ깭?꾨? 紐⑥쭛?⑸땲??\n\n二쇰줈 ?뚮즺 ?쒖“ 蹂댁“? 留ㅼ옣 愿由щ? ?대떦?섍쾶 ?⑸땲?? ?먮떂 ?묐?媛 留롮? ?몄씠??諛앹? 誘몄냼瑜?媛吏?遺꾩씠硫?醫뗪쿋?듬땲??\n\n珥덈낫?먮룄 ?섏쁺?섎ŉ, ?낅Т??移쒖젅?섍쾶 ?뚮젮?쒕┰?덈떎. ?앹궗???쒓났?대뱶由щ땲 ?명븯寃?吏?먰빐二쇱꽭??',
                        style: TextStyle(
                          fontSize: 15,
                          color: Colors.black87,
                          height: 1.6,
                        ),
                      ),
                      
                      const SizedBox(height: 32),
                      const Divider(thickness: 1, color: Colors.grey),
                      const SizedBox(height: 24),
                      
                      // Shop Info
                      Text(
                        '媛寃??뺣낫',
                        style: Theme.of(context).textTheme.titleMedium?.copyWith(
                          fontWeight: FontWeight.bold,
                          fontSize: 18,
                        ),
                      ),
                      const SizedBox(height: 16),
                      Row(
                        children: [
                          Icon(Icons.storefront_rounded, size: 20, color: Colors.grey[600]),
                          const SizedBox(width: 8),
                          const Text('移댄럹 荑좏떚 (Cafe Cuty)', style: TextStyle(fontSize: 15, fontWeight: FontWeight.w500)),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Icon(Icons.location_on_outlined, size: 20, color: Colors.grey[600]),
                          const SizedBox(width: 8),
                          const Expanded(
                            child: Text('遺?곗쭊援?以묒븰?濡?123踰덇만', style: TextStyle(fontSize: 15, color: Colors.black54)),
                          ),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Row(
                        children: [
                          Icon(Icons.call_rounded, size: 20, color: Colors.grey[600]),
                          const SizedBox(width: 8),
                          const Text('0507-1234-5678 (梨꾩슜 ?대떦??', style: TextStyle(fontSize: 15, color: Colors.black54)),
                        ],
                      ),
                      
                      const SizedBox(height: 32),


                      const SizedBox(height: 100), // Space for bottom button
                    ],
                  ),
                ),
              ),
            ],
          ),
          
          // Bottom Button
          Positioned(
            left: 20,
            right: 20,
            bottom: 30,
            child: SizedBox(
              width: double.infinity,
              height: 56,
              child: ElevatedButton(
                onPressed: () {
                  // Apply Action
                  _showApplyBottomSheet(context);
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: theme.primaryColor,
                  shadowColor: theme.primaryColor.withValues(alpha: 0.4),
                  elevation: 8,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                child: const Text(
                  '吏湲?諛붾줈 吏?먰븯湲?,
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: Colors.white,
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoRow(IconData icon, String text, {
    bool isHighlight = false, 
    Color? color, 
    Color? highlightColor,
    double fontSize = 16,
  }) {
    final finalColor = highlightColor ?? color ?? (isHighlight ? const Color(0xFF2E7D32) : Colors.black87);
    return Row(
      children: [
        Icon(icon, size: 20, color: color ?? (isHighlight ? const Color(0xFF2E7D32) : Colors.grey[600])),
        const SizedBox(width: 8),
        Expanded(
          child: Text(
            text,
            style: TextStyle(
              fontSize: fontSize,
              fontWeight: isHighlight ? FontWeight.bold : FontWeight.w500,
              color: finalColor,
            ),
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
          ),
        ),
      ],
    );
  }

  Widget _buildStepItem(IconData icon, String label) {
    return Column(
      children: [
        Container(
          width: 50,
          height: 50,
          decoration: BoxDecoration(
            color: Colors.white,
            shape: BoxShape.circle,
            border: Border.all(color: Colors.grey[200]!, width: 2),
          ),
          child: Icon(icon, color: Colors.black87),
        ),
        const SizedBox(height: 8),
        Text(
          label,
          textAlign: TextAlign.center,
          style: const TextStyle(
            fontSize: 12,
            fontWeight: FontWeight.w600,
            height: 1.3,
            color: Colors.black87,
          ),
        ),
      ],
    );
  }

  void _showApplyBottomSheet(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24.0)),
      ),
      builder: (context) {
        bool isAgreementChecked = true;
        final List<String> strengthOptions = [
          '?룧 10遺???嫄곗＜',
          '?뿣截??ㅼ쟾 ?뚰솕 ?ν넻',
          '???뚮컮 寃쎈젰 蹂댁쑀'
        ];
        final List<String> selectedStrengths = [];

        return StatefulBuilder(
          builder: (BuildContext context, StateSetter setState) {
            return Padding(
              padding: EdgeInsets.only(
                bottom: MediaQuery.of(context).viewInsets.bottom,
              ),
              child: SingleChildScrollView(
                child: Padding(
                  padding: const EdgeInsets.all(24.0),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    crossAxisAlignment: CrossAxisAlignment.stretch,
                    children: [
                      // Header
                      Stack(
                        alignment: Alignment.center,
                        children: [
                          const Text(
                            '吏?먰븯湲?,
                            style: TextStyle(
                              fontSize: 20,
                              fontWeight: FontWeight.bold,
                              color: Color(0xFF1A1A2E), // Navy
                            ),
                          ),
                          Positioned(
                            right: 0,
                            child: IconButton(
                              icon: const Icon(Icons.close, color: Colors.grey),
                              onPressed: () => Navigator.pop(context),
                              padding: EdgeInsets.zero,
                              constraints: const BoxConstraints(),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 24),

                      // Profile Section
                      Row(
                        children: [
                          Container(
                            width: 60,
                            height: 60,
                            decoration: BoxDecoration(
                              shape: BoxShape.circle,
                              color: Colors.grey[200], // Light grey background
                              border: Border.all(color: Colors.grey[300]!),
                            ),
                            child: ClipOval(
                              child: Image.asset(
                                'assets/images/unknown_user.png',
                                fit: BoxFit.cover,
                              ),
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                const Text(
                                  'User Name', // Anonymized Name
                                  style: TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.bold,
                                    color: Colors.black87,
                                  ),
                                ),
                                const SizedBox(height: 4),
                                Row(
                                  children: [
                                    const Text(
                                      'D-2 ?좏븰鍮꾩옄',
                                      style: TextStyle(fontSize: 14, color: Colors.grey),
                                    ),
                                    const SizedBox(width: 8),
                                    Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                                      decoration: BoxDecoration(
                                        color: const Color(0xFFE0F2F1), // Light Mint
                                        borderRadius: BorderRadius.circular(12),
                                      ),
                                      child: const Text(
                                        '??CUTY 鍮꾩옄 寃利??꾨즺',
                                        style: TextStyle(
                                          fontSize: 11,
                                          fontWeight: FontWeight.bold,
                                          color: Color(0xFF26A69A), // Mint
                                        ),
                                      ),
                                    ),
                                  ],
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 24),

                      // Checkbox
                      Container(
                        decoration: BoxDecoration(
                          color: Colors.grey[50],
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.grey[200]!),
                        ),
                        child: Theme(
                          data: Theme.of(context).copyWith(
                            checkboxTheme: CheckboxThemeData(
                              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(4)),
                              fillColor: WidgetStateProperty.resolveWith((states) {
                                if (states.contains(WidgetState.selected)) {
                                  return const Color(0xFF26A69A); // Mint
                                }
                                return null;
                              }),
                            )
                          ),
                          child: CheckboxListTile(
                            contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
                            title: const Text(
                              '????湲?18:00 - 22:00 洹쇰Т 媛?ν빀?덈떎.',
                              style: TextStyle(fontSize: 15, color: Colors.black87),
                            ),
                            value: isAgreementChecked,
                            onChanged: (bool? value) {
                              setState(() {
                                isAgreementChecked = value ?? false;
                              });
                            },
                            controlAffinity: ListTileControlAffinity.leading,
                            activeColor: const Color(0xFF26A69A), // Mint
                          ),
                        ),
                      ),
                      const SizedBox(height: 24),

                      // Strength Chips
                      const Text(
                        '?섏쓽 媛뺤젏 ?댄븘 (?좏깮)',
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: Color(0xFF1A1A2E), // Navy
                        ),
                      ),
                      const SizedBox(height: 12),
                      Wrap(
                        spacing: 8.0,
                        runSpacing: 8.0,
                        children: strengthOptions.map((option) {
                          final isSelected = selectedStrengths.contains(option);
                          return FilterChip(
                            label: Text(option),
                            selected: isSelected,
                            onSelected: (bool selected) {
                              setState(() {
                                if (selected) {
                                  selectedStrengths.add(option);
                                } else {
                                  selectedStrengths.remove(option);
                                }
                              });
                            },
                            backgroundColor: Colors.white,
                            selectedColor: const Color(0xFFE0F2F1), // Light Mint
                            checkmarkColor: const Color(0xFF26A69A),
                            labelStyle: TextStyle(
                              color: isSelected ? const Color(0xFF00695C) : Colors.black87,
                              fontWeight: isSelected ? FontWeight.w600 : FontWeight.normal,
                            ),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(20),
                              side: BorderSide(
                                color: isSelected ? const Color(0xFF26A69A) : Colors.grey[300]!,
                              ),
                            ),
                            showCheckmark: false, // Custom style often looks cleaner without checkmark inside chip if color changes, but user asked for Checkbox style... wait, mockup shows simple chips. I'll stick to FilterChip default behavior but style it.
                          );
                        }).toList(),
                      ),
                      const SizedBox(height: 32),

                      // Bottom Button
                      SizedBox(
                        height: 56,
                        child: ElevatedButton(
                          onPressed: () {
                            Navigator.pop(context); // Close bottom sheet
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(
                                content: Text('吏?먯씠 ?꾨즺?섏뿀?듬땲??'),
                                duration: Duration(seconds: 2),
                                behavior: SnackBarBehavior.floating,
                              ),
                            );
                          },
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xFF26A69A), // Mint
                            elevation: 0,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(16),
                            ),
                          ),
                          child: const Text(
                            '?꾨줈??蹂대궡怨?吏???꾨즺 ?됵툘',
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                              color: Colors.white,
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(height: 20),
                    ],
                  ),
                ),
              ),
            );
          },
        );
      },
    );
  }
}

=== lib\screens\jobs\job_detail_screen_career.dart ===
import 'package:flutter/material.dart';

class CareerJobDetailScreen extends StatelessWidget {
  // ?ㅼ젣濡쒕뒗 由ъ뒪?몄뿉???대┃??怨듦퀬 ?곗씠?곕? 諛쏆븘????⑸땲??
  // ?ш린?쒕뒗 '?덊띁 留ㅼ묶(Case 1)' ?곗씠?곕? ?덉떆濡?蹂댁뿬以띾땲??
  final Map<String, dynamic> jobData = {
    "company": "?쒗솕?ㅼ뀡 (嫄곗젣?ъ뾽??",
    "title": "?좊컯 ?쒖뼱 ?쒖뒪???ㅺ퀎 ?붿??덉뼱 (?좎엯/寃쎈젰)",
    "salary": "4,200留뚯썝",
    "location": "寃쎈궓 嫄곗젣??(?멸뎄?뚮㈇吏??",
    "tags": [
      {"type": "E-7", "text": "E-7 | ?꾩옄怨듯븰 2351"},
      {"type": "F2R_C", "text": "F-2-R | 寃쎈궓 嫄곗젣"},
      {"type": "S", "text": "GNI 70%??異⑹”"},
    ]
  };

  CareerJobDetailScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      // 1. ?щ챸 ?깅컮 (?대?吏 媛뺤“)
      extendBodyBehindAppBar: true,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios, color: Colors.white),
          onPressed: () => Navigator.pop(context),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.share, color: Colors.white),
            onPressed: () {},
          ),
          IconButton(
            icon: const Icon(Icons.bookmark_border, color: Colors.white),
            onPressed: () {},
          ),
        ],
      ),
      // 2. ?섎떒 怨좎젙 踰꾪듉 (?좎껌?섍린)
      bottomNavigationBar: _buildBottomActionBar(context),
      
      body: SingleChildScrollView(
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // -------------------------------------------------------
            // 3. ?곷떒 ?ㅻ뜑 ?대?吏 (湲곗뾽/吏곷Т 遺꾩쐞湲?
            // -------------------------------------------------------
            Stack(
              children: [
                Container(
                  height: 250,
                  width: double.infinity,
                  color: Colors.grey[300], // ?대?吏 濡쒕뵫 ??諛곌꼍
                  child: Image.asset(
                    'assets/images/company_bg.png', // ??諛곌꼍 ?대?吏 ?먯뀑 ?꾩슂 (?놁쑝硫??됱긽諛뺤뒪濡??泥대맖)
                    fit: BoxFit.cover,
                    errorBuilder: (c, o, s) => Container(color: const Color(0xFF283593)), // ?대?吏 ?놁쑝硫????몃뵒怨?諛곌꼍
                  ),
                ),
                // 洹몃씪?곗씠???ㅻ쾭?덉씠 (?띿뒪??媛?낆꽦)
                Positioned(
                  bottom: 0, left: 0, right: 0,
                  child: Container(
                    height: 100,
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topCenter,
                        end: Alignment.bottomCenter,
                        colors: [Colors.transparent, Colors.black.withValues(alpha: 0.7)],
                      ),
                    ),
                  ),
                ),
              ],
            ),

            // -------------------------------------------------------
            // 4. 硫붿씤 ?뺣낫 而⑦뀒?대꼫 (洹몃┝??0.4 ?곸슜)
            // -------------------------------------------------------
            Transform.translate(
              offset: const Offset(0, -20), // ?대?吏 ?꾨줈 ?댁쭩 寃뱀튂寃?
              child: Container(
                padding: const EdgeInsets.all(24),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: const BorderRadius.vertical(top: Radius.circular(30)),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.4), // ???붿껌?섏떊 洹몃┝???띾룄 0.4
                      blurRadius: 20,
                      offset: const Offset(0, -5),
                    ),
                  ],
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // 湲곗뾽紐?& ?몄쬆 諛곗?
                    Row(
                      children: [
                        Text(
                          jobData['company'],
                          style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.black54),
                        ),
                        const SizedBox(width: 6),
                        const Icon(Icons.verified, size: 16, color: Colors.blue),
                        const Text(" 踰뺣Т遺 ?몄쬆湲곗뾽", style: TextStyle(fontSize: 12, color: Colors.blue, fontWeight: FontWeight.bold)),
                      ],
                    ),
                    const SizedBox(height: 8),
                    
                    // 怨듦퀬 ?쒕ぉ
                    Text(
                      jobData['title'],
                      style: const TextStyle(fontSize: 22, fontWeight: FontWeight.bold, height: 1.3),
                    ),
                    const SizedBox(height: 16),

                    // 鍮꾩옄 ?쒓렇 由ъ뒪??(?ш쾶 諛곗튂)
                    Wrap(
                      spacing: 8,
                      runSpacing: 8,
                      children: (jobData['tags'] as List).map<Widget>((tag) => _buildDetailBadge(tag)).toList(),
                    ),
                    
                    const SizedBox(height: 24),
                    const Divider(height: 1, thickness: 1, color: Color(0xFFEEEEEE)),
                    const SizedBox(height: 24),

                    // -------------------------------------------------------
                    // 5. 鍮꾩옄 ?곹빀??蹂댁쬆 移대뱶 (?좊ː???ъ씤??)
                    // -------------------------------------------------------
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: const Color(0xFFF5F9FF), // ?꾩＜ ?고븳 釉붾（ 諛곌꼍
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: const Color(0xFFE3F2FD)),
                      ),
                      child: Row(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Icon(Icons.shield_outlined, color: Colors.indigo, size: 24),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                const Text(
                                  "鍮꾩옄 諛쒓툒 ?덉쟾 怨듦퀬",
                                  style: TextStyle(fontSize: 15, fontWeight: FontWeight.bold, color: Colors.indigo),
                                ),
                                const SizedBox(height: 4),
                                Text(
                                  "??怨듦퀬??${jobData['location']} ?뚯옱吏?대ŉ, ?곕큺 ${jobData['salary']}?쇰줈 F-2-R 諛?E-7 鍮꾩옄 諛쒓툒 ?붽굔??異⑹”?⑸땲??",
                                  style: const TextStyle(fontSize: 13, color: Colors.black87, height: 1.4),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                    
                    const SizedBox(height: 32),

                    // -------------------------------------------------------
                    // 6. ?곸꽭 ?뺣낫 (?????源붾걫???뱀뀡??
                    // -------------------------------------------------------
                    _buildSectionTitle("洹쇰Т 議곌굔"),
                    const SizedBox(height: 12),
                    _buildInfoRow(Icons.monetization_on_outlined, "?곕큺", "${jobData['salary']} (硫댁젒 ???묒쓽 媛??"),
                    _buildInfoRow(Icons.location_on_outlined, "洹쇰Т吏", jobData['location']),
                    _buildInfoRow(Icons.access_time, "洹쇰Т?쒓컙", "二?5??(09:00 - 18:00)"),
                    
                    const SizedBox(height: 32),
                    _buildSectionTitle("?대떦 ?낅Т"),
                    const SizedBox(height: 12),
                    const Text(
                      "???좊컯 ?꾧린/?꾩옄 ?쒖뒪???ㅺ퀎 諛??꾨㈃ ?묒꽦\n???꾩옣???ъ뼇 寃??諛?湲곗닠 ?묒쓽\n???앹궛 ?ㅺ퀎 湲곗닠 吏??諛??꾩옣 ???n???댁쇅 ?좎＜???而ㅻ??덉??댁뀡 (?곸뼱 ?곕?)",
                      style: TextStyle(fontSize: 15, color: Colors.black87, height: 1.6),
                    ),

                    const SizedBox(height: 32),
                    _buildSectionTitle("?먭꺽 ?붽굔"),
                    const SizedBox(height: 12),
                    const Text(
                      "??援?궡 ???愿???숆낵(?꾧린, ?꾩옄, ?쒖뼱 ?? ?숈궗 ?댁긽\n???쒓뎅???ν넻??(TOPIK 4湲??댁긽 沅뚯옣)\n??E-7 ?먮뒗 F-2-R 鍮꾩옄 諛쒓툒??寃곌꺽 ?ъ쑀媛 ?녿뒗 ??,
                      style: TextStyle(fontSize: 15, color: Colors.black87, height: 1.6),
                    ),
                    
                    const SizedBox(height: 100), // ?섎떒 踰꾪듉 怨듦컙 ?뺣낫
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  // ?섎떒 怨좎젙 踰꾪듉 (吏?먰븯湲?
  Widget _buildBottomActionBar(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 16),
      decoration: BoxDecoration(
        color: Colors.white,
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.1),
            blurRadius: 10,
            offset: const Offset(0, -5),
          ),
        ],
      ),
      child: SafeArea(
        child: ElevatedButton(
          onPressed: () {
            // TODO: 吏???꾨줈?몄뒪 ?쒖옉
          },
          style: ElevatedButton.styleFrom(
            backgroundColor: const Color(0xFF283593), // ???몃뵒怨?(?좊ː媛?
            foregroundColor: Colors.white,
            padding: const EdgeInsets.symmetric(vertical: 16),
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            elevation: 0,
          ),
          child: const Text(
            "鍮꾩옄 留ㅼ묶 吏?먰븯湲?,
            style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
          ),
        ),
      ),
    );
  }

  // ?뱀뀡 ??댄?
  Widget _buildSectionTitle(String title) {
    return Text(
      title,
      style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.black),
    );
  }

  // ?꾩씠肄?+ ?띿뒪???뺣낫 ??
  Widget _buildInfoRow(IconData icon, String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12.0),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Icon(icon, size: 20, color: Colors.grey[600]),
          const SizedBox(width: 12),
          SizedBox(
            width: 70,
            child: Text(label, style: TextStyle(fontSize: 14, color: Colors.grey[600], fontWeight: FontWeight.w500)),
          ),
          Expanded(
            child: Text(value, style: const TextStyle(fontSize: 14, color: Colors.black87, fontWeight: FontWeight.w600)),
          ),
        ],
      ),
    );
  }

  // ?곸꽭 ?섏씠吏?????諛곗? 鍮뚮뜑
  Widget _buildDetailBadge(Map<String, dynamic> tag) {
    Color bgColor;
    Color textColor;
    
    switch (tag['type']) {
      case 'E-7':
        bgColor = Colors.deepPurple[50]!;
        textColor = Colors.deepPurple;
        break;
      case 'F2R_C':
      case 'F2R_U':
        bgColor = Colors.teal[50]!;
        textColor = Colors.teal[800]!;
        break;
      default: // Salary
        bgColor = Colors.orange[50]!;
        textColor = Colors.deepOrange[800]!;
    }

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
      decoration: BoxDecoration(
        color: bgColor,
        borderRadius: BorderRadius.circular(6),
        border: Border.all(color: textColor.withValues(alpha: 0.2)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (tag['type'] == 'S') Icon(Icons.check_circle, size: 14, color: textColor),
          if (tag['type'] == 'S') const SizedBox(width: 6),
          Text(tag['text'], style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: textColor)),
        ],
      ),
    );
  }
}

=== lib\screens\jobs\providers\job_providers.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter/material.dart';
import '../../../models/job_post.dart';
import '../../../models/banner_item.dart';
import '../../../services/mock_home_repository.dart'; // Currently holds the main provider
// import '../../../data/repositories/real_home_repository.dart'; // import if needing specific provider

// Use the main repository provider which is currently wired to RealHomeRepository in mock_home_repository.dart
// Ensure this path is correct based on where `homeRepositoryProvider` is defined.
// Checked step 98: homeRepositoryProvider is in lib/services/mock_home_repository.dart

final selectedJobCategoryProvider = StateProvider<int>((ref) => 0); // 0: ?뚮컮(Part-Time), 1: 痍⑥뾽(Career)
final jobFilterProvider = StateProvider<List<String>>((ref) => []); // Stores currently active filters

final jobListProvider = FutureProvider<List<JobPost>>((ref) async {
  final repository = ref.watch(homeRepositoryProvider);
  final categoryIndex = ref.watch(selectedJobCategoryProvider);
  
  try {
    // Career Tab -> Force Empty State
    if (categoryIndex == 1) {
      return [
        JobPost(
          id: 'career_dummy_1',
          title: '寃쎈젰吏?媛쒕컻??梨꾩슜 (?붾?)',
          companyName: '誘몃옒湲곗닠',
          location: '?쒖슱 媛뺣궓援?,
          salary: '?곕큺 5,000留뚯썝 ?댁긽',
          description: '寃쎈젰吏?媛쒕컻?먮? 紐⑥떗?덈떎. ?곸떊?곸씤 ?꾨줈?앺듃??李몄뿬?섏꽭??',
          tags: ['鍮꾩옄媛??, '?숆탳 踰꾩뒪 10遺?],
          imageUrl: 'https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=1000&auto=format&fit=crop',
          isVerified: true,
          isBookmarked: false,
          postedDate: DateTime.now().subtract(const Duration(days: 5)),
        ),
      ]; 
    }
    
    // Part-Time Tab -> Fetch from Repository (Single Dummy)
    return await repository.fetchJobPosts();
  } catch (e) {
    debugPrint('JobFetch Error (Prototype Mode): $e');
    return [];
  }
});

final bannerListProvider = FutureProvider<List<BannerItem>>((ref) async {
  final repository = ref.watch(homeRepositoryProvider);
  final categoryIndex = ref.watch(selectedJobCategoryProvider);
  return await repository.fetchBanners(categoryIndex);
});

class JobTheme {
  final Color primaryColor;
  final Color secondaryColor;
  final LinearGradient bannerGradient;

  const JobTheme({
    required this.primaryColor,
    required this.secondaryColor,
    required this.bannerGradient,
  });
}

final jobThemeProvider = Provider<JobTheme>((ref) {
  final categoryIndex = ref.watch(selectedJobCategoryProvider);
  if (categoryIndex == 1) {
    // Career (Navy)
    return const JobTheme(
      primaryColor: Color(0xFF1A237E), // Indigo 900
      secondaryColor: Color(0xFF3949AB), // Indigo 600
      bannerGradient: LinearGradient(
        colors: [Color(0xFF5C6BC0), Color(0xFF283593)],
        begin: Alignment.topLeft,
        end: Alignment.bottomRight,
      ),
    );
  }
  // Part-Time (Mint)
  return const JobTheme(
    primaryColor: Color(0xFF26A69A), // Teal 400
    secondaryColor: Color(0xFF80CBC4), // Teal 200
    bannerGradient: LinearGradient(
      colors: [Color(0xFFB2DFDB), Color(0xFF4DB6AC)],
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
    ),
  );
});

=== lib\screens\jobs\widgets\career_tab_content.dart ===
import 'package:flutter/material.dart';
import '../job_detail_screen_career.dart';
import '../../diagnosis/consulting_screen.dart';

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../providers/diagnosis_provider.dart';
import '../../../../models/diagnosis_model.dart';

class CareerTabContent extends ConsumerWidget { // Changed to ConsumerWidget
  const CareerTabContent({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final diagnosisState = ref.watch(diagnosisProvider);
    final isAnalyzed = diagnosisState.isAnalysisDone;
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const SizedBox(height: 24),
        
        // -------------------------------------------------------
        // 1. 以묐떒: 鍮꾩옄 ??쒕낫??(?붾낫湲??대┃ ?쒖꽦??
        // -------------------------------------------------------
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16.0),
          child: (isAnalyzed && diagnosisState.result != null)
              ? _buildResultDashboard(context, diagnosisState.result!, diagnosisState.answer)
              : _buildLockedDashboard(context),
        ),

        const SizedBox(height: 32),

        // -------------------------------------------------------
        // 2. ?섎떒: 怨듦퀬 由ъ뒪??(?붾낫湲?異붽? & 移대뱶 ?대┃ ?쒖꽦??
        // -------------------------------------------------------
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16.0),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            crossAxisAlignment: CrossAxisAlignment.end, // ?띿뒪???쇱씤 留욎땄
            children: [
              const Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    "?닿? 吏???????덈뒗 留욎땄 湲곗뾽", // 臾멸뎄 ?섏젙 ?붿껌 諛섏쁺
                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                  ),
                ],
              ),
              
              // ??[異붽??? 由ъ뒪??'?붾낫湲? 踰꾪듉
              InkWell(
                onTap: () {
                  debugPrint(">>> [?대┃] 留욎땄 湲곗뾽 由ъ뒪???붾낫湲?);
                  // TODO: ?꾩껜 怨듦퀬 由ъ뒪???섏씠吏濡??대룞
                },
                child: const Padding(
                  padding: EdgeInsets.only(bottom: 4.0, left: 8.0), // ?곗튂 ?곸뿭 ?뺣낫
                  child: Row(
                    children: [
                      Text("?붾낫湲?, style: TextStyle(fontSize: 12, color: Colors.grey, fontWeight: FontWeight.bold)),
                      Icon(Icons.chevron_right, size: 16, color: Colors.grey),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 12),

        // 怨듦퀬 由ъ뒪??異쒕젰
        ListView.separated(
          physics: const NeverScrollableScrollPhysics(),
          shrinkWrap: true,
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
          itemCount: 5,

          separatorBuilder: (c, i) => const SizedBox(height: 16),
          itemBuilder: (context, index) => _buildJobCard(context, index),
        ),
        const SizedBox(height: 40),
      ],
    );
  }

  // ?뵏 ?좉툑 ?곹깭 ??쒕낫??
  Widget _buildLockedDashboard(BuildContext context) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.symmetric(vertical: 40, horizontal: 20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10, offset: const Offset(0, 4))],
        border: Border.all(color: Colors.grey.withValues(alpha: 0.2)),
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.indigo.withValues(alpha: 0.05),
              shape: BoxShape.circle,
            ),
            child: const Icon(Icons.lock_rounded, size: 32, color: Colors.indigo),
          ),
          const SizedBox(height: 16),
          const Text(
            "鍮꾩옄 吏꾨떒???꾨즺?섎㈃\n留욎땄 由ы룷?몃? 蹂????덉뼱??",
            textAlign: TextAlign.center,
            style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, height: 1.4),
          ),
          const SizedBox(height: 8),
          const Text(
            "媛꾨떒??吏꾨떒?쇰줈 ?⑷꺽瑜좎쓣 ?믪뿬蹂댁꽭??,
            textAlign: TextAlign.center,
            style: TextStyle(fontSize: 13, color: Colors.grey),
          ),
          const SizedBox(height: 24),
          GestureDetector(
            onTap: () {
               debugPrint(">>> [?대┃] 鍮꾩옄 吏꾨떒?섎윭 媛湲?(Locked)");
               Navigator.push(
                 context,
                 MaterialPageRoute(builder: (context) => const ConsultingScreen()),
               );
            },
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
              decoration: BoxDecoration(
                color: Colors.indigo,
                borderRadius: BorderRadius.circular(30),
                boxShadow: [BoxShadow(color: Colors.indigo.withValues(alpha: 0.3), blurRadius: 8, offset: const Offset(0, 4))],
              ),
              child: const Text(
                "吏湲?諛붾줈 吏꾨떒?섍린",
                style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 14),
              ),
            ),
          ),
        ],
      ),
    );
  }

  // ?뵑 吏꾨떒 寃곌낵 ??쒕낫??
  Widget _buildResultDashboard(BuildContext context, DiagnosisResult result, SurveyAnswer answer) {
    // 1. Primary Job (First one)
    final primary = result.primary;
    
    // Fallback if no jobs or primary is null
    if (primary == null) {
       return Container(
         width: double.infinity,
         padding: const EdgeInsets.all(20),
         decoration: BoxDecoration(
           color: Colors.white,
           borderRadius: BorderRadius.circular(16),
           border: Border.all(color: Colors.indigo.withValues(alpha: 0.2)),
         ),
         child: const Center(child: Text("異붿쿇 媛?ν븳 吏곷Т媛 ?놁뒿?덈떎.")),
      );
    }

    // Generate Insight Comment
    final String comment = _generateInsightComment(result, answer);

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [BoxShadow(color: Colors.indigo.withValues(alpha: 0.4), blurRadius: 20, offset: const Offset(0, 10))],
        border: Border.all(color: Colors.indigo.withValues(alpha: 0.2)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text("????鍮꾩옄 留ㅼ묶 由ы룷??, style: TextStyle(fontSize: 15, fontWeight: FontWeight.bold)),
              GestureDetector(
                onTap: () {
                  debugPrint(">>> [?대┃] ??鍮꾩옄 留ㅼ묶 由ы룷???붾낫湲?);
                  // TODO: ?곸꽭 由ы룷???섏씠吏濡??대룞
                },
                child: Row(
                  children: [
                    Text("?붾낫湲?, style: TextStyle(fontSize: 12, color: Colors.grey[600])),
                    Icon(Icons.chevron_right, size: 16, color: Colors.grey[600]),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          
          // Row 1: Tier Score
          _buildRichInfoRow(
            label: "?깃툒/?먯닔",
            content: Text.rich(
              TextSpan(
                children: [
                  const TextSpan(text: "異뺥븯?댁슂! "),
                  TextSpan(
                    text: "'${result.totalTier}'",
                    style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.indigo),
                  ),
                  const TextSpan(text: " ?깃툒 ?ъ꽦! ?룇"),
                ],
                style: const TextStyle(fontSize: 13, color: Colors.black87),
              ),
            ),
            iconColor: Colors.teal,
          ),
          const SizedBox(height: 10),

          // Row 2: Recommended Job
          _buildRichInfoRow(
            label: "異붿쿇 吏곷Т",
            content: Text.rich(
              TextSpan(
                children: [
                  const TextSpan(text: "媛????留욌뒗 ?룹? "),
                  TextSpan(
                    text: "[${primary.jobName}]",
                    style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.blueAccent),
                  ),
                  const TextSpan(text: " ?낅땲??"),
                ],
                style: const TextStyle(fontSize: 13, color: Colors.black87),
              ),
            ),
            iconColor: Colors.blue,
          ),
          const SizedBox(height: 10),

          // Row 3: Insight Comment (Highlight)
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.orange.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.orange.withValues(alpha: 0.3)),
            ),
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Icon(Icons.lightbulb, size: 16, color: Colors.deepOrange),
                const SizedBox(width: 8),
                Expanded(
                  child: Text(
                    comment,
                    style: const TextStyle(
                      fontSize: 13, 
                      fontWeight: FontWeight.bold, 
                      color: Colors.deepOrange,
                      height: 1.3
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  String _generateInsightComment(DiagnosisResult result, SurveyAnswer answer) {
    final primary = result.primary!;
    
    // 1. IF Visa Status is GREEN
    if (primary.visaStatus == VisaStatus.GREEN) {
      return "?꾨꼍?댁슂! ?몡 吏湲?諛붾줈 ?대젰?쒕? ?깅줉?대낫?몄슂.";
    }

    // 2. IF Low Korean Level
    if (answer.koreanLevel.contains('湲곗큹')) {
      return "?뮕 TOPIK ?먯닔留?蹂댁셿?섎㈃ 'Diamond' ?깃툒 媛?ν빐??";
    }

    // 3. IF Low Experience (Assuming expScore is mapped to '寃쎈젰' key)
    final expScore = primary.myScores['寃쎈젰'] ?? 0;
    if (expScore == 0 || answer.experiences.isEmpty) {
      return "?뮕 ?명꽩??寃쏀뿕 1媛쒕쭔 ?뷀븯硫??⑷꺽瑜좎씠 20% ?щ씪媛??";
    }

    // 4. ELSE (General)
    // Calculate simple percentile logic for display
    final score = result.totalScore;
    int percentile = (100 - score).clamp(1, 99);
    return "?꾩옱 ?곸쐞 $percentile% ?몄옱?낅땲?? ?곸꽭 ?꾨왂???뺤씤?섏꽭??";
  }

  Widget _buildRichInfoRow({required String label, required Widget content, required Color iconColor}) {
    return Row(
      children: [
        Container(width: 4, height: 14, decoration: BoxDecoration(color: iconColor, borderRadius: BorderRadius.circular(2))),
        const SizedBox(width: 8),
        Text(label, style: const TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: Colors.black54)),
        const SizedBox(width: 8),
        Expanded(child: content),
      ],
    );
  }


  Widget _buildJobCard(BuildContext context, int index) {
    final jobs = [
      // Case 1: E-7(OK) + F-2-R(Company OK) + Salary(OK)
      {
        "case": "1. ?덊띁 留ㅼ묶",
        "company": "?쒗솕?ㅼ뀡 (嫄곗젣)",
        "title": "?좊컯 ?쒖뼱 ?쒖뒪???ㅺ퀎 ?붿??덉뼱",
        "tags": [
          {"type": "E-7", "text": "E-7 | ?꾩옄怨듯븰 2351"},
          {"type": "F2R_C", "text": "F-2-R | 寃쎈궓 嫄곗젣"},
          {"type": "S", "text": "GNI 70%??異⑹”"},
        ],
        "salary": "?곕큺 4,200留뚯썝",
      },
      // Case 2: E-7(OK) + F-2-R(Salary NO)
      {
        "case": "2. E-7 ?꾩슜",
        "company": "?쒖슱 ?뚰겕??,
        "title": "IT ?붾（??湲곗닠 吏?먰???,
        "tags": [
          {"type": "E-7", "text": "E-7 | ?묒슜SW 1332"},
        ],
        "salary": "?곕큺 2,800留뚯썝 (F-2-R 誘몃떖)",
      },
      // Case 3: E-7(OK) + F-2-R(User Region OK) + Salary(OK)
      {
        "case": "3. E-7/F-2-R ???,
        "company": "?꾨?以묎났???묐젰??,
        "title": "?뚮옖??怨듭젙 愿由ъ쭅",
        "tags": [
          {"type": "E-7", "text": "E-7 | 湲곌퀎怨듯븰 2353"},
          {"type": "F2R_U", "text": "F-2-R | 嫄곗＜誘??밸?"},
          {"type": "S", "text": "GNI 70%??異⑹”"},
        ],
        "salary": "?곕큺 3,800留뚯썝",
      },
      // Case 4: E-7(NO) + F-2-R(Company OK) + Salary(OK)
      {
        "case": "4. F-2-R ?꾩슜 (吏??",
        "company": "?꾨궓 ?곴킅 ?띾젰?⑥?",
        "title": "?⑥? ?댁쁺 吏??諛??꾩옣 愿由?,
        "tags": [
          {"type": "F2R_C", "text": "F-2-R | ?꾨궓 ?곴킅"},
          {"type": "S", "text": "GNI 70%??異⑹”"},
        ],
        "salary": "?곕큺 3,500留뚯썝",
      },
      // Case 5: E-7(NO) + F-2-R(User Region OK) + Salary(OK)
      {
        "case": "5. F-2-R ?꾩슜 (嫄곗＜)",
        "company": "?먭탳 ?곗씠?곗꽱??,
        "title": "?⑥닚 ?쒕쾭 紐⑤땲?곕쭅 諛?愿由?,
        "tags": [
          {"type": "F2R_U", "text": "F-2-R | 嫄곗＜誘??밸?"},
          {"type": "S", "text": "GNI 70%??異⑹”"},
        ],
        "salary": "?곕큺 3,400留뚯썝",
      },
    ];

    final job = jobs[index];
    final tags = job['tags'] as List<Map<String, String>>;

    return GestureDetector(
      onTap: () {
        Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => CareerJobDetailScreen()),
        );
      },
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(12),
          boxShadow: [BoxShadow(color: Colors.indigo.withValues(alpha: 0.35), blurRadius: 12, offset: const Offset(0, 6))],
          border: Border.all(color: Colors.indigo.withValues(alpha: 0.15)),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Wrap(
              spacing: 6,
              runSpacing: 6,
              children: tags.map((tag) => _buildBadge(tag)).toList(),
            ),
            const SizedBox(height: 12),
            Row(
              children: [
                Container(width: 40, height: 40, decoration: BoxDecoration(color: Colors.grey[100], borderRadius: BorderRadius.circular(8)), child: const Icon(Icons.business, color: Colors.grey)),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(job['title']! as String, style: const TextStyle(fontSize: 15, fontWeight: FontWeight.bold)),
                      const SizedBox(height: 4),
                      Text(job['company']! as String, style: const TextStyle(fontSize: 12, color: Colors.grey)),
                      const SizedBox(height: 6),
                      Text(job['salary']! as String, style: const TextStyle(fontSize: 13, fontWeight: FontWeight.bold, color: Colors.black87)),
                    ],
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildBadge(Map<String, String> tag) {
    Color bgColor;
    Color textColor;
    
    switch (tag['type']) {
      case 'E-7':
        bgColor = Colors.deepPurple[50]!;
        textColor = Colors.deepPurple;
        break;
      case 'F2R_C':
        bgColor = Colors.teal[50]!;
        textColor = Colors.teal[800]!;
        break;
      case 'F2R_U':
        bgColor = Colors.indigo[50]!;
        textColor = Colors.indigo[800]!;
        break;
      default: // Salary
        bgColor = Colors.orange[50]!;
        textColor = Colors.deepOrange[800]!;
    }

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 3),
      decoration: BoxDecoration(color: bgColor, borderRadius: BorderRadius.circular(4), border: Border.all(color: textColor.withValues(alpha: 0.2))),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (tag['type'] == 'S') Icon(Icons.check_circle, size: 10, color: textColor),
          if (tag['type'] == 'S') const SizedBox(width: 4),
          Text(tag['text']!, style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: textColor)),
        ],
      ),
    );
  }
}

=== lib\screens\jobs\widgets\filter_bottom_sheet.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../providers/job_providers.dart';

class FilterBottomSheet extends ConsumerStatefulWidget {
  const FilterBottomSheet({super.key});

  @override
  ConsumerState<FilterBottomSheet> createState() => _FilterBottomSheetState();
}

class _FilterBottomSheetState extends ConsumerState<FilterBottomSheet> {
  final List<String> _allOptions = [
    '?뱧 ??二쇰?',
    '?뮥 怨좎닔??,
    '?븩 ?④린',
    '??珥덈낫媛??,
    '?뱟 二쇰쭚',
    '?뜓 ?앹궗?쒓났',
    '?쉶 ?듦렐踰꾩뒪',
  ];

  late List<String> _tempSelectedFilters;

  @override
  void initState() {
    super.initState();
    // Initialize with current provider state
    _tempSelectedFilters = List.from(ref.read(jobFilterProvider));
  }

  void _toggleFilter(String filter) {
    setState(() {
      if (_tempSelectedFilters.contains(filter)) {
        _tempSelectedFilters.remove(filter);
      } else {
        _tempSelectedFilters.add(filter);
      }
    });
  }

  void _resetFilters() {
    setState(() {
      _tempSelectedFilters.clear();
    });
  }

  void _applyFilters() {
    ref.read(jobFilterProvider.notifier).state = List.from(_tempSelectedFilters);
    Navigator.pop(context);
  }

  @override
  Widget build(BuildContext context) {
    final theme = ref.watch(jobThemeProvider);

    return Container(
      padding: const EdgeInsets.only(top: 24, left: 24, right: 24, bottom: 40),
      decoration: const BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text(
                '?곸꽭 ?꾪꽣 ?ㅼ젙',
                style: TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF1A1A2E), // Dark Navy
                ),
              ),
              IconButton(
                onPressed: () => Navigator.pop(context),
                icon: const Icon(Icons.close, color: Colors.grey),
              )
            ],
          ),
          const SizedBox(height: 20),
          
          Flexible(
            child: SingleChildScrollView(
              child: Wrap(
                spacing: 10,
                runSpacing: 10,
                children: _allOptions.map((option) {
                  final isSelected = _tempSelectedFilters.contains(option);
                  return GestureDetector(
                    onTap: () => _toggleFilter(option),
                    child: AnimatedContainer(
                      duration: const Duration(milliseconds: 200),
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                      decoration: BoxDecoration(
                        color: isSelected ? theme.primaryColor.withValues(alpha: 0.1) : Colors.grey[100],
                        borderRadius: BorderRadius.circular(24),
                        border: Border.all(
                          color: isSelected ? theme.primaryColor : Colors.grey[300]!,
                          width: 1.5,
                        ),
                      ),
                      child: Text(
                        option,
                        style: TextStyle(
                          color: isSelected ? theme.primaryColor : Colors.grey[700],
                          fontWeight: isSelected ? FontWeight.bold : FontWeight.w500,
                          fontSize: 14,
                        ),
                      ),
                    ),
                  );
                }).toList(),
              ),
            ),
          ),
          
          const SizedBox(height: 32),
          
          Row(
            children: [
              // Reset Button
              Expanded(
                flex: 3,
                child: TextButton(
                  onPressed: _resetFilters,
                  style: TextButton.styleFrom(
                    padding: const EdgeInsets.symmetric(vertical: 16),
                    backgroundColor: Colors.grey[100],
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: const Text(
                    '珥덇린??,
                    style: TextStyle(
                      color: Colors.grey,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 12),
              // Apply Button
              Expanded(
                flex: 7,
                child: ElevatedButton(
                  onPressed: _applyFilters,
                  style: ElevatedButton.styleFrom(
                    padding: const EdgeInsets.symmetric(vertical: 16),
                    backgroundColor: theme.primaryColor,
                    elevation: 0,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: const Text(
                    '?곸슜?섍린',
                    style: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}

=== lib\screens\jobs\widgets\job_app_bar.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../providers/home_view_provider.dart';
import '../providers/job_providers.dart';

class JobAppBar extends ConsumerWidget {
  const JobAppBar({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final category = ref.watch(selectedJobCategoryProvider);
    final iconColor = category == 0 ? const Color(0xFF26A69A) : const Color(0xFF1A237E);

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            children: [
              IconButton(
                onPressed: () {
                  // Back Logic
                  ref.read(homeViewProvider.notifier).state = 'dashboard';
                },
                icon: const Icon(Icons.arrow_back_ios_new, size: 24),
                color: iconColor,
                padding: EdgeInsets.zero,
                constraints: const BoxConstraints(),
              ),
              const SizedBox(width: 8),
              Text(
                'CUTY', // Logo
                style: TextStyle(
                  fontFamily: 'Poppins', // Assuming font is available or fallback to default
                  fontSize: 28,
                  fontWeight: FontWeight.w900,
                  color: iconColor,
                ),
              ),
            ],
          ),
          // Actions
          IconButton(
            onPressed: () {},
            icon: const Icon(Icons.notifications_none_outlined, size: 28),
            color: iconColor,
          ),
        ],
      ),
    );
  }
}

=== lib\screens\jobs\widgets\job_category_tab.dart ===
import 'package:flutter/material.dart';

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../providers/job_providers.dart';

class JobCategoryTab extends ConsumerStatefulWidget {
  const JobCategoryTab({super.key});

  @override
  ConsumerState<JobCategoryTab> createState() => _JobCategoryTabState();
}

class _JobCategoryTabState extends ConsumerState<JobCategoryTab> {
  // Local state not needed if fully driving from provider, but setState used for animation might benefit from local + sync. 
  // Let's rely on provider.

  @override
  Widget build(BuildContext context) {
    final selectedIndex = ref.watch(selectedJobCategoryProvider);

    return Container(
      decoration: const BoxDecoration(
        color: Colors.white,
        border: Border(bottom: BorderSide(color: Color(0xFFEEEEEE), width: 1)),
      ),
      child: Row(
        children: [
          _buildTab('?뚮컮', '(Part-Time)', 0, selectedIndex, ref),
          _buildTab('痍⑥뾽', '(Career)', 1, selectedIndex, ref),
        ],
      ),
    );
  }

  Widget _buildTab(String title, String subtitle, int index, int selectedIndex, WidgetRef ref) {
    final bool isSelected = selectedIndex == index;
    final theme = ref.watch(jobThemeProvider);

    return Expanded(
      child: InkWell(
        onTap: () {
          ref.read(selectedJobCategoryProvider.notifier).state = index;
        },
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 300),
          padding: const EdgeInsets.symmetric(vertical: 12),
          decoration: BoxDecoration(
            border: Border(
              bottom: BorderSide(
                color: isSelected ? theme.primaryColor : Colors.transparent,
                width: 3,
              ),
            ),
          ),
          child: Column(
            children: [
              Text(
                title,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: isSelected ? theme.primaryColor : Colors.grey[400],
                ),
              ),
              const SizedBox(height: 2),
              Text(
                subtitle,
                style: TextStyle(
                  fontSize: 12,
                  color: isSelected ? theme.primaryColor : Colors.grey[400],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

=== lib\screens\jobs\widgets\job_filter_chips.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'filter_bottom_sheet.dart';
import '../providers/job_providers.dart';

class JobFilterChips extends ConsumerWidget {
  const JobFilterChips({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Check if any filters are active to potentially style the button differently
    final activeFilters = ref.watch(jobFilterProvider);
    final hasActiveFilters = activeFilters.isNotEmpty;
    final theme = ref.watch(jobThemeProvider);

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: GestureDetector(
        onTap: () {
          showModalBottomSheet(
            context: context,
            isScrollControlled: true, // Allows sheet to be taller if needed
            backgroundColor: Colors.transparent,
            builder: (context) => const FilterBottomSheet(),
          );
        },
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
          decoration: BoxDecoration(
            color: hasActiveFilters ? theme.primaryColor.withValues(alpha: 0.1) : Colors.white,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(
              color: hasActiveFilters ? theme.primaryColor : Colors.grey[300]!,
              width: 1,
            ),
             boxShadow: [
              BoxShadow(
                color: ref.watch(selectedJobCategoryProvider) == 1
                    ? const Color(0xFF1A237E).withValues(alpha: 0.3) // Indigo Shadow for Career
                    : const Color(0xFF26A69A).withValues(alpha: 0.35), // Mint Shadow for Part-Time
                blurRadius: 10,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min, // Wrap content
            children: [
              Icon(
                Icons.tune_rounded,
                size: 20,
                color: hasActiveFilters ? theme.primaryColor : Colors.grey[700],
              ),
              const SizedBox(width: 8),
              Text(
                activeFilters.isEmpty 
                  ? '?뚮컮 ?꾪꽣留곹븯湲? 
                  : '${activeFilters.length}媛??꾪꽣 ?곸슜 以?, // Show count if active
                style: TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.w600,
                  color: hasActiveFilters ? theme.primaryColor : Colors.grey[700],
                ),
              ),
              const Spacer(),
              if (hasActiveFilters)
                Padding(
                  padding: const EdgeInsets.only(right: 4),
                  child: Icon(
                    Icons.check_circle,
                    size: 16,
                    color: theme.primaryColor,
                  ),
                ),
              Icon(
                Icons.keyboard_arrow_down_rounded,
                size: 20,
                color: hasActiveFilters ? theme.primaryColor : Colors.grey[400],
              ),
            ],
          ),
        ),
      ),
    );
  }
}

=== lib\screens\jobs\widgets\job_list_view.dart ===
import 'package:flutter/material.dart';
import '../../../../models/job_post.dart';
import '../../../../config/theme.dart';
import 'package:intl/intl.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../providers/job_providers.dart';
import '../job_detail_screen.dart';

class JobListView extends StatelessWidget {
  final List<JobPost> jobs;

  const JobListView({super.key, required this.jobs});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            '留욎땄 ?뚮컮 李얘린',
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: Color(0xFF1A1A2E),
            ),
          ),
          const SizedBox(height: 16),
          ListView.separated(
            physics: const NeverScrollableScrollPhysics(), // Nested in single scroll view
            shrinkWrap: true,
            itemCount: jobs.length,
            separatorBuilder: (context, index) => const SizedBox(height: 12),
            itemBuilder: (context, index) {
              return _JobCard(job: jobs[index]);
            },
          ),
          const SizedBox(height: 40), // Bottom padding
        ],
      ),
    );
  }
}

class _JobCard extends StatelessWidget {
  final JobPost job;
  const _JobCard({required this.job});

  @override
  Widget build(BuildContext context) {
    final currencyFormat = NumberFormat("#,###");

    return Consumer(
      builder: (context, ref, child) {
         final categoryIndex = ref.watch(selectedJobCategoryProvider);
         final isCareer = categoryIndex == 1;

         return Container(
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: isCareer 
                  ? const Color(0xFF1A237E).withValues(alpha: 0.3) // Indigo Shadow for Career (Darker)
                  : const Color(0xFF26A69A).withValues(alpha: 0.35), // Mint Shadow for Part-Time (Increased from 0.2)
                blurRadius: 10,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          padding: EdgeInsets.zero, // Padding handling inside InkWell or outside?
          // Better to wrap Container contents with InkWell
          clipBehavior: Clip.hardEdge, // Ensure ripple respects radius
          child: InkWell(
            onTap: () {
              // Navigation Stub for JobDetailScreen
              Navigator.push(
                context, 
                MaterialPageRoute(
                  builder: (context) => JobDetailScreen(job: job),
                ),
              );
            },
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Row(
                children: [
              // Image
              Container(
                width: 80,
                height: 80,
                decoration: BoxDecoration(
                  color: Colors.grey[200],
                  borderRadius: BorderRadius.circular(12),
                ),
                child: job.imageUrl.isNotEmpty
                    ? ClipRRect(
                        borderRadius: BorderRadius.circular(12),
                        child: Image.network(
                          job.imageUrl,
                          fit: BoxFit.cover,
                          errorBuilder: (context, error, stackTrace) {
                            return Center(
                              child: Icon(Icons.store, color: Colors.grey[400]),
                            );
                          },
                        ),
                      )
                    : Center(
                        child: Icon(Icons.store, color: Colors.grey[400]),
                      ),
              ),

              const SizedBox(width: 16),
              // Content
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      job.title,
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: Color(0xFF1A1A2E),
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                    const SizedBox(height: 4),
                    Builder(
                      builder: (context) {
                        // Prototype logic: Big number = Annual Salary
                        final isAnnual = (job.hourlyWage ?? 0) > 1000000;
                        final wageString = isAnnual 
                            ? '?곕큺 ${currencyFormat.format(((job.hourlyWage ?? 0) / 10000).round())}留뚯썝'
                            : '?쒓툒 ${currencyFormat.format(job.hourlyWage ?? 0)}??;
                        
                        return Text(
                          '$wageString??,
                          style: TextStyle(
                            fontSize: 14,
                            fontWeight: FontWeight.w700,
                            color: AppTheme.darkGreen,
                          ),
                        );
                      }
                    ),
                    const SizedBox(height: 8),
                    Row(
                      children: job.tags.map((tag) => Container(
                        margin: const EdgeInsets.only(right: 6),
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: Colors.grey[100],
                          borderRadius: BorderRadius.circular(8),
                          border: Border.all(color: Colors.grey[300]!),
                        ),
                        child: Text(
                          tag,
                          style: const TextStyle(fontSize: 11, color: Colors.grey),
                        ),
                      )).toList(),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  },
);
  }
}

=== lib\screens\jobs\widgets\promotion_banner.dart ===
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../../models/banner_item.dart';
import '../providers/job_providers.dart';
// import '../../diagnosis/diagnosis_screen.dart'; // Removed broken import
import '../../alba/permit_application_wizard.dart';

import 'package:cuty_app/providers/diagnosis_provider.dart';
import '../../diagnosis/consulting_screen.dart'; // Consulting (Entry)
import '../../diagnosis/result_screen.dart'; // Result

class PromotionBanner extends ConsumerStatefulWidget {
  const PromotionBanner({super.key});

  @override
  ConsumerState<PromotionBanner> createState() => _PromotionBannerState();
}

class _PromotionBannerState extends ConsumerState<PromotionBanner> {
  final PageController _pageController = PageController();
  int _currentPage = 0;
  Timer? _timer;

  @override
  void initState() {
    super.initState();
    _startAutoScroll();
  }

  void _startAutoScroll() {
    _timer = Timer.periodic(const Duration(seconds: 6), (timer) {
      if (_pageController.hasClients) {
        int next = _currentPage + 1;
        if (next > 2) next = 0;
        _pageController.animateToPage(
          next,
          duration: const Duration(milliseconds: 300),
          curve: Curves.easeInOut,
        );
      }
    });
  }

  void _resetTimer() {
    _timer?.cancel();
    _startAutoScroll();
  }

  @override
  void dispose() {
    _timer?.cancel();
    _pageController.dispose();
    super.dispose();
  }

  void _onArrowTap() {
    _resetTimer(); // Reset timer on interaction
    if (_pageController.hasClients) {
      int next = _currentPage + 1;
      if (next > 2) next = 0;
      _pageController.animateToPage(
        next,
        duration: const Duration(milliseconds: 300),
        curve: Curves.easeInOut,
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    // Watch the banner list provider instead of just theme
    final bannersAsync = ref.watch(bannerListProvider);

    return Column(
      children: [
        // Main Banner Area with Slider
        SizedBox(
          height: 140,
          child: bannersAsync.when(
            data: (banners) {
              if (banners.isEmpty) return const SizedBox.shrink(); // Hide if empty
              
              // Ensure currentPage is valid if banner count changes
              // If controller is past the new count, reset to 0
              if (banners.length == 1 && _currentPage != 0) {
                 _currentPage = 0;
                 if (_pageController.hasClients) {
                   // Use post frame callback to avoid build-phase jumping
                   WidgetsBinding.instance.addPostFrameCallback((_) {
                     if (_pageController.hasClients) _pageController.jumpToPage(0);
                   });
                 }
              }

              return Stack(
                clipBehavior: Clip.none,
                children: [
                  Listener(
                    onPointerDown: (_) => _timer?.cancel(),
                    onPointerUp: (_) => _startAutoScroll(),
                    onPointerCancel: (_) => _startAutoScroll(),
                    child: PageView.builder(
                      controller: _pageController,
                      clipBehavior: Clip.none,
                      itemCount: banners.length,
                      onPageChanged: (index) {
                        setState(() {
                          _currentPage = index;
                        });
                      },
                      itemBuilder: (context, index) {
                         return _buildBannerItem(banners[index]);
                      },
                    ),
                  ),

                  // Global Arrow Button (Persistent)
                  if (banners.length > 1)
                  Positioned(
                    right: 35,
                    top: 0,
                    bottom: 0,
                    child: Center(
                      child: GestureDetector(
                        onTap: _onArrowTap,
                        child: Container(
                          width: 36,
                          height: 36,
                          decoration: BoxDecoration(
                            color: Colors.black.withValues(alpha: 0.15),
                            shape: BoxShape.circle,
                          ),
                          child: const Icon(
                            Icons.arrow_forward_ios_rounded,
                            size: 16,
                            color: Colors.white,
                          ),
                        ),
                      ),
                    ),
                  ),
                ],
              );
            },
            loading: () => Container(
              margin: const EdgeInsets.symmetric(horizontal: 20),
              height: 140,
              decoration: BoxDecoration(
                color: Colors.grey[200],
                borderRadius: BorderRadius.circular(20),
              ),
              child: const Center(child: CircularProgressIndicator()),
            ),
            error: (err, stack) => const SizedBox(height: 140),
          ),
        ),

        const SizedBox(height: 16),

        // Indicator Dots - Only show if we have banners
        bannersAsync.maybeWhen(
          data: (banners) {
            if (banners.length <= 1) return const SizedBox.shrink();
            return Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: List.generate(banners.length, (index) {
                final isActive = index == _currentPage;
                final theme = ref.watch(jobThemeProvider); // Get theme for indicator color needed here
                return AnimatedContainer(
                  duration: const Duration(milliseconds: 300),
                  margin: const EdgeInsets.symmetric(horizontal: 4),
                  height: 8,
                  width: isActive ? 24 : 8,
                  decoration: BoxDecoration(
                    color: isActive ? theme.primaryColor : Colors.grey[300],
                    borderRadius: BorderRadius.circular(4),
                  ),
                );
              }),
            );
          },
          orElse: () => const SizedBox.shrink(),
        ),
      ],
    );
  }

  Widget _buildBannerItem(BannerItem item) {
    // ?렞 [?⑺넗由?濡쒖쭅] ?꾩씠???띿꽦???곕씪 ?곸젅???꾩젽 諛섑솚
    if (item.title.contains("?쒓컙??痍⑥뾽 ?덇?")) {
      return AlbaPermitBanner(item: item);
    } else if (item.title.contains("泥??뚮컮")) {
      return AlbaFirstStepBanner(item: item);
    } else if (item.title.contains("洹쇰줈怨꾩빟??)) {
      return AlbaContractBanner(item: item);
    } else if (item.imagePath != null && item.imagePath!.contains('semicut')) {
      return CareerMainBanner(item: item);
    } else if (item.title.contains("?먯냼??) || item.title.contains("泥⑥궘")) {
      return const CareerResumeBanner();
    } else {
      return CareerRocketBanner(item: item);
    }
  }
}

// -------------------------------------------------------
// ?윦 1. ?쒓컙??痍⑥뾽 ?덇? (Mint-Purple / 罹먮┃?고삎)
// -------------------------------------------------------
class AlbaPermitBanner extends StatelessWidget {
  final BannerItem item;
  const AlbaPermitBanner({super.key, required this.item});

  @override
  Widget build(BuildContext context) {
    return _BaseAlbaBanner(
      gradient: const LinearGradient(
        colors: [Color(0xFFB2EBF2), Color(0xFFE1BEE7)],
      ),
      leading: item.imagePath != null 
          ? Image.asset(item.imagePath!, height: 120) 
          : const SizedBox.shrink(),
      title: item.title,
      subtitle: item.subtitle,
      buttonStyle: _AlbaButtonStyle.white,
      leadingAlignment: Alignment.bottomCenter,
      onButtonTap: () {
        debugPrint("Clicked: ?쒓컙??痍⑥뾽 ?덇?");
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => const PermitApplicationWizard(),
          ),
        );
      },
    );
  }
}


// -------------------------------------------------------
// ?윧 2. 泥??뚮컮, 臾댁뾿遺?? (Peach-Yellow / ?꾩씠肄섑삎)
// -------------------------------------------------------
class AlbaFirstStepBanner extends StatelessWidget {
  final BannerItem item;
  const AlbaFirstStepBanner({super.key, required this.item});

  @override
  Widget build(BuildContext context) {
    return _BaseAlbaBanner(
      gradient: const LinearGradient(
        colors: [Color(0xFFFFECB3), Color(0xFFFFCC80)], // ?곕쑜???먮줈???쇱튂
      ),
      leading: const Text("??, style: TextStyle(fontSize: 60)),
      title: item.title,
      subtitle: item.subtitle,
      buttonStyle: _AlbaButtonStyle.white,
      buttonText: "?뺤씤?섍린",
      onButtonTap: () => debugPrint("Clicked: 泥??뚮컮 媛?대뱶"),
    );
  }
}

// -------------------------------------------------------
// ?윪 3. ?덉쟾??洹쇰줈怨꾩빟??(Teal-Cyan / ?꾩씠肄섑삎)
// -------------------------------------------------------
class AlbaContractBanner extends StatelessWidget {
  final BannerItem item;
  const AlbaContractBanner({super.key, required this.item});

  @override
  Widget build(BuildContext context) {
    return _BaseAlbaBanner(
      gradient: const LinearGradient(
        colors: [Color(0xFFB2DFDB), Color(0xFF80DEEA)], // ?쒖썝???곗씪-?쒖븞
      ),
      leading: const Text("?썳截?, style: TextStyle(fontSize: 60)),
      title: item.title,
      subtitle: item.subtitle,
      buttonStyle: _AlbaButtonStyle.white,
      buttonText: "?뺤씤?섍린",
      onButtonTap: () => debugPrint("Clicked: 洹쇰줈怨꾩빟??),
    );
  }
}

// -------------------------------------------------------
// ?윥 4. 痍⑥뾽 ??硫붿씤 諛곕꼫 (?낅┰ ?꾩젽)
// -------------------------------------------------------
class CareerMainBanner extends ConsumerWidget {
  final BannerItem item;
  const CareerMainBanner({super.key, required this.item});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // final surveyState = ref.watch(surveyProvider); // Unused
    final diagnosisState = ref.watch(diagnosisProvider);
    final isCompleted = diagnosisState.isAnalysisDone;
    
    // Updated: Use model getter
    final score = diagnosisState.result?.totalScore ?? 0;

    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 0),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(20),
        gradient: const LinearGradient(
          colors: [Color(0xFF5C6BC0), Color(0xFF283593)],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
      ),
      child: Stack(
        children: [
          Positioned(
            left: 24, top: 24,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              // const ?쒓굅 (踰꾪듉 ?뚮Ц??
              children: [ 
                Text(
                  "痍⑥뾽??웾 ?먯닔: ${isCompleted ? score : '--'}??, 
                  style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.white)
                ),
                const Text(
                  "痍⑥뾽鍮꾩옄?곌퀎 吏꾨떒", 
                  style: TextStyle(fontSize: 14, color: Colors.white70)
                ),
                const SizedBox(height: 16),
                GestureDetector(
                  onTap: () {
                    debugPrint("Clicked: ?ㅽ럺 吏꾨떒?섍린 (Unified)");
                     if (isCompleted) {
                        Navigator.push(context, MaterialPageRoute(builder: (context) => const ResultScreen()));
                     } else {
                        Navigator.push(context, MaterialPageRoute(builder: (context) => const ConsultingScreen()));
                     }
                  },
                  child: Container(
                    padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(20),
                    ),
                    child: Text(
                      isCompleted ? "寃곌낵 ?ㅼ떆蹂닿린" : "?ㅽ럺 吏꾨떒?섍린",
                      style: TextStyle(fontSize: 13, fontWeight: FontWeight.w600, color: Theme.of(context).primaryColor),
                    ),
                  ),
                ),
              ],
            ),
          ),
          Positioned(
            right: 15, 
            bottom: 0, 
            child: Image.asset('assets/images/capy_corp_semicut.png', height: 130)
          ),
        ],
      ),
    );
  }
}

// -------------------------------------------------------
// ?뱞 5. [?좉퇋/蹂듦뎄] ?먯냼??泥⑥궘 諛곕꼫 (Indigo / 臾몄꽌 ?대え吏)
// -------------------------------------------------------
class CareerResumeBanner extends StatelessWidget {
  const CareerResumeBanner({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 0),
      // User requested "left: 15". Assuming left alignment of the content.
      padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 15), // Adjusted padding for better layout
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(20),
        color: const Color(0xFFFFAB91), // ?덉걶 二쇳솴??
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.start, // Left align as per 'left: 15' suggestion
        children: [
          const Text("?뱞", style: TextStyle(fontSize: 48)), // 臾몄꽌 ?대え吏
          const SizedBox(width: 16), // Gap between emoji and text
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                const Text(
                  "?꾨Ц媛 ?먯냼??泥⑥궘", 
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white)
                ),
                const Text(
                  "?⑷꺽瑜좎쓣 ?믪씠???대젰???꾩꽦", 
                  style: TextStyle(fontSize: 13, color: Colors.white)
                ),
                const SizedBox(height: 12),
                Align(
                  alignment: Alignment.centerRight,
                  child: Padding(
                    padding: const EdgeInsets.only(right: 70.0), // Pulled back more (was 8)
                    child: GestureDetector(
                      onTap: () => debugPrint("Clicked: ?먯냼??泥⑥궘 ?좎껌?섍린"),
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
                        decoration: BoxDecoration(
                          color: Colors.white.withValues(alpha: 0.8),
                          borderRadius: BorderRadius.circular(20),
                          border: Border.all(color: Colors.black12),
                        ),
                        child: const Text(
                          "?좎껌?섍린", 
                          style: TextStyle(color: Colors.black, fontSize: 12, fontWeight: FontWeight.bold)
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// -------------------------------------------------------
// ?? 5. 痍⑥뾽 ??濡쒖폆 諛곕꼫 (?낅┰ ?꾩젽)
// -------------------------------------------------------
class CareerRocketBanner extends StatelessWidget {
  final BannerItem item;
  const CareerRocketBanner({super.key, required this.item});

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 0),
      padding: const EdgeInsets.symmetric(vertical: 15), // Add padding for content spacing
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(20),
        color: const Color(0xFF29B6F6),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const Text("??", style: TextStyle(fontSize: 48)),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                const Text(
                  "IT/?ㅽ??몄뾽 ?명꽩??, 
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white)
                ),
                const Text(
                  "?쒓뎅 ?ㅽ??몄뾽?먯꽌 而ㅻ━?대? ?쒖옉?섏꽭??", 
                  style: TextStyle(fontSize: 13, color: Colors.white)
                ),
                const SizedBox(height: 12),
                Align(
                  alignment: Alignment.centerRight,
                  child: Padding(
                    padding: const EdgeInsets.only(right: 70.0), // Pulled back more (was 8)
                    child: GestureDetector(
                      onTap: () => debugPrint("Clicked: IT/?ㅽ??몄뾽 ?명꽩???좎껌?섍린"),
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
                        decoration: BoxDecoration(
                          color: Colors.white.withValues(alpha: 0.8),
                          borderRadius: BorderRadius.circular(20),
                          border: Border.all(color: Colors.black12),
                        ),
                        child: const Text(
                          "?좎껌?섍린", 
                          style: TextStyle(color: Colors.black, fontSize: 12, fontWeight: FontWeight.bold)
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// -------------------------------------------------------
// ?썱截??뚮컮 諛곕꼫 ?꾩슜 怨듯넻 踰좎씠??(?뷀뀒??遺꾨━)
// -------------------------------------------------------
enum _AlbaButtonStyle { gradient, white }

class _BaseAlbaBanner extends StatelessWidget {
  final Gradient gradient;
  final Widget leading;
  final String title;
  final String subtitle;
  final _AlbaButtonStyle buttonStyle;
  final String buttonText; // 踰꾪듉 ?띿뒪??異붽?
  final AlignmentGeometry? leadingAlignment;

  const _BaseAlbaBanner({
    required this.gradient, 
    required this.leading,
    required this.title, 
    required this.subtitle, 
    required this.buttonStyle,
    this.buttonText = "?좎껌?섎윭 媛湲?, // 湲곕낯媛??ㅼ젙
    this.leadingAlignment,
    this.onButtonTap, // Callback for button tap
  });

  final VoidCallback? onButtonTap;

  @override
  Widget build(BuildContext context) {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 0),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(20), 
        gradient: gradient,
      ),
      child: Stack(
        children: [
          Positioned(
            left: 25, 
            top: 0, 
            bottom: 0, 
            child: Align(
              alignment: leadingAlignment ?? Alignment.center,
              child: leading
            )
          ),
          Positioned(
            left: 145, 
            top: 0, 
            bottom: 0,
            right: 20,
            child: Center(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(
                    title, 
                    style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.black, height: 1.2)
                  ),
                  Text(
                    subtitle, 
                    style: const TextStyle(fontSize: 13, color: Colors.black54, height: 1.2)
                  ),
                  const SizedBox(height: 12),
                  _buildButton(),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildButton() {
    if (buttonStyle == _AlbaButtonStyle.gradient) {
      // 洹몃씪?곗씠??踰꾪듉
      return GestureDetector(
        onTap: onButtonTap,
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(20),
            gradient: const LinearGradient(colors: [Color(0xFF4DB6AC), Color(0xFF7E57C2)]),
            boxShadow: [
               BoxShadow(
                 color: const Color(0xFF7986CB).withValues(alpha: 0.4), 
                 blurRadius: 8,
                 offset: const Offset(0, 4),
               ),
             ],
          ),
          child: Text(
            buttonText, 
            style: const TextStyle(color: Colors.white, fontSize: 12, fontWeight: FontWeight.bold)
          ),
        ),
      );
    } else {
      // ?붿씠??踰꾪듉
      return GestureDetector(
        onTap: onButtonTap,
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
          decoration: BoxDecoration(
            color: Colors.white.withValues(alpha: 0.8),
            borderRadius: BorderRadius.circular(20),
            border: Border.all(color: Colors.black12),
          ),
          child: Text(
            buttonText, 
            style: const TextStyle(color: Colors.black, fontSize: 12, fontWeight: FontWeight.bold)
          ),
        ),
      );
    }
  }
}

=== lib\screens\jobs\widgets\salary_dashboard.dart ===
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:flutter/cupertino.dart'; // Import Cupertino for clock icon

import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../providers/job_providers.dart';

class SalaryDashboard extends ConsumerWidget {
  const SalaryDashboard({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final currencyFormat = NumberFormat("#,###");
    final theme = ref.watch(jobThemeProvider);

    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 20),
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.05),
            blurRadius: 15,
            offset: const Offset(0, 5),
          ),
        ],
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text(
                '?덉긽 ?붽툒',
                style: TextStyle(fontSize: 14, color: Colors.grey, fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 8),
              Text(
                '${currencyFormat.format(1200000)}??,
                style: const TextStyle(
                  fontSize: 28,
                  fontWeight: FontWeight.w900,
                  color: Color(0xFF1A1A2E),
                ),
              ),
              InkWell(
                onTap: () {
                  debugPrint('湲곕줉?섍린 Click!');
                },
                borderRadius: BorderRadius.circular(8),
                child: AnimatedContainer(
                  duration: const Duration(milliseconds: 300),
                  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                  decoration: BoxDecoration(
                    color: theme.secondaryColor.withValues(alpha: 0.2), // Light background based on secondary
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Text(
                    '湲곕줉?섍린',
                    style: TextStyle(
                      color: theme.primaryColor, // Text matches primary
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                    ),
                  ),
                ),
              ),
            ],
          ),
          // Clock Icon
          const Icon(
            CupertinoIcons.time,
            size: 80,
            color: Color(0xFFDEDCBA), 
          ),
        ],
      ),
    );
  }
}

=== lib\screens\jobs\widgets\visa_report_card.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../providers/diagnosis_provider.dart';
import '../../diagnosis/consulting_screen.dart';
import '../../diagnosis/result_screen.dart';

class VisaReportCard extends ConsumerWidget {
  const VisaReportCard({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final diagnosisState = ref.watch(diagnosisProvider);
    final hasResult = diagnosisState.isAnalysisDone && diagnosisState.result != null;

    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 20, vertical: 0),
      width: double.infinity,
      constraints: const BoxConstraints(minHeight: 160),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      clipBehavior: Clip.hardEdge,
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: () {
            if (hasResult) {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => const ResultScreen()),
              );
            } else {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => const ConsultingScreen()),
              );
            }
          },
          child: hasResult
              ? _buildUnlockedSummaryCard(context, diagnosisState.result!)
              : _buildLockedReportCard(context),
        ),
      ),
    );
  }

  Widget _buildLockedReportCard(BuildContext context) {
    return Stack(
      children: [
        // Background Pattern
        Positioned.fill(
          child: Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  Colors.grey[50]!,  // Very light grey
                  Colors.grey[100]!, // Light grey
                ],
              ),
            ),
          ),
        ),
        
        // Content
        Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Icon(
                Icons.lock_outline_rounded,
                size: 40, 
                color: Color(0xFF9FA8DA), // Indigo 200
              ),
              const SizedBox(height: 16),
              const Text(
                "?섏쓽 E-7 鍮꾩옄 ?⑷꺽瑜좎? 紐???",
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF283593), // Indigo 800
                ),
              ),
              const SizedBox(height: 8),
              const Text(
                "3遺?留뚯뿉 痍⑥뾽 ??웾??吏꾨떒?섍퀬\n?곸꽭 由ы룷?몃? ?뺤씤?대낫?몄슂.",
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: 14,
                  color: Colors.black54,
                  height: 1.4,
                ),
              ),
              const SizedBox(height: 20),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                decoration: BoxDecoration(
                  color: const Color(0xFF5C6BC0), // Indigo 400
                  borderRadius: BorderRadius.circular(30),
                  boxShadow: [
                    BoxShadow(
                      color: const Color(0xFF5C6BC0).withOpacity(0.4),
                      blurRadius: 8,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: const Text(
                  "吏꾨떒 ?쒖옉?섍린",
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                    fontSize: 14,
                  ),
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildUnlockedSummaryCard(BuildContext context, dynamic result) { // Using dynamic to avoid import issues if models move, but practically uses DiagnosisResult
    final topJob = result.analysisResults.isNotEmpty 
        ? result.analysisResults.values.first 
        : null;

    return Padding(
      padding: const EdgeInsets.all(24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Row(
                children: [
                  const Icon(Icons.verified_user_outlined, size: 20, color: Color(0xFF283593)), // Indigo 800
                  const SizedBox(width: 8),
                  Text(
                    "??鍮꾩옄 留ㅼ묶 由ы룷??,
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      color: Colors.grey[800],
                    ),
                  ),
                ],
              ),
              Row(
                children: [
                  Text(
                    "?곸꽭蹂닿린",
                    style: TextStyle(
                      fontSize: 12,
                      color: Colors.grey[500],
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                  Icon(Icons.chevron_right, size: 16, color: Colors.grey[400]),
                ],
              ),
            ],
          ),
          const SizedBox(height: 20),
          
          // Scores Row
          Row(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Container(
                width: 60,
                height: 60,
                decoration: BoxDecoration(
                  color: const Color(0xFFE8EAF6), // Indigo 50
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Center(
                  child: Text(
                    "${result.totalScore}",
                    style: const TextStyle(
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                      color: Color(0xFF283593),
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 16),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    "醫낇빀 ?깃툒",
                    style: TextStyle(
                      fontSize: 12,
                      color: Colors.grey[600],
                    ),
                  ),
                  const SizedBox(height: 4),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                    decoration: BoxDecoration(
                      color: _getTierColor(result.totalTier).withOpacity(0.1),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(color: _getTierColor(result.totalTier).withOpacity(0.5)),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Text(
                          _getTierIcon(result.totalTier), 
                          style: const TextStyle(fontSize: 14)
                        ),
                        const SizedBox(width: 6),
                        Text(
                          result.totalTier,
                          style: TextStyle(
                            fontSize: 14,
                            fontWeight: FontWeight.bold,
                            color: _getTierColor(result.totalTier),
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ],
          ),
          const SizedBox(height: 20),
          Divider(color: Colors.grey[100], height: 1),
          const SizedBox(height: 16),
          
          // Recommendation
          if (topJob != null)
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Colors.grey[100],
                    shape: BoxShape.circle,
                  ),
                  child: _getSignalIcon(topJob.visaStatus),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        "媛??異붿쿇?섎뒗 吏곷Т",
                        style: TextStyle(
                          fontSize: 11,
                          color: Colors.grey[500],
                        ),
                      ),
                      const SizedBox(height: 2),
                      RichText(
                        text: TextSpan(
                          children: [
                            TextSpan(
                              text: topJob.jobName,
                              style: const TextStyle(
                                fontSize: 14,
                                fontWeight: FontWeight.bold,
                                color: Colors.black87,
                              ),
                            ),
                            const TextSpan(
                              text: " ?낅땲??",
                              style: TextStyle(
                                fontSize: 14,
                                color: Colors.black54,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
        ],
      ),
    );
  }

  Color _getTierColor(String tier) {
    switch (tier.toUpperCase()) {
      case 'DIAMOND': return Colors.blueAccent;
      case 'PLATINUM': return Colors.teal;
      case 'GOLD': return  const Color(0xFFFFA000); // Amber 700
      case 'SILVER': return Colors.grey;
      default: return Colors.grey;
    }
  }

  String _getTierIcon(String tier) {
    switch (tier.toUpperCase()) {
      case 'DIAMOND': return "?뭿";
      case 'PLATINUM': return "?뮔";
      case 'GOLD': return "?룇";
      case 'SILVER': return "?쪎";
      default: return "?렡";
    }
  }

  Widget _getSignalIcon(dynamic status) { // VisaStatus enum
    // Assuming VisaStatus string or enum. 
    // Checking string representation or enum value
    Color color = Colors.grey;
    if (status.toString().contains('GREEN')) {
      color = Colors.green;
    } else if (status.toString().contains('YELLOW')) color = Colors.amber;
    else if (status.toString().contains('RED')) color = Colors.red;

    return Icon(Icons.circle, size: 12, color: color);
  }
}

=== lib\screens\mypage\my_page_screen.dart ===
import 'package:flutter/material.dart';
import '../../models/user.dart';
import '../wallet/my_point_screen.dart';
import '../spec/spec_wallet_screen.dart';

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../providers/point_provider.dart';
import '../schedule/schedule_screen.dart';
import '../../providers/schedule_provider.dart';
import '../../models/schedule_model.dart';

class MyPageScreen extends StatelessWidget {
  const MyPageScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final user = User.dummy();

    return Scaffold(
      backgroundColor: Colors.grey[50], // Light background
      body: SafeArea(
        child: SingleChildScrollView(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20.0),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.stretch,
              children: [
                const SizedBox(height: 20),
                // 1. Profile Header
                _ProfileHeader(user: user),
                const SizedBox(height: 24),

                // 2. Visa & Work Permit Dashboard
                _VisaDashboard(user: user),
                const SizedBox(height: 24),

                // 3. Weekly Schedule
                const _WeeklySchedule(),
                const SizedBox(height: 24),

                // 4. Menu List
                const _MenuList(),
                const SizedBox(height: 40),
              ],
            ),
          ),
        ),
      ),
    );
  }
}



class _ProfileHeader extends ConsumerWidget {
  final User user;
  const _ProfileHeader({required this.user});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Watch PointProvider for real-time balance
    final pointState = ref.watch(pointProvider);
    final formattedPoints = NumberFormat('#,###').format(pointState.totalBalance);

    return Row(
      children: [
          // Avatar
        Container(
          width: 60,
          height: 60,
          // Removed padding to make the image fill the circle better as per "fit: BoxFit.cover" request
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: Colors.grey[200], // Light grey background
            border: Border.all(color: Colors.grey[300]!),
          ),
          child: ClipOval( // ClipOval ensures the square image is clipped to the circle
            child: Image.asset(
              'assets/images/unknown_user.png',
              fit: BoxFit.cover, // Cover to fill the circle
            ),
          ),
        ),
        const SizedBox(width: 16),
        // User Info
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                user.name,
                style: const TextStyle(
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF1A1A2E),
                ),
              ),
              const SizedBox(height: 4),
              Text(
                user.university,
                style: const TextStyle(
                  fontSize: 14,
                  color: Colors.grey,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ],
          ),
        ),
        // Points & Shop
        Column(
          crossAxisAlignment: CrossAxisAlignment.end,
          children: [
            GestureDetector(
              onTap: () {
                Navigator.push(
                  context,
                  MaterialPageRoute(builder: (context) => const MyPointScreen()),
                );
              },
              child: Text(
                '$formattedPoints P', 
                style: const TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF1A1A2E), // Navy
                ),
              ),
            ),
            const SizedBox(height: 8),
            GestureDetector(
              onTap: () {
                // Shop Action
              },
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),
                decoration: BoxDecoration(
                  color: const Color(0xFF3F51B5), // Indigo/Blue
                  borderRadius: BorderRadius.circular(20),
                  boxShadow: [
                    BoxShadow(
                      color: const Color(0xFF3F51B5).withValues(alpha: 0.3),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: const Text(
                  'Shop',
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                    fontSize: 12,
                  ),
                ),
              ),
            ),
          ],
        ),
      ],
    );
  }
}

class _VisaDashboard extends StatelessWidget {
  final User user;
  const _VisaDashboard({required this.user});

  @override
  Widget build(BuildContext context) {
    // Logic for Badge: If visa is "鍮꾩옄 ?뺣낫 ?놁쓬", show Grey "誘몄뿰?? badge
    final isVisaEmpty = user.visaType == '鍮꾩옄 ?뺣낫 ?놁쓬';

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: const LinearGradient(
          colors: [
            Color(0xFF009688), // Teal
            Color(0xFF3F51B5), // Blue
            Color(0xFF9C27B0), // Purple
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: const Color(0xFF3F51B5).withValues(alpha: 0.3),
            blurRadius: 16,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            '鍮꾩옄 & 痍⑥뾽 ?덇? ??쒕낫??,
            style: TextStyle(
              color: Colors.white,
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 16),
          // Card 1: Visa Status
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text(
                        '鍮꾩옄 ?곹깭',
                        style: TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                          color: Color(0xFF1A1A2E),
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        '${user.visaType} | 留뚮즺: ${user.visaExpiry}',
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.grey[600],
                        ),
                      ),
                    ],
                  ),
                ),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                  decoration: BoxDecoration(
                    color: isVisaEmpty ? Colors.grey[200] : const Color(0xFFE8F5E9),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Text(
                    isVisaEmpty ? '誘몄뿰?? : 'SAFE',
                    style: TextStyle(
                      fontSize: 11,
                      fontWeight: FontWeight.bold,
                      color: isVisaEmpty ? Colors.grey[600] : const Color(0xFF2E7D32),
                    ),
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 12),
          // Card 2: Work Permit
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text(
                        '?꾨Ⅴ諛붿씠???덇?',
                        style: TextStyle(
                          fontSize: 14,
                          fontWeight: FontWeight.bold,
                          color: Color(0xFF1A1A2E),
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        isVisaEmpty ? '- ~ -' : '${user.workPermitDate} | ${user.isWorkPermitApproved ? '?뱀씤 ?꾨즺' : '誘몄듅??}',
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.grey[600],
                        ),
                      ),
                    ],
                  ),
                ),
                Container(
                  width: 24,
                  height: 24,
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    border: Border.all(
                      color: isVisaEmpty ? Colors.grey : Colors.black87,
                      width: 1.5,
                    ),
                  ),
                  child: Icon(
                    isVisaEmpty ? Icons.access_time_rounded : Icons.check, // Empty state -> Clock icon
                    size: 16,
                    color: isVisaEmpty ? Colors.grey : Colors.black87,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}



class _WeeklySchedule extends ConsumerWidget {
  const _WeeklySchedule();

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final scheduleNotifier = ref.read(scheduleProvider.notifier);
    // Watch provider to rebuild when schedule changes
    ref.watch(scheduleProvider); 

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.05),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              const Text(
                '二쇨컙 ?쒓컙??,
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF1A1A2E),
                ),
              ),
              InkWell(
                onTap: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(builder: (context) => const ScheduleScreen()),
                  );
                },
                child: const Padding(
                  padding: EdgeInsets.all(4.0),
                  child: Text(
                    '?섏젙?섍린',
                    style: TextStyle(
                      fontSize: 12,
                      color: Colors.grey,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          // Table Layout
          Table(
            defaultVerticalAlignment: TableCellVerticalAlignment.top,
            children: [
              // Header Row
              const TableRow(
                children: [
                  Center(child: Text('Mon', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13))),
                  Center(child: Text('Tue', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13))),
                  Center(child: Text('Wed', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13))),
                  Center(child: Text('Thu', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13))),
                  Center(child: Text('Fri', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13))),
                  Center(child: Text('Sat', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13, color: Colors.red))),
                  Center(child: Text('Sun', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13, color: Colors.red))),
                ],
              ),
              const TableRow(children: [SizedBox(height: 12), SizedBox(height: 12), SizedBox(height: 12), SizedBox(height: 12), SizedBox(height: 12), SizedBox(height: 12), SizedBox(height: 12)]),
              // Row 1: Classes Chips
              TableRow(
                children: [
                  for (int i = 1; i <= 7; i++)
                    _buildDayCell(scheduleNotifier.getClassesForDay(i)),
                ],
              ),
            ],
          ),
        ],
      ),
    );
  }



  Widget _buildDayCell(List<Schedule> classes) { // Changed ClassItem to Schedule
    if (classes.isEmpty) {
      return const SizedBox(height: 30, child: Center(child: Icon(Icons.circle, size: 6, color: Colors.grey)));
    }
    
    // Check if there are mainly classes or alba (if implemented later). For now, just '?섏뾽' blue chip.
    // If multiple classes, just show one '?섏뾽' chip to indicate busy.
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 2),
      padding: const EdgeInsets.symmetric(vertical: 6),
      decoration: BoxDecoration(
        color: const Color(0xFFE3F2FD),
        borderRadius: BorderRadius.circular(8),
      ),
      child: const Text(
        '?섏뾽',
        textAlign: TextAlign.center,
        style: TextStyle(
          fontSize: 12,
          fontWeight: FontWeight.bold,
          color: Color(0xFF1565C0),
        ),
      ),
    );
  }
}

class _MenuList extends StatelessWidget {
  const _MenuList();

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.05),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        children: [
          _buildMenuItem(context, Icons.folder_outlined, '?쒕쪟 吏媛?),
          const Divider(height: 1, indent: 20, endIndent: 20),
          _buildMenuItem(context, Icons.chat_bubble_outline_rounded, '而ㅻ??덊떚 ?쒕룞'),
          const Divider(height: 1, indent: 20, endIndent: 20),
          _buildMenuItem(context, Icons.person_outline_rounded, '媛쒖씤 ?뺣낫 愿由?),
          const Divider(height: 1, indent: 20, endIndent: 20),
          _buildMenuItem(context, Icons.settings_outlined, '?ㅼ젙'),
        ],
      ),
    );
  }

  Widget _buildMenuItem(BuildContext context, IconData icon, String title) {
    return ListTile(
      leading: Icon(icon, color: Colors.black87),
      title: Text(
        title,
        style: const TextStyle(
          fontSize: 15,
          fontWeight: FontWeight.w500,
          color: Colors.black87,
        ),
      ),
      trailing: const Icon(Icons.arrow_forward_ios_rounded, size: 16, color: Colors.grey),
      onTap: () {
        if (title == '?쒕쪟 吏媛?) {
          Navigator.push(
            context,
            MaterialPageRoute(builder: (context) => const SpecWalletScreen()),
          );
        }
      },
      contentPadding: const EdgeInsets.symmetric(horizontal: 20, vertical: 4),
    );
  }
}

=== lib\screens\roadmap\thesis_schedule_screen.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class ThesisScheduleScreen extends StatefulWidget {
  const ThesisScheduleScreen({Key? key}) : super(key: key);

  @override
  State<ThesisScheduleScreen> createState() => _ThesisScheduleScreenState();
}

class _ThesisScheduleScreenState extends State<ThesisScheduleScreen> {
  // ?곕え???곗씠??
  final List<Map<String, dynamic>> _steps = [
    {'title': '?곌뎄 怨꾪쉷??Proposal) 諛쒗몴', 'date': '2025.10.15', 'isCompleted': true},
    {'title': '?숈쐞 泥?뎄 ?쇰Ц ?ъ궗 ?좎껌', 'date': '2026.04.01', 'isCompleted': true},
    {'title': '?덈퉬 ?ъ궗 (Preliminary)', 'date': '2026.05.20', 'isCompleted': false, 'isNext': true},
    {'title': '蹂??ъ궗 (Main Defense)', 'date': '2026.06.15', 'isCompleted': false},
    {'title': '理쒖쥌 ?쇰Ц ?몄뇙蹂??쒖텧', 'date': '2026.07.10', 'isCompleted': false},
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFF5F7FA),
      appBar: AppBar(
        title: Text('?쇰Ц ?ъ궗 ?쇱젙', style: GoogleFonts.notoSansKr(fontWeight: FontWeight.bold, color: Colors.black)),
        centerTitle: true,
        backgroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.black),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      body: Column(
        children: [
          // 1. ?곷떒 D-Day 諛??숆린遺??移대뱶
          Container(
            width: double.infinity,
            margin: const EdgeInsets.all(20),
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              gradient: const LinearGradient(
                colors: [Color(0xFF673AB7), Color(0xFF9575CD)], // 蹂대씪??洹몃씪?곗씠??
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
              borderRadius: BorderRadius.circular(24),
              boxShadow: [
                BoxShadow(
                  color: const Color(0xFF673AB7).withOpacity(0.4),
                  blurRadius: 15,
                  offset: const Offset(0, 8),
                ),
              ],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      '?덈퉬 ?ъ궗源뚯?',
                      style: GoogleFonts.notoSansKr(color: Colors.white.withOpacity(0.9), fontSize: 16),
                    ),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                      decoration: BoxDecoration(
                        color: Colors.white.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: const Text(
                        'D-30',
                        style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Text(
                  '?쒕쪟 以鍮꾨뒗 ???섏뀲?섏슂?',
                  style: GoogleFonts.notoSansKr(color: Colors.white, fontSize: 22, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 16),
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Row(
                    children: [
                      const Icon(Icons.stars_rounded, color: Color(0xFF673AB7)),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          '?ъ궗 ?듦낵 ???숇젰 ?먯닔 +20???뺤젙!',
                          style: GoogleFonts.notoSansKr(
                            color: const Color(0xFF673AB7),
                            fontWeight: FontWeight.bold,
                            fontSize: 13,
                          ),
                        ),
                      ),
                    ],
                  ),
                )
              ],
            ),
          ),

          // 2. ??꾨씪??由ъ뒪??
          Expanded(
            child: Container(
              width: double.infinity,
              decoration: const BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.vertical(top: Radius.circular(30)),
              ),
              child: ListView.builder(
                padding: const EdgeInsets.all(24),
                itemCount: _steps.length,
                itemBuilder: (context, index) {
                  final step = _steps[index];
                  final bool isCompleted = step['isCompleted'];
                  final bool isNext = step['isNext'] ?? false;

                  return IntrinsicHeight(
                    child: Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // ??꾨씪???쇱씤 諛???
                        Column(
                          children: [
                            Container(
                              width: 20,
                              height: 20,
                              decoration: BoxDecoration(
                                color: isCompleted 
                                    ? const Color(0xFF673AB7) 
                                    : (isNext ? Colors.white : Colors.grey[300]),
                                border: Border.all(
                                  color: isCompleted || isNext ? const Color(0xFF673AB7) : Colors.grey[300]!,
                                  width: 2,
                                ),
                                shape: BoxShape.circle,
                              ),
                              child: isCompleted 
                                  ? const Icon(Icons.check, size: 12, color: Colors.white)
                                  : (isNext ? Center(child: Container(width: 8, height: 8, decoration: const BoxDecoration(color: Color(0xFF673AB7), shape: BoxShape.circle))) : null),
                            ),
                            if (index != _steps.length - 1)
                              Expanded(
                                child: Container(
                                  width: 2,
                                  color: Colors.grey[200],
                                ),
                              ),
                          ],
                        ),
                        const SizedBox(width: 16),
                        // ?띿뒪???댁슜
                        Expanded(
                          child: Padding(
                            padding: const EdgeInsets.only(bottom: 32.0),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  step['title'],
                                  style: GoogleFonts.notoSansKr(
                                    fontSize: 16,
                                    fontWeight: isNext || isCompleted ? FontWeight.bold : FontWeight.normal,
                                    color: isNext || isCompleted ? Colors.black87 : Colors.grey[500],
                                  ),
                                ),
                                const SizedBox(height: 4),
                                Text(
                                  step['date'],
                                  style: GoogleFonts.notoSansKr(
                                    fontSize: 13,
                                    color: isNext ? const Color(0xFF673AB7) : Colors.grey[400],
                                    fontWeight: isNext ? FontWeight.w600 : FontWeight.normal,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),
                  );
                },
              ),
            ),
          ),
        ],
      ),
    );
  }
}

=== lib\screens\roadmap\visa_roadmap_screen.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import '../visa/f27_visa_calculator_screen.dart'; // Ensure this import exists
import 'thesis_schedule_screen.dart'; // Import for ThesisScheduleScreen

class VisaRoadmapScreen extends StatefulWidget {
  final String? userGoal;
  final VoidCallback? onGoalChangeRequested;

  const VisaRoadmapScreen({
    Key? key,
    this.userGoal,
    this.onGoalChangeRequested,
  }) : super(key: key);

  @override
  State<VisaRoadmapScreen> createState() => _VisaRoadmapScreenState();
}

class _VisaRoadmapScreenState extends State<VisaRoadmapScreen> {
  // ??Initialize to 0 and detailed result
  int currentScore = 0;
  bool hasCalculated = false;
  Map<String, dynamic>? detailedResult; // ??New: Stores full calculator result

  @override
  void initState() {
    super.initState();
    _refreshScore();
  }

  void _refreshScore() {
    setState(() {
      // TODO: Connect to actual store
    });
  }

  @override
  Widget build(BuildContext context) {
    bool isPass = currentScore >= 80;

    return Scaffold(
      backgroundColor: const Color(0xFFF5F7FA),
      appBar: AppBar(
        title: Text('My Visa Roadmap', style: GoogleFonts.notoSansKr(fontWeight: FontWeight.bold, color: Colors.black)),
        centerTitle: true,
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.black),
          onPressed: () => Navigator.pop(context),
        ),
        actions: [
          Padding(
            padding: const EdgeInsets.only(right: 16.0),
            child: TextButton.icon(
              onPressed: widget.onGoalChangeRequested,
              style: TextButton.styleFrom(
                backgroundColor: Colors.grey[100],
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              ),
              icon: const Icon(Icons.swap_horiz_rounded, size: 16, color: Color(0xFF1E2B4D)),
              label: Text(
                "?좏삎 蹂寃?,
                style: GoogleFonts.notoSansKr(
                  fontSize: 12,
                  fontWeight: FontWeight.bold,
                  color: const Color(0xFF1E2B4D),
                ),
              ),
            ),
          ),
        ],
      ),
      body: ListView(
        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
        children: [
          // 1. Current Visa Status Card (Keep as is)
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              color: const Color(0xFF1E2B4D),
              borderRadius: BorderRadius.circular(24),
              boxShadow: [
                BoxShadow(color: const Color(0xFF1E2B4D).withOpacity(0.3), blurRadius: 15, offset: const Offset(0, 8)),
              ],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text('?꾩옱 鍮꾩옄 ?곹깭', style: GoogleFonts.notoSansKr(color: Colors.white70, fontSize: 14)),
                const SizedBox(height: 8),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text('D-2 ?좏븰鍮꾩옄', style: GoogleFonts.notoSansKr(color: Colors.white, fontSize: 24, fontWeight: FontWeight.bold)),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                      decoration: BoxDecoration(color: Colors.white.withOpacity(0.2), borderRadius: BorderRadius.circular(20)),
                      child: Text('D-365', style: GoogleFonts.notoSansKr(color: Colors.white, fontWeight: FontWeight.w600)),
                    )
                  ],
                )
              ],
            ),
          ),
          
          const SizedBox(height: 24),

          // 1.5 ??NEW: Detailed Visa Guide Section
          _buildVisaGuideSection(context),

          const SizedBox(height: 24),

          // 2. F-2-7 Calculator Card
          GestureDetector(
            onTap: () async {
              final result = await Navigator.push(context, MaterialPageRoute(builder: (context) => const F27VisaCalculatorScreen()));
              if (result != null && result is Map<String, dynamic>) {
                  setState(() {
                      detailedResult = result;
                      currentScore = result['totalScore'] as int;
                      hasCalculated = true; 
                  });
              }
            },
            child: Container(
              padding: const EdgeInsets.fromLTRB(24, 20, 16, 20),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft, end: Alignment.bottomRight,
                  colors: [Colors.white, const Color(0xFFE3F2FD).withOpacity(0.5)],
                ),
                borderRadius: BorderRadius.circular(24),
                boxShadow: [BoxShadow(color: const Color(0xFF1E2B4D).withOpacity(0.15), blurRadius: 25, offset: const Offset(0, 10), spreadRadius: 2)],
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text('紐⑥쓽 ?먯닔 怨꾩궛湲?, style: GoogleFonts.notoSansKr(fontSize: 16, color: const Color(0xFF1E2B4D), fontWeight: FontWeight.bold)),
                        const SizedBox(height: 12),
                        // Only show score if calculated, otherwise show placeholder or ???
                        if (hasCalculated) ...[
                             RichText(
                              text: TextSpan(
                                children: [
                                  TextSpan(text: '$currentScore', style: GoogleFonts.notoSansKr(fontSize: 40, fontWeight: FontWeight.w900, color: const Color(0xFF1E2B4D), height: 1.0)),
                                  TextSpan(text: ' / 80', style: GoogleFonts.notoSansKr(fontSize: 20, color: Colors.grey[400], fontWeight: FontWeight.w600)),
                                ],
                              ),
                            ),
                        ] else ...[
                            Text('? / 80', style: GoogleFonts.notoSansKr(fontSize: 40, fontWeight: FontWeight.w900, color: Colors.grey[300], height: 1.0)),
                        ],

                        const SizedBox(height: 12),
                        // ??Button Style Action
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                          decoration: BoxDecoration(
                            color: const Color(0xFF673AB7), // Brand Color
                            borderRadius: BorderRadius.circular(20),
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                                Text(
                                hasCalculated ? '?ㅼ떆 怨꾩궛?섍린' : '紐⑥쓽 ?먯닔 怨꾩궛?대낫湲?,
                                style: GoogleFonts.notoSansKr(fontSize: 13, fontWeight: FontWeight.w700, color: Colors.white),
                              ),
                              const SizedBox(width: 4),
                              const Icon(Icons.arrow_forward_ios_rounded, color: Colors.white, size: 10)
                            ]
                          )
                        ),
                      ],
                    ),
                  ),
                  Stack(
                    alignment: Alignment.center,
                    children: [
                      Container(height: 80, width: 80, decoration: BoxDecoration(shape: BoxShape.circle, boxShadow: [BoxShadow(color: const Color(0xFF0277BD).withOpacity(0.4), blurRadius: 40, spreadRadius: 5)])),
                      Hero(tag: 'calculator_hero', child: Image.asset('assets/images/calculator.png', height: 110, fit: BoxFit.contain)),
                    ],
                  ),
                ],
              ),
            ),
          ),

          const SizedBox(height: 24),

          // 3. ??NEW: Visa Upgrade Strategy Card (Conditional)
          if (hasCalculated)
            _buildUpgradeStrategyCard(context, currentScore),
          
          if (hasCalculated)
            const SizedBox(height: 40),
        ],
      ),
    );
  }

  // --- NEW WIDGETS ---

  // 1. Detailed Visa Guide Section
  Widget _buildVisaGuideSection(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: const Color(0xFF1E2B4D).withOpacity(0.08),
            blurRadius: 20,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Row(
            children: [
              const Icon(Icons.school, color: Color(0xFF1E2B4D), size: 24),
              const SizedBox(width: 8),
              Text(
                "F-2-7 鍮꾩옄 媛쒕뀗 ?↔린",
                style: GoogleFonts.notoSansKr(
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  color: const Color(0xFF1E2B4D),
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),

          // 1. Concept Formula (Visual Equation)
          Container(
            padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 12),
            decoration: BoxDecoration(
              color: const Color(0xFFF5F7FA),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    _buildFormulaBadge("?뮳 E-7 吏곸쥌", Colors.grey[700]!, Colors.grey[200]!),
                    Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 4),
                      child: Icon(Icons.add_rounded, size: 16, color: Colors.grey[600]),
                    ),
                    _buildFormulaBadge("?뮣 80??, const Color(0xFF1565C0), const Color(0xFFE3F2FD)),
                    Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 4),
                      child: Icon(Icons.arrow_forward_rounded, size: 16, color: Colors.grey[600]),
                    ),
                    Expanded(
                      child: _buildFormulaBadge("??F-2-7 (嫄곗＜)", const Color(0xFF673AB7), const Color(0xFFEDE7F6)),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                // ??Text Update
                Text(
                  "吏곸쥌? 媛숈뒿?덈떎. (E-7-1 ?꾨Ц吏?\n?섏?留??앹궗 ?댁긽 ?숈쐞???먯닔(80??瑜?梨꾩슦硫?n鍮꾩옄媛 ?낃렇?덉씠?쒕맗?덈떎.",
                  textAlign: TextAlign.center,
                  style: GoogleFonts.notoSansKr(
                    fontSize: 13,
                    color: Colors.grey[700],
                    height: 1.5,
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 24),

          // 2. Comparison Table
          Text(
            "???낃렇?덉씠???댁빞 ?좉퉴??",
            style: GoogleFonts.notoSansKr(
              fontSize: 15,
              fontWeight: FontWeight.bold,
              color: const Color(0xFF1E2B4D),
            ),
          ),
          const SizedBox(height: 12),
          Column(
            children: [
              // ??Header Row
              Row(
                children: [
                    const SizedBox(width: 70), // Spacer for title
                    Expanded(child: Center(child: Text("?쇰컲 痍⑥뾽 (E-7)", style: GoogleFonts.notoSansKr(fontSize: 12, color: Colors.grey, fontWeight: FontWeight.bold)))),
                    // SizedBox(width: 20), // Spacer for divider not needed if using Expanded properly, but let's keep consistent
                    Expanded(child: Center(child: Text("嫄곗＜ 鍮꾩옄 (F-2-7)", style: GoogleFonts.notoSansKr(fontSize: 12, color: const Color(0xFF673AB7), fontWeight: FontWeight.bold)))),
                ],
              ),
              const SizedBox(height: 8),

              _buildCompareListRow("?댁쭅???먯쑀", "???뚯궗 ?덇? ?꾩닔", "狩??먯쑀濡쒖슫 ?댁쭅"),
              Container(height: 1, color: Colors.grey[100]),
              _buildCompareListRow("泥대쪟 湲곌컙", "?좑툘 1~2??(吏㏃쓬)", "??理쒕? 5??(?ъ쑀)"),
              Container(height: 1, color: Colors.grey[100]),
              _buildCompareListRow("媛議??쒗깮", "??諛곗슦??痍⑥뾽 遺덇?", "狩?諛곗슦?먮룄 痍⑥뾽 媛??),
              Container(height: 1, color: Colors.grey[100]),
              _buildCompareListRow("?곸＜沅?, "?맊 5??嫄곗＜ ?꾩슂", "?? 3?????좎껌 媛??),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildFormulaBadge(String text, Color textColor, Color bgColor) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 6),
      decoration: BoxDecoration(
        color: bgColor,
        borderRadius: BorderRadius.circular(8),
      ),
      child: Text(
        text,
        style: GoogleFonts.notoSansKr(
          fontSize: 12,
          fontWeight: FontWeight.bold,
          color: textColor,
        ),
        textAlign: TextAlign.center,
      ),
    );
  }

  Widget _buildCompareListRow(String title, String bad, String good) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12),
      child: Row(
        children: [
          SizedBox(
            width: 70,
            child: Text(
              title,
              style: GoogleFonts.notoSansKr(fontSize: 13, fontWeight: FontWeight.bold, color: Colors.grey[600]),
            ),
          ),
          Expanded(
            child: Row(
              children: [
                Expanded(
                  child: Text(
                    bad,
                    style: GoogleFonts.notoSansKr(fontSize: 12, color: Colors.grey[500]),
                    textAlign: TextAlign.center,
                  ),
                ),
                Expanded(
                  child: Text(
                    good,
                    style: GoogleFonts.notoSansKr(fontSize: 12, fontWeight: FontWeight.bold, color: const Color(0xFF673AB7)),
                    textAlign: TextAlign.center,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  // 2. Strategy Card Widget
  Widget _buildUpgradeStrategyCard(BuildContext context, int currentScore) {
    // Show nothing if score hasn't been calculated yet
    if (!hasCalculated) return const SizedBox.shrink();

    // Get the personalized advice text
    String strategyMessage = _analyzeStrategy();
    
    // Determine color theme based on score (Pass/Fail)
    bool isPass = (detailedResult?['totalScore'] ?? 0) >= 80;
    Color iconColor = isPass ? const Color(0xFF673AB7) : const Color(0xFFFF8F00); // Purple vs Orange

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(24),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: const Color(0xFF1E2B4D).withOpacity(0.08),
            blurRadius: 20,
            offset: const Offset(0, 8),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // 1. Fixed Header (Persona)
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: iconColor.withOpacity(0.1),
                  shape: BoxShape.circle,
                ),
                child: Icon(Icons.smart_toy_rounded, color: iconColor, size: 20),
              ),
              const SizedBox(width: 12),
              Text(
                "F-2-7 鍮꾩옄 而⑥꽕?댄듃",
                style: GoogleFonts.notoSansKr(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: const Color(0xFF1E2B4D),
                ),
              ),
            ],
          ),
          
          const SizedBox(height: 16),
          const Divider(height: 1, color: Color(0xFFEEEEEE)), // Clean separator
          const SizedBox(height: 16),

          // 2. Dynamic Consulting Message
          Text(
            strategyMessage,
            style: GoogleFonts.notoSansKr(
              fontSize: 15,
              height: 1.6, // Better readability
              color: const Color(0xFF424242),
            ),
          ),
        ],
      ),
    );
  }

  // --- Logic Helper ---
  String _analyzeStrategy() {
    if (detailedResult == null) return "?먯닔瑜?癒쇱? 怨꾩궛?대낫?몄슂.";
    
    int score = detailedResult!['totalScore'];
    bool isMasters = detailedResult!['isMasters'] ?? false;
    bool isStem = detailedResult!['isStem'] ?? false;
    int koreanScore = detailedResult!['korean'] ?? 0;
    int incomeScore = detailedResult!['income'] ?? 0;
    int volunteerScore = detailedResult!['volunteer'] ?? 0;
    int gap = 80 - score;

    // ?썞 1. Bachelor's Degree Check (Gatekeeper)
    if (!isMasters) {
      return "?좉퉸! ?뱀떆 '?앹궗 ??숈썝' 議몄뾽???욌몢怨?怨꾩떊媛?? ?럳\n\n洹몃젃?ㅻ㈃ 怨꾩궛湲곗뿉??'?앹궗'瑜??좏깮?댁빞 ?뺥솗??寃곌낵媛 ?섏샃?덈떎.\n\n留뚯빟 '援?궡 ?숈궗'濡쒕쭔 ?좎껌?섏떊?ㅻ㈃, 諛붾줈 F-2-7 蹂寃쎌? ?대졄怨?E-7 鍮꾩옄瑜?癒쇱? 嫄곗퀜???⑸땲??";
    }

    // ??2. Masters+ (Real Consulting)
    
    // 2-1. ?⑷꺽沅?
    if (score >= 80) {
       String msg = "?꾨꼍?⑸땲?? (?앹궗 + ${score}?? ?몡\n?숈쐞 ?붽굔怨??먯닔瑜?紐⑤몢 異⑹”?덉뒿?덈떎.\n?댁젣 '?꾨Ц吏?E-7-1)' 痍⑥뾽???뺤젙?섎㈃ 諛붾줈 F-2-7 蹂寃쎌씠 媛?ν빀?덈떎.";
       if (!isStem) msg += "\n(李멸퀬: ?닿났怨꾨씪硫??먯닔媛 ???ъ쑀濡쒖슱 ???덉뒿?덈떎)";
       return msg;
    }

    // 2-2. 遺덊빀寃⑷텒 (?앹궗?몃뜲 ?먯닔媛 遺議깊븳 寃쎌슦)

    // Case A: 1??遺議?& 遊됱궗 ?놁쓬
    if (gap == 1 && volunteerScore == 0) {
        return "?숈쐞???꾨꼍?쒕뜲, ??1?먯씠 遺議깊빐?? ?삲\n**'?ы쉶遊됱궗'**濡?1?먮쭔 梨꾩슦硫? ?앹궗 ?밸?濡?諛붾줈 F-2-7 二쇱씤怨듭씠 ?⑸땲??";
    }

    // Case B: KIIP 異붿쿇 (2~10??遺議?
    // Assuming 20 is max, if < 20 they can improve. Or strict KIIP check?
    // Let's stick to the condition: if gap <= 10 and not max korean
    if (koreanScore < 20 && gap <= 10) {
       return "?앹궗 ?숈쐞媛 ?덉뼱???먯닔媛 ${gap}??遺議깊븯?ㅼ슂.\n媛???뺤떎??諛⑸쾿? **'?ы쉶?듯빀?꾨줈洹몃옩(KIIP) 5?④퀎'** ?댁닔?낅땲?? 媛?곗젏 10?먯쑝濡?諛붾줈 ?⑷꺽沅?吏꾩엯?섏꽭??";
    }

    // Case C: 湲곕낯 遺議?
    return "?앹궗 ?숈쐞媛 ?덉?留??먯닔 李⑥씠媛 ?쎈땲??\n**?쒓뎅??TOPIK)** ?깃툒??理쒕?濡??щ졇?붿?, **?덉긽 ?곕큺**???덈Т ??쾶 梨낆젙??嫄??꾨땶吏 ?뺤씤?대낫?몄슂.";
  }

  // 2. Comparison Modal
  void _showComparisonModal(BuildContext context) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        height: 500,
        decoration: const BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
        ),
        padding: const EdgeInsets.all(24),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Center(child: Container(width: 40, height: 4, decoration: BoxDecoration(color: Colors.grey[300], borderRadius: BorderRadius.circular(2)))),
            const SizedBox(height: 24),
            Text("???먯닔瑜?梨꾩썙???좉퉴??", style: GoogleFonts.notoSansKr(fontSize: 20, fontWeight: FontWeight.bold)),
            const SizedBox(height: 8),
            Text("痍⑥뾽 鍮꾩옄(E-7)? 嫄곗＜ 鍮꾩옄(F-2-7)??n?띠쓽 吏덉씠 ?꾩쟾???ㅻ쫭?덈떎.", style: GoogleFonts.notoSansKr(fontSize: 14, color: Colors.grey[600])),
            const SizedBox(height: 24),
            
            // Comparison Table
            Expanded(
              child: ListView(
                children: [
                  _buildCompareRow("?댁쭅???먯쑀", "???뚯궗 ?덇? ?꾩닔", "狩??먯쑀濡쒖슫 ?댁쭅", true),
                  _buildCompareRow("泥대쪟 湲곌컙", "?좑툘 蹂댄넻 1?꾩뵫 ?곗옣", "??理쒕? 3~5??, true),
                  _buildCompareRow("諛곗슦??痍⑥뾽", "??遺덇???(F-3)", "狩?媛??(F-2-71)", true),
                  _buildCompareRow("?곸＜沅??좎껌", "?맊 5??嫄곗＜ ??, "?? 3????媛??, true),
                ],
              ),
            ),
            
            // Close Button
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () => Navigator.pop(context),
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF1E2B4D),
                  padding: const EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                ),
                child: Text("?뺤씤?덉뒿?덈떎", style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white)),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildCompareRow(String title, String bad, String good, bool isLast) {
    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: const Color(0xFFF5F7FA),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        children: [
          Text(title, style: GoogleFonts.notoSansKr(fontSize: 14, fontWeight: FontWeight.bold, color: Colors.black54)),
          const SizedBox(height: 12),
          Row(
            children: [
              Expanded(child: Center(child: Text(bad, style: GoogleFonts.notoSansKr(fontSize: 13, color: Colors.grey[600])))),
              Container(width: 1, height: 24, color: Colors.grey[300]), // Divider
              Expanded(child: Center(child: Text(good, style: GoogleFonts.notoSansKr(fontSize: 13, fontWeight: FontWeight.bold, color: const Color(0xFF673AB7))))),
            ],
          ),
        ],
      ),
    );
  }
}

=== lib\screens\schedule\schedule_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../providers/schedule_provider.dart';
import '../../models/schedule_model.dart';
import 'dart:math';

class ScheduleScreen extends ConsumerWidget {
  const ScheduleScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final classList = ref.watch(scheduleProvider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('媛뺤쓽 ?쒓컙??),
        centerTitle: true,
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () => _showAddClassDialog(context, ref),
        child: const Icon(Icons.add),
      ),
      body: LayoutBuilder(
        builder: (context, constraints) {
          final width = constraints.maxWidth;
          final timeColWidth = 40.0;
          final cellWidth = (width - timeColWidth) / 7; // 7??湲곗?

          return Column(
            children: [
              // 1. Header Row (Mon-Sun)
              Container(
                padding: const EdgeInsets.symmetric(vertical: 12),
                decoration: BoxDecoration(
                  color: Colors.grey[100],
                  border: Border(bottom: BorderSide(color: Colors.grey[300]!)),
                ),
                child: Row(
                  children: [
                    SizedBox(width: timeColWidth), // Time column width
                    ...List.generate(7, (index) {
                      final day = ["??, "??, "??, "紐?, "湲?, "??, "??][index];
                      return SizedBox(
                        width: cellWidth,
                        child: Center(
                          child: Text(
                              day, 
                              style: TextStyle(
                                fontWeight: FontWeight.bold,
                                color: index >= 5 ? Colors.red : Colors.black, // 二쇰쭚 鍮④컙??
                              )
                          ),
                        ),
                      );
                    }),
                  ],
                ),
              ),
              
              // 2. Time Grid
              Expanded(
                child: SingleChildScrollView(
                  child: Stack(
                    children: [
                      // Background Grid Lines
                      Column(
                        children: List.generate(12, (index) { // 9 AM to 8 PM (12 hours)
                          final time = index + 9;
                          return Container(
                            height: 60,
                            decoration: BoxDecoration(
                              border: Border(bottom: BorderSide(color: Colors.grey[200]!)),
                            ),
                            child: Row(
                              children: [
                                SizedBox(
                                  width: timeColWidth,
                                  child: Center(
                                    child: Text(
                                      "$time:00",
                                      style: TextStyle(fontSize: 10, color: Colors.grey[600]),
                                    ),
                                  ),
                                ),
                                const Expanded(child: SizedBox()), // Grid cell content
                              ],
                            ),
                          );
                        }),
                      ),

                      // Class Items
                      ...classList.map((item) {
                         // Calculate position
                         // 1 hour = 60 pixels height. Start time 9:00 is offset 0.
                         final top = (item.startTime - 9) * 60.0;
                         final height = item.duration * 60.0;
                         
                         // Map "Mon" -> 0, "Tue" -> 1 ...
                         final dayMap = {"Mon": 0, "Tue": 1, "Wed": 2, "Thu": 3, "Fri": 4, "Sat": 5, "Sun": 6};
                         final dayIndex = dayMap[item.day] ?? 0;
                         
                         final left = timeColWidth + (dayIndex * cellWidth);
                         
                         return Positioned(
                           top: top,
                           left: left,
                           width: cellWidth,
                           height: height,
                           child: Container(
                             margin: const EdgeInsets.all(1),
                             padding: const EdgeInsets.all(2), // 1. Reduced Padding
                             decoration: BoxDecoration(
                               color: Colors.blue[100], // Default color since model has no color
                               borderRadius: BorderRadius.circular(4),
                               border: Border.all(color: Colors.black12),
                             ),
                             child: FittedBox( // 2. FittedBox for auto-scaling
                               fit: BoxFit.scaleDown,
                               alignment: Alignment.center, // Center alignment looks better usually
                               child: Column(
                                 mainAxisAlignment: MainAxisAlignment.center,
                                 children: [
                                   Text(
                                     item.title,
                                     style: const TextStyle(
                                         fontSize: 11, // 3. Reduced Font Size
                                         fontWeight: FontWeight.bold
                                     ),
                                     textAlign: TextAlign.center,
                                     maxLines: 2,
                                     overflow: TextOverflow.ellipsis,
                                   ),
                                   if (item.classroom.isNotEmpty)
                                     Text(
                                       item.classroom,
                                       style: const TextStyle(fontSize: 9), // 3. Reduced Font Size
                                       textAlign: TextAlign.center,
                                       maxLines: 1,
                                       overflow: TextOverflow.ellipsis,
                                     ),
                                 ],
                               ),
                             ),
                           ),
                         );
                      }),
                    ],
                  ),
                ),
              ),
            ],
          );
        }
      ),
    );
  }

  void _showAddClassDialog(BuildContext context, WidgetRef ref) {
    final titleController = TextEditingController();
    final roomController = TextEditingController();
    int selectedDay = 1; // Mon
    int selectedTime = 9; // 9 AM
    int selectedDuration = 1; // 1 Hour

    showDialog(
      context: context,
      builder: (context) {
        return StatefulBuilder(
          builder: (context, setState) {
            return AlertDialog(
              title: const Text("?섏뾽 異붽?"),
              content: SingleChildScrollView(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    TextField(
                      controller: titleController,
                      decoration: const InputDecoration(labelText: "怨쇰ぉ紐?),
                    ),
                    const SizedBox(height: 8),
                    TextField(
                      controller: roomController,
                      decoration: const InputDecoration(labelText: "媛뺤쓽??),
                    ),
                    const SizedBox(height: 16),
                    Row(
                      children: [
                        const Text("?붿씪: "),
                        const SizedBox(width: 8),
                        DropdownButton<int>(
                          value: selectedDay,
                          items: List.generate(7, (index) => DropdownMenuItem(
                            value: index + 1,
                            child: Text(["??, "??, "??, "紐?, "湲?, "??, "??][index]),
                          )),
                          onChanged: (val) => setState(() => selectedDay = val!),
                        ),
                      ],
                    ),
                    Row(
                      children: [
                        const Text("?쒓컙: "),
                        const SizedBox(width: 8),
                         DropdownButton<int>(
                          value: selectedTime,
                          items: List.generate(12, (index) => DropdownMenuItem( // 9 to 20
                            value: index + 9,
                            child: Text("${index + 9}??),
                          )),
                          onChanged: (val) => setState(() => selectedTime = val!),
                        ),
                      ],
                    ),
                    Row(
                       children: [
                        const Text("?쒓컙(H): "),
                        const SizedBox(width: 8),
                         DropdownButton<int>(
                          value: selectedDuration,
                          items: [1, 2, 3, 4].map((e) => DropdownMenuItem(value: e, child: Text("$e?쒓컙"))).toList(),
                          onChanged: (val) => setState(() => selectedDuration = val!),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
              actions: [
                TextButton(onPressed: () => Navigator.pop(context), child: const Text("痍⑥냼")),
                ElevatedButton(
                  onPressed: () {
                    if (titleController.text.isEmpty) return;
                    
                    final dayMap = {1: "Mon", 2: "Tue", 3: "Wed", 4: "Thu", 5: "Fri", 6: "Sat", 7: "Sun"};

                    final newItem = Schedule(
                      id: Random().nextInt(10000), // Random ID
                      title: titleController.text,
                      classroom: roomController.text,
                      day: dayMap[selectedDay] ?? "Mon",
                      startTime: selectedTime,
                      duration: selectedDuration,
                    );
                    
                    final success = ref.read(scheduleProvider.notifier).addClass(newItem);
                    Navigator.pop(context);
                    
                    if (success) {
                      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("?섏뾽???깅줉?섏뿀?듬땲??")));
                    } else {
                       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("?대떦 ?쒓컙???대? ?섏뾽???덉뒿?덈떎.")));
                    }
                  },
                  child: const Text("?깅줉"),
                ),
              ],
            );
          }
        );
      },
    );
  }
}

=== lib\screens\shop\shop_detail_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../providers/shop_provider.dart';
import '../../providers/point_provider.dart';
import '../../models/shop_model.dart';

class ShopDetailScreen extends ConsumerWidget {
  final Shop product; // Changed ShopProduct to Shop

  const ShopDetailScreen({super.key, required this.product});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      appBar: AppBar(
        title: Text(product.name),
      ),
      body: Padding(
        padding: const EdgeInsets.all(20.0),
        child: Column(
          children: [
            Container(
              height: 200,
              width: double.infinity,
              color: Colors.grey.shade200,
              child: const Icon(Icons.image, size: 100, color: Colors.grey),
            ),
            const SizedBox(height: 20),
            Text(
              product.name,
              style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 10),
            Text(
              '${product.price} P',
              style: const TextStyle(fontSize: 20, color: Colors.purple, fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 20),
            Text(
              product.description ?? '?ㅻ챸 ?놁쓬',
              style: const TextStyle(fontSize: 16),
            ),
            const SizedBox(height: 30),
            
            // Terms & Conditions
             Container(
               width: double.infinity,
               padding: const EdgeInsets.all(16),
               decoration: BoxDecoration(
                 color: Colors.grey[50],
                 borderRadius: BorderRadius.circular(12),
                 border: Border.all(color: Colors.grey[200]!),
               ),
               child: Column(
                 crossAxisAlignment: CrossAxisAlignment.start,
                 children: const [
                   Text("?곹뭹 ?좎쓽?ы빆", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                   SizedBox(height: 8),
                   Text("???대떦 ?곹뭹??留ㅼ옣???놁쓣 寃쎌슦, ?숈씪 媛寃??댁긽???ㅻⅨ ?곹뭹?쇰줈 援먰솚??媛?ν빀?덈떎. (李⑥븸 寃곗젣 ?꾩슂)", style: TextStyle(fontSize: 12, color: Colors.grey, height: 1.4)),
                   Text("??蹂?荑좏룿???좏슚湲곌컙? 諛쒓툒?쇰줈遺??60?쇱엯?덈떎.", style: TextStyle(fontSize: 12, color: Colors.grey, height: 1.4)),
                   Text("???쇰? ?뱀닔 留ㅼ옣(諛깊솕?? 怨듯빆, ?닿쾶?????먯꽌???ъ슜???쒗븳?????덉뒿?덈떎.", style: TextStyle(fontSize: 12, color: Colors.grey, height: 1.4)),
                   Text("???ъ씤?몃줈 援щℓ???곹뭹? ?꾧툑?쇰줈 ?섎텋?섏? ?딆쑝硫? 援щℓ ??痍⑥냼媛 遺덇??ν빀?덈떎.", style: TextStyle(fontSize: 12, color: Colors.grey, height: 1.4)),
                   Text("???ъ슜 ??吏곸썝?먭쾶 諛붿퐫?쒕? ?쒖떆??二쇱꽭?? (?붾㈃ 諛앷린 理쒕? 沅뚯옣)", style: TextStyle(fontSize: 12, color: Colors.grey, height: 1.4)),
                 ],
               ),
            ),
            const Spacer(),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () {
                   final pointNotifier = ref.read(pointProvider.notifier);
                   final shopNotifier = ref.read(shopProvider.notifier);
                   
                   final success = shopNotifier.buyItem(product, pointNotifier);
                   
                   if (success) {
                     ScaffoldMessenger.of(context).showSnackBar(
                       const SnackBar(content: Text('?럦 援щℓ ?깃났! 蹂닿??⑥뿉 ?닿꼈?댁슂.')),
                     );
                   } else {
                     ScaffoldMessenger.of(context).showSnackBar(
                       SnackBar(
                         content: const Text('?Ⅲ ?ъ씤?멸? 遺議깊빀?덈떎.'),
                         backgroundColor: Colors.red[400],
                       ),
                     );
                   }
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF8B5CF6),
                  padding: const EdgeInsets.symmetric(vertical: 16),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                ),
                child: const Text('援щℓ?섍린', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

=== lib\screens\shop\shop_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../providers/shop_provider.dart';
import '../../providers/nav_provider.dart';
import '../../providers/point_provider.dart';
import 'dart:async'; // For Timer
import '../../widgets/shop/shop_list_item.dart';
import 'shop_detail_screen.dart';
import 'storage_screen.dart';

class ShopScreen extends ConsumerStatefulWidget {
  const ShopScreen({super.key});

  @override
  ConsumerState<ShopScreen> createState() => _ShopScreenState();
}

class _ShopScreenState extends ConsumerState<ShopScreen> {
  String _selectedCategory = '?꾩껜';
  
  final categories = [
    {'id': 'all', 'label': '?꾩껜', 'icon': Icons.grid_view_rounded},
    {'id': 'cafe', 'label': '移댄럹', 'icon': Icons.coffee_rounded},
    {'id': 'store', 'label': '?몄쓽??, 'icon': Icons.store_mall_directory_rounded},
    {'id': 'voucher', 'label': '?곹뭹沅?, 'icon': Icons.confirmation_number_rounded},
  ];

  @override
  Widget build(BuildContext context) {
    // Watch Providers
    final shopState = ref.watch(shopProvider);
    final pointState = ref.watch(pointProvider);

    // Filter Products
    final filteredProducts = _selectedCategory == '?꾩껜' 
        ? shopState.products 
        : shopState.products.where((p) {
            String catId = categories.firstWhere((c) => c['label'] == _selectedCategory)['id'] as String;
            return p.category == catId;
          }).toList();


    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.white,
        elevation: 0,
        centerTitle: false,
        titleSpacing: -5,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios_new_rounded, color: Colors.black),
          onPressed: () {
             final canPop = Navigator.canPop(context);
             if (canPop) {
               Navigator.pop(context);
             } else {
               ref.read(bottomNavIndexProvider.notifier).state = 1; // 1 is Home
             }
          },
        ),
        title: RichText(
          text: const TextSpan(
            style: TextStyle(
              fontSize: 24,
              fontWeight: FontWeight.w900,
              letterSpacing: -0.5,
            ),
            children: [
              TextSpan(text: 'CUTY ', style: TextStyle(color: Color(0xFF1A2B48))),
              TextSpan(text: 'SHOP', style: TextStyle(color: Color(0xFF8B5CF6))),
            ],
          ),
        ),
        actions: [
          IconButton(
            icon: const Icon(Icons.inventory_2_outlined, color: Colors.black),
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) => const StorageScreen()),
              );
            },
          ),
          GestureDetector(
            onTap: () {
               ScaffoldMessenger.of(context).showSnackBar(
                 const SnackBar(content: Text('?ъ씤??異⑹쟾?뚮줈 ?대룞?⑸땲??(以鍮꾩쨷)'))
               );
            },
            child: Container(
              margin: const EdgeInsets.only(right: 20, top: 10, bottom: 10),
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),
              decoration: BoxDecoration(
                color: const Color(0xFF8B5CF6),
                borderRadius: BorderRadius.circular(20),
              ),
              child: Row(
                children: [
                   Image.asset(
                     'assets/images/coin_gold.png',
                     width: 16,
                     height: 16,
                     fit: BoxFit.contain,
                   ),
                  const SizedBox(width: 6),
                  Text(
                    '${pointState.totalBalance.toString().replaceAllMapped(RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'), (Match m) => '${m[1]},')} P',
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.w800,
                      fontSize: 13,
                    ),
                  ),
                ],
              ),
            ),
          )
        ],
      ),
      body: shopState.isLoading 
          ? const Center(child: CircularProgressIndicator())
          : CustomScrollView(
              slivers: [
                // Carousel Banner
                 const SliverToBoxAdapter(
                  child: _ShopBanner(),
                ),

                // Category Chips
                SliverAppBar(
                  backgroundColor: Colors.white,
                  pinned: true,
                  elevation: 0,
                  toolbarHeight: 60,
                  flexibleSpace: ListView.separated(
                    padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                    scrollDirection: Axis.horizontal,
                    itemCount: categories.length,
                    separatorBuilder: (_, __) => const SizedBox(width: 8),
                    itemBuilder: (context, index) {
                      final cat = categories[index];
                      final isSelected = _selectedCategory == cat['label'];
                      
                      return GestureDetector(
                        onTap: () => setState(() => _selectedCategory = cat['label'] as String),
                        child: AnimatedContainer(
                          duration: const Duration(milliseconds: 200),
                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                          decoration: BoxDecoration(
                            color: isSelected ? const Color(0xFF8B5CF6) : Colors.white,
                            borderRadius: BorderRadius.circular(20),
                            border: Border.all(
                              color: isSelected ? const Color(0xFF8B5CF6) : Colors.grey[200]!,
                            ),
                            boxShadow: isSelected ? [
                              BoxShadow(
                                color: const Color(0xFF8B5CF6).withOpacity(0.3),
                                blurRadius: 8,
                                offset: const Offset(0, 4),
                              )
                            ] : null,
                          ),
                          child: Row(
                            children: [
                              Icon(
                                cat['icon'] as IconData,
                                size: 16,
                                color: isSelected ? Colors.white : Colors.grey[500],
                              ),
                              const SizedBox(width: 6),
                              Text(
                                cat['label'] as String,
                                style: TextStyle(
                                  color: isSelected ? Colors.white : Colors.grey[500],
                                  fontWeight: FontWeight.bold,
                                  fontSize: 13,
                                ),
                              ),
                            ],
                          ),
                        ),
                      );
                    },
                  ),
                ),

                SliverPadding(
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
                  sliver: SliverList(
                    delegate: SliverChildBuilderDelegate(
                      (context, index) {
                        final product = filteredProducts[index];
                        return ShopListItem(
                          product: product,
                          onTap: () {
                            // Navigate to Detail Screen
                            Navigator.push(
                              context,
                              MaterialPageRoute(
                                builder: (_) => ShopDetailScreen(product: product),
                              ),
                            );
                          },
                        );
                      },
                      childCount: filteredProducts.length,
                    ),
                  ),
                ),
                
                // Bottom Safe Area
                const SliverToBoxAdapter(
                  child: SizedBox(height: 40),
                )
              ],
            ),
    );
  }
}

class _ShopBanner extends StatefulWidget {
  const _ShopBanner();

  @override
  State<_ShopBanner> createState() => _ShopBannerState();
}

class _ShopBannerState extends State<_ShopBanner> {
  final PageController _pageController = PageController();
  int _currentPage = 0;
  late final Timer _timer;

  // Using dynamic list for simplicity or clean model
  // Using dynamic list for simplicity or clean model
  final List<Map<String, dynamic>> _banners = [
    {
      'color': const Color(0xFFFCE4EC), // Pink.shade50
      'title': '愿묎퀬 蹂닿퀬\n?ъ씤??諛쏄린',
      'image': 'assets/images/capy_AD.png', // User requested
      'tag': 'AD',
      'titleColor': const Color(0xFFE91E63), // Pink
      'tagColor': const Color(0xFFC2185B),
    },
    {
      'color': const Color(0xFFE8EAF6), // Indigo.shade50
      'title': '?좉퇋 ?낆젏\n?좎씤 ?대깽??,
      'image': 'assets/images/capy_business.png',
      'tag': 'EVENT',
      'titleColor': const Color(0xFF3F51B5), // Indigo
      'tagColor': const Color(0xFF303F9F),
    },
    {
      'color': const Color(0xFFE8F5E9), // Green.shade50
      'title': '移쒓뎄 珥덈??섎㈃\n+500P 利앹젙!',
      'image': 'assets/images/capy_friend.png', 
      'tag': 'INVITE',
      'titleColor': const Color(0xFF2E7D32), // Green
      'tagColor': const Color(0xFF1B5E20),
    },
  ];

  @override
  void initState() {
    super.initState();
    _timer = Timer.periodic(const Duration(seconds: 6), (timer) { // Adjusted to 6 seconds
      if (_pageController.hasClients) {
         int nextPage = _pageController.page!.toInt() + 1;
         _pageController.animateToPage(
           nextPage,
           duration: const Duration(milliseconds: 500),
           curve: Curves.easeInOut,
         );
      }
    });
  }

  @override
  void dispose() {
    _timer.cancel();
    _pageController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Container(
       height: 160,
       margin: const EdgeInsets.all(20),
       child: Stack(
         alignment: Alignment.center,
         children: [
           PageView.builder(
             controller: _pageController,
             onPageChanged: (index) {
               setState(() => _currentPage = index % _banners.length);
             },
             itemBuilder: (context, index) {
               final banner = _banners[index % _banners.length];
               return Container(
                 margin: const EdgeInsets.symmetric(horizontal: 4), 
                 decoration: BoxDecoration(
                   color: banner['color'],
                   borderRadius: BorderRadius.circular(16),
                 ),
                 child: Stack(
                   children: [
                     // Text Content
                     Positioned(
                       top: 30,
                       left: 24,
                       child: Column(
                         crossAxisAlignment: CrossAxisAlignment.start,
                         children: [
                           Container(
                             padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                             decoration: BoxDecoration(
                               color: banner['tagColor'].withOpacity(0.1),
                               borderRadius: BorderRadius.circular(8),
                             ),
                             child: Text(
                               banner['tag'],
                               style: TextStyle(
                                 fontSize: 10,
                                 fontWeight: FontWeight.bold,
                                 color: banner['tagColor'],
                               ),
                             ),
                           ),
                           const SizedBox(height: 12),
                           Text(
                             banner['title'],
                             style: TextStyle(
                               fontSize: 20,
                               fontWeight: FontWeight.bold,
                               color: banner['titleColor'],
                               height: 1.3,
                             ),
                           ),
                         ],
                       ),
                     ),
                     // Image (Right)
                     Positioned(
                       right: 10,
                       bottom: 10,
                       width: 100,
                       height: 100,
                       child: Image.asset(
                         banner['image'],
                         fit: BoxFit.contain,
                         errorBuilder: (context, error, stackTrace) {
                           return Icon(Icons.image_not_supported, size: 50, color: Colors.grey[400]);
                         },
                       ),
                     ),
                   ],
                 ),
               );
             },
           ),
           
           // Indicators
           Positioned(
             bottom: 16,
             left: 0,
             right: 0,
             child: Row(
               mainAxisAlignment: MainAxisAlignment.center,
               children: List.generate(_banners.length, (index) {
                 final isActive = _currentPage == index;
                 return AnimatedContainer(
                   duration: const Duration(milliseconds: 300),
                   margin: const EdgeInsets.symmetric(horizontal: 3),
                   width: isActive ? 16 : 6,
                   height: 6,
                   decoration: BoxDecoration(
                     color: isActive ? Colors.black87 : Colors.black12,
                     borderRadius: BorderRadius.circular(3),
                   ),
                 );
               }),
             ),
           ),

           // Left Arrow
           Positioned(
             left: 10,
             child: GestureDetector(
               onTap: () {
                 _pageController.previousPage(
                   duration: const Duration(milliseconds: 300),
                   curve: Curves.easeInOut,
                 );
               },
               child: Container(
                 padding: const EdgeInsets.all(8),
                 decoration: BoxDecoration(
                   color: Colors.white.withOpacity(0.5),
                   shape: BoxShape.circle,
                 ),
                 child: const Icon(Icons.arrow_back_ios_new, size: 16, color: Colors.black54),
               ),
             ),
           ),

           // Right Arrow
           Positioned(
             right: 10,
             child: GestureDetector(
               onTap: () {
                 _pageController.nextPage(
                   duration: const Duration(milliseconds: 300),
                   curve: Curves.easeInOut,
                 );
               },
               child: Container(
                 padding: const EdgeInsets.all(8),
                 decoration: BoxDecoration(
                   color: Colors.white.withOpacity(0.5),
                   shape: BoxShape.circle,
                 ),
                 child: const Icon(Icons.arrow_forward_ios, size: 16, color: Colors.black54),
               ),
             ),
           ),
         ],
       ),
    );
  }
}

=== lib\screens\shop\storage_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../providers/shop_provider.dart';
import '../../models/shop_model.dart';

class StorageScreen extends ConsumerWidget {
  const StorageScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final shopState = ref.watch(shopProvider);
    final myInventory = shopState.inventory;

    return Scaffold(
      appBar: AppBar(
        title: const Text('蹂닿???),
        centerTitle: true,
      ),
      body: myInventory.isEmpty
          ? _buildEmptyState(context)
          : ListView.separated(
              padding: const EdgeInsets.all(20),
              itemCount: myInventory.length,
              separatorBuilder: (context, index) => const SizedBox(height: 12),
              itemBuilder: (context, index) {
                final item = myInventory[index];
                return _buildInventoryItem(context, item);
              },
            ),
    );
  }

  Widget _buildEmptyState(BuildContext context) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const Icon(Icons.inventory_2_outlined, size: 64, color: Colors.grey),
          const SizedBox(height: 16),
          const Text(
            '蹂닿??⑥씠 鍮꾩뼱?덉뼱???? ?뿊截?,
            style: TextStyle(fontSize: 16, color: Colors.grey),
          ),
          const SizedBox(height: 24),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context); // Go back to Shop
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: const Color(0xFF8B5CF6),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
              padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
            ),
            child: const Text("?쇳븨?섎윭 媛湲?, style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  Widget _buildInventoryItem(BuildContext context, Shop item) { // Changed ShopProduct to Shop
    final imgUrl = item.imageUrl ?? 'assets/images/placeholder.png'; // Null check
    
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.grey[200]!),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.05),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Row(
        children: [
          // Image
          Container(
            width: 50,
            height: 50,
            decoration: BoxDecoration(
              color: Colors.grey[100],
              borderRadius: BorderRadius.circular(8),
            ),
             child: ClipRRect(
              borderRadius: BorderRadius.circular(8),
              child: Image.asset(imgUrl, fit: BoxFit.cover, errorBuilder: (c,e,s) => const Icon(Icons.image)),
            ),
          ),
          const SizedBox(width: 16),
          // Name
          Expanded(
            child: Text(
              item.name,
              style: const TextStyle(
                fontWeight: FontWeight.bold,
                fontSize: 15,
              ),
            ),
          ),
          // Use Button
          ElevatedButton(
            onPressed: () => _showBarcodeDialog(context, item),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.white,
              foregroundColor: const Color(0xFF8B5CF6),
              elevation: 0,
              side: const BorderSide(color: Color(0xFF8B5CF6)),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
            ),
            child: const Text("?ъ슜?섍린"),
          ),
        ],
      ),
    );
  }

  void _showBarcodeDialog(BuildContext context, Shop item) { // Changed ShopProduct to Shop
    showDialog(
      context: context,
      builder: (context) {
        return AlertDialog(
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              const SizedBox(height: 10),
              Text(
                item.name,
                style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 18),
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: 20),
              // Dummy Barcode
              Container(
                height: 80,
                width: double.infinity,
                decoration: BoxDecoration(
                  color: Colors.white,
                  border: Border.all(color: Colors.grey[300]!),
                ),
                child: Row(
                   mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                   children: List.generate(30, (index) {
                     // Generate random widths for barcode look
                     return Container(
                       width: 2 + (index % 3) * 2.0,
                       height: 60,
                       color: Colors.black,
                     );
                   }),
                ),
              ),
              const SizedBox(height: 10),
              const Text("1234 5678 9012", style: TextStyle(letterSpacing: 4, fontSize: 12)),
              const SizedBox(height: 20),
              const Text(
                "吏곸썝?먭쾶 蹂댁뿬二쇱꽭??,
                style: TextStyle(color: Colors.grey, fontSize: 14),
              ),
              const SizedBox(height: 10),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text("?リ린"),
            ),
          ],
        );
      },
    );
  }
}

=== lib\screens\shop\widgets\shop_banner_carousel.dart ===
import 'package:flutter/material.dart';

class ShopBannerCarousel extends StatelessWidget {
  const ShopBannerCarousel({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 150,
      margin: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.purple.shade50,
        borderRadius: BorderRadius.circular(16),
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(16),
        child: Stack(
          children: [
            Positioned.fill(
              child: Image.asset(
                'assets/images/capy_business.png',
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.campaign, size: 48, color: Colors.purple.shade200),
                        const SizedBox(height: 8),
                        Text(
                          'CUTY SHOP ?ㅽ뵂 ?대깽??',
                          style: TextStyle(
                            fontWeight: FontWeight.bold,
                            color: Colors.purple.shade400,
                          ),
                        ),
                      ],
                    ),
                  );
                },
              ),
            ),
            Positioned(
              bottom: 16,
              left: 16,
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                decoration: BoxDecoration(
                  color: Colors.black.withOpacity(0.6),
                  borderRadius: BorderRadius.circular(20),
                ),
                child: const Text(
                  '?ㅽ뵂 湲곕뀗 ?밴? ?럦',
                  style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

=== lib\screens\spec\spec_wallet_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:cuty_app/providers/document_provider.dart';
import '../../models/document_model.dart';
import 'dart:math';

// UI ?뺤쓽???뺤쟻 ?대옒??
class SpecDocDefinition {
  final String name;
  final IconData icon;

  const SpecDocDefinition({
    required this.name,
    required this.icon,
  });
}

class SpecWalletScreen extends ConsumerWidget {
  const SpecWalletScreen({super.key});

  // 1. ?꾩닔 ?좊텇/泥대쪟 (Identity & Residence)
  static const List<SpecDocDefinition> identityDocs = [
    SpecDocDefinition(name: "?멸뎅?몃벑濡앹쬆", icon: Icons.badge_outlined),
    SpecDocDefinition(name: "?숈깮利?, icon: Icons.badge),
    SpecDocDefinition(name: "?ш텒?щ낯", icon: Icons.airplanemode_active),
    SpecDocDefinition(name: "嫄곗＜吏 利앸튃", icon: Icons.home_work_outlined),
    SpecDocDefinition(name: "嫄곗＜吏利앸챸??, icon: Icons.home),
    SpecDocDefinition(name: "?꾨?李⑥쬆紐낆꽌", icon: Icons.article),
    SpecDocDefinition(name: "湲곗닕??嫄곗＜ ?몄쬆??, icon: Icons.apartment),
    SpecDocDefinition(name: "嫄곗＜吏 ?쒓났?뺤씤??, icon: Icons.check_circle_outline),
  ];

  // 2. ?숈뾽 諛??댄븰 (Academics & Language)
  static const List<SpecDocDefinition> academicDocs = [
    SpecDocDefinition(name: "?ы븰利앸챸??, icon: Icons.school),
    SpecDocDefinition(name: "?깆쟻利앸챸??, icon: Icons.grade),
    SpecDocDefinition(name: "?섎즺利?, icon: Icons.card_membership),
    SpecDocDefinition(name: "?좏뵿利앸챸??, icon: Icons.language),
    SpecDocDefinition(name: "?ы쉶?듯빀?꾨줈洹몃옩利앸챸??, icon: Icons.diversity_3),
    SpecDocDefinition(name: "?멸뎅??利앸챸??, icon: Icons.translate),
  ];

  // 3. 而ㅻ━??諛??ㅽ럺 (Career & Achievements)
  static const List<SpecDocDefinition> careerDocs = [
    SpecDocDefinition(name: "遊됱궗?쒕룞 ?몄쬆??, icon: Icons.volunteer_activism),
    SpecDocDefinition(name: "寃쎈젰?몄쬆??, icon: Icons.work),
    SpecDocDefinition(name: "?곸옣", icon: Icons.emoji_events),
    SpecDocDefinition(name: "?먭꺽利?, icon: Icons.verified),
    SpecDocDefinition(name: "硫댄뿀", icon: Icons.drive_eta),
    SpecDocDefinition(name: "湲고?", icon: Icons.folder_open),
  ];

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // 1. ?ㅼ젣 蹂댁쑀 以묒씤 ?쒕쪟 由ъ뒪??媛?몄삤湲?
    final myDocs = ref.watch(documentProvider);

    return Scaffold(
      backgroundColor: Colors.grey[50], // Light background
      appBar: AppBar(
        title: const Text('?ㅽ럺 吏媛?),
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
        elevation: 0,
        centerTitle: true,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.fromLTRB(20, 20, 20, 40),
        child: Column(
          children: [
            _buildSection(context, "?お ?꾩닔 ?좊텇/泥대쪟", "?덉쟾??泥대쪟瑜??꾪븳 ?꾩닔 ?쒕쪟", identityDocs, myDocs, ref),
            const SizedBox(height: 32),
            _buildSection(context, "?럳 ?숈뾽 諛??댄븰", "?숆탳 ?앺솢怨??댄븰 ?λ젰 利앸챸", academicDocs, myDocs, ref),
            const SizedBox(height: 32),
            _buildSection(context, "?룇 而ㅻ━??諛??ㅽ럺", "?섎쭔??寃쎌웳?μ쓣 利앸챸?섎뒗 怨?, careerDocs, myDocs, ref),
          ],
        ),
      ),
    );
  }

  Widget _buildSection(BuildContext context, String title, String subtitle, List<SpecDocDefinition> docs, List<Document> myDocs, WidgetRef ref) { // Changed DocumentItem to Document
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // Section Header
        Text(title, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Color(0xFF1A1A2E))),
        const SizedBox(height: 4),
        Text(subtitle, style: TextStyle(fontSize: 13, color: Colors.grey[600])),
        const SizedBox(height: 16),
        
        // Grid
        GridView.builder(
          physics: const NeverScrollableScrollPhysics(),
          shrinkWrap: true,
          gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
            crossAxisCount: 3,
            crossAxisSpacing: 12,
            mainAxisSpacing: 12,
            childAspectRatio: 0.8, // Slightly taller cards
          ),
          itemCount: docs.length,
          itemBuilder: (context, index) {
            final def = docs[index];
            
            // 蹂댁쑀 ?щ? ?뺤씤
            // We use .name or .title (compatibility getter)
            // But 'firstWhere' requires a return value if not found. 
            // We return a dummy Document with id 0 for "not found".
            final matchingDoc = myDocs.firstWhere(
              (doc) => doc.name == def.name || doc.name.startsWith(def.name),
              orElse: () => Document(id: 0, name: "", type: "", createdAt: DateTime.now(), imageUrl: ""),
            );
            
            final isRegistered = matchingDoc.id != 0;

            return _buildDocCard(context, def, isRegistered, isRegistered ? matchingDoc.expiryDate : "none", ref);
          },
        ),
      ],
    );
  }

  Widget _buildDocCard(BuildContext context, SpecDocDefinition def, bool isRegistered, String expiryDate, WidgetRef ref) {
    return Card(
      color: Colors.white,
      elevation: 0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: isRegistered
            ? const BorderSide(color: Colors.indigoAccent, width: 1.5)
            : BorderSide(color: Colors.grey.shade200),
      ),
      child: InkWell(
        onTap: () => _showDocumentOptions(context, def, isRegistered, ref),
        borderRadius: BorderRadius.circular(16),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              def.icon, 
              size: 32, 
              color: isRegistered ? Colors.indigo : Colors.grey[300]
            ),
            const SizedBox(height: 12),
            Text(
              def.name,
              textAlign: TextAlign.center,
              maxLines: 2,
              overflow: TextOverflow.ellipsis,
              style: TextStyle(
                fontSize: 12, // Slightly smaller font for dense grid
                fontWeight: isRegistered ? FontWeight.bold : FontWeight.w500,
                color: isRegistered ? Colors.black87 : Colors.grey[600],
              ),
            ),
             if (isRegistered && expiryDate != "none") ...[
               const SizedBox(height: 6),
               Container(
                 padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                 decoration: BoxDecoration(
                   color: Colors.indigo.withValues(alpha: 0.08),
                   borderRadius: BorderRadius.circular(6),
                 ),
                 child: Text(
                   expiryDate,
                   style: const TextStyle(
                     fontSize: 10,
                     color: Colors.indigo,
                     fontWeight: FontWeight.w700,
                   ),
                 ),
               )
             ] else if (!isRegistered) ...[
                const SizedBox(height: 4),
                const Text(
                  "+300P",
                  style: TextStyle(
                    fontSize: 10,
                    fontWeight: FontWeight.w800,
                    color: Color(0xFFFF9800), // Orange
                    letterSpacing: -0.2, // 怨듦컙 ?뺣낫瑜??꾪빐 ?먭컙 ?댁쭩 異뺤냼
                  ),
                )
             ]
          ],
        ),
      ),
    );
  }

  void _showDocumentOptions(BuildContext context, SpecDocDefinition def, bool isRegistered, WidgetRef ref) {
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.white,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
      ),
      builder: (context) {
        return SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      def.name,
                      style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                    ),
                    if (isRegistered)
                       Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: Colors.green.withValues(alpha: 0.1),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: const Text("?깅줉??, style: TextStyle(color: Colors.green, fontWeight: FontWeight.bold, fontSize: 12)),
                       )
                  ],
                ),
                const SizedBox(height: 24),
                
                // 1. ?뺤씤?섍린
                _buildActionTile(
                  context, 
                  icon: Icons.visibility_outlined, 
                  label: '?뺤씤?섍린',
                  onTap: () {
                    Navigator.pop(context);
                    if (!isRegistered) {
                         ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("?깅줉???쒕쪟媛 ?놁뒿?덈떎.")));
                    } else {
                         ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("?쒕쪟 ?대?吏瑜?遺덈윭?듬땲??..")));
                    }
                  },
                ),
                
                const SizedBox(height: 12),
                
                if (!isRegistered) ...[
                  // 2. PDF ?깅줉
                  _buildActionTile(
                    context, 
                    icon: Icons.picture_as_pdf_outlined, 
                    label: '?몄쬆?섍퀬 300P 諛쏄린 (PDF)',
                    onTap: () {
                      // ?ㅼ젣 ?깅줉 濡쒖쭅
                      ref.read(documentProvider.notifier).addDocumentWithReward(
                          Document(
                            id: Random().nextInt(10000), // generated id
                            name: def.name,  // ?대┃???쒕쪟 ?대쫫?쇰줈 ?깅줉
                            type: 'pdf',
                            createdAt: DateTime.now(),
                            imageUrl: 'assets/images/doc_placeholder.png', // dummy
                          )
                      );
                      Navigator.pop(context);
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(
                          content: Text("?럦 ?쒕쪟 ?몄쬆 蹂댁긽 300P媛 ?곷┰?섏뿀?듬땲??"),
                          backgroundColor: Colors.blueAccent,
                        ),
                      );
                    },
                  ),
                  
                  const SizedBox(height: 12),

                  // 3. 移대찓???깅줉
                  _buildActionTile(
                    context, 
                    icon: Icons.camera_alt_outlined, 
                    label: '?몄쬆?섍퀬 300P 諛쏄린 (珥ъ쁺)',
                    onTap: () {
                      // ?ㅼ젣 ?깅줉 濡쒖쭅
                      ref.read(documentProvider.notifier).addDocumentWithReward(
                          Document(
                            id: Random().nextInt(10000), // generated id
                            name: def.name, 
                            type: 'image',
                            createdAt: DateTime.now(),
                            imageUrl: 'assets/images/doc_placeholder.png',
                          )
                      );
                      Navigator.pop(context);
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(
                          content: Text("?럦 ?쒕쪟 ?몄쬆 蹂댁긽 300P媛 ?곷┰?섏뿀?듬땲??"),
                          backgroundColor: Colors.blueAccent,
                        ),
                      );
                    },
                  ),
                ] else ...[
                   _buildActionTile(
                    context, 
                    icon: Icons.delete_outline, 
                    label: '??젣?섍린',
                    onTap: () {
                       Navigator.pop(context);
                       ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("??젣 湲곕뒫? 以鍮꾩쨷?낅땲??")));
                    },
                  )
                ],
                const SizedBox(height: 12),
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildActionTile(BuildContext context, {required IconData icon, required String label, required VoidCallback onTap}) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 16),
        decoration: BoxDecoration(
          color: Colors.grey[50],
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: Colors.grey[200]!),
        ),
        child: Row(
          children: [
            Icon(icon, color: Colors.grey[800]),
            const SizedBox(width: 16),
            Text(label, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w500)),
            const Spacer(),
            Icon(Icons.chevron_right, color: Colors.grey[400]),
          ],
        ),
      ),
    );
  }
}

=== lib\screens\visa\f27_visa_calculator_screen.dart ===
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:google_fonts/google_fonts.dart';
import '../../providers/f27_visa_provider.dart';

class F27VisaCalculatorScreen extends StatefulWidget {
  const F27VisaCalculatorScreen({super.key});

  @override
  State<F27VisaCalculatorScreen> createState() => _F27VisaCalculatorScreenState();
}

class _F27VisaCalculatorScreenState extends State<F27VisaCalculatorScreen> {
  final TextEditingController _regionScoreController = TextEditingController();

  @override
  void initState() {
    super.initState();
    // Initialize controller with current provider value
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final provider = Provider.of<VisaScoreProvider>(context, listen: false);
      if (provider.regionalScore > 0) {
        _regionScoreController.text = provider.regionalScore.toString();
      }
    });
  }

  @override
  void dispose() {
    _regionScoreController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Consumer<VisaScoreProvider>(
      builder: (context, store, child) {
        final currentScore = store.calculateTotalScore();
        final isPass = currentScore >= 80;

        return Scaffold(
          backgroundColor: const Color(0xFFF5F7FA),
          appBar: AppBar(
            title: Text('F-2-7 ?먯닔 ?덉륫', style: GoogleFonts.notoSansKr(fontWeight: FontWeight.bold, color: Colors.black)),
            backgroundColor: Colors.white,
            elevation: 0,
            leading: IconButton(
              icon: const Icon(Icons.arrow_back, color: Colors.black),
              onPressed: () => Navigator.pop(context),
            ),
            actions: [
              IconButton(
                icon: const Icon(Icons.refresh, color: Colors.grey),
                onPressed: () {
                  store.reset();
                  _regionScoreController.clear();
                  ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('珥덇린?붾릺?덉뒿?덈떎.')));
                },
              )
            ],
          ),
          body: Column(
            children: [
              Expanded(
                child: ListView(
                  padding: const EdgeInsets.all(16),
                  children: [
                    
                    // --- ?쒕쪟吏媛??곕룞?섍린 (NEW) ---
                    Container(
                      margin: const EdgeInsets.only(bottom: 24),
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: const Color(0xFFE0E0E0)),
                      ),
                      child: Row(
                        children: [
                          Container(
                            padding: const EdgeInsets.all(8),
                            decoration: BoxDecoration(
                              color: Colors.orange.withOpacity(0.1),
                              shape: BoxShape.circle,
                            ),
                            child: const Icon(Icons.wallet, color: Colors.orange, size: 20),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Text(
                              '???쒕쪟吏媛??곕룞?섍린',
                              style: GoogleFonts.notoSansKr(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                                color: const Color(0xFF1E2B4D),
                              ),
                            ),
                          ),
                          Switch(
                            value: store.isSpecWalletLinked,
                            activeColor: Colors.white,
                            activeTrackColor: const Color(0xFF673AB7),
                            onChanged: (value) {
                              store.toggleSpecWallet(value);
                              if (value) {
                                ScaffoldMessenger.of(context).showSnackBar(
                                  const SnackBar(
                                    content: Text('?쒕쪟吏媛??곗씠?곌? ?곕룞?섏뿀?듬땲??'),
                                    duration: Duration(seconds: 1),
                                  ),
                                );
                              }
                            },
                          ),
                        ],
                      ),
                    ),

                    _buildSectionTitle('1. 湲곕낯 ??ぉ (理쒕? 130??'),
                    
                    // --- ?섏씠 ---
                    _buildCard(
                      title: '?섏씠 (Age)',
                      subtitle: '留??섏씠 湲곗?',
                      children: [
                        _buildRadioItem(store, '?섏씠', '18~24??, 23),
                        _buildRadioItem(store, '?섏씠', '25~29??, 25, isBest: true),
                        _buildRadioItem(store, '?섏씠', '30~34??, 23),
                        _buildRadioItem(store, '?섏씠', '35~39??, 20),
                        _buildRadioItem(store, '?섏씠', '40~44??, 12),
                        _buildRadioItem(store, '?섏씠', '45~50??, 8),
                        _buildRadioItem(store, '?섏씠', '51???댁긽', 3),
                      ],
                    ),

                    // --- ?숇젰 ---
                    _buildCard(
                      title: '鍮꾩옄 ?좎껌 ???숇젰 (議몄뾽 ?덉젙 ?ы븿)',
                      subtitle: 'D-2 ?좏븰??以?議몄뾽 ?덉젙?먮뒗 痍⑤뱷???숈쐞(?앹궗 ??瑜??좏깮?섏꽭??',
                      children: [
                        SwitchListTile(
                          title: Text('?닿났怨??꾧났 ?먮뒗 蹂듭닔 ?꾧났 (2媛??숈쐞)', style: GoogleFonts.notoSansKr(fontSize: 14, fontWeight: FontWeight.w600)),
                          subtitle: Text('泥댄겕 ?????믪? 諛곗젏 ?곸슜', style: GoogleFonts.notoSansKr(fontSize: 12, color: Colors.grey)),
                          value: store.isStemOrDoubleMajor,
                          activeThumbColor: const Color(0xFF0277BD),
                          onChanged: (val) {
                            store.updateStemStatus(val);
                          },
                        ),
                        const Divider(),
                        _buildRadioItem(store, '?숇젰', '諛뺤궗', store.isStemOrDoubleMajor ? 25 : 20),
                        _buildRadioItem(store, '?숇젰', '?앹궗', store.isStemOrDoubleMajor ? 20 : 17),
                        _buildRadioItem(store, '?숇젰', '?숈궗', store.isStemOrDoubleMajor ? 17 : 15),
                        _buildRadioItem(store, '?숇젰', '?꾨Ц?숈궗', store.isStemOrDoubleMajor ? 15 : 10),
                      ],
                    ),

                    // --- ?쒓뎅??---
                    _buildCard(
                      title: '?쒓뎅??(Korean)',
                      subtitle: 'TOPIK 湲됱닔 ?먮뒗 ?ы쉶?듯빀 ?④퀎',
                      children: [
                        _buildRadioItem(store, '?쒓뎅??, 'TOPIK 5~6湲?/ KIIP 5?④퀎', 20),
                        _buildRadioItem(store, '?쒓뎅??, 'TOPIK 4湲?/ KIIP 4?④퀎', 15),
                        _buildRadioItem(store, '?쒓뎅??, 'TOPIK 3湲?/ KIIP 3?④퀎', 10),
                        _buildRadioItem(store, '?쒓뎅??, 'TOPIK 2湲?/ KIIP 2?④퀎', 5),
                        _buildRadioItem(store, '?쒓뎅??, 'TOPIK 1湲?/ KIIP 1?④퀎', 3),
                      ],
                    ),

                    // --- ?뚮뱷 ---
                    _buildCard(
                      title: '?곌컙 ?뚮뱷 (Income)',
                      subtitle: '?꾨뀈???뚮뱷湲덉븸利앸챸??湲곗?',
                      children: [
                        _buildRadioItem(store, '?뚮뱷', '1?????댁긽', 60),
                        _buildRadioItem(store, '?뚮뱷', '9泥쒕쭔 ~ 1??誘몃쭔', 58),
                        _buildRadioItem(store, '?뚮뱷', '8泥쒕쭔 ~ 9泥쒕쭔 誘몃쭔', 56),
                        _buildRadioItem(store, '?뚮뱷', '7泥쒕쭔 ~ 8泥쒕쭔 誘몃쭔', 53),
                        _buildRadioItem(store, '?뚮뱷', '6泥쒕쭔 ~ 7泥쒕쭔 誘몃쭔', 50),
                        _buildRadioItem(store, '?뚮뱷', '5泥쒕쭔 ~ 6泥쒕쭔 誘몃쭔', 45),
                        _buildRadioItem(store, '?뚮뱷', '4泥쒕쭔 ~ 5泥쒕쭔 誘몃쭔', 40),
                        _buildRadioItem(store, '?뚮뱷', '3泥쒕쭔 ~ 4泥쒕쭔 誘몃쭔', 30),
                        _buildRadioItem(store, '?뚮뱷', '理쒖??꾧툑 ~ 3泥쒕쭔 誘몃쭔', 10),
                        _buildRadioItem(store, '?뚮뱷', '?놁쓬 / 誘몄랬??, 0),
                      ],
                    ),

                    const SizedBox(height: 24),
                    _buildSectionTitle('2. 媛??諛?媛먯젏 (理쒕? +40 / -80)'),

                    // --- 媛??---
                    _buildCard(
                      title: '媛????ぉ (Bonus Points)',
                      subtitle: '?⑹궛 理쒕? 40?먭퉴吏 ?몄젙',
                      children: [
                        Text('1. ?숈쐞 媛??(??1)', style: GoogleFonts.notoSansKr(fontWeight: FontWeight.bold, color: Colors.blue[800])),
                        RadioListTile<String>(
                          title: const Text('?대떦 ?놁쓬'),
                          value: 'none',
                          groupValue: store.uniBonusType ?? 'none',
                          onChanged: (val) => store.updateUniBonus(null),
                        ),
                        RadioListTile<String>(
                          title: const Text('?멸퀎 ?곗닔 ???(QS 500 / THE 200)'),
                          subtitle: const Text('諛뺤궗 +30 / ?앹궗 +20 / ?숈궗 +15'),
                          value: 'top_global',
                          groupValue: store.uniBonusType,
                          activeColor: const Color(0xFF0277BD),
                          onChanged: (val) => store.updateUniBonus(val),
                        ),
                        RadioListTile<String>(
                          title: const Text('援?궡 ????숈쐞 ?뚯?'),
                          subtitle: const Text('諛뺤궗 +10 / ?앹궗 +7 / ?숈궗 +5'),
                          value: 'domestic',
                          groupValue: store.uniBonusType,
                          activeColor: const Color(0xFF0277BD),
                          onChanged: (val) => store.updateUniBonus(val),
                        ),
                        
                        const Divider(),
                        Text('2. ?뺤콉 諛??밸퀎 媛??(以묐났 媛??', style: GoogleFonts.notoSansKr(fontWeight: FontWeight.bold, color: Colors.blue[800])),
                        _buildCheckboxItem('?ы쉶?듯빀?꾨줈洹몃옩(KIIP) 5?④퀎 ?댁닔 (+10)', store.kiipCompleted, (val) => store.updateKiipBonus(val!)),
                        _buildCheckboxItem('泥⑤떒/誘몃옒?곗뾽 遺꾩빞 醫낆궗 (+20)', store.highTechIndustry, (val) => store.updateHighTechBonus(val!)),
                        _buildCheckboxItem('以묒븰?됱젙湲곌???異붿쿇 (+20)', store.govRecommendation, (val) => store.updateGovBonus(val!)),
                        _buildCheckboxItem('?쒓뎅??李몄쟾援??곗닔?몄옱 (+20)', store.warVeteran, (val) => store.updateVeteranBonus(val!)),
                        
                        const Divider(),
                        Text('3. 援?궡 ?ы쉶遊됱궗 (??1)', style: GoogleFonts.notoSansKr(fontWeight: FontWeight.bold, color: Colors.blue[800])),
                        _buildRadioItem(store, '遊됱궗', '3???댁긽', 7),
                        _buildRadioItem(store, '遊됱궗', '2???댁긽', 5),
                        _buildRadioItem(store, '遊됱궗', '1???댁긽', 1),

                        const Divider(),
                        Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                          child: Row(
                            children: [
                              Expanded(child: Text('4. 吏???뱁솕 嫄곗＜/洹쇰Т (理쒕? 20??', style: GoogleFonts.notoSansKr(fontSize: 14))),
                              SizedBox(
                                width: 60,
                                child: TextField(
                                  controller: _regionScoreController,
                                  keyboardType: TextInputType.number,
                                  textAlign: TextAlign.center,
                                  decoration: const InputDecoration(hintText: '0', isDense: true),
                                  onChanged: (val) {
                                    store.updateRegionalScore(int.tryParse(val) ?? 0);
                                  },
                                ),
                              ),
                              const Text(' ??),
                            ],
                          ),
                        ),
                      ],
                    ),

                    // --- 媛먯젏 ---
                    _buildCard(
                      title: '媛먯젏 ??ぉ (Penalty)',
                      subtitle: '?꾨컲 ?ъ떎???덈뒗 寃쎌슦',
                      children: [
                        _buildCheckboxItem('異쒖엯援??由щ쾿 ?꾨컲 (-30??', store.immigrationViolation, (val) => store.updateImmigrationPenalty(val!), isPenalty: true),
                        _buildCheckboxItem('?뺤궗 泥섎쾶 ?대젰 (-40??', store.criminalPunishment, (val) => store.updateCriminalPenalty(val!), isPenalty: true),
                      ],
                    ),
                    
                    const SizedBox(height: 100), // ?섎떒 ?щ갚
                  ],
                ),
              ),
              

              
              // --- ?섎떒 怨좎젙 諛?(Updated: '?꾨즺' 踰꾪듉) ---
              Container(
                width: double.infinity,
                decoration: BoxDecoration(
                  color: Colors.white,
                  boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.1), blurRadius: 10, offset: const Offset(0, -5))],
                  borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
                ),
                padding: const EdgeInsets.fromLTRB(24, 20, 24, 40), // Bottom padding for safe area
                child: Row(
                  children: [
                    // Score Text
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text('?꾩옱 ?덉륫 ?먯닔', style: GoogleFonts.notoSansKr(color: Colors.grey[600], fontSize: 12)),
                        Text('$currentScore??, style: GoogleFonts.notoSansKr(fontSize: 24, fontWeight: FontWeight.w800, color: const Color(0xFF1E2B4D))),
                      ],
                    ),
                    const SizedBox(width: 20),
                    // Action Button
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () {
                          // Calculate breakdown
                          int totalScore = store.calculateTotalScore();
                          bool isMasters = store.educationLevel == '?앹궗' || store.educationLevel == '諛뺤궗';
                          
                          // Calculate specific scores for advice
                          int koreanScore = 0;
                          if (store.koreanLevel?.contains('5?④퀎') == true || store.koreanLevel?.contains('5~6湲?) == true) koreanScore = 20;
                          else if (store.koreanLevel?.contains('4?④퀎') == true || store.koreanLevel?.contains('4湲?) == true) koreanScore = 15;
                          else if (store.koreanLevel?.contains('3?④퀎') == true || store.koreanLevel?.contains('3湲?) == true) koreanScore = 10;
                          else if (store.koreanLevel?.contains('2?④퀎') == true || store.koreanLevel?.contains('2湲?) == true) koreanScore = 5;
                          else if (store.koreanLevel?.contains('1?④퀎') == true || store.koreanLevel?.contains('1湲?) == true) koreanScore = 3;

                          int volunteerScore = 0;
                          if (store.volunteerBonus == '3???댁긽') volunteerScore = 7;
                          else if (store.volunteerBonus == '2???댁긽') volunteerScore = 5;
                          else if (store.volunteerBonus == '1???댁긽') volunteerScore = 1;

                          int incomeScore = 0;
                          if (store.incomeBracket == '1?????댁긽') incomeScore = 60;
                          else if (store.incomeBracket == '9泥쒕쭔 ~ 1??誘몃쭔') incomeScore = 58;
                          else if (store.incomeBracket == '8泥쒕쭔 ~ 9泥쒕쭔 誘몃쭔') incomeScore = 56;
                          else if (store.incomeBracket == '7泥쒕쭔 ~ 8泥쒕쭔 誘몃쭔') incomeScore = 53;
                          else if (store.incomeBracket == '6泥쒕쭔 ~ 7泥쒕쭔 誘몃쭔') incomeScore = 50;
                          else if (store.incomeBracket == '5泥쒕쭔 ~ 6泥쒕쭔 誘몃쭔') incomeScore = 45;
                          else if (store.incomeBracket == '4泥쒕쭔 ~ 5泥쒕쭔 誘몃쭔') incomeScore = 40;
                          else if (store.incomeBracket == '3泥쒕쭔 ~ 4泥쒕쭔 誘몃쭔') incomeScore = 30;
                          else if (store.incomeBracket == '理쒖??꾧툑 ~ 3泥쒕쭔 誘몃쭔') incomeScore = 10;

                          Navigator.pop(context, {
                            'totalScore': totalScore,
                            'isMasters': isMasters,
                            'isStem': store.isStemOrDoubleMajor,
                            'volunteer': volunteerScore,
                            'korean': koreanScore,
                            'income': incomeScore,
                            'age': store.selectedAge,
                          });
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF673AB7),
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                          elevation: 0,
                        ),
                        child: Text(
                          '?꾨즺',
                          style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white),
                        ),
                      ),
                    ),
                  ],
                ),
              )
            ],
          ),
        );
      },
    );
  }

  // --- ?꾩젽 鍮뚮뜑 ?ы띁 ---
  
  Widget _buildSectionTitle(String title) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 4),
      child: Text(title, style: GoogleFonts.notoSansKr(fontSize: 16, fontWeight: FontWeight.bold, color: const Color(0xFF1E2B4D))),
    );
  }

  Widget _buildCard({required String title, required String subtitle, required List<Widget> children}) {
    return Card(
      elevation: 2,
      margin: const EdgeInsets.only(bottom: 16),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Theme(
        data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
        child: ExpansionTile(
          initiallyExpanded: true,
          title: Text(title, style: GoogleFonts.notoSansKr(fontWeight: FontWeight.bold, fontSize: 16)),
          subtitle: Text(subtitle, style: GoogleFonts.notoSansKr(fontSize: 12, color: Colors.grey[600])),
          children: children,
        ),
      ),
    );
  }

  Widget _buildRadioItem(VisaScoreProvider store, String group, String label, int score, {bool isBest = false}) {
    String? groupValue;
    // 洹몃９蹂?Value 留ㅽ븨
    if (group == '?섏씠') {
      groupValue = store.selectedAge;
    } else if (group == '?숇젰') {
      groupValue = store.educationLevel;
    } else if (group == '?쒓뎅??) {
      groupValue = store.koreanLevel;
    } else if (group == '?뚮뱷') {
      groupValue = store.incomeBracket;
    } else if (group == '遊됱궗') {
      groupValue = store.volunteerBonus;
    }

    return RadioListTile<String>(
      title: Row(
        children: [
          Expanded(child: Text(label, style: GoogleFonts.notoSansKr(fontSize: 14))),
          if (isBest) 
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
              margin: const EdgeInsets.only(left: 4),
              decoration: BoxDecoration(color: Colors.amber[100], borderRadius: BorderRadius.circular(4)),
              child: const Text('BEST', style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.orange)),
            ),
        ],
      ),
      secondary: Container(
        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
        decoration: BoxDecoration(color: Colors.grey[100], borderRadius: BorderRadius.circular(6)),
        child: Text('+$score', style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.black54)),
      ),
      value: label,
      groupValue: groupValue,
      activeColor: const Color(0xFF0277BD),
      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 0),
      dense: true,
      onChanged: (val) {
        if (group == '?섏씠') {
          store.updateAge(val);
        } else if (group == '?숇젰') {
          store.updateEducation(val);
        } else if (group == '?쒓뎅??) {
          store.updateKoreanLevel(val);
        } else if (group == '?뚮뱷') {
          store.updateIncome(val);
        } else if (group == '遊됱궗') {
          store.updateVolunteerBonus(val);
        }
      },
    );
  }

  Widget _buildCheckboxItem(String label, bool value, Function(bool?) onChanged, {bool isPenalty = false}) {
    return CheckboxListTile(
      title: Text(label, style: GoogleFonts.notoSansKr(fontSize: 14)),
      value: value,
      activeColor: isPenalty ? Colors.red : const Color(0xFF0277BD),
      onChanged: onChanged,
      controlAffinity: ListTileControlAffinity.leading,
      contentPadding: const EdgeInsets.symmetric(horizontal: 8),
      dense: true,
    );
  }
}

=== lib\screens\visa\visa_dashboard_screen.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:provider/provider.dart';
import '../../providers/f27_visa_provider.dart';
import 'f27_visa_calculator_screen.dart';

class VisaDashboardScreen extends StatefulWidget {
  final String userGoal; // 'novice', 'residency', 'job', etc.
  final VoidCallback? onGoalChangeRequested; // Callback to reset goal

  const VisaDashboardScreen({
    super.key,
    this.userGoal = 'novice',
    this.onGoalChangeRequested,
  });

  @override
  State<VisaDashboardScreen> createState() => _VisaDashboardScreenState();
}

class _VisaDashboardScreenState extends State<VisaDashboardScreen> {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFF5F7FA),
      appBar: AppBar(
        title: Text(
          'My Visa Roadmap',
          style: GoogleFonts.notoSansKr(
            fontWeight: FontWeight.w700,
            fontSize: 18,
            color: Colors.black87,
          ),
        ),
        backgroundColor: Colors.white,
        elevation: 0,
        centerTitle: true,
        iconTheme: const IconThemeData(color: Colors.black87),
        actions: [
          IconButton(
            onPressed: widget.onGoalChangeRequested ?? () {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('紐⑺몴 ?ㅼ젙 蹂寃?湲곕뒫 以鍮?以?)),
              );
            },
            icon: const Icon(Icons.edit_road),
            tooltip: '紐⑺몴 蹂寃?,
          ),
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildHeader(),
            const SizedBox(height: 20),
            if (widget.userGoal == 'novice') _buildNoviceContent(),
            if (widget.userGoal == 'residency') _buildResidencyContent(context),
            if (widget.userGoal == 'job') _buildJobContent(),
          ],
        ),
      ),
    );
  }

  Widget _buildHeader() {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: const Color(0xFF1E2B4D),
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: const Color(0xFF1E2B4D).withValues(alpha: 0.3),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            '?꾩옱 鍮꾩옄 ?곹깭',
            style: GoogleFonts.notoSansKr(
              color: Colors.white70,
              fontSize: 14,
            ),
          ),
          const SizedBox(height: 8),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                'D-2 ?좏븰鍮꾩옄',
                style: GoogleFonts.notoSansKr(
                  color: Colors.white,
                  fontSize: 24,
                  fontWeight: FontWeight.w700,
                ),
              ),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                decoration: BoxDecoration(
                  color: Colors.white.withValues(alpha: 0.2),
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Text(
                  'D-365',
                  style: GoogleFonts.notoSansKr(
                    color: Colors.white,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildNoviceContent() {
    return Column(
      children: [
        _buildInfoCard(
          title: '異쒖꽍瑜?愿由?,
          value: '95%',
          description: '?덉쟾??鍮꾩옄 ?곗옣???꾪빐 80% ?댁긽 ?좎??섏꽭??',
          icon: Icons.check_circle_outline,
          color: Colors.green,
        ),
        const SizedBox(height: 16),
        _buildInfoCard(
          title: '?쒓컙??痍⑥뾽 ?덉슜',
          value: '二?20?쒓컙',
          description: '?숆린 以??덉슜 ?쒓컙?낅땲?? 諛⑺븰 以묒뿉??臾댁젣??',
          icon: Icons.access_time,
          color: Colors.orange,
        ),
      ],
    );
  }

  Widget _buildResidencyContent(BuildContext context) {
    // Get live score from Store
    final currentScore = Provider.of<VisaScoreProvider>(context).calculateTotalScore();
    final isPass = currentScore >= 80;

    return Column(
      children: [
        _buildInfoCard(
          title: 'F-2-7 ?먯닔 ?덉륫',
          value: '$currentScore??/ 80??,
          description: isPass 
              ? '異뺥븯?⑸땲?? 紐⑺몴 ?먯닔瑜??ъ꽦?덉뒿?덈떎.' 
              : '紐⑺몴 ?먯닔源뚯? ${80 - currentScore}???⑥븯?듬땲??\n?곗튂?섏뿬 ?곸꽭 ?먯닔 怨꾩궛?섍린',
          icon: Icons.calculate_outlined,
          color: isPass ? Colors.green : Colors.blue,
          onTap: () {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => const F27VisaCalculatorScreen(),
              ),
            ).then((_) {
               setState(() {});
            });

          },
        ),
        const SizedBox(height: 16),
         _buildInfoCard(
          title: '?ы쉶?듯빀?꾨줈洹몃옩',
          value: '3?④퀎 ?댁닔',
          description: '5?④퀎 ?댁닔 ??媛?곗젏??遺?щ맗?덈떎.',
          icon: Icons.school_outlined,
          color: Colors.purple,
        ),
      ],
    );
  }

  Widget _buildJobContent() {
     return Column(
      children: [
        _buildInfoCard(
          title: 'E-7 ?붽굔 異⑹”',
          value: '以鍮?以?,
          description: '?꾧났 愿??吏곷Т ?먯깋???꾩슂?⑸땲??',
          icon: Icons.work_outline,
          color: Colors.indigo,
        ),
        const SizedBox(height: 16),
         _buildInfoCard(
          title: '?쒓뎅???λ젰',
          value: 'TOPIK 4湲?,
          description: '痍⑥뾽???좊━??5湲??꾩쟾??異붿쿇?댁슂!',
          icon: Icons.translate,
          color: Colors.teal,
        ),
      ],
    );
  }

  Widget _buildInfoCard({
    required String title,
    required String value,
    required String description,
    required IconData icon,
    required Color color,
    VoidCallback? onTap,
  }) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(16),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.05),
              blurRadius: 10,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: color.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(icon, color: color, size: 28),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: GoogleFonts.notoSansKr(
                      fontSize: 14,
                      color: Colors.grey[600],
                    ),
                  ),
                  Text(
                    value,
                    style: GoogleFonts.notoSansKr(
                      fontSize: 18,
                      fontWeight: FontWeight.w700,
                      color: Colors.black87,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    description,
                    style: GoogleFonts.notoSansKr(
                      fontSize: 12,
                      color: Colors.grey[500],
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}


=== lib\screens\visa\visa_goal_selection_screen.dart ===
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class VisaGoalSelectionScreen extends StatelessWidget {
  final Function(String) onGoalSelected;

  const VisaGoalSelectionScreen({
    super.key,
    required this.onGoalSelected,
  });

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.white,
        elevation: 0,
        iconTheme: const IconThemeData(color: Colors.black),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.fromLTRB(20, 10, 20, 40),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              '?대뼡 誘몃옒瑜?n轅덇씀?쒕굹??',
              style: GoogleFonts.notoSansKr(
                fontSize: 28,
                fontWeight: FontWeight.w700,
                height: 1.3,
                color: const Color(0xFF1E2B4D),
              ),
            ),
            const SizedBox(height: 10),
            Text(
              '?섏쨷???몄젣??蹂寃쏀븷 ???덉쑝???명븯寃??좏깮?섏꽭?? ?봽',
              style: GoogleFonts.notoSansKr(
                fontSize: 14,
                color: Colors.grey[600],
              ),
            ),
            const SizedBox(height: 30),
            // Top Grid - Vertical 1:2 Layout
            GridView.count(
              shrinkWrap: true,
              physics: const NeverScrollableScrollPhysics(),
              crossAxisCount: 2,
              mainAxisSpacing: 16,
              crossAxisSpacing: 16,
              childAspectRatio: 0.5, // 1:2 Ratio for Vertical Cards
              children: [
                _buildVerticalClassCard(
                  context,
                  title: '?곌뎄/嫄곗＜??,
                  subtitle: '??숈썝 吏꾪븰 ?덉젙 &\nF-2-7(嫄곗＜) 紐⑺몴',
                  description: '?⑥닚 痍⑥뾽鍮꾩옄(E-7)??留뚯”?섏? 留덉꽭??\n?앹궗 ?숈쐞瑜??쒖슜?????먯쑀濡쒖슫 F-2-7(嫄곗＜ 鍮꾩옄)濡?諛붾줈 ?낃렇?덉씠?쒗븷 ???덉뒿?덈떎. 80???ъ꽦???꾪븳 議깆쭛寃??꾨왂???뚮젮?쒕┫寃뚯슂.',
                  imagePath: 'assets/images/class_academic.jpg',
                  goalKey: 'residency',
                  color: Colors.purple[50]!,
                  icon: Icons.school_outlined,
                ),
                _buildVerticalClassCard(
                  context,
                  title: '?ㅼ쟾 痍⑥뾽??,
                  subtitle: '?숇? 議몄뾽 ??n?쒓뎅 湲곗뾽 諛붾줈 痍⑥뾽',
                  description: '議몄뾽 ???쒓뎅 湲곗뾽??痍⑥뾽?섎뒗 寃껋씠 紐⑺몴?쒓뎔?? E-7 鍮꾩옄 諛쒓툒 議곌굔遺???명꽩?? 硫댁젒 轅?곴퉴吏 ?쒓? 瑗쇨세?섍쾶 梨숆꺼?쒕┫寃뚯슂.',
                  imagePath: 'assets/images/class_job.jpg',
                  goalKey: 'job',
                  color: Colors.blue[50]!,
                  icon: Icons.work_outline_rounded,
                ),
                _buildVerticalClassCard(
                  context,
                  title: '李쎌뾽??,
                  subtitle: '?섎쭔???꾩씠?붿뼱濡?n湲곗닠 李쎌뾽 ?꾩쟾',
                  description: '硫뗭쭊 ?꾩씠?붿뼱媛 ?덉쑝?쒓뎔?? D-8-4 鍮꾩옄 痍⑤뱷???꾪븳 OASIS ?꾨줈洹몃옩怨?踰뺤씤 ?ㅻ┰ ?덉감瑜??④퍡 以鍮꾪빐 遊먯슂.',
                  imagePath: 'assets/images/class_startup.jpg',
                  goalKey: 'startup',
                  color: Colors.orange[50]!,
                  icon: Icons.rocket_launch_outlined,
                ),
                _buildVerticalClassCard(
                  context,
                  title: '湲濡쒕쾶??,
                  subtitle: '?쒓뎅 ?숈쐞 痍⑤뱷 ??n蹂멸뎅/?댁쇅 吏꾩텧',
                  description: '?쒓뎅?먯꽌???숈뾽??留덉튂怨????볦? ?몄긽?쇰줈! ?먰솢??洹援?以鍮꾨굹 ??援?吏꾩텧???꾪븳 ?쒕쪟 ?묒뾽???꾩??쒕┫寃뚯슂.',
                  imagePath: 'assets/images/class_global.png',
                  goalKey: 'global',
                  color: Colors.teal[50]!,
                  icon: Icons.public_outlined,
                ),
              ],
            ),
            const SizedBox(height: 16),
            // Bottom Horizontal Card
            _buildHorizontalClassCard(
              context,
              title: '?숆탳 ?앺솢??,
              subtitle: '?쇰떒 ?숆탳 ?앺솢怨?鍮꾩옄 ?좎???吏묒쨷?좊옒??,
              description: '?쇰떒? 利먭굅??罹좏띁???쇱씠?꾧? ?곗꽑?댁짛! 異쒖꽍瑜?愿由ъ? ?숈젏, 洹몃━怨?鍮꾩옄 ?곗옣???꾩슂??湲곕낯湲곕????꾪깂?섍쾶 ?ㅼ졇遊먯슂.',
              imagePath: 'assets/images/class_basic.png', // Fallback to png as jpg not found
              goalKey: 'novice',
              color: Colors.grey[100]!,
              icon: Icons.spa_outlined,
            ),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  void _showConfirmationDialog(
    BuildContext context, {
    required String title,
    required String description,
    required String imagePath,
    required Color color,
    required String goalKey,
  }) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return Dialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(20),
          ),
          backgroundColor: Colors.white,
          elevation: 0,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Top Image Area
              Stack(
                alignment: Alignment.topCenter,
                clipBehavior: Clip.none,
                children: [
                  Container(
                    height: 120,
                    decoration: BoxDecoration(
                      color: color,
                      borderRadius: const BorderRadius.only(
                        topLeft: Radius.circular(20),
                        topRight: Radius.circular(20),
                      ),
                    ),
                  ),
                  Positioned(
                    top: 20,
                    height: 140, // Allow overlap
                    child: Image.asset(
                      imagePath,
                      fit: BoxFit.contain,
                      errorBuilder: (context, error, stackTrace) =>
                          const Icon(Icons.person, size: 80, color: Colors.grey),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 50), // Spacing for the overlapping image
              
              // Content Area
              Padding(
                padding: const EdgeInsets.symmetric(horizontal: 24),
                child: Column(
                  children: [
                    Text(
                      title,
                      style: GoogleFonts.notoSansKr(
                        fontSize: 22,
                        fontWeight: FontWeight.w700,
                        color: const Color(0xFF1E2B4D),
                      ),
                      textAlign: TextAlign.center,
                    ),
                    const SizedBox(height: 16),
                    Text(
                      description,
                      style: GoogleFonts.notoSansKr(
                        fontSize: 15,
                        color: Colors.grey[800],
                        height: 1.5,
                      ),
                      textAlign: TextAlign.center,
                    ),
                    const SizedBox(height: 24),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                      decoration: BoxDecoration(
                        color: Colors.blue.withValues(alpha: 0.05),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: Colors.blue.withValues(alpha: 0.1)),
                      ),
                      child: Row(
                        children: [
                          const Icon(Icons.lightbulb_outline, color: Colors.blueAccent, size: 20),
                          const SizedBox(width: 10),
                          Expanded(
                            child: Text(
                              '紐⑺몴???섏쨷??[留덉씠?섏씠吏]?먯꽌\n?몄젣??諛붽? ???덉뼱??',
                              style: GoogleFonts.notoSansKr(
                                fontSize: 13,
                                color: Colors.blue[800],
                                height: 1.3,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 30),
              
              // Actions Area
              Padding(
                padding: const EdgeInsets.fromLTRB(20, 0, 20, 24),
                child: Row(
                  children: [
                    Expanded(
                      child: TextButton(
                        onPressed: () => Navigator.of(context).pop(),
                        style: TextButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          backgroundColor: Colors.grey[100],
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: Text(
                          '?ㅻⅨ 嫄?蹂쇰옒??,
                          style: GoogleFonts.notoSansKr(
                            fontSize: 16,
                            color: Colors.grey[600],
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () {
                          Navigator.of(context).pop(); // Close dialog
                          onGoalSelected(goalKey); // Proceed with select
                        },
                        style: ElevatedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          backgroundColor: const Color(0xFF1E2B4D), // Brand color
                          elevation: 0,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: Text(
                          '?닿구濡?寃곗젙!',
                          style: GoogleFonts.notoSansKr(
                            fontSize: 16,
                            color: Colors.white,
                            fontWeight: FontWeight.w700,
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildVerticalClassCard(
    BuildContext context, {
    required String title,
    required String subtitle,
    required String description,
    required String imagePath,
    required String goalKey,
    required Color color,
    required IconData icon,
  }) {
    return GestureDetector(
      onTap: () => _showConfirmationDialog(
        context,
        title: title,
        description: description,
        imagePath: imagePath,
        color: color,
        goalKey: goalKey,
      ),
      child: Card(
        elevation: 4,
        margin: EdgeInsets.zero,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        clipBehavior: Clip.antiAlias,
        child: Column(
          children: [
            // Top Image - Flex 3 (75%)
            Expanded(
              flex: 3,
              child: Image.asset(
                imagePath,
                fit: BoxFit.cover,
                width: double.infinity,
                alignment: Alignment.topCenter,
                errorBuilder: (context, error, stackTrace) => Container(
                  color: Colors.grey[200],
                  child: const Center(child: Icon(Icons.broken_image, color: Colors.grey)),
                ),
              ),
            ),
            // Bottom Info - Flex 1 (25%)
            Expanded(
              flex: 1,
              child: Container(
                width: double.infinity,
                color: color,
                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(icon, size: 16, color: Colors.black54),
                        const SizedBox(width: 4),
                        Text(
                          title,
                          style: GoogleFonts.notoSansKr(
                            fontSize: 15,
                            fontWeight: FontWeight.w700,
                            color: const Color(0xFF1E2B4D),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 2),
                    Text(
                      subtitle,
                      style: GoogleFonts.notoSansKr(
                        fontSize: 11,
                        color: Colors.black54,
                        height: 1.2,
                        fontWeight: FontWeight.w500,
                      ),
                      textAlign: TextAlign.center,
                      maxLines: 2,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildHorizontalClassCard(
    BuildContext context, {
    required String title,
    required String subtitle,
    required String description,
    required String imagePath,
    required String goalKey,
    required Color color,
    required IconData icon,
  }) {
    return GestureDetector(
      onTap: () => _showConfirmationDialog(
        context,
        title: title,
        description: description,
        imagePath: imagePath,
        color: color,
        goalKey: goalKey,
      ),
      child: Card(
        elevation: 4,
        margin: EdgeInsets.zero,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        clipBehavior: Clip.antiAlias,
        child: SizedBox(
          height: 120, // Fixed height for horizontal card
          child: Row(
            children: [
              // Left Image - Flex 3 (30%)
              Expanded(
                flex: 3,
                child: Image.asset(
                  imagePath,
                  fit: BoxFit.cover,
                  height: double.infinity,
                  alignment: Alignment.topCenter,
                  errorBuilder: (context, error, stackTrace) => Container(
                  color: Colors.grey[200],
                  child: const Center(child: Icon(Icons.broken_image, color: Colors.grey)),
                ),
                ),
              ),
              // Right Info - Flex 7 (70%)
              Expanded(
                flex: 7,
                child: Container(
                  color: color,
                  padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Icon(icon, size: 24, color: Colors.black54),
                          const SizedBox(width: 8),
                          Text(
                            title,
                            style: GoogleFonts.notoSansKr(
                              fontSize: 18,
                              fontWeight: FontWeight.w700,
                              color: const Color(0xFF1E2B4D),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 6),
                      Text(
                        subtitle,
                        style: GoogleFonts.notoSansKr(
                          fontSize: 13,
                          color: Colors.black54,
                          height: 1.3,
                          fontWeight: FontWeight.w500,
                        ),
                        maxLines: 2,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ],
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

=== lib\screens\visa\visa_screen_wrapper.dart ===
import 'package:flutter/material.dart';
import 'visa_goal_selection_screen.dart';
import '../roadmap/visa_roadmap_screen.dart';

// Mock State for session persistence
class VisaState {
  static String? userGoal;
}

class VisaScreenWrapper extends StatefulWidget {
  const VisaScreenWrapper({super.key});

  @override
  State<VisaScreenWrapper> createState() => _VisaScreenWrapperState();
}

class _VisaScreenWrapperState extends State<VisaScreenWrapper> {
  
  void _updateGoal(String? goal) {
    setState(() {
      VisaState.userGoal = goal;
    });
  }

  @override
  Widget build(BuildContext context) {
    // If goal is null, show selection screen
    if (VisaState.userGoal == null) {
      return VisaGoalSelectionScreen(
        onGoalSelected: (selectedGoal) {
          _updateGoal(selectedGoal);
        },
      );
    } 
    // Otherwise, show dashboard (now Roadmap)
    else {
      return VisaRoadmapScreen(
        userGoal: VisaState.userGoal!,
        onGoalChangeRequested: () {
          _updateGoal(null); // Reset goal to trigger selection screen
        },
      );
    }
  }
}

=== lib\screens\wallet\my_point_screen.dart ===
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';
import '../../providers/point_provider.dart';

class MyPointScreen extends ConsumerWidget {
  const MyPointScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final pointState = ref.watch(pointProvider);

    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        title: const Text('?ъ씤???댁뿭', style: TextStyle(fontWeight: FontWeight.bold)),
        centerTitle: true,
        backgroundColor: Colors.white,
        elevation: 0,
        foregroundColor: Colors.black,
      ),
      body: Column(
        children: [
          // 1. Total Balance Section
          Container(
            padding: const EdgeInsets.fromLTRB(24, 10, 24, 30),
            child: Column(
              children: [
                const Text('?꾩옱 蹂댁쑀 ?ъ씤??, style: TextStyle(fontSize: 14, color: Colors.grey)),
                const SizedBox(height: 8),
                Text(
                  '${NumberFormat('#,###').format(pointState.totalBalance)} P',
                  style: const TextStyle(fontSize: 32, fontWeight: FontWeight.bold, color: Color(0xFF8B5CF6)),
                ),
              ],
            ),
          ),

          // 2. Mission Banners (Horizontal Scroll)
          SizedBox(
            height: 100,
            child: ListView(
              scrollDirection: Axis.horizontal,
              padding: const EdgeInsets.symmetric(horizontal: 20),
              children: [
                _buildMissionCard(
                  context,
                  title: "?쒕쪟 ?깅줉?섍퀬",
                  reward: "300P",
                  icon: Icons.description_outlined,
                  color: const Color(0xFFE3F2FD), // Light Blue
                  onTap: () => ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("DocumentProvider ?곕룞 ?덉젙 ?뱞"))),
                ),
                const SizedBox(width: 12),
                _buildMissionCard(
                  context,
                  title: "硫댁젒 ?꾧린 ?곌퀬",
                  reward: "500P",
                  icon: Icons.rate_review_outlined,
                  color: const Color(0xFFF3E5F5), // Light Purple
                  onTap: () => ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("AlbaProvider ?곕룞 ?덉젙 ?렎"))),
                ),
              ],
            ),
          ),
          
          const Divider(height: 40, thickness: 8, color: Color(0xFFF5F5F5)),

          // 3. History List
          Expanded(
            child: pointState.history.isEmpty
            ? const Center(child: Text("?꾩쭅 ?곷┰???ъ씤?멸? ?놁뼱??"))
            : ListView.separated(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
              itemCount: pointState.history.length,
              separatorBuilder: (context, index) => const Divider(height: 1, color: Color(0xFFEEEEEE)),
              itemBuilder: (context, index) {
                final history = pointState.history[index];
                final isEarned = history.type == 'earn';
                
                return Padding(
                  padding: const EdgeInsets.symmetric(vertical: 16),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            history.title,
                            style: const TextStyle(fontSize: 15, fontWeight: FontWeight.w600, color: Color(0xFF1A1A2E)),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            DateFormat('MM.dd HH:mm').format(history.date),
                            style: const TextStyle(fontSize: 12, color: Colors.grey),
                          ),
                        ],
                      ),
                      Text(
                        '${isEarned ? '+' : ''}${NumberFormat('#,###').format(history.amount)} P',
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: isEarned ? const Color(0xFF8B5CF6) : const Color(0xFFFF5252),
                        ),
                      ),
                    ],
                  ),
                );
              },
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildMissionCard(BuildContext context, {required String title, required String reward, required IconData icon, required Color color, required VoidCallback onTap}) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        width: 160,
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: color,
          borderRadius: BorderRadius.circular(16),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Row(
              children: [
                Icon(icon, size: 20, color: Colors.black54),
                const Spacer(),
                const Icon(Icons.arrow_forward_ios, size: 12, color: Colors.black26),
              ],
            ),
            const SizedBox(height: 8),
            Text(title, style: const TextStyle(fontSize: 12, color: Colors.black54)),
            Text(reward, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.black87)),
          ],
        ),
      ),
    );
  }
}

=== lib\screens\wallet\wallet_main_screen.dart ===
import 'package:flutter/material.dart';

class WalletMainScreen extends StatelessWidget {
  const WalletMainScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('?쒕쪟吏媛?),
      ),
      backgroundColor: Colors.white,
      body: const Center(
        child: Text('?곗씠???곕룞 ?湲?以?),
      ),
    );
  }
}

=== lib\services\api_service.dart ===
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import '../models/user.dart';

class ApiService {
  // Singleton Pattern
  static final ApiService instance = ApiService._internal();
  ApiService._internal();

  // Configuration
  static const String baseUrl = ""; // To be filled

  final _storage = const FlutterSecureStorage();

  // 1. Login
  Future<bool> login(String email, String password) async {
    // Prevent parsing error if baseUrl is empty
    if (baseUrl.isEmpty) {
      print("[API] Base URL is empty. Login simulation.");
      return false; 
    }

    final url = Uri.parse('$baseUrl/api/v1/auth/login');
    try {
      final response = await http.post(
        url,
        headers: {'Content-Type': 'application/json'},
        body: jsonEncode({'email': email, 'password': password}),
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        final accessToken = data['access_token'];
        if (accessToken != null) {
          await _storage.write(key: 'access_token', value: accessToken);
          return true;
        }
      } else {
        print('Login Failed: ${response.statusCode} - ${response.body}');
      }
    } catch (e) {
      print('Login Error: $e');
    }
    return false;
  }

  // 2. Fetch My Info
  Future<User?> fetchMyInfo() async {
    if (baseUrl.isEmpty) return null;
    
    final url = Uri.parse('$baseUrl/api/v1/users/me');
    try {
      final accessToken = await _storage.read(key: 'access_token');
      if (accessToken == null) return null;

      final response = await http.get(
        url,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $accessToken',
        },
      );

      if (response.statusCode == 200) {
        final data = jsonDecode(response.body); // Directly expects User JSON
        return User.fromJson(data);
      } else {
        print('Fetch Info Failed: ${response.statusCode}');
      }
    } catch (e) {
      print('Fetch Info Error: $e');
    }
    return null;
  }
}

=== lib\services\home_repository.dart ===
import '../models/schedule_item.dart';
import '../models/community_post.dart';
import '../models/job_post.dart';
import '../models/banner_item.dart';

abstract class HomeRepository {
  Future<List<ScheduleItem>> fetchDailySchedule();
  Future<List<CommunityPost>> fetchPopularPosts();
  Future<List<JobPost>> fetchJobPosts();
  Future<List<BannerItem>> fetchBanners(int categoryIndex);
}

=== lib\services\home_repository_impl.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../models/schedule_item.dart';
import '../models/community_post.dart';
import '../models/job_post.dart';
import '../models/banner_item.dart';
import 'api_service.dart';
import 'home_repository.dart';

class HomeRepositoryImpl implements HomeRepository {
  final ApiService _apiService;

  HomeRepositoryImpl({required ApiService apiService}) : _apiService = apiService;

  @override
  Future<List<ScheduleItem>> fetchDailySchedule() async {
    // [Backend Readiness]
    // Currently ApiService doesn't have a specific method for schedules.
    // In a real scenario, we would add fetchSchedules() to ApiService.
    // For now, returning empty list to satisfy interface.
    // TODO: Implement actual API call when backend endpoint is ready.
    return []; 
  }

  @override
  Future<List<CommunityPost>> fetchPopularPosts() async {
    try {
      final postModels = await _apiService.fetchPopularPosts();
      
      // Map PostModel to CommunityPost
      return postModels.map((model) {
        return CommunityPost(
          userName: "?듬챸", // PostModel doesn't have user info yet
          title: model.title,
          content: model.content,
          likes: model.likeCount,
          comments: 0, // PostModel doesn't have comment count yet
          timeAgo: "諛⑷툑 ??, // PostModel doesn't have timestamp yet
        );
      }).toList();
    } catch (e) {
      // In production, might want to log this or rethrow specific error
      throw Exception('Failed to fetch popular posts: $e');
    }
  }

  @override
  Future<List<JobPost>> fetchJobPosts() async {
    // Placeholder - ApiService support needed
    return [];
  }

  @override
  Future<List<BannerItem>> fetchBanners(int categoryIndex) async {
    return [];
  }
}

// Provider
final homeRepositoryImplProvider = Provider<HomeRepository>((ref) {
  // Assuming generic ApiService is sufficient or configured elsewhere
  return HomeRepositoryImpl(apiService: ApiService()); 
});

=== lib\services\mock_home_repository.dart ===
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../models/schedule_item.dart';
import '../models/community_post.dart';
import '../models/job_post.dart';
import '../models/banner_item.dart'; // Import BannerItem
import 'package:dio/dio.dart'; // Import Dio
import '../data/repositories/real_home_repository.dart'; // Import Real Repo
import 'home_repository.dart';

final homeRepositoryProvider = Provider<HomeRepository>((ref) {
  // Use RealHomeRepository with Dio
  // For now, let's create a placeholder Dio. In a real app, you might provide Dio separately.
  final dio = Dio(BaseOptions(
    baseUrl: 'https://api.university.ac.kr', // Base URL from API Spec context (implied)
    connectTimeout: const Duration(seconds: 5),
    receiveTimeout: const Duration(seconds: 3),
  ));
  return RealHomeRepository(dio);
});

class MockHomeRepository implements HomeRepository {
  @override
  Future<List<ScheduleItem>> fetchDailySchedule() async {
    await Future.delayed(const Duration(seconds: 1)); // Simulate network delay
    return [
      ScheduleItem(
        time: '10:00',
        title: '寃쎌젣濡?,
        subtitle: '寃쎌쟻 304',
      ),
    ];
  }

  @override
  Future<List<CommunityPost>> fetchPopularPosts() async {
    await Future.delayed(const Duration(seconds: 1)); // Simulate network delay
    return [
      CommunityPost(
        userName: '遺?곕?留쏆쭛??,
        title: '遺?곕? 留쏆쭛 由ъ뒪??怨듭쑀?댁슂!',
        content: '遺?곕? 留쏆쭛 由ъ뒪??怨듭쑀?댁슂! ?뵦',
        likes: 21,
        comments: 11,
        timeAgo: '2?쒓컙',
      ),
    ];
  }
  @override
  Future<List<JobPost>> fetchJobPosts() async {
    await Future.delayed(const Duration(seconds: 1));
    return [
      JobPost(
        title: '轅?뚮컮 湲됯뎄',
        hourlyWage: 12000,
        tags: ['?④린', '移댄럹'],
        imageUrl: '',
        isVerified: true,
      ),
    ];
  }

  @override // Updated to match HomeRepository abstract class
  Future<List<BannerItem>> fetchBanners(int categoryIndex) async {
    return [];
  }
}

=== lib\widgets\shop\shop_list_item.dart ===
import 'package:flutter/material.dart';
import '../../models/shop_model.dart';
// import '../../providers/shop_provider.dart'; // No longer needed if using model directly

class ShopListItem extends StatelessWidget {
  final Shop product; // Changed ShopProduct to Shop
  final VoidCallback onTap;

  const ShopListItem({
    super.key,
    required this.product,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      margin: const EdgeInsets.only(bottom: 12),
      elevation: 0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(16),
        side: BorderSide(color: Colors.grey.shade200),
      ),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Padding(
          padding: const EdgeInsets.all(12),
          child: Row(
            children: [
              // Image Placeholder
              // Image Placeholder (Grey Box)
              Container(
                width: 80,
                height: 80,
                decoration: BoxDecoration(
                  color: Colors.grey.shade200,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Icon(Icons.shopping_bag_outlined, color: Colors.grey.shade400, size: 32),
              ),
              const SizedBox(width: 16),
              // Text Content
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      product.category.toUpperCase(),
                      style: TextStyle(
                        fontSize: 10,
                        fontWeight: FontWeight.bold,
                        color: Colors.purple.shade300,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      product.name,
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: Color(0xFF1A1A2E),
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      '${product.price} P',
                      style: const TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                        color: Color(0xFF8B5CF6),
                      ),
                    ),
                  ],
                ),
              ),
              const Icon(Icons.chevron_right, color: Colors.grey),
            ],
          ),
        ),
      ),
    );
  }
}

